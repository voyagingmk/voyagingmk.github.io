<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Wymançš„æŠ€æœ¯åšå®¢</title>
    <description>å†™ä½œä¸»é¢˜è¦†ç›–ï¼šæ¸¸æˆå¼€å‘æŠ€æœ¯ã€å›¾å½¢å­¦ã€æœºå™¨å­¦ä¹ ã€‚QQï¼š234707482</description>
    <link>http://localhost:4000</link>
    <atom:link href="http://localhost:4000/feed.xml" rel="self" type="application/rss+xml" />
    
      <item>
        <title>æ— æŸå‹ç¼©ç®—æ³•ï¼šdeflate</title>
        <description>&lt;p&gt;æœ¬æ–‡ç›®æ ‡æ˜¯ææ¸…æ¥šzlibåº“çš„deflateç®—æ³•å®ç°ã€‚&lt;/p&gt;

&lt;!--more--&gt;

&lt;h2&gt;åè¯è§£é‡Š&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/DEFLATE&quot;&gt;deflate&lt;/a&gt;ï¼šæœ€å¸¸è§çš„æ— æŸå‹ç¼©ç®—æ³•ï¼Œéå¸¸å…³é”®ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Zip_(file_format)&quot;&gt;.zip&lt;/a&gt;ï¼šarchive formatï¼Œä½¿ç”¨äº†deflateå‹ç¼©ç®—æ³•&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Gzip&quot;&gt;.gz&lt;/a&gt;(æˆ–gzipæ ¼å¼ï¼‰: single file compress formatï¼Œä¹Ÿæ˜¯ä½¿ç”¨äº†deflateå‹ç¼©ç®—æ³•&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Tar_(computing)&quot;&gt;.tar.gz&lt;/a&gt;æˆ–.tgzï¼šarchive formatï¼Œå¯è®¤ä¸º.gzæ–‡ä»¶çš„é›†åˆï¼Œä½†åˆä¸æ­¢æ˜¯å¤šä¸ª.gzçš„é›†åˆï¼Œå› ä¸ºtgzåˆ©ç”¨äº†æ–‡ä»¶ä¹‹é—´çš„å…³è”ä¿¡æ¯ï¼Œæå‡äº†å‹ç¼©ç‡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://zlib.net/&quot;&gt;zlib&lt;/a&gt;ï¼šä¸€ä¸ªé€šç”¨åº“ï¼Œåªæœ‰æºä»£ç ï¼Œä¸æä¾›å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ”¯æŒgzipã€‚linuxå†…æ ¸ã€libpngã€gitç­‰ç­‰éƒ½ç”¨äº†å®ƒã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.gnu.org/software/gzip/manual/gzip.html&quot;&gt;gzip&lt;/a&gt;ï¼šGNU Gzipï¼Œå¼€æºï¼Œæä¾›äº†gzipå’Œgunzipå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç›´æ¥å¯ä»¥ç”¨æ¥å‹ç¼©ã€è§£å‹ç¼©ã€‚å†…éƒ¨ä¹Ÿæ˜¯å®ç°äº†deflateç®—æ³•ã€‚&lt;/p&gt;

&lt;p&gt;7-Zipï¼šç±»ä¼¼gzipï¼Œä¹Ÿæ˜¯å·¥å…·ã€‚&lt;/p&gt;

&lt;p&gt;ç»è¿‡äº†è§£ï¼Œgzipçš„æºç ç›¸å¯¹&lt;/p&gt;

&lt;h2&gt;Huffman Coding å’Œ LZ77&lt;/h2&gt;

&lt;h3&gt;LZ77ï¼ˆLempelâ€“Ziv Codingï¼‰&lt;/h3&gt;

&lt;p&gt;LZ77æ˜¯åŸºäº&lt;strong&gt;å­—å…¸&lt;/strong&gt;çš„ç®—æ³•ã€‚æ€è·¯æ˜¯ï¼ŒæŠŠæ•°æ®ä¸­çš„é‡å¤ï¼ˆå†—ä½™ï¼‰éƒ¨åˆ†ï¼Œç”¨æ›´çŸ­çš„metadataå…ƒä¿¡æ¯ä»£æ›¿ã€‚&lt;/p&gt;

&lt;p&gt;wikiï¼š&lt;a href=&quot;https://en.wikipedia.org/wiki/LZ77_and_LZ78#LZ77&quot;&gt;LZ77 and LZ78&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;æ ¹æ®wikiæ‰€è¯´ï¼Œä½œè€…æ˜¯å‘æ˜äº†2ä¸ªç®—æ³•LZ77å’ŒLZ78ã€‚è¿™2ä¸ªç®—æ³•æ˜¯å…¶ä»–LZç®—æ³•å˜ç§çš„åŸºç¡€ï¼ˆLZWã€LZSSã€LZMAï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢é‡ç‚¹ä»‹ç»LZ77ã€‚&lt;/p&gt;

&lt;h4&gt;LZ77å…³é”®è¯ï¼š&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;input streamï¼šå¾…å‹ç¼©çš„å­—èŠ‚åºåˆ—ä¸²&lt;/li&gt;
&lt;li&gt;byteï¼šå­—èŠ‚ï¼Œæ˜¯input streamçš„åŸºæœ¬å…ƒç´ &lt;/li&gt;
&lt;li&gt;coding positionï¼šç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰ç¼–ç ä½ç½®ï¼›ä¹Ÿæ˜¯lookahead bufferçš„èµ·å§‹ä½ç½®&lt;/li&gt;
&lt;li&gt;lookahead bufferï¼šå°±æ˜¯æŒ‡coding positionä¸ºèµ·ç‚¹ï¼Œinput streamæœ«ç«¯ä¸ºç»ˆç‚¹çš„è¿™æ®µå­—èŠ‚åºåˆ—&lt;/li&gt;
&lt;li&gt;windowï¼šæœ€å¤§é•¿åº¦ä¸ºWçš„æ»‘åŠ¨çª—å£ï¼Œä¹Ÿæ˜¯ä»¥coding positionä¸ºèµ·ç‚¹ï¼Œä½†æ˜¯çª—å£æ–¹å‘æ˜¯&lt;strong&gt;åå‘å¾€å·¦&lt;/strong&gt;ï¼›çª—å£åˆå§‹é•¿åº¦ä¸º0ï¼Œéšç€ç¼–ç çš„è¿›è¡Œï¼Œé•¿åº¦ä¼šå¢é•¿åˆ°Wï¼Œç„¶åå°±å¼€å§‹å¾€å³æ»‘åŠ¨&lt;/li&gt;
&lt;li&gt;matchï¼šå½“å‰åŒ¹é…ä¸²&lt;/li&gt;
&lt;li&gt;pointerï¼šå½“å‰åŒ¹é…ä¸²çš„ä¿¡æ¯ï¼Œä¸€èˆ¬ç”¨ï¼ˆBï¼ŒLï¼‰è¡¨ç¤ºï¼ŒBè¡¨ç¤ºGo &lt;strong&gt;B&lt;/strong&gt;ackå¤šå°‘ä¸ªå­—èŠ‚ï¼ˆä»coding positionå¾€å·¦ï¼‰ï¼Œå› ä¸ºä¹Ÿå«starting offsetï¼›LæŒ‡åŒ¹é…ä¸²ä»starting offsetå¾€å³å»¶ä¼¸çš„é•¿åº¦ã€‚ pointerä¸ºï¼ˆ0ï¼Œ0ï¼‰æ—¶ï¼Œè¡¨ç¤ºåŒ¹é…å¤±è´¥ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h4&gt;LZ77è¦æ³¨æ„çš„ç‚¹ï¼š&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;pointerçš„Læ˜¯å¯èƒ½æ¯”Bè¿˜å¤§çš„ï¼Œå³åŒ¹é…ä¸²ä»windowåŒºåŸŸï¼Œå»¶ä¼¸è¿›äº†lookahead bufferåŒºåŸŸï¼Œåˆå› ä¸ºåŒ¹é…ä¸²çš„èµ·ç‚¹å°±æ˜¯lookahead bufferçš„èµ·ç‚¹ï¼Œæ‰€ä»¥æ­¤æ—¶å‡ºç°äº†&lt;strong&gt;repeat&lt;/strong&gt;ç°è±¡ã€‚è¿™ä¸ªrepeatæ˜¯æ²¡é—®é¢˜çš„ï¼Œç”šè‡³æ˜¯æœ‰ç”¨çš„ï¼Œå¯ä»¥å¯¹ä¸æ–­é‡å¤çš„æ•°æ®å¤§å¤§å‹ç¼©ã€‚&lt;/li&gt;
&lt;li&gt;pointeræœ‰åŒ¹é…æˆåŠŸå’ŒåŒ¹é…å¤±è´¥2ç§æƒ…å†µï¼Œæ‰€ä»¥æŠŠpointerä¿¡æ¯è¾“å‡ºæ—¶ï¼Œè¿˜å¾—åœ¨pointerå‰ç”¨ä¸€ä¸ªbitè¡¨ç¤ºæ˜¯å“ªç§pointerã€‚&lt;/li&gt;
&lt;li&gt;pointeré‡Œ2ä¸ªä¿¡æ¯ï¼šBå’ŒLï¼Œå®ƒä»¬çš„ä½æ•°ä¸€èˆ¬æ˜¯å›ºå®šçš„ã€‚ä½æ•°å¤§å°å¯ä»¥æ˜¯ä»»æ„çš„N bitsï¼Œä½†æ˜¾ç„¶ï¼Œä½æ•°å¤ªå°‘çš„è¯ï¼Œè¯´æ˜æœ€å¤§åŒ¹é…é•¿åº¦å°±å—é™ï¼Œå³å¯¹äºè¶…é•¿ä¸²æ˜¯æ— æ³•é«˜åº¦å‹ç¼©çš„ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é‡ç‚¹&lt;/strong&gt;ï¼šæœ‰çš„æ–‡ç« ä¼šæŠŠpointerè¡¨ç¤ºæˆï¼ˆBï¼ŒLï¼ŒCï¼‰ã€‚Cå°±æ˜¯ä¸€ä¸ªbyteæ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºä»»æ„ä¸€ä¸ªbyteç¬¬ä¸€æ¬¡å‡ºç°æ—¶ï¼Œè‚¯å®šæ˜¯æ‰¾ä¸åˆ°åŒ¹é…ä¸²çš„ï¼Œæ‰€ä»¥ä¼šè¾“å‡ºï¼ˆ0ï¼Œ0ï¼Œbyteï¼‰ï¼›å¹¶ä¸”ï¼Œä¸ºäº†è¾“å‡ºç¼“å†²åŒºçš„ç»“æ„ä¸€è‡´æ€§ï¼Œå½“åŒ¹é…æˆåŠŸæ—¶ï¼Œä¹Ÿå¾—è¾“å‡ºï¼ˆBï¼ŒLï¼ŒCï¼‰ï¼ŒCç›¸å½“äºä¸€ä¸ªç©ºçš„å ä½ç¬¦ï¼Œæœ‰ç‚¹æµªè´¹ï¼Œæ‰€ä»¥æœ‰çš„LZ77ç®—æ³•ä¼šå†æˆåŠŸåŒ¹é…åï¼ŒæŠŠä¸‹ä¸€ä¸ªbyteå­˜åˆ°å ä½ç¬¦é‡Œï¼Œå› æ­¤encoding positionè¦ç§»åŠ¨L+1ã€‚ï¼ˆæ³¨æ„ä¸‹æ–‡è®²è§£çš„å®ä¾‹å ä½ç¬¦æ˜¯ç•™ç©ºçš„ï¼‰&lt;/li&gt;
&lt;li&gt;Bå’ŒLè€—ç”¨çš„ä½æ•°ä¸éœ€è¦ä¸€æ ·ã€‚&lt;/li&gt;
&lt;li&gt;æ—¢ç„¶å›ºå®šäº†Bå’ŒLçš„ä½æ•°å¤§å°ï¼Œé‚£ä¹ˆæœ€å¤§çª—å£å¤§å°Wä¹Ÿæ˜¯å¯ä»¥å›ºå®šçš„ï¼Œä¾‹å¦‚å½“Wä¸º32KBæ—¶ï¼Œé‚£ä¹ˆ15 bitså°±å¯ä»¥è¡¨è¾¾32KBçš„ä»»æ„ä¸€ä¸ªå€¼ã€‚&lt;/li&gt;
&lt;li&gt;windowçš„æœ€å¤§é•¿åº¦Wå½±å“åˆ°å‹ç¼©æ¯”ç‡å’Œå‹ç¼©æ•ˆç‡ã€‚æ˜¾ç„¶Wè¶Šå¤§ï¼ŒåŒ¹é…å¾—è¶Šå……åˆ†ï¼Œä½†ä¹Ÿè¶Šæ…¢ã€‚&lt;/li&gt;
&lt;li&gt;éœ€è¦å®šä¸€ä¸ª&lt;strong&gt;æœ€å°åŒ¹é…é•¿åº¦&lt;/strong&gt;ï¼Œåªæœ‰å½“å½“å‰åŒ¹é…ä¸²å¤§äºæœ€å°åŒ¹é…é•¿åº¦æ—¶ï¼Œè¿™ä¸ªåŒ¹é…æ‰æˆç«‹ã€‚ä¾‹å¦‚Bç”¨15ä½ï¼ŒLç”¨8ä½ï¼Œå·®ä¸å¤šå°±ç”¨äº†3ä¸ªå­—èŠ‚ï¼Œå¦‚æœå½“å‰åŒ¹é…ä¸²ä¸è¶³3ä¸ªå­—èŠ‚ï¼Œä¾‹å¦‚1ä¸ªå­—èŠ‚ï¼Œé‚£å°±å¯¼è‡´encodingåé•¿åº¦åè€Œæ›´é•¿äº†ã€‚&lt;/li&gt;
&lt;li&gt;æ˜¾ç„¶LZ77çš„compressåšçš„å·¥ä½œé‡è¦æ¯”decompresså¤šå¾—å¤šï¼Œå› ä¸ºåšäº†å¤§é‡çš„åŒ¹é…æŸ¥æ‰¾ã€‚æ‰€ä»¥LZ77ç‰¹åˆ«é€‚åˆäº&lt;strong&gt;ä¸€æ¬¡å‹ç¼©ï¼Œå¤šæ¬¡è§£å‹ç¼©&lt;/strong&gt;çš„æƒ…æ™¯ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h4&gt;å®ä¾‹ï¼š&lt;/h4&gt;

&lt;p&gt;è¿™ç§ç®—æ³•ç”¨å®ä¾‹æ¥ç†è§£æ˜¯æœ€å¿«çš„ã€‚å¾®è½¯&lt;a href=&quot;https://msdn.microsoft.com/en-us/library/ee916854.aspx&quot;&gt;è¿™ç¯‡æ–‡ç« &lt;/a&gt;å°±ç»™å‡ºäº†ä¸€ä¸ªä¾‹å­ï¼Œè¿™é‡Œæ‹¿æ¥ç”¨ä¸€ä¸‹ã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆ&lt;a href=&quot;https://www.cnblogs.com/junyuhuang/p/4138376.html&quot;&gt;å¦å¤–è¿™ç¯‡æ–‡ç« &lt;/a&gt;ç»™å‡ºäº†è¿™ä¸ªä¾‹å­çš„ç¤ºæ„å›¾ï¼Œå»ºè®®åŒæ—¶å‚ç…§ä¸‹ï¼Œæœ¬æ–‡å°±ä¸åšå›¾äº†ï¼‰&lt;/p&gt;

&lt;p&gt;å¾…å‹ç¼©å­—èŠ‚ä¸²ï¼ˆæµï¼‰ï¼šAABCBBABC&lt;/p&gt;

&lt;p&gt;å­—èŠ‚ä¸²ä¸­æ¯ä¸ªå­—èŠ‚è®°ä¸€ä¸ªä½ç½®æ ‡è®°positionï¼ˆä¸Šé¢çš„encoding positionä¹Ÿæ˜¯æŒ‡è¿™ä¸ªï¼‰ï¼Œä»1å¼€å§‹æ•°ï¼Œä¸æ˜¯ä»0å“¦ï¼š&lt;/p&gt;

&lt;pre&gt;

Position    1    2    3    4    5    6    7    8    9

Byte        A    A    B    C    B    B    A    B    C

&lt;/pre&gt;

&lt;p&gt;å¼€å§‹LZ77ç¼–ç ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.4/1.png&quot; alt=&quot;1.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;LZ77ç¼–ç åï¼Œå°±è¾“å‡ºäº†æœ€å³è¾¹ä¸€åˆ—ï¼Œæ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯æ–¹ä¾¿ç†è§£ï¼Œå®é™…ä¸Šä¸ä¼šå­˜æˆæ–‡æœ¬å½¢å¼ï¼Œæ²¡æœ‰ï¼ˆ ï¼‰ï¼Œè¿™äº›å­—ç¬¦ã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œé‡ç‚¹è¦ææ‡‚outputè¿™ä¸€åˆ—æ˜¯æ€ä¹ˆæ¥çš„ï¼Œç”¨äººè¯æ¥æè¿°ä¸‹ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;åˆå§‹æ—¶ï¼Œæ»‘åŠ¨çª—å£windowæ˜¯ç©ºçš„ï¼šã€ã€‘&lt;/li&gt;
&lt;li&gt;ç¬¬1æ¬¡é‡åˆ°Aï¼Œç„¶ååœ¨windowé‡Œmatchä¸€ä¸‹ï¼Œå¿…ç„¶æ‰¾ä¸åˆ°Aï¼Œmatchå¤±è´¥ï¼Œäºæ˜¯è¾“å‡º(0,0)Aã€‚windowæ›´æ–°ä¸ºã€Aã€‘&lt;/li&gt;
&lt;li&gt;ç¬¬2æ¬¡é‡åˆ°Aï¼Œwindowé‡Œmatchä¸€ä¸‹ï¼Œæ­¤æ—¶è¦æ³¨æ„ï¼Œmatchçš„æ–¹å‘æ˜¯å³åˆ°å·¦ï¼ˆåå‘ï¼‰ã€‚åœ¨windowå³èµ·ç¬¬1ä¸ªä½ç½®å°±æ‰¾åˆ°äº†Aï¼Œæ‰€ä»¥è¾“å‡º(1, 1)ï¼Œwindowæ›´æ–°ä¸ºã€AAã€‘&lt;/li&gt;
&lt;li&gt;ç¬¬1æ¬¡é‡åˆ°Bï¼ŒåŒæ­¥éª¤1ï¼Œè¾“å‡º(0,0)Bï¼Œwindowæ›´æ–°ä¸ºã€AABã€‘&lt;/li&gt;
&lt;li&gt;åŒæ­¥éª¤3ï¼Œè¾“å‡º(0,0)Cï¼Œwindowæ›´æ–°ä¸ºã€AABCã€‘&lt;/li&gt;
&lt;li&gt;ç¬¬2æ¬¡é‡åˆ°Bï¼Œåœ¨windowç¬¬2ä¸ªä½ç½®æ‰¾åˆ°Bï¼Œäºæ˜¯starting positionä¸º2ï¼ŒåŒæ—¶å‘ç°ä¸‹ä¸€ä¸ªå­—èŠ‚ä¸åŒ¹é…ï¼ˆå·¦Cå’Œå³Bï¼‰ï¼Œæ‰€ä»¥é•¿åº¦ä¸º1ï¼Œè¾“å‡ºï¼ˆ2ï¼Œ1ï¼‰ï¼Œwindowæ›´æ–°ä¸ºã€AABCBã€‘&lt;/li&gt;
&lt;li&gt;ç¬¬3æ¬¡é‡åˆ°Bï¼Œåœ¨windowç¬¬1ä¸ªä½ç½®å°±æ‰¾åˆ°Bï¼ŒåŒæ—¶å‘ç°ä¸‹ä¸€ä¸ªå­—èŠ‚ä¸åŒ¹é…ï¼ˆå·¦Bå’Œå³Cï¼‰ï¼Œæ‰€ä»¥é•¿åº¦ä¸º1ï¼Œè¾“å‡ºï¼ˆ1ï¼Œ1ï¼‰ï¼Œwindowæ›´æ–°ä¸ºã€AABCBBã€‘&lt;/li&gt;
&lt;li&gt;ç¬¬3æ¬¡é‡åˆ°Aï¼Œåœ¨windowç¬¬5ä¸ªä½ç½®æ‰¾åˆ°Aï¼Œç„¶åè¿­ä»£åŒ¹é…ï¼Œå‘ç°åé¢çš„BCä¹ŸåŒ¹é…ä¸Šï¼Œæ‰€ä»¥é•¿åº¦ä¸º3ï¼Œè¾“å‡ºï¼ˆ5ï¼Œ3ï¼‰ï¼Œwindowæ›´æ–°ä¸ºã€AABCBBABCã€‘&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ¥ä¸‹æ¥ï¼Œçœ‹çœ‹å¦‚ä½•æŠŠè¿™ä¸€åˆ—outputå†è§£ç å›åŸæ–‡ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.4/2.png&quot; alt=&quot;2.png&quot;&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;è¾“å…¥(0,0)Aï¼Œè¡¨ç¤ºç›´æ¥å¾€è¾“å‡ºç¼“å†²åŒºpushä¸€ä¸ªAå­—ç¬¦ã€‚ ã€Aã€‘&lt;/li&gt;
&lt;li&gt;è¾“å…¥(1,1)ï¼Œåªæœ‰metaä¿¡æ¯ï¼Œ(1,1)æ„æ€æ˜¯å®ƒçš„ä½ç½®ç­‰äº1ï¼Œé•¿åº¦ä¸º1ï¼Œ&lt;strong&gt;æ³¨æ„ï¼Œä½ç½®æ˜¯åå‘æ•°ï¼Œé•¿åº¦æ˜¯æ­£å‘æ•°&lt;/strong&gt;ã€‚æ˜¾ç„¶ï¼Œ(1,1)ç­‰äºç¼“å†²åŒºçš„å­—ç¬¦Aï¼Œäºæ˜¯pushäº†ä¸€ä¸ªä¸€æ ·çš„Aã€‚ã€AAã€‘&lt;/li&gt;
&lt;li&gt;(0,0)Bï¼Œå’Œæ­¥éª¤1ä¸€æ ·ï¼Œç›´æ¥pushä¸€ä¸ªBã€‚ã€AABã€‘&lt;/li&gt;
&lt;li&gt;(0,0)Cï¼ŒåŒä¸Šã€‚ã€AABCã€‘&lt;/li&gt;
&lt;li&gt;(2,1)ï¼Œåˆæ˜¯metaä¿¡æ¯ï¼Œä½ç½®ä¸º2ï¼Œé•¿åº¦ä¸º1ï¼Œå€’ç€æ•°å½“å‰ç¼“å†²åŒºï¼Œå‘ç°èµ·ç‚¹æ˜¯Bå­—ç¬¦ï¼Œé•¿åº¦ä¸º1ï¼Œæ‰€ä»¥pushä¸€ä¸ªBã€‚ã€AABCBã€‘&lt;/li&gt;
&lt;li&gt;(1,1)ï¼Œå‚è€ƒæ­¥éª¤5ï¼Œä¹Ÿæ˜¯pushä¸€ä¸ªBã€‚ã€AABCBBã€‘&lt;/li&gt;
&lt;li&gt;(5,3)ï¼Œé•¿åº¦ç»ˆäºä¸ä¸º1äº†ï¼Œé¦–å…ˆåœ¨ç¼“å†²åŒºå€’ç€æ•°5ä¸‹ï¼Œå‘ç°æ˜¯å·¦èµ·ç¬¬äºŒä¸ªAï¼Œç„¶åé•¿åº¦3ï¼Œäºæ˜¯å¾€å³å†è·å–2ä¸ªå­—ç¬¦ï¼Œå¾—åˆ°ABCï¼Œpushåˆ°ç¼“å†²åŒºï¼Œå¾—åˆ°ã€AABCBBABCã€‘&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;ä¸Šé¢çš„å†…å®¹æå¾—æ‡‚çš„è¯ï¼Œå°±å·®ä¸å¤šäº†ï¼Œè¦ç»§ç»­æ·±å…¥å°±æ˜¯çœ‹æºç ã€‚ä½†ä¸æ€¥ï¼Œå…ˆçœ‹å®ŒHuffman Codingã€‚&lt;/p&gt;

&lt;h3&gt;Huffman Coding&lt;/h3&gt;

&lt;h2&gt;zlib å’Œ deflate&lt;/h2&gt;

&lt;h3&gt;zlib&lt;/h3&gt;

&lt;h3&gt;deflate&lt;/h3&gt;

&lt;p&gt;å…ˆåšLZ77ï¼Œå†åšHuffmanï¼Œ&lt;/p&gt;

&lt;h2&gt;adler32 å’Œ CRC32&lt;/h2&gt;

&lt;h2&gt;å†å²&lt;/h2&gt;

&lt;p&gt;ä¸€ä½ç­”ä¸»å†™äº†å‹ç¼©ç®—æ³•çš„æ¼”å˜å²ï¼Œå¾ˆå€¼å¾—ä¸€çœ‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/20762094/how-are-zlib-gzip-and-zip-related-what-do-they-have-in-common-and-how-are-they&quot;&gt;https://stackoverflow.com/questions/20762094/how-are-zlib-gzip-and-zip-related-what-do-they-have-in-common-and-how-are-they&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ—©æœŸunixç³»ç»Ÿä¸Šé¢åªæœ‰compressæŒ‡ä»¤ï¼Œcompressä½¿ç”¨äº†ä¸€ä¸ªæœ‰ç‰ˆæƒçš„LZWç®—æ³•ï¼Œä½œè€…Phil Katzå¯¹LZWçš„å…è´¹ä½¿ç”¨æœ‰æ‰€äº‰è®®ã€‚&lt;/p&gt;

&lt;p&gt;å¹¶ä¸”ï¼Œzip formatä¹Ÿæ˜¯è¿™ä¸ªä½œè€…è®¾è®¡çš„ï¼Œä½†åº†å¹¸zip formatæ˜¯æ— ç‰ˆæƒçš„ï¼Œäºæ˜¯å°±æœ‰ä¸ªå«Info-ZIP groupçš„ç»„ç»‡å¼€å‘äº†åŒæ ·å¯ä»¥å‹ç¼©&amp;amp;è§£å‹ç¼©zipçš„ç¨‹åºï¼Œå¼€æºå…è´¹è·¨å¹³å°ï¼Œè¿™ä¸ªä¸œè¥¿å¯¼è‡´zip formatè¢«å¤§èŒƒå›´ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶ååˆ°äº†90å¹´ä»£æ—©æœŸï¼Œå‡ºç°äº†æ–°çš„å‹ç¼©æ ¼å¼ï¼šgzip formatï¼ˆæˆ–.gzï¼‰ä»¥åŠå¯¹åº”çš„ç¨‹åºgzipã€‚gzipçš„ä»£ç ç»§æ‰¿è‡ªInfo-ZIPï¼Œgzipæ˜¯æ‰“ç®—ç”¨æ¥å–ä»£unixçš„compressçš„ã€‚&lt;/p&gt;

&lt;p&gt;gzipå•ä¸ªæ–‡ä»¶æ—¶ï¼Œä¼šç»™è¯¥æ–‡ä»¶åŠ ä¸Š.gzåç¼€ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶ååˆåˆ°äº†90å¹´ä»£ä¸­æœŸï¼Œåˆé‡åˆ°äº†ç‰ˆæƒé—®é¢˜ï¼Œè¿™æ¬¡æ˜¯å…³äºgifæ ¼å¼çš„ï¼Œgifç”¨äº†å¸¦ç‰ˆæƒçš„LZWç®—æ³•ã€‚äºæ˜¯åˆæœ‰äººç«™å‡ºæ¥å¼€å‘äº†æ›¿ä»£å“ï¼špngã€‚è¿™æ˜¯ä¸€ç§æ— æŸå‹ç¼©å›¾ç‰‡çš„æŠ€æœ¯ï¼ŒåŒæ ·ä½¿ç”¨äº†deflateä½œä¸ºå†…éƒ¨æ ¼å¼ã€‚ä¸ºäº†æ‰©å¤§pngçš„ä½¿ç”¨èŒƒå›´ï¼Œå°±å¼„å‡ºäº†libpngå’Œzlibä¸¤ä¸ªç½‘ç«™ã€‚libpngæ˜¯ç”¨æ¥å¤„ç†pngæœ‰å…³çš„æ‰€æœ‰äº‹æƒ…ï¼Œè€Œzlibæ˜¯ä½œä¸ºlibpngèƒŒåçš„æ”¯æ’‘ï¼šæä¾›äº†å‹ç¼©å’Œè§£å‹ç¼©ç®—æ³•ï¼ˆå½“ç„¶ç°åœ¨ä¹Ÿè¢«ç”¨äºåˆ«çš„è½¯ä»¶ï¼‰ã€‚æ³¨æ„ï¼Œzlibçš„ä»£ç ç»§æ‰¿è‡ªgzipã€‚&lt;/p&gt;

&lt;p&gt;å°ç»“2ç‚¹ï¼š&lt;strong&gt;gzipæ˜¯zlibä¹‹çˆ¶ï¼›ä»¥ä¸Šè¯´çš„ç‰ˆæƒé—®é¢˜ç°åœ¨éƒ½å·²è¿‡æœŸäº†&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;p&gt;zlibå…¼å®¹gzipï¼Œä¸”æä¾›äº†æ¯”gzipæ›´å¤šçš„åŠŸèƒ½é€‰é¡¹ã€‚ä¸€æ˜¯wrappingæ¨¡å¼å¯é€‰ï¼šæ— wrappingã€zlib wrappingã€gzip wrappingã€‚æ— wrappingå°±æ˜¯ä»…ä½¿ç”¨deflateå†…éƒ¨æ ¼å¼ï¼›pngä½¿ç”¨çš„å°±æ˜¯zlib wrappingã€‚&lt;/p&gt;

&lt;p&gt;zlib wrappingå’Œgzip wrappingçš„ä¸»è¦åŒºåˆ«æ˜¯ï¼šzlib wrappingæ›´ç´§å‡‘å¹¶ä¸”æ–°å¢äº†Adler-32ç®—æ³•ï¼Œæ¯”gzipç”¨çš„CRC32æ›´å¿«ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥zlibæºç ä¼šæ˜¾å¾—æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å…¼å®¹gzipæ ¼å¼å’ŒCRC32ï¼Œä¸”æ–°å¢äº†zlibæ ¼å¼å’ŒAdler32ï¼›gzipå°±æ˜¾å¾—æ¯”è¾ƒåŸå§‹ï¼Œåªæœ‰deflateå’ŒCRC32ä»£ç ã€‚&lt;/p&gt;

&lt;p&gt;zlibæ˜¯ç›®å‰æœ€å¹¿æ³›ä½¿ç”¨çš„å‹ç¼©åº“ã€‚&lt;/p&gt;

&lt;p&gt;å†åæ¥ï¼Œå°±å‡ºç°äº†æ–°çš„åŸºäºdeflateå‹ç¼©åº“ï¼š7-Zipå’Œgoogleçš„zopfliã€‚zopfliçš„å‹ç¼©ç‡æ¯”zlibçš„æœ€é«˜å‹ç¼©ç‡è¿˜é«˜ï¼Œå‹æ¦¨äº†æœ€åçš„ä¸€äº›ç©ºé—´ï¼Œä½†ä¹ŸèŠ±è´¹äº†æ›´å¤šçš„CPUæ—¶é—´ã€‚å½“ç„¶è¿™ä¸ªæœ€é«˜å‹ç¼©levelæ˜¯å¯é€‰çš„ã€‚æ³¨æ„ï¼Œzopfliåªæä¾›äº†å‹ç¼©åŠŸèƒ½ï¼Œè§£å‹ç¼©ä¾ç„¶å¾—ç”¨zlibæˆ–gzipï¼ˆå¤§æ¦‚æ˜¯å› ä¸ºè§£å‹ç¼©æœ¬æ¥å°±è¶³å¤Ÿä¼˜ç§€äº†ï¼‰ï¼›zopfliè™½ç„¶æœ‰3-8%çš„å‹ç¼©ç‡æå‡ï¼Œä½†è€—æ—¶å¢é•¿å¾—æ›´å‰å®³ï¼Œè§‰å¾—zopfliè¿˜æ˜¯æ˜¾å¾—é¸¡è‚‹ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šè¯´çš„éƒ½æ˜¯åŸºäºdeflateç®—æ³•çš„å‹ç¼©åº“ã€‚å®é™…ä¸Šè¿˜å­˜åœ¨åˆ«çš„ç®—æ³•ï¼šbzip2ã€LZMAç­‰ï¼Œä»–ä»¬æœ‰çš„ç”šè‡³æ˜¯å®Œèƒœdeflateã€‚ä½†å¾ˆå¯æƒœï¼Œåœ¨äº’è”ç½‘ä¸­è¦æ›´æ›¿ä¸€ç§æ ‡å‡†æ˜¯éå¸¸å›°éš¾çš„ã€‚deflateå·²ç»å¹¿æ³›è¿ç”¨åˆ°webçš„æ–¹æ–¹é¢é¢ï¼Œéš¾ä»¥å–ä»£ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥è¿˜æ˜¯å­¦ä¹ deflateå…ˆå§ã€‚å¹¶ä¸”ï¼Œé˜…è¯»zlibåº“æœ€ä½³ã€‚&lt;/p&gt;

&lt;h2&gt;èµ„æ–™&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc1951&quot;&gt;RFC1951 : DEFLATE Compressed Data Format Specification version 1.3&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://qianwenjie.net/?p=17&quot;&gt;http://qianwenjie.net/?p=17&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://marknelson.us/1997/01/01/zlib-engine/&quot;&gt;http://marknelson.us/1997/01/01/zlib-engine/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.zlib.net/feldspar.html&quot;&gt;http://www.zlib.net/feldspar.html&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Mon, 02 Apr 2018 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/zlib-1/</link>
        <guid isPermaLink="true">http://localhost:4000/zlib-1/</guid>
      </item>
    
      <item>
        <title>å¤šçº¿ç¨‹ç½‘ç»œåº“å¼€å‘ç¬”è®°</title>
        <description>&lt;!--more--&gt;

&lt;h2&gt;wait-free V.S. lock-free&lt;/h2&gt;

&lt;p&gt;åœ¨wikiä¸Šè¿™2ä¸ªä¸œè¥¿éƒ½æ˜¯æŒ‡&lt;a href=&quot;https://en.wikipedia.org/wiki/Non-blocking_algorithm&quot;&gt;Non-blocking algorithm&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h3&gt;éé˜»å¡&lt;/h3&gt;

&lt;p&gt;ä¸€ä¸ªç®—æ³•è¢«ç§°ä½œéé˜»å¡çš„å‰ææ˜¯ï¼šçº¿ç¨‹çš„å¤±è´¥æˆ–æŒ‚èµ·ï¼ˆfailure or suspensionï¼‰ï¼Œä¸ä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹çš„å¤±è´¥æˆ–æŒ‚èµ·ã€‚&lt;/p&gt;

&lt;h3&gt;lock-freeï¼š&lt;/h3&gt;

&lt;p&gt;åœ¨ç³»ç»Ÿçº§åˆ«ä¿è¯è¯¥ç³»ç»Ÿï¼ˆå³ç”¨æˆ·ç¨‹åºï¼‰æ€»æ˜¯æœ‰è¿›å±•çš„ï¼ˆprogressï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœè¯¥ç³»ç»Ÿçš„æ‰€æœ‰çº¿ç¨‹è¿è¡Œè¶³å¤Ÿé•¿æ—¶é—´ï¼Œèƒ½ä¿è¯è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹å–å¾—è¿›å±•(make progressï¼‰ï¼Œå°±æ˜¯lock-freeã€‚&lt;/p&gt;

&lt;p&gt;åœ¨lock-freeä¸­ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œå…¶ä»–çº¿ç¨‹ä¾ç„¶èƒ½å–å¾—è¿›å±•ã€‚lock-freeä¼˜ç‚¹åœ¨äºCPUæ˜¯å¯ä»¥ä¸€ç›´ç¹å¿™çš„ï¼Œå½“å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ï¼ŒCPUå¯ä»¥æ¥ç€å¤„ç†åˆ«çš„çº¿ç¨‹ï¼ˆæ²¡æœ‰æ ¸å¿ƒå¤„äºç©ºé—²çŠ¶æ€ï¼‰ï¼Œå› æ­¤å¢åŠ äº†ç³»ç»Ÿçš„ååé‡ã€‚ä½†ä¸è¶³ä¹‹å¤„æ˜¯ï¼Œè¿˜æ˜¯å¯èƒ½å­˜åœ¨ä¸€äº›çº¿ç¨‹æ˜¯è¢«å»¶è¿Ÿå¤„ç†çš„(waiting)ï¼Œä¹Ÿå°±æ„å‘³ç€è¿™äº›çº¿ç¨‹çš„å·¥ä½œæœ‰å»¶æ—¶ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨lock-freeç³»ç»Ÿä¸­ä¼˜åŒ–å»¶æ—¶çš„åŠæ³•æ˜¯ï¼Œå»ºç«‹è°ƒåº¦å™¨ï¼Œç»´æŠ¤ä¸€ä¸ªè¾ƒå¥½çš„å¹³å‡å»¶æ—¶ã€‚&lt;/p&gt;

&lt;h3&gt;wait-freeï¼š&lt;/h3&gt;

&lt;p&gt;å’Œlock-freeçš„åŒºåˆ«æ˜¯ï¼Œwait-freeæ˜¯åœ¨lock-freeçš„å‰æä¸Šï¼Œè¿›ä¸€æ­¥è¦æ±‚è¯¥ç³»ç»Ÿçš„çº¿ç¨‹çš„æ“ä½œåœ¨æœ‰é™æ­¥éª¤å†…èƒ½ä¿è¯å®Œæˆã€‚æ‰€ä»¥wait-freeå¿…ç„¶æ»¡è¶³lock-freeã€‚&lt;/p&gt;

&lt;p&gt;å°±ä¸Šé¢è¯´çš„ååé‡è€Œè¨€ï¼Œwait-freeæ›´ä½³ï¼Œå› ä¸ºä¿è¯äº†æ¯ä¸ªçº¿ç¨‹åªè¦æœ‰æœºä¼šè¢«CPUè½½å…¥æ‰§è¡Œï¼Œå°±æ€»æ˜¯èƒ½åœ¨æœ‰é™æ­¥å†…å®Œæˆï¼Œæ²¡æœ‰ç­‰å¾…å»¶æ—¶ï¼Œno waitingã€‚ä¾‹å¦‚å®æ—¶äº¤æ˜“ç³»ç»Ÿå°±éœ€è¦wait-freeã€‚&lt;/p&gt;

&lt;h3&gt;Q&amp;amp;A&lt;/h3&gt;

&lt;p&gt;Qï¼šä¸ºä»€ä¹ˆlock-freeä¸ç­‰äºwait-freeï¼Ÿ&lt;/p&gt;

&lt;p&gt;Aï¼šå‡è®¾ä¸€ä¸ªæƒ…æ™¯ï¼Œç³»ç»Ÿè¿è¡Œåœ¨næ ¸ç¯å¢ƒï¼Œå¹¶ä¸”æœ‰nä¸ªçº¿ç¨‹åœ¨åšä¸€ä¸ªé•¿æ“ä½œï¼Œå…¶ä¸­æœ‰mä¸ªï¼ˆm&amp;lt;nï¼‰çº¿ç¨‹èƒ½åœ¨æœ‰é™æ­¥å†…å®Œæˆæ“ä½œï¼Œå…¶ä»–çš„n - mçº¿ç¨‹å¯èƒ½ä¼šæ“ä½œå¤±è´¥(fail)å¹¶ä¸€ç›´ä¸æ–­é‡è¯•ï¼ˆretry on failureï¼‰ï¼ˆå¤±è´¥åŸå› å¯èƒ½é‚£nä¸ªçº¿ç¨‹æœ‰å…³ï¼‰ï¼Œn-mçº¿ç¨‹æ˜¯ä¸èƒ½ä¿è¯åœ¨æœ‰é™æ­¥éª¤å†…å®Œæˆæ“ä½œçš„ï¼ˆä¹Ÿå°±æ˜¯éœ€è¦waitï¼‰ï¼Œæ‰€ä»¥è¿™ç§ç³»ç»Ÿå°±åªæ˜¯lock-freeè€Œå·²ã€‚è€Œå¦‚æœæ¢ä½œwait-freeçš„è¯ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½èƒ½ä¿è¯æ“ä½œèƒ½åœ¨æœ‰é™æ­¥ä»¥å†…å®Œæˆï¼Œå¹¶ä¸”æ¯ä¸ªçº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’ç‹¬ç«‹ï¼Œæ²¡æœ‰ä¾èµ–ï¼Œå°±æ˜¯æ— ç­‰å¾…ï¼Œå³wait-freeã€‚&lt;/p&gt;

&lt;p&gt;Qï¼šlock-freeæ˜¯ä¸æ˜¯å°±æ˜¯æ— é”ï¼Ÿ&lt;/p&gt;

&lt;p&gt;Aï¼šç¡®å®æ˜¯è¦æ±‚æ— é”ã€‚å› ä¸ºå¦‚æœç³»ç»Ÿå†…æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†é”ï¼Œç„¶åä¸‡ä¸€çº¿ç¨‹å¼‚å¸¸äº†æ²¡æœ‰é‡Šæ”¾é”ï¼ˆæ— æ³•ä¿è¯progressï¼‰ï¼Œå°±ä¼šå¯¼è‡´ç­‰å¾…è¯¥çº¿ç¨‹çš„å…¶ä»–çº¿ç¨‹æ°¸ä¹…é¥¥é¥¿ã€‚å¦‚æœè¿™ä¸ªé”é‡Šä¸é‡Šæ”¾å¯¹å…¶ä»–çº¿ç¨‹æ— æ‰€è°“ï¼Œé‚£è¿™ä¸ªé”ä¹Ÿæ˜¾ç„¶æ— æ„ä¹‰ã€‚ç»¼ä¸Šï¼Œlock-freeå¿…ç„¶è¦æ±‚æ— é”ã€‚ &lt;/p&gt;

&lt;p&gt;wait-freeä¹Ÿæ˜¯æ— é”ï¼Ÿ&lt;/p&gt;

&lt;p&gt;Aï¼šwait-freeæ˜¯æ¯”lock-freeæ›´è¿›ä¸€æ­¥çš„ä¸œè¥¿ï¼Œå½“ç„¶ä¹Ÿå¾—æ˜¯æ— é”ã€‚&lt;/p&gt;

&lt;h2&gt;ABA problem&lt;/h2&gt;

&lt;h2&gt;æŒ‡ä»¤é‡æ’å’Œthread fence&lt;/h2&gt;

&lt;h3&gt;æŒ‡ä»¤é‡æ’ï¼š&lt;/h3&gt;

&lt;p&gt;ï¼ˆå‚è€ƒèµ„æ–™ï¼š&lt;a href=&quot;http://preshing.com/20120625/memory-ordering-at-compile-time/%EF%BC%89&quot;&gt;http://preshing.com/20120625/memory-ordering-at-compile-time/ï¼‰&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç¼–è¯‘å™¨ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå¯èƒ½ä¼šæŒ‰å’Œc/c++ä»£ç ä¸ä¸€æ ·çš„é¡ºåºé‡æ–°æ’åˆ—æŒ‡ä»¤ã€‚&lt;/p&gt;

&lt;p&gt;æŒ‡ä»¤é‡æ’éœ€è¦æ‰“å¼€ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹ã€‚&lt;/p&gt;

&lt;p&gt;æŒ‡ä»¤é‡æ’ä¿è¯å¯¹å•çº¿ç¨‹ç¨‹åºæ²¡æœ‰å½±å“ã€‚ä½†å¯¹å¤šçº¿ç¨‹ç¨‹åºæ¥è¯´ï¼Œå°±æƒ¨äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¾‹å­ï¼ˆLinux 3.10.0-514.26.2.el7.x86_64ï¼Œgcc 4.8.5ï¼‰ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;A&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;B&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;B&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æ‰§è¡Œ gcc -S -masm=intel test.cï¼Œå¾—åˆ°ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;    mov eax, DWORD PTR B[rip]   // å–å‡ºBå€¼å¹¶å†™å…¥eax
    add eax, 1                  // eax = eax + 1
    mov DWORD PTR A[rip], eax   // æŠŠeaxå†™å…¥A
    mov DWORD PTR B[rip], 0     // B = 0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æ‰§è¡Œ gcc -S -masm=intel -O2 test.cï¼Œå¾—åˆ°ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;    mov eax, DWORD PTR B[rip]   // å–å‡ºBå€¼å¹¶å†™å…¥eax
    mov DWORD PTR B[rip], 0     // B = 0
    add eax, 1                  // eax = eax + 1
    mov DWORD PTR A[rip], eax   // æŠŠeaxå†™å…¥A
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æ˜¾ç„¶ï¼Œä¸¤è€…åŒºåˆ«æ˜¯ç¬¬å››è¡ŒB=0æŒ‡ä»¤è¢«æå‰åˆ°ç¬¬äºŒè¡Œäº†ï¼Œå³B=0å‘ç”Ÿåœ¨å¯¹Açš„èµ‹å€¼ä¹‹å‰ï¼Œå’Œcä»£ç æ˜¯ä¸åŒçš„é¡ºåºã€‚&lt;/p&gt;

&lt;p&gt;å•çº¿ç¨‹ç¨‹åºä¸ä¼šæ„ŸçŸ¥åˆ°è¿™ä¸ªåŒºåˆ«ã€‚ä½†è€ƒè™‘åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå°±å®¹æ˜“å¼•å‘ä¸€äº›é—®é¢˜ã€‚&lt;/p&gt;

&lt;p&gt;ä¸€æ˜¯å½±å“åˆ°äº†lock-freeä»£ç ï¼Œè€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼Œç”¨äº†ä¸€ä¸ªå…±äº«å˜é‡IsPublishedæ¥æ ‡å¿—Valueæ˜¯å¦æœ‰æ•°æ®ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IsPublished&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;sendValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;IsPublished&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;å¦‚æœç¼–è¯‘å™¨é‡æ’äº†æŒ‡ä»¤ï¼Œä½¿å¾—IsPublished=1(Store)å‘ç”Ÿåœ¨Value = x(Store)ä¹‹å‰ã€‚å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™2æ¬¡storeä¹‹é—´æŠ¢å äº†CPUï¼Œå®ƒçœ‹åˆ°IsPublishedä¸º1ï¼Œä½†å…¶å®Valueæ˜¯è¿˜æœªèµ‹å€¼çš„ï¼Œå°±å¼•å‘äº†é”™è¯¯ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœä¸æƒ³å—åˆ°é‡æ’æŒ‡ä»¤çš„å±å®³ï¼Œé‚£å°±å¾—è€ƒè™‘ä½¿ç”¨thread fenceäº†ã€‚&lt;/p&gt;

&lt;h3&gt;memory_orderï¼ˆè®¿å­˜æ¬¡åºï¼‰å’Œthread fence&lt;/h3&gt;

&lt;p&gt;ä¸­æ–‡ï¼š&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://zh.cppreference.com/w/cpp/atomic/memory_order&quot;&gt;http://zh.cppreference.com/w/cpp/atomic/memory_order&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è‹±æ–‡ï¼š&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://en.cppreference.com/w/cpp/atomic/memory_order&quot;&gt;http://en.cppreference.com/w/cpp/atomic/memory_order&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;åˆ†æˆä¸‰å¤§ç±»ï¼š&lt;/p&gt;

&lt;p&gt;ä¸€. é¡ºåºä¸€è‡´æ€§æ¨¡å‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;memory_order_seq_cstï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;äºŒ. relaxæ¨¡å‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;memory_order_relaxedï¼šæ²¡æœ‰é¡ºåºé™åˆ¶ï¼Œä»…ä¿è¯è¯¥æ“ä½œçš„åŸå­æ€§ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸‰. Acquire-Releaseæ¨¡å‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;memory_order_consumeï¼š&lt;/li&gt;
&lt;li&gt;memory_order_acquireï¼š&lt;/li&gt;
&lt;li&gt;memory_order_releaseï¼š&lt;/li&gt;
&lt;li&gt;memory_order_acq_relï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;cache line å’Œ cache line bouncing&lt;/h2&gt;

&lt;h2&gt;little&amp;#39;s law å¾‹ç‰¹å®šå¾‹&lt;/h2&gt;

&lt;h2&gt;consistent hashing ä¸€è‡´æ€§å“ˆå¸Œ&lt;/h2&gt;

&lt;p&gt;å‚è€ƒä»£ç ï¼ˆpythonï¼‰ï¼š&lt;a href=&quot;https://github.com/goller/hashring&quot;&gt;https://github.com/goller/hashring&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å‚è€ƒä»£ç ï¼ˆgoï¼‰ï¼š&lt;a href=&quot;https://godoc.org/stathat.com/c/consistent#example-New&quot;&gt;https://godoc.org/stathat.com/c/consistent#example-New&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ioriiod0/consistent_hash&quot;&gt;https://github.com/ioriiod0/consistent_hash&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 29 Mar 2018 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/wynet-1/</link>
        <guid isPermaLink="true">http://localhost:4000/wynet-1/</guid>
      </item>
    
      <item>
        <title>ã€ŠTCP IPè¯¦è§£å·1ã€‹12-17ç« TCPç¬”è®°</title>
        <description>&lt;!--more--&gt;

&lt;h2&gt;12ç«  TCPåˆæ­¥&lt;/h2&gt;

&lt;p&gt;tcp featuresï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;tcpæœ‰å·®é”™çº æ­£ï¼Œip udp æ²¡æœ‰&lt;/li&gt;
&lt;li&gt;çª—å£ï¼šåˆ†ç»„æ•°é‡çš„å¤§å°é™åˆ¶äº†ç½‘ç»œåˆ©ç”¨ç‡ï¼ˆååé‡ï¼‰&lt;/li&gt;
&lt;li&gt;çª—å£æ»‘åŠ¨ï¼šæ”¶åˆ°ACKæ—¶ï¼Œçª—å£å¯èƒ½ä¼šå‘å³æ»‘åŠ¨&lt;/li&gt;
&lt;li&gt;æµæ§ï¼šåŸºäºå‘é€é€Ÿç‡å’ŒåŸºäºçª—å£&lt;/li&gt;
&lt;li&gt;çª—å£æ›´æ–°(é€šå‘Š)ï¼šæ¥æ”¶æ–¹å‘é€çª—å£é€šå‘Šç»™å‘é€æ–¹ï¼Œä¸€èˆ¬å’Œå’ŒACKä¸€èµ·å‘ï¼Œçª—å£å‘å‹æ»‘åŠ¨çš„æ—¶å€™åŒäº‹å˜æ›´çª—å£å¤§å°&lt;/li&gt;
&lt;li&gt;é€šä¿¡é€Ÿç‡SW/R (bits/s)ï¼šSæ˜¯åˆ†ç»„æ¯”ç‰¹æ€»å¤§å°ï¼ŒWæ˜¯çª—å£å¤§å°ï¼ŒRæ˜¯RTT&lt;/li&gt;
&lt;li&gt;å¦‚æœå‘é€é€Ÿç‡è¶…è¿‡ä¸­é—´è·¯ç”±å™¨çš„èƒ½åŠ›ï¼Œå°±éœ€è¦æ‹¥å¡æ§åˆ¶(congestion control)ï¼Œå¦åˆ™ä¼šè·¯ç”±å™¨ä¸¢åŒ…&lt;/li&gt;
&lt;li&gt;æ˜¾æ€§é€šå‘Šï¼šç”¨åè®®å­—æ®µå‘Šè¯‰å‘é€æ–¹ç½‘ç»œæƒ…å†µ&lt;/li&gt;
&lt;li&gt;éšæ€§é€šå‘Šï¼šæ ¹æ®å…¶ä»–ç½‘ç»œç‰¹å¾è‡ªä¸»å‡æ…¢å‘é€é€Ÿç‡&lt;/li&gt;
&lt;li&gt;ç»„åŒ…(packetization)ï¼šæŠŠä¸€ä¸ªå­—èŠ‚æµè½¬æ¢æˆä¸€ç»„IPå¯ä»¥æºå¸¦çš„åˆ†ç»„&lt;/li&gt;
&lt;li&gt;åˆ†ç»„åºåˆ—å·ï¼šä»£è¡¨äº†æ¯ä¸ªåˆ†ç»„çš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨æ•´ä¸ªæ•°æ®æµä¸­çš„å­—èŠ‚åç§»ï¼Œè€Œä¸æ˜¯åˆ†ç»„å·&lt;/li&gt;
&lt;li&gt;åˆ†ç»„å¤§å°å¯å˜ï¼Œå¹¶å…è®¸åˆ†ç»„é‡æ–°ç»„åˆï¼ˆrepacketization)&lt;/li&gt;
&lt;li&gt;æ ¡éªŒå’Œï¼šæŠ¥æ–‡æ®µæ”¶åˆ°æ—¶å¦‚æœæ£€éªŒå’Œä¸å¯¹ï¼Œä¼šä¸¢å¼ƒåˆ†ç»„&lt;/li&gt;
&lt;li&gt;å·®é”™ä¿æŠ¤ï¼šå‘é€å¤§æ•°æ®æ—¶æ£€éªŒå’Œå¯èƒ½ä¼šå¤±æ•ˆï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±åšæ›´å¼ºå¤§çš„æ ¡éªŒå’Œï¼ˆCRCï¼‰&lt;/li&gt;
&lt;li&gt;ACKï¼šä¸€ä¸ªæŒ‡ç¤ºå­—èŠ‚å·Nçš„ACKæš—ç¤ºäº†æ‰€æœ‰&amp;lt;=Nçš„å­—èŠ‚éƒ½å‘—æˆåŠŸæ¥æ”¶äº†&lt;/li&gt;
&lt;li&gt;è‹¥å‰é¢çš„ACKä¸¢å¤±ï¼Œåç»­çš„ACKä¹Ÿå¯ä»¥ç¡®è®¤å‰é¢çš„åˆ†ç»„ï¼ˆrobustï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä¸å¸¦æ•°æ®çš„åŒ…å¯èƒ½æ²¡æœ‰å¯é æ€§ä¿è¯ï¼Œå¦‚Window Update ACKåŒ…&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;é‡è¦æ€§èƒ½é—®é¢˜ï¼šé‡ä¼ è¶…æ—¶æ—¶é—´&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¾€è¿”æ—¶é—´ä¼°è®¡ï¼ˆRTT estimationï¼‰ï¼šé‡‡æ ·æœ€è¿‘çš„å¤šä¸ªRTTå¹¶å–å¹³å‡&lt;/li&gt;
&lt;li&gt;è¶…æ—¶å¹¶ä¸èƒ½ç­‰äºRTTå‡å€¼ï¼Œå› ä¸ºå¯èƒ½æœ‰å¾ˆå¤šRTTæ˜¯è¶…è¿‡å‡å€¼çš„ï¼Œä»è€Œå¯¼è‡´ä¸æ–­è¶…æ—¶é‡ä¼ &lt;/li&gt;
&lt;li&gt;è¶…æ—¶åº”ç•¥å¤§äºRTTå‡å€¼ï¼Œä½†ä¹Ÿä¸èƒ½è¿‡å¤§ï¼Œå¦åˆ™ç½‘ç»œä¼šå˜å¾—ç©ºé—²&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;tcpå¤´éƒ¨ï¼š&lt;/p&gt;

&lt;p&gt;-2å­—èŠ‚ï¼šæºç«¯å£
-2å­—èŠ‚ï¼šç›®çš„ç«¯å£
-4å­—èŠ‚ï¼šåºåˆ—å·seq
-4å­—èŠ‚ï¼šACK
-4ä½ï¼šå¤´éƒ¨é•¿åº¦
-4ä½ï¼šä¿ç•™
-8ä½ï¼šflags
-2å­—èŠ‚ï¼šçª—å£å¤§å°
-2å­—èŠ‚ï¼šæ ¡éªŒå’Œ
-2å­—èŠ‚ï¼šç´§æ€¥æŒ‡é’ˆ
-40å­—èŠ‚ï¼šé€‰é¡¹&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é•¿åº¦ï¼šé»˜è®¤20å­—èŠ‚ï¼Œå¸¦é€‰é¡¹çš„è¯æœ€å¤š60å­—èŠ‚&lt;/li&gt;
&lt;li&gt;å››å…ƒç»„ï¼šå®¢æˆ·ç«¯ä¸»æœºIP+socketç«¯å£å·ã€æœåŠ¡ç«¯ä¸»æœºIP+socketç«¯å£å·&lt;/li&gt;
&lt;li&gt;SACK: Seletiveåœ°ACKï¼Œè¦æ¯”æ™®é€šACKé«˜æ•ˆï¼Œå› ä¸ºå¯ä»¥å¯¹æ¬¡åºæ‚ä¹±çš„æŠ¥æ–‡å…ˆACKã€‚&lt;/li&gt;
&lt;li&gt;å¤´éƒ¨é•¿åº¦ï¼šè™½ç„¶åªæœ‰4ä½ï¼Œä½†æ˜¯å•ä½æ˜¯wordï¼ˆ32bitsï¼‰ï¼Œæ‰€ä»¥å¯è¡¨ç¤º(2&lt;sup&gt;4&lt;/sup&gt; - 1)* 4bytes = 60å­—èŠ‚çš„å¤´éƒ¨é•¿åº¦ã€‚&lt;/li&gt;
&lt;li&gt;çª—å£å¤§å°ï¼šå­—èŠ‚æ•°ï¼Œæ‰€ä»¥æœ€å¤§çª—å£å¤§å°å­—èŠ‚æ•°ä¸º2&lt;sup&gt;16&lt;/sup&gt; - 1 = 65535å­—èŠ‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¤„ç†å·®é”™çš„åŠæ³•ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å·®é”™çŸ«æ­£ç &lt;/li&gt;
&lt;li&gt;æ•°æ®é‡ä¼ &lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;13ç«  TCPè¿æ¥ç®¡ç†&lt;/h2&gt;

&lt;p&gt;å»ºç«‹è¿æ¥ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Cå‘é€ISN(c)ï¼ˆä¸»åŠ¨æ‰“å¼€ï¼‰&lt;/li&gt;
&lt;li&gt;Sæ”¶åˆ°ISN(c)ï¼Œå‘é€ACK=ISN(c)+1 ã€ ISN(s) ï¼ˆè¢«åŠ¨æ‰“å¼€ï¼‰&lt;/li&gt;
&lt;li&gt;Cæ”¶åˆ°ACKå’ŒISN(s)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ–­å¼€è¿æ¥ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä¸€æ–¹å‘é€FINï¼ˆä¸»åŠ¨å…³é—­è€…ï¼‰ï¼Œè¦å‘é€å½“å‰åºåˆ—å·Kï¼Œä¸”å¸¦æœ‰ä¸€ä¸ªACKï¼ˆåºåˆ—å·Lï¼Œä»£è¡¨æœ€è¿‘ä¸€æ¬¡æ”¶åˆ°çš„æ•°æ®ï¼‰&lt;/li&gt;
&lt;li&gt;å¦ä¸€æ–¹æ”¶åˆ°FINåï¼Œå‘é€ACK=k+1ä½œä¸ºå“åº”ï¼ˆè¢«åŠ¨å…³é—­è€…ï¼‰ï¼ŒåŒæ—¶é€šçŸ¥ä¸Šå±‚åº”ç”¨ç¨‹åº&lt;/li&gt;
&lt;li&gt;å¦ä¸€æ–¹åº”ç”¨ç¨‹åºå‘FINï¼ˆè½¬å˜ä¸ºä¸»åŠ¨å…³é—­è€…ï¼‰ï¼Œåºåˆ—å·ä¸ºL&lt;/li&gt;
&lt;li&gt;ä¸€æ–¹æ”¶åˆ°FINï¼Œå‘ç»™å¦ä¸€æ–¹ACKç¡®è®¤&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸¤æ¬¡åŠå…³é—­ï¼šä¸¤è¾¹éƒ½è¦å‘FINï¼Œæ‰èƒ½å˜æˆå®Œå…¨å…³é—­&lt;/p&gt;

&lt;p&gt;åŠå…³é—­ï¼šcloseã€shutdownåŒæ–¹éƒ½å¯ä»¥è°ƒç”¨ï¼Œcloseæ˜¯å…¨å…³é—­ï¼Œshutdownèƒ½å®ç°åŠå…³é—­&lt;/p&gt;

&lt;p&gt;ISNï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;4å¾®ç§’+1&lt;/li&gt;
&lt;li&gt;ä¼ªé€ åŒ…é—®é¢˜ï¼šåªè¦å››å…ƒç»„ä¸€æ ·ï¼Œå°±èƒ½ä¼ªé€ å‘åŒ…ã€‚ISNéœ€è¦è®¾è®¡æˆéš¾ä»¥è¢«çŒœå‡ºï¼Œæ–¹æ³•æ˜¯ï¼šéšæœºã€æ•£åˆ—ã€åŠ å¯†ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿æ¥å»ºç«‹è¶…æ—¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;syné‡å‘æ¬¡æ•°ï¼šcat /proc/sys/net/ipv4/tcp_syn_retriesï¼ˆæˆ–sysctl net.ipv4.tcp_syn_retriesï¼‰ï¼Œä¸€èˆ¬ç­‰äº6&lt;/li&gt;
&lt;li&gt;synacké‡å‘æ¬¡æ•°ï¼šcat /proc/sys/net/ipv4/tcp_synack_retriesï¼Œä¸€èˆ¬ç­‰äº2&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;MTUï¼š æœ€å¤§ä¼ è¾“å•å…ƒã€‚è·¯å¾„MTUä¸º1500å­—èŠ‚ã€‚ipv4ï¼š1460+40å­—èŠ‚ï¼Œipv6ï¼š1440+60å­—èŠ‚ã€‚&lt;/p&gt;

&lt;h3&gt;é€‰é¡¹ï¼š&lt;/h3&gt;

&lt;p&gt;MSSï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æœ€å¤§æ®µå¤§å°ï¼Œè®°å½•æ•°æ®ï¼ˆä¸åŒ…æ‹¬å¤´éƒ¨ï¼‰é•¿åº¦ï¼Œå 2ä¸ªå­—èŠ‚ã€‚æœ€å°ä¿è¯536å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œä¸€èˆ¬æ˜¯1460å­—èŠ‚&lt;/li&gt;
&lt;li&gt;æœ€å¤§æ®µå¤§å°ä¸æ˜¯åå•†å€¼ï¼Œè€Œæ˜¯é™å®šå€¼ï¼Œ&lt;/li&gt;
&lt;li&gt;65535ç‰¹æ®Šå€¼ï¼Œipv6ç½‘ç»œä¸­è¶…é•¿æ•°æ®æŠ¥ä¼šç”¨åˆ°ã€‚ä½†å®é™…MSSä»å—è·¯å¾„MTUé™åˆ¶ï¼Œæ‰€ä»¥MSSå€¼ä¸ºMTU-(40 IPv6å¤´+20 tcpå¤´ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;SACKï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å‘SYN/SYNACKæ—¶å°±å¾—å‘è¿™ä¸ªSACKå‘Šè¯‰å¯¹æ–¹æ”¯æŒSACKï¼ˆåŒå‘ï¼‰&lt;/li&gt;
&lt;li&gt;å½“æ¥æ”¶åˆ°ä¹±åºçš„æ•°æ®æ—¶ï¼Œå¯å‘å‘é€æ–¹å‘é€SACKé€‰é¡¹&lt;/li&gt;
&lt;li&gt;é•¿åº¦ä¸º8n+2ï¼Œ2ä¸ªå­—èŠ‚ä¸€ä¸ªè¡¨ç¤ºé€‰é¡¹ç§ç±»ä¸€ä¸ªè¡¨ç¤ºnï¼Œnç­‰äºSACKå—æ•°é‡&lt;/li&gt;
&lt;li&gt;SACKå—ï¼šå·²ç»æˆåŠŸæ¥æ”¶çš„åºåˆ—å·èŒƒå›´ï¼ˆåºåˆ—å·32ä½ï¼Œéœ€è¦startå’Œendï¼Œæ‰€ä»¥æ€»å…±è¦8ä¸ªå­—èŠ‚ï¼‰&lt;/li&gt;
&lt;li&gt;æœ€å¤§nä¸º3ï¼ŒSACKæœ€å¤šå 8*3 + 2 = 26å­—èŠ‚ï¼ˆå› ä¸ºä¸€èˆ¬è¿˜æœ‰ä¸ªæ—¶é—´æˆ³ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;çª—å£ç¼©æ”¾é€‰é¡¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å­—èŠ‚ï¼š16bits&lt;/li&gt;
&lt;li&gt;èŒƒå›´ï¼š 0-14ï¼Œ0è¡¨ç¤ºæ²¡æœ‰ç¼©æ”¾ã€‚&lt;/li&gt;
&lt;li&gt;æœ€å¤§çª—å£å¤§å°ï¼š65535 x 2&lt;sup&gt;14&lt;/sup&gt; ï¼Œçº¦1GBã€‚&lt;/li&gt;
&lt;li&gt;tcpç»ˆç«¯å†…éƒ¨ä¼šç»´æŠ¤è¿™ä¸ªçœŸå®çš„çª—å£å¤§å°&lt;/li&gt;
&lt;li&gt;ä¸»åŠ¨æ‰“å¼€è€…å‘WSCALEï¼Œè¢«åŠ¨æ‰“å¼€è€…æ¥æ”¶åˆ°WSCALEæ‰èƒ½åœ¨SYNACKä¸­å‘WSCALE&lt;/li&gt;
&lt;li&gt;å¦‚æœä¸»åŠ¨æ‰“å¼€è€…æ²¡æ¥æ”¶åˆ°è¢«åŠ¨æ‰“å¼€è€…çš„WSCALEï¼Œå°±è®¾ä¸º0&lt;/li&gt;
&lt;li&gt;è‡ªå·±çš„ä¸ºSï¼Œå‘çª—å£å¤§å°ç»™å¯¹æ–¹æ—¶ï¼Œå³ç§»Sä½åå°†16æ•°å€¼å¡«å……åˆ°å¤´éƒ¨&lt;/li&gt;
&lt;li&gt;å¯¹æ–¹çš„ä¸ºRï¼Œæ”¶åˆ°å¯¹æ–¹çš„çª—å£å¤§å°æ—¶ï¼Œå·¦ç§»Rä½æ‰æ˜¯çœŸå®å¤§å°&lt;/li&gt;
&lt;li&gt;ç¼©æ”¾å¤§å°æ˜¯æ ¹æ®æ¥æ”¶ç¼“å­˜çš„å¤§å°è‡ªåŠ¨é€‰å–çš„&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ—¶é—´æˆ³é€‰é¡¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä½œç”¨1ï¼šä¼°ç®—RTT&lt;/li&gt;
&lt;li&gt;ä½œç”¨2ï¼šç”¨æ¥é˜²æ­¢åºåˆ—å·å›ç»•å¯¼è‡´çš„æ—§åŒ…æ— æ³•å»é™¤é—®é¢˜&lt;/li&gt;
&lt;li&gt;TSVï¼šå‘é€æŠ¥æ–‡æ—¶æ”¾è‡ªå·±çš„å½“å‰æ—¶é—´æˆ³ ï¼ˆTimestamp Value)&lt;/li&gt;
&lt;li&gt;TSERï¼šå‘ACKçš„æ—¶å€™æŠŠæœ€æ–°çš„TSVï¼ˆTsRecentï¼‰å¤åˆ¶è¿›å»ï¼ˆTimesatamp Echo Replyï¼‰&lt;/li&gt;
&lt;li&gt;TsRecentå¹¶ä¸æ˜¯æ¥è‡ªæœ€æ–°åˆ°è¾¾çš„æŠ¥æ–‡æ®µï¼Œè€Œæ˜¯æ¥è‡ªæœ€æ—©çš„ä¸€ä¸ªæœªç»ç¡®è®¤çš„æŠ¥æ–‡æ®µ&lt;/li&gt;
&lt;li&gt;RTT = current time - TSER&lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;è·¯å¾„MTUå‘ç°&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;ä¸»è¦æ–¹æ¡ˆæ˜¯ï¼šå‘å¤§åŒ…ï¼Œæ”¶åˆ°PTBï¼ˆpacket too bigï¼‰æ¶ˆæ¯åï¼Œè°ƒæ•´è‡ªå·±MSS&lt;/li&gt;
&lt;li&gt;é»‘æ´é—®é¢˜ï¼šé˜²ç«å¢™å¯¼è‡´æ— æ³•æ”¶åˆ°PTBæ¶ˆæ¯ï¼Œæ— æ³•çŸ¥é“æ˜¯ç½‘ç»œä¸é€šè¿˜æ˜¯åŒ…å¤ªå¤§&lt;/li&gt;
&lt;li&gt;é»‘æ´æ¢æµ‹ï¼šæŠ¥æ–‡é‡ä¼ å¤±è´¥å¤šæ¬¡åï¼Œå°è¯•æ”¹æˆè¾ƒå°æŠ¥æ–‡æ®µï¼ˆåˆ†ç‰‡ï¼‰&lt;/li&gt;
&lt;li&gt;è·¯ç”±æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ‰€ä»¥æ¯10åˆ†é’Ÿè¦å°è¯•ä¸€ä¸ªæ›´å¤§çš„MSSï¼ˆæ¥è¿‘åˆå§‹çš„å‘é€æ–¹MSSï¼‰&lt;/li&gt;
&lt;li&gt;MSSå¤§å°å½±å“ååé‡å’Œçª—å£å¤§å°&lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;TCPçŠ¶æ€è½¬æ¢&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/20.png&quot; alt=&quot;5.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/19.png&quot; alt=&quot;5.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;TIME_WAITï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è®©è¿·é€”çš„æŠ¥æ–‡å¯ä»¥åœ¨ç½‘ç»œä¸­æ¶ˆå¤±&lt;/li&gt;
&lt;li&gt;é˜²æ­¢æ–°è¿æ¥é”™è¯¯æ¥æ”¶æ—§çš„è¿·é€”çš„æŠ¥æ–‡&lt;/li&gt;
&lt;li&gt;ä¸€èˆ¬è¦æŒç»­2ä¸ªMSLï¼ˆ60ç§’ï¼‰&lt;/li&gt;
&lt;li&gt;é™é»˜æ—¶é—´ï¼šå¦‚æœTIME_WAITä¸»æœºå´©æºƒé‡å¯ï¼Œéœ€è¦ç­‰å¾…2MSLåæ‰èƒ½å»ºç«‹æ–°è¿æ¥ï¼ˆä½†ä¸€èˆ¬æ“ä½œç³»ç»Ÿä¸ä¼šè¿™æ ·åšï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;TIME_WAITçŠ¶æ€å…¶å®ä¸åšä»€ä¹ˆäº‹æƒ…ï¼Œå°±æ˜¯é™åˆ¶1åˆ†é’Ÿå†…è¿™æ¡è¿æ¥çš„å…¶ä¸­ä¸€ç«¯ä¸èƒ½å‘èµ·å¯¹å¦ä¸€ç«¯çš„æ–°è¿æ¥ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåªæœ‰ä¸€ç«¯è¿›å…¥TIME_WAITè€Œå¦ä¸€ç«¯å¯ä»¥ç›´æ¥CLOSEDçš„åŸå› ã€‚&lt;/p&gt;

&lt;p&gt;FIN_WAIT_2:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä¸»åŠ¨å…³é—­æ–¹å‘é€finå¹¶æ”¶åˆ°finackå°±è¿›å…¥äº†FIN_WAIT_2&lt;/li&gt;
&lt;li&gt;å¤„äºFIN_WAIT_2æ—¶éœ€è¦ç­‰å¦ä¸€æ–¹å‘é€finï¼ˆæ°¸ä¹…ç­‰å¾…ï¼‰&lt;/li&gt;
&lt;li&gt;closeç³»ç»Ÿè°ƒç”¨ä¼šè‡ªåŠ¨å¯åŠ¨å®šæ—¶å™¨ï¼Œ60ç§’åå¼ºåˆ¶è¿›å…¥CLOSEDçŠ¶æ€&lt;/li&gt;
&lt;li&gt;ç”¨shutdownçš„åŠå…³é—­ä¸ä¼šå¯åŠ¨å®šæ—¶å™¨&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åŒæ—¶æ‰“å¼€åŒæ—¶å…³é—­ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ˜¯å¯ä»¥æ­£ç¡®å¤„ç†çš„ï¼Œå¹¶ä¸”åªä¼šå»ºç«‹ä¸€æ¡è¿æ¥&lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;RSTé‡ç½®æŠ¥æ–‡æ®µ&lt;/h3&gt;

&lt;p&gt;å‘é€æ—¶æœºï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ²¡æœ‰å¯¹åº”çš„ç›‘å¬socketæ—¶&lt;/li&gt;
&lt;li&gt;å¼ºåˆ¶ç»ˆæ­¢è¿æ¥æ—¶ã€‚æ’é˜ŸæŠ¥æ–‡ä¼šè¢«ä¸¢å¼ƒï¼Œå¹¶é©¬ä¸Šå‘RST&lt;/li&gt;
&lt;li&gt;ä¸€ç«¯å´©æºƒé‡å¯ï¼Œæ”¶åˆ°æ­£å¸¸å·¥ä½œï¼ˆåŠå¼€è¿æ¥ï¼‰çš„å¦ä¸€ç«¯çš„æŠ¥æ–‡æ—¶&lt;/li&gt;
&lt;li&gt;TIME_WAITé”™è¯¯æ—¶ï¼ŒTIME_WAITç«¯æ”¶åˆ°è¿·é€”çš„æŠ¥æ–‡å¹¶å‘é€ACKä½†è¢«CLOSEDçš„å¯¹ç«¯RST&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;TIME_WAITé”™è¯¯ï¼šæ˜¯ä¸€ç§éœ€è¦é¿å…çš„é”™è¯¯ï¼ŒTIME_WAITçŠ¶æ€éœ€è¦å¿½ç•¥RSTï¼Œå¦åˆ™å°±ä¼šè¿‡æ—©åœ°è¿›å…¥CLOSED&lt;/p&gt;

&lt;p&gt;å¼ºåˆ¶ç»ˆæ­¢æ–¹æ³•ï¼šSO_LINGERè®¾0ï¼ˆsocketé€—ç•™é€‰é¡¹ï¼‰ï¼Œå«ä¹‰æ˜¯ï¼Œä¸ä¼šä¸ºäº†ç¡®å®šæ•°æ®æ˜¯å¦åˆ°è¾¾å¦ä¸€ç«¯è€Œé€—ç•™ä»»ä½•æ—¶é—´ã€‚&lt;/p&gt;

&lt;p&gt;æ¥æ”¶åˆ°çš„RSTï¼Œå¿…ç„¶è¦å¸¦ACKï¼Œä¸”åºåˆ—å·è¦åœ¨å¯¹ç«¯çª—å£èŒƒå›´å†…ï¼Œå¦åˆ™å¯èƒ½ä¼šé­åˆ°ä¼ªé€ RSTæ”»å‡»ã€‚&lt;/p&gt;

&lt;p&gt;å‘é€RSTï¼Œä¸éœ€è¦ä¸€ä¸ªRSTACKã€‚å¯¹ç«¯æ”¶åˆ°RSTå°±è‡ªç„¶é‡ç½®è¿æ¥äº†ï¼ˆå¯èƒ½å¯¹ç«¯ä¼šä¸¢å¤±RSTï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;UDPæ²¡æœ‰RSTï¼Œä½†æ˜¯æœ‰ICMPç›®çš„åœ°ä¸å¯è¾¾æ¶ˆæ¯&lt;/p&gt;

&lt;h2&gt;14ç«  TCPè¶…æ—¶å’Œé‡ä¼ &lt;/h2&gt;

&lt;p&gt;tcp_retries1ï¼šè¿æ¥å·²ç»å»ºç«‹åï¼ŒåŸºæœ¬é‡ä¼ æ¬¡æ•°ã€‚æ¬¡æ•°è¾¾åˆ°åï¼Œä¼šå…ˆå°è¯•è®©ç½‘ç»œå±‚æ›´æ–°è·¯ç”±å†ç»§ç»­å‘åŒ…ã€‚ä¸€èˆ¬ä¸º3æ¬¡.&lt;/p&gt;

&lt;p&gt;tcp_retries2ï¼šè¿æ¥å·²ç»å»ºç«‹åï¼Œæœ€å¤§é‡ä¼ æ¬¡æ•°ã€‚æ¬¡æ•°è¾¾åˆ°åï¼Œä¼šæ–­å¼€è¿æ¥ã€‚&lt;/p&gt;

&lt;p&gt;é‡ä¼ è¶…æ—¶&amp;lt;RTTï¼šå¯¹ç½‘ç»œå¼•å…¥ä¸å¿…è¦çš„é‡å¤æ•°æ®&lt;/p&gt;

&lt;p&gt;é‡ä¼ è¶…æ—¶&amp;gt;RTTï¼šç½‘ç»œåˆ©ç”¨ç‡(ååé‡)ä¸‹é™&lt;/p&gt;

&lt;p&gt;RTTæ˜¯æ¯ä¸ªtcpè¿æ¥ç‹¬ç«‹è®¡ç®—çš„ã€‚&lt;/p&gt;

&lt;h3&gt;RTOä¼°ç®—æ–¹æ³•ï¼š&lt;/h3&gt;

&lt;p&gt;ç»å…¸æ–¹æ³•ï¼š&lt;/p&gt;

&lt;p&gt;SRTT = a(SRTT) + (1-a)RTTï¼Œaä¸€èˆ¬ä¸º0.8~0.9ï¼Œç§°ä¸ºæŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡/ä½é€šè¿‡æ»¤å™¨ï¼ˆEWMAï¼‰&lt;/p&gt;

&lt;p&gt;RTO = min(ubound, max(lbound, (SRTT)b))ï¼Œbä¸ºæ—¶å»¶ç¦»æ•£å› å­ï¼Œæ¨èå€¼1.3 ï½ 2.0&lt;/p&gt;

&lt;p&gt;uboundï¼š1åˆ†é’Ÿï¼Œlboundï¼š1ç§’ã€‚&lt;/p&gt;

&lt;p&gt;é€‚ç”¨äºç¨³å®šRTTçš„ç½‘ç»œã€‚&lt;/p&gt;

&lt;p&gt;æ ‡å‡†æ–¹æ³•ï¼š&lt;/p&gt;

&lt;p&gt;srtt = (1-g)srtt + (g)M
rttvar = (1-h)rttvar + (h)(|M - srtt|)
RTO = srtt + 4(rttvar)&lt;/p&gt;

&lt;p&gt;Må°±æ˜¯ç»å…¸æ–¹æ³•é‡Œçš„RTTï¼›srttå’ŒSRTTç­‰ä»·ï¼›|M - srtt|ä¸ºå¹³å‡åå·®ï¼Œæ‰€ä»¥rttvarä¸ºå¹³å‡åå·®çš„EWMAã€‚&lt;/p&gt;

&lt;p&gt;gï¼šæ–°æ ·æœ¬Må srttä¼°è®¡å€¼çš„æƒé‡ï¼Œ1/8&lt;/p&gt;

&lt;p&gt;hï¼šæ–°å¹³å‡åå·®æ ·æœ¬|M-srtt|å rttvarçš„æƒé‡ï¼Œ1/4&lt;/p&gt;

&lt;p&gt;æœ€ç»ˆï¼ŒRTOä¸ºsrttåŠ ä¸Š4å€rttvarï¼Œ4æ˜¯ä¸€ä¸ªç ”ç©¶å‡ºæ¥çš„å¸¸é‡å€¼ã€‚&lt;/p&gt;

&lt;p&gt;å½“Må˜åŒ–æ—¶ï¼Œ|M-srtt|è¶Šå¤§ï¼Œrttvarä¹Ÿè¶Šå¤§ï¼ŒRTOå¢é•¿è¶Šå¿«&lt;/p&gt;

&lt;p&gt;æ—¶é’Ÿç²’åº¦ï¼š&lt;/p&gt;

&lt;p&gt;Linuxè®¡æ—¶å™¨æ—¶é’Ÿç²’åº¦ä¸º1msï¼Œè®¾ä¸ºGã€‚&lt;/p&gt;

&lt;p&gt;RTO = srtt + max(Gï¼Œ4(rttvar))&lt;/p&gt;

&lt;p&gt;Linux RTOé»˜è®¤RTOæœ€å°å€¼200ms&lt;/p&gt;

&lt;p&gt;æ”¶åˆ°ç¬¬ä¸€ä¸ªRTTæµ‹é‡å€¼æ—¶å†æ¬¡åˆå§‹åŒ–ï¼š&lt;/p&gt;

&lt;p&gt;srtt = M&lt;/p&gt;

&lt;p&gt;rttvar = M/2&lt;/p&gt;

&lt;p&gt;RTO = srtt + 4(rttvar) = 3M &lt;/p&gt;

&lt;p&gt;é‡ä¼ äºŒä¹‰æ€§ï¼š&lt;/p&gt;

&lt;p&gt;å‘ç”Ÿé‡ä¼ æ—¶ï¼Œè‹¥æ”¶åˆ°ACKï¼Œå¹¶ä¸èƒ½çŸ¥é“æ˜¯å¯¹ç¬¬ä¸€æ¬¡è¿˜æ˜¯ç¬¬äºŒæ¬¡å‘åŒ…çš„ç¡®è®¤ï¼Œæ‰€ä»¥æ— æ³•è®¡ç®—RTTï¼Œéœ€è¦è·³è¿‡ã€‚(Karnç®—æ³•ç¬¬ä¸€éƒ¨åˆ†)&lt;/p&gt;

&lt;p&gt;è‹¥ç”¨äº†æ—¶é—´æˆ³é€‰é¡¹åˆ™å¯ä»¥å¤„ç†äºŒä¹‰æ€§ï¼Œå› ä¸ºACKåŒ…é™„å¸¦äº†å‘åŒ…çš„æ—¶é—´æˆ³ï¼Œå°±å¯ä»¥çŸ¥é“ACKæ˜¯å¯¹ç¬¬ä¸€æ¬¡è¿˜æ˜¯ç¬¬äºŒæ¬¡å‘åŒ…çš„ç¡®è®¤ã€‚&lt;/p&gt;

&lt;p&gt;é€€é¿ç³»æ•°(backoff factor)ï¼šæ¯å½“é‡ä¼ è®¡æ—¶å™¨å‡ºç°è¶…æ—¶ï¼Œé€€é¿ç³»æ•°åŠ å€ï¼Œ&lt;strong&gt;ç›´åˆ°æ¥æ”¶åˆ°éé‡ä¼ æ•°æ®æ—¶é‡è®¾ä¸º1&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;h3&gt;åŸºäºå®šæ—¶å™¨çš„é‡ä¼ ï¼š&lt;/h3&gt;

&lt;p&gt;éœ€è¦è®°å½•è¢«è®¡æ—¶çš„æŠ¥æ–‡æ®µåºåˆ—å·ï¼Œè‹¥åŠæ—¶æ”¶åˆ°è¯¥æŠ¥æ–‡æ®µçš„ACKï¼Œé‚£ä¹ˆè®¡æ—¶å™¨è¢«å–æ¶ˆã€‚&lt;/p&gt;

&lt;p&gt;æ²¡ä¸¢åŒ…çš„è¯è®¡æ—¶å™¨ä¸ä¼šè¶…æ—¶ã€‚&lt;/p&gt;

&lt;p&gt;è‹¥åœ¨è®¾å®šçš„RTOå†…ï¼Œæ²¡æ”¶åˆ°ACKï¼Œå°±ä¼šè§¦å‘è¶…æ—¶é‡ä¼ ã€‚&lt;/p&gt;

&lt;p&gt;æ­¤æ—¶éœ€è¦é™ä½å‘é€é€Ÿç‡ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å‡å°å‘é€çª—å£å¤§å°&lt;/li&gt;
&lt;li&gt;é‡ä¼ å¤§äº1æ¬¡æ—¶ï¼Œå¢å¤§RTOé€€é¿å› å­ï¼ŒRTO = Î³RTOï¼ŒÎ³ = 1 2 4 8 Â·Â·Â· ã€‚ä½†RTOä¸ä¼šTCP_RTO_MAX&lt;/li&gt;
&lt;li&gt;ä¸€æ—¦æ”¶åˆ°ACKï¼ŒÎ³é‡ç½®ä¸º1&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åŸºäºå®šæ—¶å™¨çš„é‡ä¼ ä¸æ˜¯å¥½ä¸œè¥¿ï¼Œä¼šå¯¼è‡´ç½‘ç»œåˆ©ç”¨ç‡ä¸‹é™ã€‚&lt;/p&gt;

&lt;h3&gt;å¿«é€Ÿé‡ä¼ &lt;/h3&gt;

&lt;p&gt;åŸºäºå¯¹ç«¯çš„åé¦ˆä¿¡æ¯æ¥å¼•å‘é‡ä¼ ã€‚ï¼ˆå’ŒåŸºäºè®¡æ—¶å™¨çš„é‡ä¼ çš„æœ¬è´¨åŒºåˆ«ï¼‰&lt;/p&gt;

&lt;p&gt;æ›´åŠ åŠæ—¶ã€‚&lt;/p&gt;

&lt;p&gt;tcpä¸€èˆ¬éƒ½å®ç°äº†åŸºäºè®¡æ—¶å™¨çš„é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ ã€‚&lt;/p&gt;

&lt;p&gt;é‡ç‚¹ï¼šæ¥æ”¶ç«¯æ”¶åˆ°å¤±åºæŠ¥æ–‡æ®µæ—¶ï¼Œéœ€è¦&lt;strong&gt;ç«‹å³&lt;/strong&gt;ç”Ÿæˆ&lt;strong&gt;é‡å¤ACK&lt;/strong&gt;å¹¶&lt;strong&gt;ç«‹å³å‘é€&lt;/strong&gt;ï¼Œå¤±åºæƒ…å†µè¡¨æ˜å‡ºç°äº†ä¸¢æ®µï¼ˆæ¥æ”¶ç¼“å­˜å‡ºç°ç©ºæ´ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;é‡å¤ACKï¼šè¿™ä¸ªACKå¯ä»¥è¡¨æ˜æ˜¯å“ªä¸€ä¸ªåˆ†ç»„æ²¡æœ‰æ”¶åˆ°ã€‚ä½†å› ä¸ºæ˜¯ç”¨äº†tcpçš„seqæ®µï¼Œæ‰€ä»¥ä¸€ä¸ªRTTå†…åªèƒ½å¡«è¡¥ä¸€ä¸ªç©ºç¼ºã€‚&lt;/p&gt;

&lt;p&gt;ç«‹å³å‘é€é‡å¤ACKæ˜¯ä¸ºäº†è®©å‘é€ç«¯å°½æ—©å¾—çŸ¥æœ‰å¤±åºæŠ¥æ–‡æ®µï¼Œå¹¶å‘ŠçŸ¥ç©ºç¼ºåœ¨å“ªã€‚&lt;/p&gt;

&lt;p&gt;å½“æ¥æ”¶ç«¯æ”¶åˆ°&lt;strong&gt;å½“å‰æœŸæœ›åºåˆ—å·çš„åç»­åˆ†ç»„&lt;/strong&gt;æ—¶ï¼Œå½“å‰æœŸæœ›çš„åŒ…å¯èƒ½ä¸¢å¤±äº†ï¼Œä¹Ÿå¯èƒ½æ˜¯å»¶è¿Ÿåˆ°è¾¾ï¼Œ2è€…æ— æ³•åŒºåˆ†ã€‚&lt;/p&gt;

&lt;p&gt;å› æ­¤éœ€è¦ç­‰å¾…ä¸€å®šæ•°ç›®çš„é‡å¤ACKï¼ˆé‡å¤ACKé˜ˆå€¼ dupthreshï¼Œä¸€èˆ¬ä¸º3ï¼Œä¹Ÿæœ‰åŠ¨æ€çš„ï¼‰ï¼Œæ‰èƒ½åˆ¤æ–­æ•°æ®æ˜¯å¦ä¸¢å¤±å¹¶å¿«é€Ÿé‡ä¼ ã€‚&lt;/p&gt;

&lt;p&gt;æ€»ä¹‹ï¼Œå‘é€ç«¯æ”¶åˆ°è‡³å°‘3ä¸ªé‡å¤ACKåï¼Œé©¬ä¸Šé‡ä¼ &lt;strong&gt;å¯èƒ½ä¸¢å¤±çš„åˆ†ç»„&lt;/strong&gt;ï¼Œè€Œä¸å¿…ç­‰è®¡æ—¶å™¨è¶…æ—¶ã€‚&lt;/p&gt;

&lt;h3&gt;å¸¦é€‰æ‹©ç¡®è®¤çš„é‡ä¼ SACK&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;http://packetlife.net/blog/2010/jun/17/tcp-selective-acknowledgments-sack/&quot;&gt;http://packetlife.net/blog/2010/jun/17/tcp-selective-acknowledgments-sack/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;SACKæ˜¯æŒ‡å·²æ¥æ”¶çš„å¤±åºæŠ¥æ–‡æ®µï¼Œå¹¶ä¸æ˜¯æŒ‡ä¸¢å¤±çš„æŠ¥æ–‡æ®µã€‚&lt;/p&gt;

&lt;p&gt;SACKä¼šé‡å¤å‘ï¼Œä¾‹å¦‚æ”¶åˆ°è¿ç»­çš„2ä¸ªæŠ¥æ–‡æ®µ3å’Œ4ï¼Œè¿”å›2ä¸ªACKï¼ŒACKéƒ½ä¸º1ï¼ˆduplicate ACKï¼‰ï¼Œä½†ç¬¬ä¸€ä¸ªåŒ…å¸¦äº†SACK=3ï¼Œç¬¬äºŒä¸ªåŒ…å¸¦äº†SACK=3ã€4ã€‚å‘é€ç«¯æ”¶åˆ°è¿™2ä¸ªACKæ—¶ï¼Œå°±ä¼šçŸ¥é“æŠ¥æ–‡æ®µ2ä¸¢å¤±ï¼Œé‚£ä¹ˆé‡ä¼ 2ã€‚&lt;/p&gt;

&lt;p&gt;ä¸€ä¸ªtcpå¤´çš„SACKæœ€å¤š3å—ã€‚&lt;/p&gt;

&lt;p&gt;æ”¶åˆ°SACKå¹¶é‡ä¼ äº†åŒ…ï¼Œä¹Ÿä¸èƒ½æ¸…ç©ºé‡ä¼ ç¼“å­˜çš„è¯¥åŒ…ï¼ˆé£Ÿè¨€é—®é¢˜ï¼‰ã€‚åªæœ‰æ¥æ”¶ç«¯å‘æ¥çš„æ™®é€štcp ACKå·å¤§äºå‘é€ç«¯æœ€å¤§åºåˆ—å·å€¼æ‰å¯æ¸…é™¤ã€‚&lt;/p&gt;

&lt;p&gt;RTTè¾ƒå¤§ï¼Œä¸¢åŒ…ä¸¥é‡æ—¶ï¼ŒSACKçš„ä¼˜åŠ¿å°±èƒ½ä½“ç°å‡ºæ¥ã€‚å› ä¸ºä¸€ä¸ªRTTå¯ä»¥å¡«è¡¥å¤šä¸ªç©ºç¼ºå¾ˆé‡è¦ã€‚&lt;/p&gt;

&lt;h3&gt;ä¼ªè¶…æ—¶ä¸é‡ä¼ &lt;/h3&gt;

&lt;p&gt;GBNï¼šè¿ç»­å‘äº†nä¸ªæŠ¥æ–‡æ®µï¼Œå¦‚æœç½‘ç»œçªç„¶ç¼“æ…¢ï¼Œæœ€å‰é¢çš„é‚£ä¸ªè¶…æ—¶äº†ï¼Œä¼šè§¦å‘é‡ä¼ ï¼Œæ­¤æ—¶åé¢çš„n-1ä¸ªåŒ…ä¹Ÿæ²¡è¢«ç¡®è®¤ï¼Œé‚£ä¹ˆnä¸ªæŠ¥æ–‡æ®µéƒ½é‡ä¼ ï¼ˆå›é€€ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¼ªé‡ä¼ ï¼šæ²¡æœ‰ä¸¢åŒ…ä¹Ÿå‘ç”Ÿäº†é‡ä¼ ï¼Œå«ä¼ªé‡ä¼ ã€‚åŸå› ï¼šç½‘ç»œå»¶è¿Ÿã€åŒ…å¤±åºã€åŒ…é‡å¤ã€ACKä¸¢å¤±ã€‚&lt;/p&gt;

&lt;p&gt;RTTå¢åŠ ï¼Œè¶…è¿‡å½“å‰RTOæ—¶ï¼Œå°±æœ‰å¯èƒ½å‡ºç°ä¼ªè¶…æ—¶ï¼ˆé‡ä¼ ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;é‡è¦ä»»åŠ¡ï¼šæ£€æµ‹å‡ºä¼ªé‡ä¼ ï¼Œå‡ ç§æ–¹æ³•ï¼šD-SACKã€F-RTOã€Eifelæ£€æµ‹&lt;/p&gt;

&lt;p&gt;D-SACKï¼šé‡å¤SACKï¼Œä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„é€‰é¡¹ã€‚&lt;/p&gt;

&lt;p&gt;å¼€å¯åï¼Œå¯åœ¨ç¬¬ä¸€ä¸ªSACKå—ä¸­å‘ŠçŸ¥æ¥æ”¶ç«¯æ”¶åˆ°çš„é‡å¤æŠ¥æ–‡æ®µåºåˆ—å·ã€‚&lt;/p&gt;

&lt;p&gt;å…è®¸tcpä¸€ç«¯å¼€å¯D-SACKè€Œå¦ä¸€ç«¯æ²¡æœ‰D-SACKï¼Œä¸éœ€è¦å¯¹ç§°ï¼Œæ²¡æœ‰å¼€å¯D-SACKçš„ä¸€ç«¯ä¸èƒ½ä½¿ç”¨D-SACKã€‚&lt;/p&gt;

&lt;p&gt;åŸç†æ˜¯ï¼ŒSACKæ¥æ”¶ç«¯å…è®¸äº†åŒ…å«seq&amp;lt;=ç´¯è®¡ACKçš„SACKå—ã€‚&lt;/p&gt;

&lt;p&gt;å’Œé€šå¸¸çš„SACKçš„åŒºåˆ«ï¼šDSACKåªåŒ…å«åœ¨å•ä¸ªACKä¸­ï¼Œå¹¶ä¸”ä¸ä¼šåœ¨å¤šä¸ªSACKä¸­é‡å¤ã€‚é²æ£’æ€§æ¯”SACKä½ã€‚&lt;/p&gt;

&lt;p&gt;Eifelæ£€æµ‹ç®—æ³•ï¼šå‘ç”Ÿè¶…æ—¶é‡ä¼ æ—¶ï¼ŒEifelç®—æ³•ç­‰å¾…æ¥æ”¶ä¸‹ä¸€ä¸ªACKï¼Œè‹¥ä¸ºé’ˆå¯¹ç¬¬ä¸€æ¬¡ä¼ è¾“ï¼ˆå³åŸå§‹ä¼ è¾“ï¼‰çš„ACKï¼ˆç”¨æ—¶é—´æˆ³åˆ¤æ–­ï¼‰ï¼Œåˆ™å¯ä»¥çŸ¥é“è¯¥é‡ä¼ æ˜¯ä¼ªé‡ä¼ ï¼ˆåˆ©ç”¨TSOPTæ¥æ£€æµ‹ä¼ªé‡ä¼ ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;Forward RTO-recoveryï¼ˆè·¯ç”±è½¬å‘å»¶è¿Ÿå¯¼è‡´çš„RTOçš„æ¢å¤æœºåˆ¶ï¼Œç®€ç§°F-RTOï¼‰ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ£€æµ‹ä¼ªé‡ä¼ çš„æ ‡å‡†ç®—æ³•&lt;/li&gt;
&lt;li&gt;ä¸éœ€è¦ä»»ä½•tcpé€‰é¡¹&lt;/li&gt;
&lt;li&gt;æ˜¯å‘é€ç«¯è‡ªå·±çš„ç®—æ³•&lt;/li&gt;
&lt;li&gt;æ¥æ”¶ç«¯ä¸æ”¯æŒæ—¶é—´æˆ³é€‰é¡¹ï¼Œä¹Ÿèƒ½å·¥ä½œ&lt;/li&gt;
&lt;li&gt;åªæ£€æµ‹ç”±é‡ä¼ è®¡æ—¶å™¨è¶…æ—¶å¼•å‘çš„ä¼ªé‡ä¼ ï¼Œåˆ«çš„æ— æ³•åˆ¤æ–­&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;F-RTOä¼šä¿®æ”¹TCPçš„è¡Œä¸º&lt;/strong&gt;ã€‚å…¶å®å°±æ˜¯GBNçš„é—®é¢˜ã€‚åœ¨è¶…æ—¶é‡ä¼ åæ”¶åˆ°ç¬¬ä¸€ä¸ªACKæ—¶ï¼Œæ”¹æˆå‘é€æ–°æ•°æ®ã€‚ç­‰åˆ°ä¸‹ä¸€ä¸ªACKåˆ°è¾¾æ—¶ï¼Œå¦‚æœ2ä¸ªACKä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯&lt;strong&gt;é‡å¤ACK&lt;/strong&gt;ï¼Œåˆ™è®¤ä¸ºæ­¤æ¬¡é‡ä¼ æ²¡é—®é¢˜ï¼ˆç¡®å®å‘ç”Ÿäº†ä¸¢åŒ…ï¼Œé‡å¤ACKæŒ‡å‡ºäº†ä¸¢å¤±çš„æŠ¥æ–‡æ®µï¼‰ã€‚å¦‚æœ2ä¸ªéƒ½ä¸æ˜¯é‡å¤ACKï¼Œé‚£ä¹ˆå°±æ˜¯ä¼ªé‡ä¼ ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç”¨ä¸Šé¢çš„ä»»æ„æ£€æµ‹ç®—æ³•æ£€æµ‹åˆ°ä¼ªé‡ä¼ åï¼Œè¦åº”ç”¨Eifelå“åº”ç®—æ³•ï¼š&lt;/p&gt;

&lt;p&gt;è¯´ç™½äº†å°±æ˜¯æ›´æ–°srttå’Œrttvarã€‚å› ä¸ºä¼ªè¶…æ—¶å¯¼è‡´ä¸´æ—¶ä¿®æ”¹äº†srttå’Œrttvarï¼ˆRTOå˜äº†ï¼‰ï¼Œæ£€æµ‹å‘ç°ä¼ªè¶…æ—¶ï¼Œé‚£å°±å¾—æ¢å¤åˆ°æ­£å¸¸çš„srttã€rttvarã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;è®¡æ—¶å™¨è¶…æ—¶æ—¶ï¼Œè®°å½•srtt_prev = srtt+2(G)ã€rttvar_prev = rttvarã€‚ä½†ç›´åˆ°å‘ç°æœ‰ä¼ªè¶…æ—¶å‰ï¼Œéƒ½ä¸ä¼šä½¿ç”¨å®ƒä»¬ã€‚&lt;/li&gt;
&lt;li&gt;æ‰§è¡ŒæŸç§ä¼ªè¶…æ—¶æ£€æµ‹ã€‚&lt;/li&gt;
&lt;li&gt;æ£€æµ‹åˆ°ä¼ªè¶…æ—¶ï¼Œè®¾ç½®&lt;strong&gt;ä¼ªæ¢å¤&lt;/strong&gt;ä¸ºSPUR_TOï¼ˆspurious timeout)&lt;/li&gt;
&lt;li&gt;è‹¥ä¼ªæ¢å¤ä¸ºSPUR_TOï¼ŒæŠŠä¸‹ä¸€ä¸ªè¦å‘é€çš„æŠ¥æ–‡æ®µçš„åºåˆ—å·æ”¹ä¸ºæœ€æ–°çš„æœªå‘é€è¿‡çš„æŠ¥æ–‡æ®µã€‚å°±å¯ä»¥é¿å…GBNã€‚&lt;/li&gt;
&lt;li&gt;æ›´æ–°srttã€rttvarã€RTOï¼šsrtt = max(srtt_prevï¼Œm)ï¼Œrttvar = max(rttvar_prev, m/2)ï¼ŒRTO = srtt + max(G, 4(rttvar))ã€‚ä¸ºäº†æŠ›å¼ƒRTTå†å²å€¼ã€‚å¦å¤–ï¼ŒRTOæ›´æ–°æ–¹å¼ä¸å˜ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;h3&gt;åŒ…å¤±åºä¸åŒ…é‡å¤&lt;/h3&gt;

&lt;p&gt;åŒ…çš„é—®é¢˜æœ‰ä¸‰ç§ï¼šä¸¢å¤±ã€å¤±åºã€é‡å¤ã€‚tcpéœ€è¦åŒºåˆ†ã€‚&lt;/p&gt;

&lt;p&gt;å¤±åºï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¦‚æœå‘ç”Ÿåœ¨åå‘é“¾è·¯ï¼ˆACKï¼‰ï¼Œå‘é€ç«¯æ”¶åˆ°çš„ACKæ˜¯ä¹±åºï¼Œé‚£ä¹ˆå¯èƒ½å…ˆæ”¶åˆ°åé¢çš„ACKï¼Œå¯¼è‡´å‘é€çª—å£å¿«é€Ÿå‰ç§»ï¼ˆå¹¶ä¸”åé¢æ”¶åˆ°çš„ACKè¢«ä¸¢å¼ƒï¼‰ã€‚å¿«é€Ÿå‰ç§»ä¼šå¯¼è‡´&lt;strong&gt;æµé‡çªå‘&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å‘ç”Ÿåœ¨æ­£å‘é“¾è·¯ï¼Œtcpå¯èƒ½æ— æ³•æ­£ç¡®è¯†åˆ«å¤±åºorä¸¢åŒ…ã€‚å¤±åºç¨‹åº¦ä¸å¤§æ—¶ï¼Œå¯ä»¥è¿…é€Ÿå¾—åˆ°å¤„ç†ï¼›åä¹‹ï¼Œtcpå¯èƒ½ä¼šè¯¯è®¤ä¸ºæ•°æ®ä¸¢å¤±ï¼Œä¹Ÿå°±å¯¼è‡´ä¼ªé‡ä¼ ï¼ˆä¸»è¦æ˜¯æŒ‡å¿«é€Ÿé‡ä¼ ï¼‰ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åŒºåˆ†ä¸¢å¤±å’Œå¤±åºä¸æ˜¯é‡è¦é—®é¢˜ï¼›äº’è”ç½‘ä¸­ä¸¥é‡çš„å¤±åºå¹¶ä¸å¸¸è§ï¼Œdupthreshè®¾3å°±è¶³å¤Ÿäº†ã€‚&lt;/p&gt;

&lt;p&gt;é‡å¤ï¼š&lt;/p&gt;

&lt;p&gt;é“¾è·¯å±‚é‡ä¼ æ—¶ä¼šç”Ÿæˆé‡å¤å‰¯æœ¬ã€‚ä¼šå¯¼è‡´æ¥æ”¶ç«¯ç”Ÿæˆä¸€ç³»åˆ—é‡å¤çš„ACKï¼Œè§¦å‘ä¼ªå¿«é€Ÿé‡ä¼ ã€‚&lt;/p&gt;

&lt;p&gt;ä½†DSACKèƒ½å¤„ç†è¿™ç§æƒ…å†µï¼Œå› ä¸ºé‡å¤ACKæ²¡æœ‰åŒ…å«å¤±åºä¿¡æ¯ï¼Œæ„å‘³ç€ACKæ˜¯é‡å¤æ•°æ®ã€‚&lt;/p&gt;

&lt;h3&gt;ç›®çš„åº¦é‡&lt;/h3&gt;

&lt;p&gt;å³æ“ä½œç³»ç»Ÿåœ¨tcpæ–­å¼€è¿æ¥åä¾ç„¶ç¼“å­˜äº†è¯¥æ¡è·¯å¾„çš„rttä¹‹ç±»çš„ä¿¡æ¯ã€‚æ–¹ä¾¿ä¸‹æ¬¡å’Œè¯¥åœ°å€å»ºç«‹è¿æ¥æ—¶ï¼Œåˆå§‹åŒ–srtt rttvarã€‚&lt;/p&gt;

&lt;h3&gt;é‡æ–°ç»„åŒ…&lt;/h3&gt;

&lt;p&gt;å½“å‘ç”Ÿé‡ä¼ ï¼Œå¹¶ä¸éœ€è¦å®Œå…¨é‡ä¼ ç›¸åŒçš„æŠ¥æ–‡æ®µï¼Œè€Œå¯ä»¥é‡æ–°ç»„åŒ…ï¼Œå‘é€ä¸€ä¸ªæ›´å¤§çš„æŠ¥æ–‡æ®µæ¥æé«˜æ€§èƒ½ã€‚&lt;/p&gt;

&lt;h3&gt;é‡ä¼ ç›¸å…³çš„æ”»å‡»&lt;/h3&gt;

&lt;p&gt;ä½é€Ÿç‡DoSæ”»å‡»ï¼š&lt;/p&gt;

&lt;p&gt;æ¯æ¬¡å—å®³tcpé‡ä¼ æ—¶ï¼Œå°±å‘ä¸€å †æ•°æ®ç»™å®ƒå¹¶å¯¼è‡´é‡ä¼ è¶…æ—¶ï¼Œè¿›è€Œå¯¼è‡´å¯¹æ–¹å‡å°å‘é€é€Ÿç‡ã€é€€é¿å‘é€ï¼Œæœ€ç»ˆå¯¼è‡´æ— æ³•æ­£å¸¸ä½¿ç”¨ç½‘ç»œå¸¦å®½ã€‚&lt;/p&gt;

&lt;p&gt;é¢„é˜²æ–¹æ³•æ˜¯ï¼Œéšæœºéšé€‰RTOï¼Œä½¿å¾—æ”»å‡»è€…æ— æ³•é¢„çŸ¥ç¡®åˆ‡çš„é‡ä¼ æ—¶é—´ã€‚&lt;/p&gt;

&lt;p&gt;å‡æ…¢å—å®³tcpçš„å‘é€å¹¶ä½¿RTTä¼°è®¡å€¼è¿‡å¤§ï¼ˆè¿‡åˆ†è¢«åŠ¨ï¼‰ï¼š&lt;/p&gt;

&lt;p&gt;å¯¼è‡´ä¸¢åŒ…åä¸ä¼šç«‹å³é‡ä¼ ã€‚&lt;/p&gt;

&lt;p&gt;ä¼ªé€ ACKä½¿å—å®³tcpçš„RTTä¼°è®¡å€¼è¿‡å°ï¼ˆè¿‡åˆ†ç§¯æï¼‰ï¼š&lt;/p&gt;

&lt;p&gt;å¯¼è‡´è¿‡åˆ†å‘é€ï¼Œé€ æˆå¤§é‡çš„æ— æ•ˆä¼ è¾“ã€‚&lt;/p&gt;

&lt;h2&gt;15ç«  TCPæ•°æ®æµå’Œçª—å£ç®¡ç†&lt;/h2&gt;

&lt;h3&gt;Nagleç®—æ³•ï¼š&lt;/h3&gt;

&lt;p&gt;ç®—æ³•è¦æ±‚ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å½“ä¸€ä¸ªtcpè¿æ¥ä¸­æœ‰åœ¨ä¼ æ•°æ®ï¼ˆå·²å‘é€ä½†æœªç¡®è®¤ï¼‰ï¼Œå°çš„æŠ¥æ–‡æ®µï¼ˆé•¿åº¦å°äºSMSSï¼‰å°±ä¸èƒ½è¢«å‘é€ï¼Œç›´åˆ°æ‰€æœ‰çš„åœ¨ä¼ æ•°æ®éƒ½æ”¶åˆ°ACKã€‚&lt;/li&gt;
&lt;li&gt;å¹¶ä¸”ï¼Œåœ¨æ”¶åˆ°ACKåï¼Œtcpéœ€è¦æ”¶é›†è¿™äº›å°æ•°æ®ï¼Œå°†å…¶æ•´åˆåˆ°ä¸€ä¸ªæŠ¥æ–‡æ®µä¸­å‘é€ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;ç‰¹ç‚¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è¿«ä½¿tcpéµå¾ªåœç­‰è§„ç¨‹ï¼ˆstop-and-waitï¼‰ã€‚å‘ä¸€ä¸ªåŒ…å°±å¾—ç­‰åˆ°æ”¶åˆ°ACKåå†å‘ä¸‹ä¸€ä¸ªåŒ…ï¼Œå‘åŒ…é—´éš”ç­‰äºRTTã€‚&lt;/li&gt;
&lt;li&gt;å› æ­¤æ¯ä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªåŒ…åœ¨ä¼ &lt;/li&gt;
&lt;li&gt;å› æ­¤å‡å°‘äº†å°åŒ…æ•°ï¼ŒåŒæ—¶ä¹Ÿå¢å¤§äº†å»¶è¿Ÿã€‚&lt;/li&gt;
&lt;li&gt;å®ç°äº†è‡ªæ—¶é’Ÿæ§åˆ¶ï¼ˆself-clockingï¼‰ã€‚ACKè¿”å›è¶Šå¿«ï¼Œæ•°æ®ä¼ è¾“ä¹Ÿè¶Šå¿«ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨é«˜å»¶è¿Ÿç½‘ç»œä¸­ï¼Œéœ€è¦å‡å°‘ğŸ›°æŠ¥æ–‡æ•°ã€‚ç®—æ³•ä½¿å¾—å•ä½æ—¶é—´å†…å‘é€çš„æŠ¥æ–‡æ®µæ•°ç›®æ›´å°‘ã€‚&lt;/p&gt;

&lt;h3&gt;å»¶æ—¶ACKå’ŒNagleç®—æ³•ç»“åˆï¼š&lt;/h3&gt;

&lt;p&gt;ç®€å•æ¥è¯´å°±æ˜¯ä¼šæ­»é”ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æœåŠ¡ç«¯ï¼ˆNagleï¼‰å‘ä¸€ä¸ªåŒ…åå¼€å§‹ç­‰å¾…ACK&lt;/li&gt;
&lt;li&gt;å®¢æˆ·ç«¯ï¼ˆå»¶æ—¶ACKï¼‰æ”¶åŒ…åä¸é©¬ä¸Šå‘é€ACKè€Œæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´å†å‘&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å› ä¸ºå®¢æˆ·ç«¯æœ€ç»ˆä¼šå‘å‡ºACKï¼Œæ‰€ä»¥æ­»é”å¯è§£ã€‚ä½†ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œè¿æ¥å¤„äºç©ºé—²çŠ¶æ€ï¼ˆæ˜æ˜æœ‰äº‹å¿™ï¼‰ï¼Œæ€§èƒ½å˜å·®ã€‚&lt;/p&gt;

&lt;p&gt;ç¦ç”¨Nagleï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¯¹socketè®¾ç½®TCP_NODELAY&lt;/li&gt;
&lt;li&gt;æ•´ä¸ªç³»ç»Ÿè®¾ç½®nodelay&lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;æµé‡æ§åˆ¶å’Œçª—å£ç®¡ç†&lt;/h3&gt;

&lt;p&gt;å‘é€çª—å£ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å­—èŠ‚ä¸ºå•ä½&lt;/li&gt;
&lt;li&gt;SND.UNAï¼Œå‘é€çª—å£å·¦è¾¹ç•Œ&lt;/li&gt;
&lt;li&gt;SND.WNDï¼Œå‘é€çª—å£å¤§å°&lt;/li&gt;
&lt;li&gt;SND.UNA + SND.WNDï¼Œå‘é€çª—å£å³è¾¹ç•Œ&lt;/li&gt;
&lt;li&gt;SND.NXTï¼Œä¸‹ä¸ªè¦å‘é€çš„æ•°æ®åºåˆ—å·&lt;/li&gt;
&lt;li&gt;SND.UNA + SND.WND - SND.NXTï¼Œå¯ç”¨å‘é€çª—å£&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;çª—å£è¿åŠ¨æœ¯è¯­ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;closeï¼šå·¦è¾¹ç•Œå³ç§»ï¼ˆçª—å£ç¼©å°ï¼‰ã€‚å‘ç”Ÿåœ¨å·²å‘é€æ•°æ®å¾—åˆ°ACKç¡®è®¤ã€‚&lt;/li&gt;
&lt;li&gt;openï¼šå³è¾¹ç•Œå³ç§»ï¼ˆçª—å£å˜å¤§ï¼‰ã€‚å¯å‘é€æ•°æ®é‡å˜å¤§ã€‚åŒæ ·å‘ç”Ÿåœ¨å·²å‘é€æ•°æ®å¾—åˆ°ACKç¡®è®¤ã€‚&lt;/li&gt;
&lt;li&gt;shrinkï¼šæ”¶ç¼©ï¼Œå³è¾¹ç•Œå·¦ç§»ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Noteï¼šå·¦è¾¹ç•Œä¸å¯èƒ½å·¦ç§»ã€‚&lt;/p&gt;

&lt;p&gt;æ¥æ”¶çª—å£ï¼šç±»ä¼¼å‘é€çª—å£ã€‚ä½†çª—å£ä¸­é—´å› ä¸ºSACKé€‰é¡¹ï¼Œå¯èƒ½ä¼šæœ‰è¢«ACKçš„åºåˆ—å·ï¼ˆæœªç¡®è®¤çš„å°±æ˜¯ç©ºæ´ï¼‰ã€‚ä½†å¿…é¡»RCV.NXTæ¥æ”¶äº†ï¼Œçª—å£æ‰èƒ½å³ç§»ã€‚&lt;/p&gt;

&lt;p&gt;é›¶çª—å£å¯¼è‡´çš„é—®é¢˜ï¼š&lt;/p&gt;

&lt;p&gt;å·¦å³è¾¹ç•Œç›¸ç­‰æ—¶ï¼Œå«é›¶çª—å£ã€‚æ­¤æ—¶å‘é€ç«¯ä¸èƒ½å‘æ•°æ®ã€‚&lt;/p&gt;

&lt;p&gt;æ¥æ”¶ç«¯é‡æ–°è·å¾—å¯ç”¨ç©ºé—´æ—¶ï¼Œä¼šç»™å‘é€ç«¯å‘é€ä¸€ä¸ªçª—å£æ›´æ–°ï¼ˆwindow updateï¼‰ï¼Œå½“ç„¶è¿˜æ˜¯ç”¨é€šå‘Šçª—å£ã€‚ä½†è¿™ä¸ªå‘åŒ…ä¸å¸¦æ•°æ®ï¼ˆå› ä¸ºè¿™æ˜¯æ¥æ”¶ç«¯ï¼Œè‹¥å‘äº†æ•°æ®å°±å˜æˆå…¨åŒå·¥çš„å‘é€ç«¯äº†ï¼‰ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªå…¸å‹çš„ACKæ¶ˆæ¯ã€‚è¿™ä¸ªACKæ˜¯å¯èƒ½ä¸¢å¤±çš„ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœä¸¢å¤±äº†ï¼Œå°±ä¼šè¿›å…¥æ­»é”çŠ¶æ€ã€‚å‘é€ç«¯ä¸çŸ¥é“æ¥æ”¶ç«¯å·²ç»å¯ä»¥æ¥æ”¶æ•°æ®ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥å‘é€ç«¯ä¼šå®šæ—¶æ¢æµ‹probeå¯¹æ–¹çª—å£ï¼Œç”¨æ¥ä¼ºæœºå¢å¤§å‘é€çª—å£ï¼Œæ¥æ”¶ç«¯æ”¶åˆ°æ—¶å¿…é¡»è¿”å›ACKï¼ˆåŒ…å«äº†çª—å£å¤§å°å­—æ®µï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;æ¢æµ‹æ—¶æœºä¸ºä¸€ä¸ªRTOè¶…æ—¶åï¼Œç„¶åæŒ‡æ•°é—´éš”å‘é€ã€‚&lt;/p&gt;

&lt;p&gt;probeæ˜¯å¸¦æœ‰ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®çš„ï¼ˆç”¨æˆ·çš„æ•°æ®ï¼‰ï¼Œæ‰€ä»¥tcpä¼šå¯é ä¼ è¾“å®ƒã€‚ä¸è¿‡å¦‚æœæ¥æ”¶ç«¯ä¾ç„¶æ²¡æœ‰å¯ç”¨ç¼“å­˜ç©ºé—´ï¼Œå°±ä¼šä¸¢æ‰è¿™ä¸ªåŒ…ã€‚&lt;/p&gt;

&lt;h4&gt;ç³Šæ¶‚çª—å£ç»¼åˆå¾(silly window syndromeï¼ŒSWS)ï¼š&lt;/h4&gt;

&lt;p&gt;ç™¾åº¦ç™¾ç§‘è§£é‡Šï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ç³Šæ¶‚çª—å£ç»¼åˆç—‡æ˜¯æŒ‡å½“å‘é€ç«¯åº”ç”¨è¿›ç¨‹äº§ç”Ÿæ•°æ®å¾ˆæ…¢ã€æˆ–æ¥æ”¶ç«¯åº”ç”¨è¿›ç¨‹å¤„ç†æ¥æ”¶ç¼“å†²åŒºæ•°æ®å¾ˆæ…¢ï¼Œæˆ–äºŒè€…å…¼è€Œæœ‰ä¹‹ï¼›å°±ä¼šä½¿åº”ç”¨è¿›ç¨‹é—´ä¼ é€çš„æŠ¥æ–‡æ®µå¾ˆå°ï¼Œç‰¹åˆ«æ˜¯æœ‰æ•ˆè½½è·å¾ˆå°ï¼› æç«¯æƒ…å†µä¸‹ï¼Œæœ‰æ•ˆè½½è·å¯èƒ½åªæœ‰1ä¸ªå­—èŠ‚ï¼›ä¼ è¾“å¼€é”€æœ‰40å­—èŠ‚(20å­—èŠ‚çš„IPå¤´+20å­—èŠ‚çš„TCPå¤´) è¿™ç§ç°è±¡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;æ¥æ”¶ç«¯é€šå‘Šçª—å£è¾ƒå°&lt;/li&gt;
&lt;li&gt;å‘é€ç«¯å‘é€çš„æ•°æ®æ®µè¾ƒå°&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è§£å†³æ–¹æ¡ˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ¥æ”¶ç«¯ï¼šä¸åº”é€šå‘Šå°çš„çª—å£å€¼&lt;/li&gt;
&lt;li&gt;å‘é€ç«¯ï¼šä¸åº”å‘é€å°çš„æŠ¥æ–‡æ®µ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å‘é€ç«¯éœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰èƒ½å‘é€ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å…¨é•¿ï¼ˆMSSï¼‰çš„æŠ¥æ–‡æ®µ&lt;/li&gt;
&lt;li&gt;æ•°æ®æ®µé•¿åº¦&amp;gt;=æ¥æ”¶ç«¯é€šå‘Šè¿‡çš„&lt;strong&gt;æœ€å¤§çª—å£å€¼&lt;/strong&gt;çš„ä¸€åŠã€‚ï¼ˆè¦è®°å½•ä¸€ä¸ªæœ€å¤§å€¼ï¼Œå‘é€ç«¯æ‰å¯çŒœæµ‹æ¥æ”¶ç¼“å­˜å¤§å°ï¼‰&lt;/li&gt;
&lt;li&gt;ACKä¸æ˜¯ç›®å‰æœŸæœ›çš„ï¼ˆæˆ–è€…è¯´æ²¡æœ‰æœªç»ç¡®è®¤çš„æ•°æ®ï¼Œé‚£ä¹ˆå‘é€ç«¯ç«‹å³å‘é€æ–°æ•°æ®æ˜¯åˆç†çš„ï¼‰ æˆ– ç¦ç”¨äº†Nagleç®—æ³• &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç¬¬ä¸‰ç‚¹åè¿‡æ¥è¯´å°±æ˜¯ï¼šå¦‚æœå¯ç”¨äº†Nagleæˆ–è€…æœ‰æœªç¡®è®¤çš„åœ¨ä¼ æ•°æ®ï¼Œé‚£ä¹ˆä¸åº”è¯¥å‘é€å°åŒ…&lt;/p&gt;

&lt;h4&gt;å¤§å®¹é‡ç¼“å­˜ä¸è‡ªåŠ¨è°ƒä¼˜&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;åœ¨ç›¸ä¼¼ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨è¾ƒå°æ¥æ”¶ç¼“å­˜çš„tcpååé‡ä¼šè¾ƒå·®&lt;/li&gt;
&lt;li&gt;å³ä½¿æ¥æ”¶ç«¯æŒ‡å®šäº†å¤§å®¹é‡ç¼“å­˜ï¼Œä½†å‘é€ç«¯æŒ‡å®šäº†å°ç¼“å­˜ï¼Œæ€§èƒ½è¿˜æ˜¯å·®&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™2ä¸ªé—®é¢˜å¾ˆå…³é”®ï¼Œå¹¶ä¸”å› ä¸ºç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¾ˆå¤štcpåè®®æ ˆä¸­åº”ç”¨å±‚æ˜¯ä¸èƒ½æŒ‡å®šç¼“å­˜å¤§å°çš„ã€‚æ“ä½œç³»ç»Ÿä¼šè‡ªå·±å®šä¸€ä¸ªå®šå€¼æˆ–å¼„æˆåŠ¨æ€å€¼ã€‚&lt;/p&gt;

&lt;p&gt;çª—å£å¤§å°çš„è‡ªåŠ¨è°ƒä¼˜ï¼šåªèƒ½æŒ‰ç±»å‹é€‰ï¼Œæ²¡æœ‰å…·ä½“å€¼ï¼Œdisabledã€ highlyrestrictedã€ reStrictedã€ normalã€experimentalã€‚&lt;/p&gt;

&lt;p&gt;ç¼“å­˜å¤§å°çš„åŠ¨æ€è°ƒæ•´ï¼šé€šè¿‡ä¼°ç®—å‘é€æ–¹çš„æ‹¥å¡çª—å£çš„å¤§å°ï¼Œæ¥åŠ¨æ€è®¾ç½®TCPæ¥æ”¶ç¼“å­˜çš„å¤§å°ã€‚&lt;/p&gt;

&lt;h3&gt;ç´§æ€¥æœºåˆ¶&lt;/h3&gt;

&lt;p&gt;è™½ç„¶tcpçš„ç´§æ€¥æœºåˆ¶è°ƒç”¨ç”¨äº†ä¸€ä¸ªå«MSG_OOBçš„flagï¼Œä½†æ˜¯å…¶å®å¹¶ä¸æ˜¯å¸¦å¤–æ•°æ®ï¼Œè¿™ä¸ªç´§æ€¥æ•°æ®ä¸€æ ·æ˜¯åœ¨ç”¨æˆ·çš„æ•°æ®æµä¸­ä¼ è¾“ï¼Œåªæ˜¯ä¼˜å…ˆçº§æ›´é«˜ã€‚&lt;/p&gt;

&lt;p&gt;å‘é€çš„ç´§æ€¥æ•°æ®åªèƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶æ”¾è¿›å½“å‰ç¼“å†²åŒºæœ«å°¾ã€‚å› ä¸ºç”¨äº†tcpçš„å¯é ä¼ è¾“ï¼Œæ‰€ä»¥åªéœ€è¦æ’å…¥ä¸€æ¬¡ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸ºçª—å£å¤§å°åŸå› ï¼Œå¯èƒ½ä¸èƒ½ç«‹å³å‘å‡ºè¿™ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯tcpä¼šçŸ¥é“å·²ç»è¿›å…¥ç´§æ€¥çŠ¶æ€ï¼Œæ‰€æœ‰å‘å‡ºå»çš„åŒ…éƒ½æ‰“å¼€äº†URGæ ‡å¿—ã€‚&lt;/p&gt;

&lt;p&gt;å¯¹æ¥æ”¶ç«¯æ¥è¯´ï¼Œæ”¶åˆ°URGçš„åŒ…å¤´ï¼Œä¸ç­‰äºè¯¥æŠ¥æ–‡æ®µé‡Œå°±æœ‰ç´§æ€¥æ•°æ®ï¼ˆè¿˜åœ¨æ”¶åˆ°ï¼‰ã€‚è¦ç”¨ç´§æ€¥æŒ‡é’ˆæ¥åˆ¤æ–­ã€‚åœ¨æ”¶åˆ°ç´§æ€¥æ•°æ®å‰å¯èƒ½æœ‰å¤šä¸ªåŒ…å¤´ï¼ŒåŒ…å¤´é‡Œçš„ç´§æ€¥æŒ‡é’ˆéƒ½ä¸€æ ·ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†è®©ç”¨æˆ·åŠæ—¶recvæ‹¿åˆ°ç´§æ€¥æ•°æ®ï¼Œéœ€è¦ç”¨ä¿¡å·SIGURGçš„æ–¹å¼é€šçŸ¥ã€‚SIGURGåœ¨ç¬¬ä¸€æ¬¡æ”¶åˆ°URGåŒ…å¤´æ—¶è§¦å‘ä¸€æ¬¡ã€‚&lt;/p&gt;

&lt;p&gt;å¸¦å¤–æ•°æ®ç¼“å†²åŒºï¼šåˆ°è¾¾çš„ç´§æ€¥æ•°æ®ä¸èƒ½æ··åœ¨ç”¨æˆ·æ•°æ®ç¼“å†²åŒºï¼Œæ‰€ä»¥å¦å¤–ç”¨è¿™ä¸ªæ¥å­˜ï¼Œç­‰ç”¨æˆ·æ¥è¯»å–ã€‚&lt;/p&gt;

&lt;p&gt;send(sockfd, &amp;#39;x&amp;#39;, 1, MSG_OOB);&lt;/p&gt;

&lt;p&gt;recv(sockfd, &amp;amp;ch, 1, MSG_OOB);&lt;/p&gt;

&lt;p&gt;recvï¼šåœ¨ç´§æ€¥çŠ¶æ€ä¸‹ï¼Œå¸¦å¤–æ•°æ®ä»æœªåˆ°è¾¾ï¼Œå‡½æ•°è¿”å›EWOULDFBLOCKï¼›éç´§æ€¥çŠ¶æ€ä¸‹ï¼Œè°ƒç”¨ä¸Šè¿°å‡½æ•°ï¼Œè¿”å›EINVALã€‚&lt;/p&gt;

&lt;h2&gt;TCPæ‹¥å¡æ§åˆ¶&lt;/h2&gt;

&lt;p&gt;å›é¡¾ï¼šæµé‡æ§åˆ¶æœºåˆ¶æ˜¯åŸºäºé€šå‘Šçª—å£å¤§å°å­—æ®µæ¥å®ç°ï¼Œæ˜ç¡®åœ°å‘Šè¯‰äº†å‘é€ç«¯ï¼Œæ¥æ”¶ç«¯çš„ç¼“å­˜å¤§å°ï¼Œé¿å…äº†æ¥æ”¶ç«¯ç¼“å­˜æº¢å‡ºã€‚å‘é€ç«¯é™ä½äº†å‘é€é€Ÿç‡ã€‚&lt;/p&gt;

&lt;p&gt;å¯¹è·¯ç”±å™¨è€Œè¨€ï¼šè¶…è´Ÿè·æ—¶ï¼Œé™ä½å‘é€é€Ÿç‡æˆ–ä¸¢å¼ƒéƒ¨åˆ†æ•°æ®ã€‚åŸå› æ˜¯ï¼Œå³ä½¿è·¯ç”±å™¨èƒ½ç¼“å­˜ä¸€éƒ¨åˆ†æ•°æ®ï¼Œç„¶åæ…¢æ…¢å‘å‡ºå»ï¼Œä½†æºæºä¸æ–­çš„æ•°æ®åˆ°è¾¾ï¼Œåˆ°è¾¾é€Ÿç‡é«˜äºå‘å‡ºé€Ÿç‡ï¼Œä»»ä½•å®¹é‡éƒ½å¾—æº¢å‡ºã€‚ï¼ˆæ’é˜Ÿç†è®ºï¼ï¼‰&lt;/p&gt;

&lt;p&gt;æ‹¥å¡ï¼šè·¯ç”±å™¨æ— æ³•å¤„ç†é«˜é€Ÿç‡åˆ°è¾¾çš„æµé‡è€Œè¢«è¿«ä¸¢å¼ƒæ•°æ®ä¿¡æ¯çš„ç°è±¡&lt;/p&gt;

&lt;p&gt;æ‹¥å¡æ§åˆ¶æœºåˆ¶ï¼šæ˜¯ä¸ºäº†ç¼“è§£æ‹¥å¡æƒ…å†µï¼Œtcpè¿æ¥ä¸¤ç«¯éƒ½è¦è¿›è¡Œ&lt;/p&gt;

&lt;h3&gt;tcpæ‹¥å¡æ£€æµ‹ï¼š&lt;/h3&gt;

&lt;p&gt;å›é¡¾ï¼šå¯¹äºä¸¢åŒ…ï¼Œtcpé‡‡å–é¦–è¦æœºåˆ¶æ˜¯é‡ä¼ ï¼šè¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ ã€‚&lt;/p&gt;

&lt;p&gt;ä½†å½“ç½‘ç»œæ‹¥å¡æ—¶ï¼Œé‡ä¼ ä¼šå¯¼è‡´ç«ä¸Šæµ‡æ²¹ã€‚æ‰€ä»¥è¦é¿å…è¿™ä¸ªæƒ…å†µã€‚&lt;/p&gt;

&lt;p&gt;å½“æ‹¥å¡æƒ…å†µå‡ºç°æ—¶çš„å¤„ç†æªæ–½ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å‡ç¼“å‘é€é€Ÿç‡&lt;/li&gt;
&lt;li&gt;æ‹¥å¡æƒ…å†µå¥½è½¬æ—¶ï¼Œæ£€æµ‹å’Œä½¿ç”¨æ–°çš„å¯ç”¨å¸¦å®½&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç„¶è€Œå¾ˆéš¾åšåˆ°ï¼šå› ä¸ºå¯¹äºtcpå‘é€æ–¹è€Œè¨€ï¼Œæ²¡æœ‰ä¸€ä¸ªå‡†ç¡®çš„æ–¹æ³•å»çŸ¥æ™“è·¯ç”±å™¨çš„çŠ¶æ€ã€‚&lt;/p&gt;

&lt;p&gt;åªèƒ½ç”¨ä¸€äº›ä¿¡æ¯æ¥æ¨æ–­ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å‡ºç°ä¸¢åŒ…&lt;/li&gt;
&lt;li&gt;æ—¶å»¶æµ‹é‡&lt;/li&gt;
&lt;li&gt;æ˜¾å¼æ‹¥å¡é€šçŸ¥ï¼ˆECNï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ£€æµ‹å‡ºæ‹¥å¡åï¼Œå°±æ˜¯å¯¹æ‹¥å¡çš„å¤„ç†ã€‚å…¶å®å°±æ˜¯whenå‡é€Ÿå’Œhowå‡é€Ÿã€howæ¢å¤é€Ÿç‡ã€‚&lt;/p&gt;

&lt;h3&gt;å‡ç¼“TcPå‘é€&lt;/h3&gt;

&lt;p&gt;æ‹¥å¡çª—å£ï¼šåæ˜ ç½‘ç»œä¼ è¾“èƒ½åŠ›çš„å˜é‡ï¼Œcwnd&lt;/p&gt;

&lt;p&gt;æ¥æ”¶ç«¯é€šçŸ¥çª—å£ï¼šawnd&lt;/p&gt;

&lt;p&gt;å‘é€ç«¯å®é™…å¯ç”¨çª—å£ï¼šW = min(cwnd, awnd)&lt;/p&gt;

&lt;p&gt;åœ¨å¤–æ•°æ®å¤§å°ï¼ˆflight sizeï¼‰ï¼šå‘é€ç«¯å‘é€çš„æ•°æ®ä¸­ï¼Œæœªæ”¶åˆ°ACKçš„æ•°æ®ä¸èƒ½å¤šäºWï¼ˆå­—èŠ‚ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;cwndæ— æ³•æ‹¿åˆ°å‡†ç¡®å€¼ï¼šç¼ºä¹æ˜¾ç¤ºæ‹¥å¡çš„ä¿¡å·&lt;/p&gt;

&lt;p&gt;Wã€cwndã€awndéœ€è¦æ ¹æ®ç»éªŒè®¾å®šå¹¶åŠ¨æ€è°ƒèŠ‚ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥ï¼ŒWçš„å€¼ä¸èƒ½è¿‡å¤§æˆ–è¿‡å°ï¼Œåº”æ¥è¿‘BDPï¼ˆbandwidth-delay prodcutï¼‰ï¼Œå¸¦å®½å»¶è¿Ÿç§¯ï¼Œä¹Ÿç§°ä½œæœ€ä½³çª—å£å¤§å°ï¼ˆoptimal window sizeï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;Wåæ˜ ç½‘ç»œä¸­å¯å­˜å‚¨çš„å¾…å‘é€æ•°æ®é‡å¤§å°ã€‚&lt;/p&gt;

&lt;p&gt;å®é™…è®¡ç®—æ–¹æ³•ï¼šW = RTT * é“¾è·¯ä¸­æœ€å°é€šè¡Œé€Ÿç‡&lt;/p&gt;

&lt;p&gt;Wè¶Šæ¥è¿‘BDPï¼Œç½‘ç»œèµ„æºåˆ©ç”¨å¾—è¶Šé«˜æ•ˆã€‚&lt;/p&gt;

&lt;p&gt;ç¡®å®šBDPæ˜¯éš¾ç‚¹ã€‚&lt;/p&gt;

&lt;h3&gt;ç»å…¸æ–¹æ³•&lt;/h3&gt;

&lt;p&gt;åŒæ—¶åªè¿è¡Œä¸€ä¸ªï¼Œå¯ä»¥äº’ç›¸åˆ‡æ¢ã€‚&lt;/p&gt;

&lt;p&gt;åŸºäºåŒ…å®ˆæ’ã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å»ºç«‹tcpæ—¶æ‰§è¡Œæ…¢å¯åŠ¨&lt;/li&gt;
&lt;li&gt;ç›´è‡³æœ‰ä¸¢åŒ…æ—¶ï¼Œæ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•&lt;/li&gt;
&lt;/ol&gt;

&lt;h4&gt;æ…¢å¯åŠ¨&lt;/h4&gt;

&lt;p&gt;åŸå› ï¼šç”±äºæœªçŸ¥ç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼Œéœ€è¦ç¼“æ…¢æ¢æµ‹å¯ç”¨ä¼ è¾“èµ„æºï¼Œé˜²æ­¢çŸ­æ—¶é—´å†…å¤§é‡æ•°æ®æ³¨å…¥å¯¼è‡´æ‹¥å¡ã€‚&lt;/p&gt;

&lt;p&gt;ä½œç”¨ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;ä½¿TCPåœ¨ç”¨æ‹¥å¡é¿å…æ¢å¯»æ›´å¤šå¯ç”¨å¸¦å®½ä¹‹å‰å¾—åˆ°cwndå€¼&lt;/li&gt;
&lt;li&gt;å¸®åŠ©tcpå»ºç«‹ackæ—¶é’Ÿ&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ—¶æœºï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ–°è¿æ¥&lt;/li&gt;
&lt;li&gt;æ£€æµ‹åˆ°RTOå¯¼è‡´çš„ä¸¢åŒ…æ—¶&lt;/li&gt;
&lt;li&gt;é•¿æ—¶é—´å¤„äºç©ºé—²çŠ¶æ€&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åŸç†ï¼š&lt;/p&gt;

&lt;p&gt;SMSS: å‘é€æ–¹çš„æœ€å¤§æ®µå¤§å° = minï¼ˆæ¥æ”¶æ–¹MSSï¼Œè·¯å¾„MTUï¼‰&lt;/p&gt;

&lt;p&gt;IWï¼šåˆå§‹çª—å£ï¼Œä¸€å¼€å§‹å‘é€çš„æ•°æ®æ®µå¤§å°ï¼ˆSYNäº¤æ¢åï¼‰&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;IW = 2 * SMSSï¼Œif SMSS &amp;gt; 2190&lt;/li&gt;
&lt;li&gt;IW = 3 * SMSSï¼Œif 2190 &amp;gt;= SMS &amp;gt; 1095&lt;/li&gt;
&lt;li&gt;IW = 4 * SMSSï¼Œelse&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åˆå§‹cwnd = IW = 1 * SMSSï¼ˆç®€å•èµ·è§ï¼Œè®¾1ï¼‰&lt;/p&gt;

&lt;p&gt;æ¯æ¬¡æ”¶åˆ°ACKï¼Œcwndä¼šæ…¢æ…¢å¢åŠ ï¼šcwnd += min(N, SMSS)&lt;/p&gt;

&lt;p&gt;Nï¼šæœªACKçš„æ•°æ®ï¼Œé€šè¿‡è¿™ä¸€â€å¥½çš„ACKâ€œèƒ½ç¡®è®¤çš„æ•°æ®å¤§å°&lt;/p&gt;

&lt;p&gt;å¥½çš„ACKï¼šæ–°æ”¶åˆ°ACKå¤§äºä¹‹å‰æ”¶åˆ°çš„ACK&lt;/p&gt;

&lt;p&gt;è¿™æ ·è®¾è®¡æ˜¯å› ä¸ºï¼šå¦‚æœæ¯æ¬¡æ”¶åˆ°ACKéƒ½ç›´æ¥+=SMSSï¼Œå¯èƒ½ä¼šé­åˆ°â€œACKåˆ†è£‚â€æ”»å‡»ï¼Œé€šè¿‡å‘é€å°ACKå¯¼è‡´å‘é€æ–¹åŠ é€Ÿå‘é€ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœNå¤§äºSMSSï¼Œè¯´æ˜æ­£åœ¨å‘é€å¤§é‡æ•°æ®ï¼Œé‚£ä¹ˆå°±åª+=SMSSï¼Œcwnd = 2 * SMSS.&lt;/p&gt;

&lt;p&gt;æ­¤æ—¶å°±å¯ä»¥å‘é€2ä¸ªæ•°æ®æ®µï¼Œå¦‚æœç»§ç»­æ¥æ”¶ACKæˆåŠŸï¼ˆ2ä¸ªACKï¼‰ï¼Œåˆ™2å˜4ã€4å˜8ï¼ŒæŒ‡æ•°å¢åŠ ã€‚&lt;/p&gt;

&lt;p&gt;kï¼škè½®åï¼ŒW = 2&lt;sup&gt;kï¼Œk&lt;/sup&gt; = log2(W)ï¼Œéœ€è¦kä¸ªRTTæ—¶é—´ï¼Œçª—å£æ‰èƒ½è¾¾åˆ°Wã€‚&lt;/p&gt;

&lt;p&gt;æŒ‡æ•°å¢é•¿çœ‹ä¼¼å¿«ï¼Œä½†è¿˜æ˜¯æ¯”ä¸€å¼€å§‹å°±ä»¥æœ€å¤§é€Ÿç‡ï¼ˆæ¥æ”¶æ–¹æœ€å¤§çª—å£ï¼‰æ…¢ï¼ˆWä¸ä¼šè¶…è¿‡awndï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼Œå¦‚æœæ¥æ”¶ç«¯å¼€å¯äº†ACKæ—¶å»¶ï¼Œæ¥æ”¶ç«¯å°±ä¸ä¼šå‘2ä¸ªACKï¼Œè€Œæ˜¯åˆå¹¶1ä¸ªï¼Œé‚£ä¹ˆå¢é€Ÿå˜å¾—æ›´æ…¢ã€‚&lt;/p&gt;

&lt;p&gt;éäº¤äº’å¼tcpæµï¼šå…¶å®å°±æ˜¯æŒ‡å•æ–¹å‘é€å¤§æ•°æ®çš„æƒ…å†µï¼Œä¸æ˜¯çŸ­æ¶ˆæ¯çš„ä¸€é—®ä¸€ç­”ï¼ˆhttpï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å¯¹äºéäº¤äº’å¼tcpæµæ¥è¯´ï¼Œdelayed ACKæ˜¯ä¸å¥½çš„ï¼Œæ­¤æ—¶æ¥æ”¶ç«¯æ˜¯ä¸ä¼šå‘æ•°æ®çš„ï¼Œæ‰€ä»¥æ²¡å¯èƒ½åœ¨æ•°æ®åŒ…é‡Œå¸¦ä¸ŠACKã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨Quick ACKæœºåˆ¶ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡QuickACKï¼Œæ¥æ”¶ç«¯recvåå¯ä»¥ç«‹å³å‘é€ACKï¼Œæ²¡æœ‰delayã€‚&lt;/p&gt;

&lt;p&gt;ä½†tcpæœ¬èº«å¾ˆéš¾çŸ¥é“æ˜¯ä¸æ˜¯éäº¤äº’å¼çš„æµã€‚å¯ä»¥è¿™æ ·åšï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ–°tcpè¿æ¥å¼€å¯quick ACKï¼Œç›´åˆ°æ£€æµ‹åˆ°è¯¥tcpæœ‰äº¤äº’å¼ç‰¹å¾æ—¶å…³é—­ã€‚ï¼ˆLinuxé»˜è®¤å¦‚æ­¤ï¼‰&lt;/li&gt;
&lt;li&gt;æ–°tcpè¿æ¥å…³é—­quick ACKï¼Œå½“è¿æ¥ä¸æ˜¯äº¤äº’å¼æ—¶ï¼Œå¼€å¯ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;http://www.jauu.net/2010/10/02/tcp-quick-ack-versus-packet-overhead/&quot;&gt;http://www.jauu.net/2010/10/02/tcp-quick-ack-versus-packet-overhead/&lt;/a&gt;&lt;/p&gt;

&lt;h4&gt;æ‹¥å¡é¿å…&lt;/h4&gt;

&lt;p&gt;å½“æŒ‡æ•°å¢é•¿åˆ°ä¸€å®šç¨‹åº¦ï¼Œå°±ä¼šå¼€å§‹ä¸¢åŒ…ã€‚&lt;/p&gt;

&lt;p&gt;æ­¤æ—¶è®¾ç½®ä¸€ä¸ªæ…¢å¯åŠ¨é˜ˆå€¼ï¼ˆssthreshï¼‰ï¼Œå…¬å¼ä¸‹é¢è¯´ï¼›å½“å‰æ‹¥å¡çª—å£å¤§å°ï¼ˆcwndï¼‰å‡åˆ°ä¸€åŠï¼ˆä¸ä¸€å®šï¼Œåªæ˜¯ç»å…¸åšæ³•ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;åªç•™ä¸€åŠæ˜¯é¿å…å æ»¡å…¨éƒ¨å¸¦å®½ï¼Œå¯¼è‡´è·¯ç”±å™¨å…¶ä»–è¿æ¥ä¸¢åŒ…ã€‚&lt;/p&gt;

&lt;p&gt;æ‹¥å¡é¿å…ï¼š&lt;/p&gt;

&lt;p&gt;å½“ç¡®ç«‹äº†æ…¢å¯åŠ¨é˜ˆå€¼ï¼Œtcpå°±è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µã€‚cwndä¸å†ç¿»å€ï¼Œè€Œæ˜¯çº¿æ€§å¢å¤§ã€‚è¿™å°±å¯ä»¥å¾—åˆ°æ›´å¤šçš„ä¼ è¾“èµ„æºè€Œä¸è‡³äºå½±å“å…¶ä»–è¿æ¥ã€‚&lt;/p&gt;

&lt;p&gt;\( cwnd_{t+1} = cwnd_t  + SMSS * SMSS/cwnd_t \)&lt;/p&gt;

&lt;p&gt;å…¶å®å°±æ˜¯æ¯æ¬¡æ”¶åˆ°ACKå°±å¢åŠ ï¼ˆ1/kï¼‰å€ (æ¬¡çº¿æ€§)&lt;/p&gt;

&lt;h4&gt;æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…çš„é€‰æ‹©&lt;/h4&gt;

&lt;p&gt;æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…ä¹‹é—´çš„åŒºåˆ«ï¼šå½“æ–°çš„ACKåˆ°è¾¾æ—¶ï¼Œcwndæ€æ ·å¢é•¿ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å½“cwnd &amp;lt; ssthreshï¼šæ…¢å¯åŠ¨&lt;/li&gt;
&lt;li&gt;å½“cwnd &amp;gt; ssthreshï¼šæ‹¥å¡é¿å…&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ssthreshåœ¨æ•´ä¸ªè¿æ¥ä¸­ä¸æ˜¯ä¿æŒä¸å˜çš„ã€‚æ²¡æœ‰ä¸¢åŒ…æ—¶ï¼Œè®°ä½ä¸Šä¸€æ¬¡æœ€å¥½çš„çª—å£ä¼°è®¡å€¼ã€‚æœ‰ä¸¢åŒ…æ—¶ï¼ŒæŒ‰ä¸‹é¢å…¬å¼æ›´æ–°ï¼š&lt;/p&gt;

&lt;p&gt;ssthresh=max (cwnd/2, 2*SMSS)&lt;/p&gt;

&lt;h4&gt;Tahoeã€ Renoä»¥åŠå¿«é€Ÿæ¢å¤ç®—æ³•&lt;/h4&gt;

&lt;p&gt;Tahoeï¼šæœ‰ä¸¢åŒ…æ—¶ï¼Œcwndç›´æ¥å˜1ï¼Œé‡æ–°æ…¢å¯åŠ¨ã€‚ä¼šå¯¼è‡´å¸¦å®½åˆ©ç”¨ç‡ä½ä¸‹ã€‚&lt;/p&gt;

&lt;p&gt;è§£å†³åŠæ³•ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è¶…æ—¶ä¸¢åŒ…ï¼šcwnd = 1&lt;/li&gt;
&lt;li&gt;é‡å¤ACKå¼•èµ·çš„ä¸¢åŒ…ï¼šcwnd = ä¸Šä¸€ä¸ªssthreshï¼ˆå¿«é€Ÿé‡ä¼ å°±ä¼šæœ‰è¿™ç§ä¸¢åŒ…ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Renoå¿«é€Ÿæ¢å¤ï¼š&lt;/p&gt;

&lt;p&gt;å› ä¸ºä¸¢åŒ…è¿›å…¥çš„æ…¢å¯åŠ¨é˜¶æ®µï¼Œå¯ä»¥å¿«é€Ÿæ¢å¤ï¼Œæ–¹æ³•æ˜¯æ¯æ¥æ”¶åˆ°ä¸€ä¸ªACKï¼ˆé‡å¤ACKï¼‰ï¼Œcwndå°±å¢é•¿1 SMSSï¼ˆæ€¥é€Ÿï¼‰ï¼Œç›´åˆ°æ¥æ”¶åˆ°ä¸€ä¸ªâ€å¥½çš„ACKâ€œã€‚&lt;/p&gt;

&lt;h3&gt;æ ‡å‡†TCP&lt;/h3&gt;

&lt;p&gt;å¯ä»¥å°ç»“å‡ºä¸€å¥—æ ‡å‡†ç®—æ³•ï¼š&lt;/p&gt;

&lt;p&gt;åœ¨TCPè¿æ¥å»ºç«‹ä¹‹åˆé¦–å…ˆæ˜¯æ…¢å¯åŠ¨é˜¶æ®µ(cwnd = IW), ssthreshé€šå¸¸å–ä¸€è¾ƒå¤§å€¼(è‡³å°‘ä¸ºawnd)ã€‚å½“æ¥æ”¶åˆ°ä¸€ä¸ªå¥½çš„ACK (è¡¨æ˜æ–°çš„æ•°æ®ä¼ è¾“æˆåŠŸ),
cwndä¼šç›¸åº”æ›´æ–°ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;cwnd += SMSS (è‹¥cwnd&amp;lt;ssthresh)æ…¢å¯åŠ¨&lt;/li&gt;
&lt;li&gt;cwnd += SMSS*SMSS/cwnd (è‹¥cwnd&amp;gt;ssthresh)æ‹¥å¡é¿å…&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å½“æ”¶åˆ°ä¸‰æ¬¡é‡å¤ACK (æˆ–å…¶ä»–è¡¨æ˜éœ€è¦å¿«é€Ÿé‡ä¼ çš„ä¿¡å·)è‚˜ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹è¡Œä¸ºï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;ssthreshæ›´æ–°ä¸ºå¤§äºç­‰å¼ ssthresh = max(åœ¨å¤–æ•°æ®å€¼/2, 2*SMSS) ä¸­çš„å€¼&lt;/li&gt;
&lt;li&gt;å¯ç”¨å¿«é€Ÿé‡ä¼ ç®—æ³•ï¼Œå°†cwndè®¾ä¸º(ssthresh + 3*SMSS)&lt;/li&gt;
&lt;li&gt;æ¯æ¥æ”¶ä¸€ä¸ªé‡å¤ACK, CWndå€¼æš‚æ—¶å¢åŠ 1 SMSS&lt;/li&gt;
&lt;li&gt;å½“æ¥æ”¶åˆ°ä¸€ä¸ªå¥½çš„ACKï¼Œå°†cwndé‡è®¾ä¸ºssthreshï¼ˆæ”¶ç¼©ï¼‰&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;ä»¥ä¸Šç¬¬2æ­¥å’Œç¬¬3æ­¥æ„æˆäº†å¿«é€Ÿæ¢å¤ã€‚&lt;/p&gt;

&lt;h3&gt;å¯¹æ ‡å‡†ç®—æ³•çš„æ”¹è¿›&lt;/h3&gt;

&lt;p&gt;NewRenoï¼š&lt;/p&gt;

&lt;p&gt;å› ä¸ºRenoéœ€è¦æ”¶åˆ°é‡å¤ACKæ‰èƒ½å¿«é€Ÿæ¢å¤ï¼Œä½†å¦‚æœå…ˆæ”¶åˆ°äº†å¥½çš„ACKï¼ˆå±€éƒ¨ACKï¼‰ï¼ˆä½†è¿˜æœ‰åˆ«çš„åŒ…å·²å‘é€æœªç¡®è®¤ï¼‰ï¼Œå¯¼è‡´äº†çª—å£è†¨èƒ€è¿‡æ—©ç»“æŸï¼Œæ­¤æ—¶ä¼ è¾“é€šé“å°±ä¼šå¾ˆç©ºé—²ã€‚ä¸”å¦‚æœé‡å¤ACKä¸è¶³ä¸‰ä¸ªï¼ˆç½‘ç»œä¸­æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®è¡¨åœ¨ä¼ è¾“å°±ä¼šè¿™æ ·)ï¼Œä¸ä¼šè¿›å…¥å¿«é€Ÿé‡ä¼ ï¼Œè€Œç¡®å®åˆæœ‰ä¸¢åŒ…ï¼Œé‚£ä¹ˆæœ€ç»ˆå°±æ˜¯RTOè¶…æ—¶ï¼Œè¿›è¡Œè¶…æ—¶é‡ä¼ ï¼Œå¹¶æ…¢å¯åŠ¨ã€‚&lt;/p&gt;

&lt;p&gt;Renoè®°å½•äº†ä¸€ä¸ªæœ€é«˜åºåˆ—å·æ¥è§£å†³ã€‚æ•ˆæœå°±æ˜¯é¿å…è¿‡æ—©ç»“æŸè†¨èƒ€ã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆå…¶ä»–æ”¹è¿›ä¹‹åå†å­¦ä¹ ï¼‰&lt;/p&gt;

&lt;h3&gt;å…±äº«æ‹¥å¡çŠ¶æ€ä¿¡æ¯&lt;/h3&gt;

&lt;p&gt;å…¶å®å°±æ˜¯æ“ä½œç³»ç»Ÿçš„æœ¬åœ°ä¼˜åŒ–ã€‚æ–°è¿æ¥å¯ä»¥åˆ©ç”¨æ—§è¿æ¥çš„ä¿¡æ¯ï¼Œæ¥ä¼˜åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;net.ipv4.tcp_no_metrics_save = 0ï¼Œé»˜è®¤å¼€å¯&lt;/p&gt;

&lt;p&gt;æ¯ä¸ªtcpå…³é—­å‰ï¼Œä¿å­˜ä¿¡æ¯ï¼šsrttã€rttvarã€é‡æ’ä¼°è®¡å€¼ã€cwndã€ssthresh&lt;/p&gt;

&lt;h3&gt;TCPå‹å¥½æ€§&lt;/h3&gt;

&lt;p&gt;å°±æ˜¯å¤šæ¡tcpè¿æ¥å¯¹èµ„æºçš„ç«äº‰é—®é¢˜ã€‚æœ‰ä¸€æ¡å¾ˆå¤æ‚çš„å…¬å¼ã€‚ç¯‡å¹…å¾ˆçŸ­ï¼Œåº”è¯¥ä¸æ˜¯é‡ç‚¹ã€‚&lt;/p&gt;

&lt;h3&gt;é«˜é€Ÿç¯å¢ƒä¸‹çš„TCP&lt;/h3&gt;

&lt;h3&gt;åŸºäºå»¶è¿Ÿçš„æ‹¥å¡æ§åˆ¶ç®—æ³•&lt;/h3&gt;

&lt;h3&gt;ç¼“å†²åŒºè†¨èƒ€&lt;/h3&gt;

&lt;p&gt;ç½‘ç»œä¸­çš„è·¯ç”±è®¾å¤‡ï¼Œå…¶ç¼“å†²åŒºçš„å¤§å°ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œè¿‡å¤§çš„ç¼“å†²åŒºåè€Œä¼šå¯¼è‡´ç½‘ç»œæ‹¥å¡ã€‚&lt;/p&gt;

&lt;p&gt;ç¼“å†²åŒºè¿‡å°ï¼š&lt;/p&gt;

&lt;p&gt;å¾ˆå®¹æ˜“å°±è¢«å†™æ»¡ï¼Œä¸¢åŒ…ç‡å˜é«˜ï¼Œå¯¼è‡´ä¼ è¾“æ•ˆç‡å·®&lt;/p&gt;

&lt;p&gt;ç¼“å†²åŒºè¿‡å¤§ï¼š &lt;/p&gt;

&lt;p&gt;å¦‚æœè·¯ç”±å™¨æ¥æ”¶é€Ÿç‡å¤§äºå‘é€é€Ÿç‡ï¼Œå°±ä¼šæœ‰å¤§é‡æ•°æ®åœ¨è·¯ç”±å™¨æ’é˜Ÿï¼Œå»¶è¿Ÿå¾ˆå¤§ï¼Œæ­¤æ—¶è¿˜ä¸ç®—æ˜¯ä¸¢åŒ…ã€‚ä¸¢åŒ…è¦ç­‰åˆ°å‘é€ç«¯è¶…æ—¶æ‰ç®—ï¼Œç„¶ååˆå¾€è·¯ç”±å™¨å¡å…¥äº†é‡å¤æŠ¥æ–‡æ®µã€‚&lt;/p&gt;

&lt;p&gt;æ‹¥å¡ä¿¡å·åé¦ˆè¿‡æ…¢ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://blog.csdn.net/zerooffdate/article/details/77688460&quot;&gt;https://blog.csdn.net/zerooffdate/article/details/77688460&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç§¯æé˜Ÿåˆ—ç®¡ç†å’ŒECNï¼š&lt;/p&gt;

&lt;p&gt;ä¸€èˆ¬ï¼Œè·¯ç”±å™¨æ²¡æœ‰ä¹‰åŠ¡æŠŠæ‹¥å¡ä¿¡æ¯å‘ç»™tcpå‘é€ç«¯ã€‚å°±ä¸åˆ©äºæ‹¥å¡æ§åˆ¶ã€‚&lt;/p&gt;

&lt;p&gt;è·¯ç”±å™¨é»˜è®¤åªæœ‰FIFOå’Œå°¾éƒ¨ä¸¢å¼ƒæœºåˆ¶ï¼Œå…ˆåˆ°çš„åŒ…ä¼šå‘å‡ºå»ï¼Œååˆ°çš„åŒ…å¦‚æœå¡ä¸ä¸‹äº†ï¼Œå°±ä¸¢å¼ƒã€‚&lt;/p&gt;

&lt;p&gt;åº”ç”¨FIFOå’Œå°¾éƒ¨ä¸¢å¼ƒä»¥å¤–çš„è°ƒåº¦ç®—æ³•å’Œç¼“å­˜ç®¡ç†ç­–ç•¥è¢«è®¤ä¸ºæ˜¯ç§¯æçš„ã€‚&lt;/p&gt;

&lt;p&gt;AQMï¼šç§¯æé˜Ÿåˆ—ç®¡ç†&lt;/p&gt;

&lt;p&gt;ECNï¼šéå¸¸ä¾èµ–è·¯ç”±å™¨ã€äº¤æ¢æœºçš„æ‹¥å¡é€šçŸ¥æœºåˆ¶ã€‚&lt;/p&gt;

&lt;p&gt;è·¯ç”±å™¨ä¼šç»™å‘é€ä¸­çš„æŠ¥æ–‡æ‰“ä¸ŠECNæ ‡è¯†ï¼ŒæŠ¥æ–‡é€åˆ°æ¥æ”¶ç«¯åï¼Œæ¥æ”¶ç«¯å†é€šè¿‡ACKåŒ…å‘Šè¯‰å‘é€ç«¯ECNã€‚å‘é€ç«¯å°±å¯ä»¥é™ä½å‘é€é€Ÿç‡ã€‚&lt;/p&gt;

&lt;h3&gt;ä¸TCPæ‹¥å¡æ§åˆ¶ç›¸å…³çš„æ”»å‡»&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;ACKåˆ†è£‚æ”»å‡»ï¼šæ‹†åˆ†ACKï¼Œä»è€Œè®©å‘é€ç«¯çš„cwndåŠ é€Ÿå¢é•¿ã€‚è§£å†³åŠæ³•ï¼šå‰é¢è¯´åˆ°äº†ã€‚&lt;/li&gt;
&lt;li&gt;é‡å¤ACKæ”»å‡»ï¼šå°±æ˜¯æœ¬æ¥æ²¡é‡å¤ACKï¼Œå¼ºè¡Œå‘é‡å¤çš„ï¼Œä¹Ÿæ˜¯å¯¼è‡´å‘é€ç«¯åœ¨å¿«é€Ÿæ¢å¤é˜¶æ®µå¢é•¿å¾—æ›´å¿«ã€‚è§£å†³åŠæ³•ï¼šé™åˆ¶å‘é€ç«¯åœ¨æ¢å¤é˜¶æ®µçš„åœ¨å¤–æ•°æ®å€¼&lt;/li&gt;
&lt;li&gt;ä¹è§‚å“åº”æ”»å‡»ï¼šå¯¹è¿˜æ²¡æœ‰æ”¶åˆ°çš„æŠ¥æ–‡æ®µäº§ç”ŸACKã€‚å¯¼è‡´å‘é€ç«¯è®¡ç®—å‡ºæ¥çš„RTTå˜å°ï¼Œå‘é€ç«¯å°±ä¼šæ¯”æ­£å¸¸æƒ…å†µä¸‹å‘å¾—æ›´å¿«ã€‚è§£å†³åŠæ³•ï¼šå‘é€æŠ¥æ–‡å¤§å°åŠ ä¸€ç‚¹éšæœºï¼Œä½¿å¾—æ¥æ”¶ç«¯éš¾ä»¥çŒœå‡ºã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;h2&gt;TCPä¿æ‹¬æœºåˆ¶&lt;/h2&gt;

&lt;p&gt;è¿™ä¸€ç« å¾ˆçŸ­ï¼Œä¸æ˜¯å¾ˆé‡ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;keepaliveæ˜¯ä¸€ç§ä¸æ€ä¹ˆçº³å…¥æ ‡å‡†çš„æŠ€æœ¯ã€‚å› ä¸ºkeepaliveæ˜¯æœ‰é—®é¢˜çš„ï¼šå¯¹äºä¸€ä¸ªé•¿è¿æ¥ï¼Œå¦‚æœå‘é€ä¿æ´»æ¢æµ‹çš„æ—¶å€™ï¼Œåˆšå¥½è¿™æ®µæ—¶é—´ä¸­é—´ç½‘ç»œå‡ºäº†ç‚¹é—®é¢˜ï¼ˆä¾‹å¦‚è·¯ç”±å™¨é‡å¯ï¼‰ï¼Œå°±ä¼šå¯¼è‡´å¥½çš„è¿æ¥è¢«ä¸­æ–­æ‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¿æ´»åŠŸèƒ½æ˜¯ä¸ºæœåŠ¡å™¨æä¾›çš„ã€‚æœåŠ¡å™¨éœ€è¦çŸ¥é“å®¢æˆ·ç«¯æ˜¯å¦å´©æºƒæˆ–ç¦»å¼€ï¼Œæ‰èƒ½é‡Šæ”¾è¿æ¥èµ„æºã€‚&lt;/p&gt;

&lt;p&gt;ä¸€èˆ¬ï¼Œé•¿æ—¶é—´äº¤äº’å¼æœåŠ¡å°±ä¸æœŸæœ›ä¿æ´»åŠŸèƒ½ï¼ˆsshï¼‰ï¼›çŸ­æ—¶é—´éäº¤äº’å¼æœåŠ¡å°±æœŸæœ›ä¿æ´»åŠŸèƒ½ï¼ˆWebæœåŠ¡å™¨ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;é»˜è®¤å…³é—­ã€‚&lt;/p&gt;

&lt;p&gt;éå¯¹ç§°ï¼Œä¸¤ç«¯éƒ½å¯ä»¥å„è‡ªåškeepaliveã€‚&lt;/p&gt;

&lt;p&gt;ç»„æˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;keepalive timeï¼šä¿æ´»æ—¶é—´ï¼Œå³å‘é€ä¿æ´»æ¢æµ‹çš„è®¡æ—¶å™¨çš„timeoutæ—¶é—´ã€‚ä¸€èˆ¬ä¸ºæ— æ•°æ®ä¼ è¾“å2å°æ—¶ã€‚&lt;/li&gt;
&lt;li&gt;keepalive intervalï¼šç¬¬ä¸€ä¸ªæ¢æµ‹å‘é€åï¼Œå¦‚æœæ²¡æ”¶åˆ°å›åŒ…ï¼Œå°±éœ€è¦ç´§è·Ÿç€å†æ¬¡å‘é€æ¢æµ‹ã€‚ä¸€èˆ¬ä¸º75ç§’ã€‚&lt;/li&gt;
&lt;li&gt;keepalive probeï¼šæ¢æµ‹å¤šå°‘æ¬¡åæ‰è®¤ä¸ºå¯¹ç«¯ä¸å¯è¾¾ï¼Œä¸­æ–­è¿æ¥ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ¢æµ‹æŠ¥æ–‡ï¼š&lt;/p&gt;

&lt;p&gt;ä¸€ä¸ªç©ºæŠ¥æ–‡æ®µæˆ–å¸¦ä¸€ä¸ªå­—èŠ‚ï¼ˆåƒåœ¾æ•°æ®ï¼‰çš„æŠ¥æ–‡æ®µã€‚åºåˆ—å·ç­‰äºå¯¹ç«¯å‘é€çš„ACKæœ€å¤§åºåˆ—å·å‡1ï¼Œå› ä¸ºè¿™ä¸ªåºåˆ—å·å·²ç»è¢«æˆåŠŸæ¥æ”¶ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹å¯¹ç«¯é€ æˆå½±å“ã€‚&lt;/p&gt;

&lt;p&gt;æ¢æµ‹æŠ¥æ–‡è¿”å›çš„å“åº”å¯ä»¥ç¡®å®šè¿æ¥æ˜¯å¦åœ¨å·¥ä½œã€‚&lt;/p&gt;

&lt;p&gt;å“åº”æŠ¥æ–‡ä¹Ÿæ˜¯ä¸å¸¦æ•°æ®æˆ–è€…åªå¸¦åƒåœ¾æ•°æ®ã€‚&lt;/p&gt;

&lt;p&gt;2ç§æŠ¥æ–‡ä¸¢å¤±äº†éƒ½ä¸ä¼šé‡ä¼ ã€‚ï¼ˆæ‰€ä»¥éœ€è¦é‡å¤æ¢æµ‹ï¼‰&lt;/p&gt;

&lt;p&gt;æ¢æµ‹å‰åï¼Œå¯¹ç«¯å¯èƒ½çš„å››ç§çŠ¶æ€ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å¯¹ç«¯æ­£å¸¸å·¥ä½œï¼Œæ­£å¸¸å“åº”äº†æ¢æµ‹ã€‚æ¢æµ‹å®šæ—¶å™¨é‡ç½®ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹ç«¯å·²å´©æºƒæˆ–é‡å¯ä¸­ï¼Œæ­¤æ—¶ä¸ä¼šå“åº”æ¢æµ‹ã€‚æ¢æµ‹ç«¯ä¼šä¸€ç›´æ¢æµ‹ç›´åˆ°è¶…è¿‡æ¢æµ‹æ¬¡æ•°ï¼Œå°±è®¤ä¸ºå¯¹ç«¯å·²ç»å…³é—­ï¼Œæ–­å¼€è¿™ä¸ªè¿æ¥ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹ç«¯å·²å´©æºƒä½†å·²é‡å¯ï¼Œä¼šå‘é€RSTé‡ç½®æŠ¥æ–‡æ®µä½œä¸ºå“åº”ã€‚æ¢æµ‹ç«¯ä¼šæ–­å¼€è¿æ¥ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹ç«¯æ­£å¸¸å·¥ä½œï¼Œä½†å› å…¶ä»–åŸå› æ¢æµ‹æŠ¥æ–‡ä¸èƒ½åˆ°è¾¾ã€‚4å’Œ2ç›¸åŒï¼Œå› ä¸ºtcpæ— æ³•åŒºåˆ†å¼€ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Noteï¼šå¯¹ç«¯æ­£å¸¸å…³é—­ç„¶åé‡å¯ï¼Œæ˜¯æ²¡é—®é¢˜çš„ã€‚å¯¹ç«¯ä¼šå‘é€FINï¼Œæ­£å¸¸æ–­å¼€è¿æ¥ã€‚&lt;/p&gt;

&lt;p&gt;æ¬ºéª—æ”»å‡»ï¼šå› ä¸ºä¿æ´»æŠ¥æ–‡ä¸åŒ…å«ç”¨æˆ·æ•°æ®ï¼ŒåŠ å¯†å¼ºåº¦æœ‰é™ã€‚å®¹æ˜“ä¼ªé€ ã€‚å¯¼è‡´è¿æ¥ä¸€ç›´ä¿æŒï¼Œæµªè´¹æœåŠ¡ç«¯èµ„æºã€‚&lt;/p&gt;
</description>
        <pubDate>Sat, 24 Mar 2018 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/tcpip-1/</link>
        <guid isPermaLink="true">http://localhost:4000/tcpip-1/</guid>
      </item>
    
      <item>
        <title>ç¢°æ’æ£€æµ‹ç®—æ³•(äºŒ)ï¼šåŸå§‹GJKè¯¦è§£</title>
        <description>&lt;p&gt;GJKï¼Œå…¨ç§°&lt;a href=&quot;https://en.wikipedia.org/wiki/Gilbert%E2%80%93Johnson%E2%80%93Keerthi_distance_algorithm&quot;&gt;Gilbertâ€“Johnsonâ€“Keerthi distance algorithm&lt;/a&gt;ï¼Œæ˜¯éå¸¸å¸¸ç”¨çš„ç¢°æ’æ£€æµ‹ç®—æ³•ã€‚&lt;/p&gt;

&lt;p&gt;åŸå§‹GJKçš„åŠŸèƒ½ï¼šå‡†ç¡®åœ°å‘Šè¯‰è°ƒç”¨è€…2ä¸ªå‡ ä½•ä½“&lt;strong&gt;æ˜¯å¦&lt;/strong&gt;ç¢°æ’ã€‚&lt;/p&gt;

&lt;p&gt;GJKçš„ä¸»è¦ç‰¹æ€§ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;åªé€‚ç”¨äºå‡¸ä½“&lt;/li&gt;
&lt;li&gt;GJKç®—æ³•ä¸ç»´åº¦æ— å…³ï¼Œ2Dã€3Déƒ½å¯ä»¥ç”¨&lt;/li&gt;
&lt;li&gt;ä¸è¦æ±‚å¯¹é¡¶ç‚¹æ•°ç»„åšæ’åº&lt;/li&gt;
&lt;li&gt;å­˜åœ¨ä¸€äº›æŠ€å·§å¯ä»¥å¤§å¤§ä¼˜åŒ–GJKçš„æ€§èƒ½&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æœ¬æ–‡å°†è¯¦è§£åŸå§‹GJKçš„æ¥é¾™å»è„‰ã€‚&lt;/p&gt;

&lt;h3&gt;ç›®å½•ï¼š&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1&quot;&gt;æ•°å­¦çŸ¥è¯†ç‚¹&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1.1&quot;&gt;é—µå¯å¤«æ–¯åŸºæ•°å­¦ Minkowski Math&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#1.2&quot;&gt;å•çº¯å½¢ Simplex&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#1.3&quot;&gt;å‘é‡æ··åˆç§¯ Vector Triple Product&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2&quot;&gt;GJKç®—æ³•åŸç†&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#2.1&quot;&gt;GJKä¼ªä»£ç &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2.2&quot;&gt;Supportå‡½æ•°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2.3&quot;&gt;NearestSimplexå‡½æ•°&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3&quot;&gt;äºŒç»´å¹³é¢çš„GJKç®—æ³•å®ç°&lt;/a&gt; 

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#3.1&quot;&gt;b2Distanceæ ¸å¿ƒé€»è¾‘&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3.2&quot;&gt;b2Simplex::GetSearchDirection&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3.3&quot;&gt;b2Simplex::Solve2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3.4&quot;&gt;b2Simplex::Solve3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3.5&quot;&gt;b2DistanceProxy::GetSupport&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4&quot;&gt;å…¶ä»–ç»†èŠ‚&lt;/a&gt; &lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5&quot;&gt;å‚è€ƒèµ„æ–™&lt;/a&gt; 

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#5.1&quot;&gt;GJKå„ç§å®ç°&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;!--more--&gt;

&lt;h1&gt;&lt;div id=&quot;1&quot;&gt;æ•°å­¦çŸ¥è¯†ç‚¹&lt;/div&gt;&lt;/h1&gt;

&lt;p&gt;åŸå§‹GJKåŒ…å«çš„çŸ¥è¯†ç‚¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é—µå¯å¤«æ–¯åŸºå’Œ Minkowski sum&lt;/li&gt;
&lt;li&gt;å‘é‡æ··åˆç§¯ vector triple product&lt;/li&gt;
&lt;li&gt;2Då‰ç§¯å…¬å¼&lt;/li&gt;
&lt;li&gt;è´¨å¿ƒåæ ‡å…¬å¼&lt;/li&gt;
&lt;li&gt;ké˜¶å•çº¯å½¢ k-Simplex&lt;/li&gt;
&lt;li&gt;supporting pointå’ŒSupportå‡½æ•°&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å…¶ä¸­æœ‰å‡ ä¸ªç‚¹æ”¾åˆ°åé¢çš„ç®—æ³•å®ç°ä¸€èŠ‚å†ä»‹ç»ã€‚&lt;/p&gt;

&lt;h2&gt;&lt;div id=&quot;1.1&quot;&gt;é—µå¯å¤«æ–¯åŸºæ•°å­¦ Minkowski Math&lt;/div&gt;&lt;/h2&gt;

&lt;h3&gt;Minkowskiæ‰©å¤§è¿ç®—  &lt;a href=&quot;https://en.wikipedia.org/wiki/Minkowski_addition&quot;&gt;Minkowski Sum&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;\[ A \oplus B = \bigcup _{b \in B} A^{b}  \]&lt;/p&gt;

&lt;p&gt;å…¶ä¸­ï¼Œ\(A^{b} = \{ a + b | a \in A\}  = A + b \)ï¼Œä»£è¡¨é›†åˆAæ•´ä½“ç§»åŠ¨b&lt;/p&gt;

&lt;p&gt;ï¼ˆå¯ä»¥ç†è§£ä¸ºå‡ ä½•å½¢çŠ¶çš„Unionå¹¶é›†è¿ç®—ï¼‰&lt;/p&gt;

&lt;h3&gt;Minkowskiæ”¶ç¼©è¿ç®—&lt;/h3&gt;

&lt;p&gt;\[ A \ominus B = \bigcap _{b \in B} A^{-b}  \]&lt;/p&gt;

&lt;p&gt;å…¶ä¸­ï¼Œ\(A^{-b} = \{ a - b | a \in A\}  = A - b \)ï¼Œä»£è¡¨é›†åˆAæ•´ä½“ç§»åŠ¨-b&lt;/p&gt;

&lt;p&gt;ï¼ˆå¯ä»¥ç†è§£ä¸ºå‡ ä½•å½¢çŠ¶çš„Intersectäº¤é›†è¿ç®—ï¼‰&lt;/p&gt;

&lt;h3&gt;Minkowskiå‡æ³•è¿ç®—ï¼ˆMinkowskiå·®)&lt;/h3&gt;

&lt;p&gt;\[ A - B =  A \oplus (-B)  \]&lt;/p&gt;

&lt;p&gt;è¿™æ¡å…¬å¼æ‰æ˜¯çœŸæ­£åº”ç”¨åˆ°GJKç®—æ³•é‡Œçš„å…¬å¼ã€‚&lt;/p&gt;

&lt;p&gt;å¯ä»¥ç†è§£ä¸ºBå…ˆåšäº†ä¸€æ¬¡é•œåƒï¼Œç„¶åå†å’ŒAåšå¹¶é›†è¿ç®—ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥ï¼Œè¯´åˆ°GJKçš„Minkowskiè¿ç®—æ—¶ï¼Œå¯ä»¥å«Minkowskiå’Œï¼Œä¹Ÿå¯ä»¥å«Minkowskiå·®ã€‚anywayã€‚&lt;/p&gt;

&lt;h2&gt;å‘é‡æ··åˆç§¯ Vector Triple Product&lt;/h2&gt;

&lt;p&gt;æ›¾ç»ï¼Œæˆ‘åœ¨æˆ‘çš„&lt;a href=&quot;http://127.0.0.1:4000/triangle-intersect/&quot;&gt;ç”¨çº¿æ€§ä»£æ•°çŸ¥è¯†è§£å†³å…‰çº¿å’Œä¸‰è§’å½¢çš„äº¤ç‚¹é—®é¢˜&lt;/a&gt;ä¸€æ–‡ä¸­æåˆ°äº†ä¸€ä¸ªæ•°å­¦å…¬å¼ï¼Œå«&lt;strong&gt;æ ‡é‡æ··åˆç§¯(Scalar Triple Product)&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;p&gt;è€Œåœ¨GJKä¸­ï¼Œéœ€è¦ç”¨åˆ°ç›¸ä¼¼çš„å¦ä¸€ä¸ªä¸œè¥¿â€”â€”&lt;strong&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Triple_product&quot;&gt;å‘é‡æ··åˆç§¯(Vector Triple Product)&lt;/a&gt;&lt;/strong&gt;, åŒæ—¶ä¹Ÿè¢«ç§°ä¸º&lt;strong&gt;BAC-CABç‰¹æ€§&lt;/strong&gt;:&lt;/p&gt;

&lt;p&gt;\[ A\times (B\times C) = B(A\cdot C) - C(A\cdot B) \]&lt;/p&gt;

&lt;p&gt;\[ (A\times B)\times C = -C\times (A\times B) \]&lt;/p&gt;

&lt;p&gt;\[ (A\times B)\times C = B(A\cdot C) - A(B\cdot C)  \]&lt;/p&gt;

&lt;p&gt;Proof: &lt;a href=&quot;https://en.wikipedia.org/wiki/Triple_product#Proof&quot;&gt;https://en.wikipedia.org/wiki/Triple_product#Proof&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;GJKä½¿ç”¨çš„ç¬¬ä¸‰æ¡å…¬å¼ã€‚&lt;/p&gt;

&lt;h2&gt;&lt;div id=&quot;1.2&quot;&gt;å•çº¯å½¢ &lt;a href=&quot;https://en.wikipedia.org/wiki/Simplex&quot;&gt;Simplex&lt;/a&gt;&lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;æŒ‰ç…§wikiçš„è§£é‡Šï¼Œké˜¶å•çº¯å½¢ï¼ŒæŒ‡çš„æ˜¯kç»´ç©ºé—´ä¸­çš„å¤šèƒå½¢ï¼Œä¸”å¤šèƒå½¢æ˜¯k+1ä¸ªé¡¶ç‚¹ç»„æˆçš„å‡¸åŒ…ã€‚æ ¹æ®è¿™ä¸ªå®šä¹‰å‡ºå‘ï¼Œå°±å¯ä»¥ç†è§£GJKç®—æ³•ä¸­ä¼šæåˆ°çš„å„ç§Simplexæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼š&lt;/p&gt;

&lt;h3&gt;0é˜¶å•çº¯å½¢ 0-Simplex&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/3.png&quot; alt=&quot;3.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;æ ¹æ®å‰é¢çš„å®šä¹‰ï¼Œ0é˜¶å•çº¯å½¢æ˜¯0ç»´ç©ºé—´ä¸‹çš„0+1=1ä¸ªé¡¶ç‚¹ç»„æˆçš„å‡¸åŒ…ï¼Œæ˜¾ç„¶åªèƒ½æ˜¯ä¸€ä¸ªç‚¹ã€‚&lt;/p&gt;

&lt;h3&gt;1é˜¶å•çº¯å½¢ 1-Simplex&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/4.png&quot; alt=&quot;4.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;1é˜¶å•çº¯å½¢ï¼Œ1ç»´ç©ºé—´ï¼Œ1+1=2ä¸ªé¡¶ç‚¹ï¼Œæ‰€ä»¥å°±æ˜¯ä¸€æ¡ç›´çº¿ï¼ˆ1ç»´ç©ºé—´ï¼‰ä¸Šçš„ä¸€ä¸ªçº¿æ®µã€‚&lt;/p&gt;

&lt;h3&gt;2é˜¶å•çº¯å½¢ 2-Simplex&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/5.png&quot; alt=&quot;5.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;2é˜¶å•çº¯å½¢ï¼Œ2ç»´ç©ºé—´ï¼Œ2+1=3ä¸ªé¡¶ç‚¹ï¼Œæ‰€ä»¥å°±æ˜¯ä¸€ä¸ªå¹³é¢ï¼ˆ2ç»´ç©ºé—´ï¼‰ä¸Šçš„ä¸€ä¸ªä¸‰è§’å½¢ï¼Œä¸‰è§’å½¢æˆ‘ä»¬å°±ç†Ÿæ‚‰äº†ï¼Œæ˜¾ç„¶æ˜¯ä¸€ä¸ªå‡¸åŒ…æ— è¯¯ã€‚&lt;/p&gt;

&lt;h3&gt;3é˜¶å•çº¯å½¢ 3-Simplex&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/6.png&quot; alt=&quot;6.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;3é˜¶å•çº¯å½¢ï¼Œ3ç»´ç©ºé—´ï¼Œ3+1=4ä¸ªé¡¶ç‚¹ï¼Œæ‰€ä»¥å°±æ˜¯3ç»´ç«‹ä½“ç©ºé—´é‡Œçš„ä¸€ä¸ªå››é¢ä½“(tetrahedron)ï¼Œæ˜¾ç„¶ä¹Ÿæ˜¯ä¸€ä¸ªå‡¸åŒ…ã€‚&lt;/p&gt;

&lt;h3&gt;k&amp;gt;3é˜¶å•çº¯å½¢&lt;/h3&gt;

&lt;p&gt;æˆ‘æƒ³è¯»è€…åšçš„éƒ½æ˜¯2Dæˆ–3Dçš„é¡¹ç›®ï¼Œ2Dé¡¹ç›®æœ€å¤šç”¨åˆ°2-Simplexï¼Œ3Dé¡¹ç›®æœ€å¤šç”¨åˆ°3-Simplexã€‚k&amp;gt;3çš„Simplexï¼Œå¿½ç•¥å§ã€‚&lt;/p&gt;

&lt;h1&gt;&lt;div id=&quot;2&quot;&gt;GJKç®—æ³•åŸç†&lt;/div&gt;&lt;/h1&gt;

&lt;p&gt;GJKç®—æ³•ï¼Œæœ¬è´¨å°±æ˜¯åˆ©ç”¨Minkowskiå·®æ¥åˆ¤æ–­2ä¸ªå‡ ä½•ä½“æœ‰æ²¡ç¢°æ’ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸ºå¦‚æœç¢°æ’äº†ï¼Œé‚£ä¹ˆ2ä¸ªå‡ ä½•ä½“è‡³å°‘åŒ…å«äº†åŒä¸€ä¸ªç‚¹ï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä»¬çš„Minkowskiå·®å¿…ç„¶åŒ…å«åŸç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;æ˜ç™½è¿™ä¸€ç‚¹åï¼ŒGJKå…¶å®å°±å·²ç»å­¦åˆ°å¤§åŠäº†ã€‚&lt;/p&gt;

&lt;h2&gt;&lt;div id=&quot;2.1&quot;&gt;åˆ’é‡ç‚¹ï¼šæ¥è‡ªwikiçš„GJKä¼ªä»£ç &lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;ç»è¿‡æŸ¥é˜…å¤§é‡èµ„æ–™ï¼Œå‘ç°è¿˜æ˜¯wikiå¯¹GJKçš„è§£é‡Šä¸€è¯­ä¸­çš„ï¼Œæ‰€ä»¥ä¸‹é¢ä»‹ç»ä¸‹wikiç»™å‡ºçš„GJKä¼ªä»£ç ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-js&quot; data-lang=&quot;js&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;GJK_intersection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;shape&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;shape&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;vector&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;vector&lt;/span&gt;  &lt;span class=&quot;nx&quot;&gt;A&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Support&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Support&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;simplex&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;A&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;A&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Support&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Support&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;nx&quot;&gt;reject&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;âˆª&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;A&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;contains_origin&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;NearestSimplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;contains_origin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;nx&quot;&gt;accept&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;è¿™ä»½ä»£ç å‡†ç¡®æè¿°äº†&lt;strong&gt;åŸå§‹&lt;/strong&gt;GJKçš„æ ¸å¿ƒé€»è¾‘ï¼š&lt;strong&gt;åªéœ€è¦è¾“å…¥2ä¸ªshapeå’Œä¸€ä¸ªåˆå§‹æ–¹å‘ï¼Œå°±èƒ½å‘Šè¯‰ä½ è¿™2ä¸ªshapeæœ‰æ²¡ç¢°æ’&lt;/strong&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;åˆ†åˆ«æ²¿ç€åˆå§‹æ–¹å‘Då’Œåæ–¹å‘-Dï¼Œæ±‚å‡ºpå’Œqçš„supporting pointï¼Œå¹¶è®¡ç®—Minkowskiå·®ï¼Œå¾—åˆ°å‘é‡Aã€‚&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;æŠŠAè¾“å…¥å•çº¯å½¢sï¼Œæ­¤æ—¶å•çº¯å½¢ä¸º0-simplex (å¦‚æœä½ ä¸çŸ¥é“æ˜¯ä»€ä¹ˆï¼Œè¯´æ˜æ²¡çœ‹ä¸Šæ–‡)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Dé‡æ–°è®¾ç½®ä¸º-A (è¿™ä¸€æ­¥æ“ä½œä¸æ˜¯å¾ˆå…³é”®ï¼Œå¯ä»¥ä¸æ·±ç©¶ä¸ºä»€ä¹ˆ)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;è¿›å…¥å¾ªç¯:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;åŒæ­¥éª¤1ç±»ä¼¼ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªMinkowskiå·®ï¼Œå¹¶ä¾ç„¶èµ‹å€¼ç»™Aï¼ˆè¿™é‡Œè¦æ³¨æ„åˆ°ï¼ŒAæ°¸è¿œæ˜¯æœ€æ–°è®¡ç®—å¾—åˆ°çš„Minkowskiå·®å‘é‡ï¼‰&lt;/li&gt;
&lt;li&gt;åˆ¤æ–­Aå’ŒDçš„ç‚¹ç§¯æ˜¯å¦å°äº0ï¼Œå®é™…ä¸Šå°±æ˜¯åˆ¤æ–­Aå’ŒDçš„å¤¹è§’æ˜¯ä¸æ˜¯å¤§äº90åº¦ã€‚æˆ–è€…æ¢å¥è¯è¯´ï¼ŒAåœ¨Dæ–¹å‘ä¸Šçš„æŠ•å½±è·ç¦»ï¼Œæ˜¯å¦å°äº0ï¼Œå°äº0è¯´æ˜æŠ•å½±åœ¨äº†Dçš„åæ–¹å‘ä¸Šã€‚æ‰€ä»¥ï¼Œå¦‚æœç‚¹ç§¯å°äº0ï¼Œè¯´æ˜ä¸èƒ½åœ¨DOæ–¹å‘ä¸Šæ‰¾åˆ°ç¦»åŸç‚¹Originæ›´è¿‘çš„Minkowskiå·®é¡¶ç‚¹ï¼Œè¿™ä¸ªAè¢«rejectï¼ŒGJKè¿”å›falseï¼Œ2ä¸ªshapeæ²¡æœ‰ç¢°æ’ã€‚&lt;/li&gt;
&lt;li&gt;åˆ°äº†è¿™é‡Œï¼Œè¯´æ˜æ–°çš„Aç¦»åŸç‚¹æ›´è¿‘äº†ï¼Œé‚£ä¹ˆæŠŠAåŠ è¿›å•çº¯å½¢ï¼Œæ­¤æ—¶å•çº¯å½¢å«æœ‰2ä¸ªé¡¶ç‚¹ï¼Œæ‰€ä»¥æ˜¯1-simplex&lt;/li&gt;
&lt;li&gt;ç»è¿‡NearestSimplexè¿‡æ»¤ï¼Œå¾—åˆ°æ–°çš„å•çº¯å½¢sï¼Œä»¥åŠæ›´æ–°äº†æ–¹å‘å‘é‡Dï¼Œcontains_originè¡¨ç¤ºè¿™ä¸ªå•çº¯å½¢æ˜¯å¦åŒ…å«åŸç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœcontains_originä¸ºtrueï¼Œé‚£ä¹ˆè¯´æ˜2ä¸ªshapeé‡Œåˆ†åˆ«å­˜åœ¨2ä¸ªç‚¹ï¼Œåæ ‡ç›¸åŒï¼Œä½¿å¾—Minkowskiå·®ä¸º0ï¼ˆåŸç‚¹ï¼‰ï¼Œä¹Ÿå°±æ„å‘³ç€2ä¸ªshapeå‘ç”Ÿäº†ç¢°æ’ï¼ŒGJKè¿”å›trueã€‚&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;ä¸‹é¢ç« èŠ‚ç»§ç»­ä»‹ç»ä¼ªä»£ç é‡Œå‡ºç°çš„&lt;strong&gt;Supportå’ŒNearestSimplexå‡½æ•°&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;h2&gt;&lt;div id=&quot;2.2&quot;&gt;Supportå‡½æ•°&lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;åœ¨ä¸åŒçš„èµ„æ–™ä¸­ï¼ŒSupportå‡½æ•°å¯èƒ½æœ‰ä¸åŒçš„å®šä¹‰ï¼Œå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Point support(Shape&amp;amp; shape, Vector&amp;amp; d)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Point support(Shape&amp;amp; shape1, Shape&amp;amp; shape2, Vector&amp;amp; d)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¯ä»¥æŠŠä¸Šé¢çš„ç¬¬äºŒä¸ªsupportæ”¹åä¸ºsupprot2ï¼Œæ–¹ä¾¿åŒºåˆ†ã€‚supprot2å…¶å®æ˜¯å¯¹supprotçš„ä¸€å±‚å°è£…ã€‚&lt;/p&gt;

&lt;p&gt;å…ˆä»‹ç»supportã€‚ç”¨ä¼ªä»£ç è¡¨ç¤ºï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// wikiï¼šreturns the point on shape which has the highest dot product with d&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å³æ‰¾å‡ºshapeé‡Œçš„ä¸€ä¸ªç‚¹ï¼ŒæŠŠè¿™ä¸ªç‚¹æŠ•å½±åˆ°dæ–¹å‘å‘é‡ä¸Šï¼Œå®ƒç¦»åŸç‚¹çš„è·ç¦»æœ€å¤§ï¼ˆè¦åŒºåˆ†æ­£è´Ÿï¼‰&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;support&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Shape&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// å…·ä½“å®ç°å¯ä»¥è‡ªè¡Œè®¾è®¡ï¼Œè¿™é‡Œå±•ç¤ºçš„æ˜¯æš´åŠ›éå†ç®—æ³•ï¼Œbrute-force&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;VertexID&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FirstVertex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;REAL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vertices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;REAL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vertices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxv&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;maxv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;maxp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vertices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;supportçš„è¿”å›å€¼ï¼Œå°±æ˜¯æ‰€è°“çš„supporting pointã€‚&lt;/p&gt;

&lt;p&gt;æœ‰äº†supportï¼Œå°±å¯ä»¥å®ç°supprot2äº†ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// ç»™å®š2ä¸ªé™æ€å‡ ä½•å½¢çŠ¶å’Œä¸€ä¸ªæ–¹å‘å‘é‡ï¼Œæ±‚å‡ºç»è¿‡Minkowskiå‡æ³•è¿ç®—å¾—åˆ°çš„ç‚¹ï¼ˆå”¯ä¸€ï¼‰&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;support2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Shape&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Shape&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// æ²¿ç€dæ–¹å‘æ‰¾å‡ºshape1ä¸­æœ€è¿œçš„ç‚¹p1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;support&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// æ²¿ç€-dæ–¹å‘æ‰¾å‡ºshape2ä¸­æœ€è¿œçš„ç‚¹p2&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;support&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Minkowskiå‡æ³•è¿ç®—ï¼ˆå…¶å®åªæ˜¯æ™®é€šçš„å‘é‡è¿ç®—ï¼‰&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// p3åˆšå¥½å°±è½åœ¨shape1ã€shape2é—µå¯å¤«æ–¯åŸºå·®çš„å‡¸åŒ…çš„è¾¹ä¸Š&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;&lt;div id=&quot;2.3&quot;&gt;NearestSimplexå‡½æ•°&lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;wiki:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;takes a simplex &lt;strong&gt;s&lt;/strong&gt; and returns the simplex on &lt;strong&gt;s&lt;/strong&gt; closest to the origin, and a direction toward the origin normal to the new simplex. If &lt;strong&gt;s&lt;/strong&gt; itself contains the origin, &lt;strong&gt;NearestSimplex&lt;/strong&gt; accepts &lt;strong&gt;s&lt;/strong&gt; and the two shapes are determined to intersect.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;NearestSimplexå¾ˆä¸å‡¡ï¼Œåšäº†å¾ˆå¤šäº‹æƒ…ã€‚ä¸€æ˜¯NearestSimplexå¯ä»¥åˆ¤å®š2ä¸ªshapeæ˜¯å¦ç¢°æ’ï¼›äºŒæ˜¯æ›´æ–°å•çº¯å½¢sï¼›ä¸‰æ˜¯ç»™å‡ºæ–°çš„è¿­ä»£æ–¹å‘dã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;è¦åˆ¤å®š2ä¸ªshapeæ˜¯å¦ç¢°æ’ï¼Œæœ‰å‰ææ¡ä»¶ï¼š&lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
&lt;li&gt;å¯¹äº2Dç©ºé—´ï¼Œå•çº¯å½¢séœ€æ˜¯2-simplexï¼Œå³sè¦å«æœ‰3ä¸ªé¡¶ç‚¹ï¼Œæ‰èƒ½åˆ¤æ–­sæ˜¯å¦åŒ…å«åŸç‚¹originï¼›&lt;/li&gt;
&lt;li&gt;å¯¹äº3Dç©ºé—´ï¼Œå•çº¯å½¢séœ€æ˜¯3-simplexï¼Œå³sè¦å«æœ‰4ä¸ªé¡¶ç‚¹ï¼Œæ„æˆä¸€ä¸ª4é¢ä½“ï¼Œæ‰èƒ½åˆ¤æ–­sæ˜¯å¦åŒ…å«åŸç‚¹originã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ‰€ä»¥æ‰§è¡Œåˆ°NearestSimplexæ—¶ï¼Œå¦‚æœsé‡Œåªæœ‰ä¸åˆ°3ä¸ªé¡¶ç‚¹çš„è¯ï¼Œè‚¯å®šä¸ç®—ç¢°æ’ã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;æ›´æ–°å•çº¯å½¢ï¼Œç›®çš„æ˜¯ä¿è¯sæ»¡è¶³k-simplexçš„å®šä¹‰ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;ä¾‹å¦‚åœ¨2Dç©ºé—´ï¼Œå››è¾¹å½¢å¹¶ä¸æ˜¯2-simplexï¼Œä¸‰è§’å½¢æ‰æ˜¯2-simplexã€‚å‡è®¾såŒ…å«4ä¸ªé¡¶ç‚¹çš„æ—¶å€™ï¼Œå°±éœ€è¦å»æ‰1ä¸ªé¡¶ç‚¹ï¼Œæ‰èƒ½æ„æˆ2-simplexã€‚&lt;/p&gt;

&lt;p&gt;å¯¹äºNearestSimplexå‡½æ•°ï¼Œå®ƒæœ‰ä¸€äº›å°åŠ¨ä½œã€‚ä»¥2Dç©ºé—´ä¸ºä¾‹ï¼š&lt;/p&gt;

&lt;p&gt;å› ä¸ºæ„æˆ2-simplexä»…éœ€è¦3ä¸ªé¡¶ç‚¹ï¼Œå¦‚æœæœ€æ–°pushè¿›sçš„ç‚¹ï¼Œæ„æˆçš„2-simplexå¹¶æ²¡æœ‰åŒ…å«åŸç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä¸¢å¼ƒsé‡Œçš„ä¸Šä¸Šä¸ªé¡¶ç‚¹ï¼Œä½¿å¾—sé€€åŒ–åˆ°1-simplexï¼Œå³sæ˜¯ä¸€æ¡çº¿æ®µã€‚&lt;/p&gt;

&lt;p&gt;è€Œå¦‚æœæ„æˆçš„2-simplexåŒ…å«äº†åŸç‚¹ï¼ŒGJK_intersectionå°±å¯ä»¥ç›´æ¥è¿”å›trueäº†ã€‚æ‰€ä»¥å°±æ˜¯è¯´ï¼Œ&lt;strong&gt;så˜æˆ2-simplexçš„æ—¶å€™ï¼Œå°±æ˜¯GJK_intersectionè¿”å›trueçš„æ—¶å€™&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;p&gt;è€Œå› ä¸ºç®—æ³•çš„æµç¨‹è®¾è®¡ï¼Œæ‰§è¡Œåˆ°NearestSimplexçš„æ—¶å€™ï¼Œså¿…ç„¶èµ·ç å«æœ‰2ä¸ªé¡¶ç‚¹ã€‚ç»¼ä¸Šï¼ŒNearestSimplexè¿”å›çš„så¿…ç„¶æ˜¯2-simplexæˆ–1-simplexï¼Œè€Œä¸å¯èƒ½æ˜¯0-simplexã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;æ–°çš„è¿­ä»£æ–¹å‘d&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ ¹æ®ç¬¬äºŒç‚¹ï¼Œå¦‚æœsä¸èƒ½æ„æˆ2-simplexï¼ˆæ²¡æœ‰ç¢°æ’ï¼‰ï¼Œå°±è¿˜éœ€è¦ç»§ç»­è¿­ä»£ã€‚&lt;/p&gt;

&lt;p&gt;æ–°çš„è¿­ä»£æ–¹å‘æ˜¯1-simplexé‡Œçš„2ä¸ªé¡¶ç‚¹æ„æˆçš„çº¿æ®µçš„æ³•å‘é‡ã€‚&lt;/p&gt;

&lt;p&gt;æ³•å‘é‡æ–¹å‘æœ‰2ä¸ªï¼Œéœ€è¦é€‰æ‹©æœå‘originçš„é‚£ä¸€ä¾§çš„æ³•å‘ã€‚&lt;/p&gt;

&lt;h1&gt;&lt;div id=&quot;3&quot;&gt;äºŒç»´å¹³é¢çš„GJKç®—æ³•å®ç°&lt;/div&gt;&lt;/h1&gt;

&lt;p&gt;ä¸ºäº†å­¦åˆ°çœŸæ­£é è°±çš„GJKç®—æ³•ï¼Œæ‰€ä»¥ä¸‹é¢ä½¿ç”¨Box2Dçš„b2Distanceå‡½æ•°ï¼Œä½œä¸ºå­¦ä¹ å¯¹è±¡ã€‚ï¼ˆæ‰¾åˆ°çš„å…¶ä»–GJKä»£ç éƒ½è§‰å¾—å¥‡å¥‡æ€ªæ€ªçš„ï¼‰&lt;/p&gt;

&lt;p&gt;b2Distanceä¸ä»…å®ç°äº†GJKç®—æ³•ï¼Œè¿˜å®ç°äº†Simplex Cacheæœºåˆ¶ï¼Œå³æ”¯æŒæ—¶é—´ç›¸å¹²æ€§ï¼Œä»è€Œæå‡è®¡ç®—æ•ˆç‡ã€‚&lt;/p&gt;

&lt;p&gt;ä¸è¿‡æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œb2Distanceä¸ä¸€å®šèƒ½ç›´æ¥æ”¹æˆæ”¯æŒ3Dï¼Œå› ä¸ºç”¨åˆ°äº†ä¸€äº›2Då‡ ä½•å…¬å¼ï¼Œä¾‹å¦‚b2Crossã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢å°†ç²¾ç®€b2Distanceä»£ç ï¼ˆå»æ‰äº†Simplex Cacheã€input-&amp;gt;useRadiiç­‰ï¼‰ï¼Œåªä¿ç•™å’ŒGJKç›¸å…³çš„ï¼Œæ¥æ–¹ä¾¿è¯»è€…ç†è§£b2Distanceã€‚&lt;/p&gt;

&lt;h2&gt;&lt;div id=&quot;3.1&quot;&gt;b2Distanceæ ¸å¿ƒé€»è¾‘&lt;/div&gt;&lt;/h2&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c++&quot; data-lang=&quot;c++&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;b2Distance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b2DistanceOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;b2SimplexCache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2DistanceInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2DistanceProxy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proxyA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;proxyA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2DistanceProxy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proxyB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;proxyB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;b2Transform&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transformA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transformA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Transform&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transformB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transformB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// å•çº¯å½¢ç±»å®ä¾‹ï¼&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Simplex&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;b2SimplexVertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertices&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_maxIters&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// saveAã€saveBã€saveCountä¿å­˜ä¸Šä¸€è½®è¿­ä»£çš„ç»“æœï¼Œç”¨æ¥é˜²æ­¢è¿›å…¥æ­»å¾ªç¯&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saveA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saveB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saveCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„GJKè¿­ä»£loopäº†&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_maxIters&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;saveCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saveCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;saveA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;saveB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// æ ¹æ®å½“å‰çš„å•çº¯å½¢æ‹¥æœ‰çš„é¡¶ç‚¹æ•°é‡ï¼Œé€‰æ‹©ä¸åŒçš„å¤„ç†æµç¨‹&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Solve2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Solve3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;b2Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// å•çº¯å½¢å·²ç»æœ‰3ä¸ªé¡¶ç‚¹ï¼Œè¯´æ˜åŸç‚¹å·²ç»åœ¨å•çº¯å½¢é‡Œé¢äº†&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// æ ¹æ®sè®¡ç®—æ–°çš„æœç´¢æ–¹å‘d&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetSearchDirection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;


        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LengthSquared&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2_epsilon&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2_epsilon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// dçš„é•¿åº¦å‡ ä¹ç­‰äº0ï¼Œè¯´æ˜å½“å‰çš„å•çº¯å½¢å¾ˆå¯èƒ½å·²ç»åŒ…å«åŸç‚¹äº†&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// å¯èƒ½æ˜¯sçš„ä¸€æ¡è¾¹å‹åˆ°ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸‰è§’å½¢åŒºåŸŸåŒ…å«äº†åŸç‚¹&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;// å°½ç®¡å¾ˆå¯èƒ½å‡ ä½•ä½“é‡å äº†ï¼Œä½†ä¸èƒ½è®¤ä¸ºå‡ ä½•ä½“ä¹‹é—´çš„è·ç¦»ä¸º0&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// å› ä¸ºsimplexä»…åŒ…å«1æˆ–2ä¸ªé¡¶ç‚¹ï¼Œè¿™æ—¶å€™ä¼šé‡åˆ°æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼Œ&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// å¾ˆéš¾åˆ¤æ–­è¿™2ä¸ªå‡ ä½•ä½“æ˜¯ç¢°æ’äº†è¿˜æ˜¯è·ç¦»éå¸¸è¿‘&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—ä¸‹ä¸€ä¸ªMinkowskiå·®vertex&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// simplexé‡Œçš„è¦è¢«å†™å…¥çš„é¡¶ç‚¹&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;b2SimplexVertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertices&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// åˆ†åˆ«å¯¹2ä¸ªå‡ ä½•ä½“è°ƒç”¨supportå‡½æ•°&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proxyA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetSupport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b2MulT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transformA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transformA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proxyA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetVertex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proxyB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetSupport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b2MulT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transformB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transformB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proxyB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetVertex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Minkowskiå·® &lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; 

        &lt;span class=&quot;c1&quot;&gt;// iterçš„å€¼ç­‰åŒäºè¢«è®¡ç®—å‡ºæ¥çš„support pointæ•°é‡&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// åˆ¤æ–­æ˜¯å¦é‡å¤ï¼Œä¹Ÿæ˜¯é€€å‡ºè¿™ä¸ªå¾ªç¯çš„ä¸»è¦æ¡ä»¶&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;duplicate&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saveCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saveA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indexB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saveB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;duplicate&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;duplicate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// åˆ°äº†è¿™é‡Œè¯´æ˜æ–°çš„vertexç¬¦åˆæœŸæœ›&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—witness pointï¼Œä¸‹ä¸€ç¯‡GJKæ–‡ç« å†ä»‹ç»&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// æ€»ä¹‹pointA pointBæ˜¯è·ç¦»åŸç‚¹æœ€è¿‘çš„Minkowskiå·®(ä¸€ä¸ªé¡¶ç‚¹)å¯¹åº”çš„2ä¸ªç‚¹&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetWitnessPoints&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pointA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pointB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// è¿™é‡Œè°ƒç”¨çš„æ˜¯é‡è½½å‡½æ•°&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// distanceå­˜å‚¨äº†pointA pointBä¹‹é—´çš„å·®å€¼ï¼ˆ&amp;gt;=0)&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// distanceå°äºä¸€ä¸ªé¢„æœŸé˜ˆå€¼æ—¶ï¼Œå°±è®¤ä¸ºè¿™2ä¸ªå‡ ä½•ä½“å‘ç”Ÿç¢°æ’&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;distance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Distance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pointA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pointB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; 
    &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iterations&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// ç¼“å­˜&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;simplex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WriteCache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ä¸‹é¢ç»§ç»­ä»‹ç»è¿™æ®µä»£ç é‡Œå‡ºç°çš„GetSearchDirectionã€Solve2ã€Solve3ã€GetSupportå‡½æ•°ã€‚&lt;/p&gt;

&lt;h2&gt;&lt;div id=&quot;3.2&quot;&gt;b2Simplex::GetSearchDirection&lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;æ ¹æ®ç®—æ³•ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œåˆ°GetSearchDirectionæ—¶ï¼Œå•çº¯å½¢é¡¶ç‚¹æ•°åªèƒ½æ˜¯1æˆ–2ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœé¡¶ç‚¹æ•°ä¸º1ï¼Œä¸‹ä¸ªæœç´¢æ–¹å‘å°±æ˜¯è¯¥é¡¶ç‚¹å‘é‡çš„åæ–¹å‘ã€‚so easyã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœé¡¶ç‚¹æ•°ä¸º2ï¼Œéœ€è¦åˆ¤æ–­åŸç‚¹åœ¨\( e_{12} \)çš„å“ªä¸€ä¾§ï¼Œå¹¶è®¡ç®—æœå‘é‚£ä¸€ä¾§çš„å‚ç›´äºw1w2çš„å‘é‡ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªé—®é¢˜çš„è§£å†³ï¼Œéœ€è¦ç”¨åˆ°2Då‰ç§¯å…¬å¼ã€‚è¯»è€…å¯èƒ½ä¸æ¸…æ¥šè¿™æ˜¯ä»€ä¹ˆä½†æ²¡å…³ç³»ã€‚ç°å…ˆä»3Då‰ç§¯å…¬å¼è¯´èµ·ã€‚&lt;/p&gt;

&lt;p&gt;å‰ç§¯(&lt;a href=&quot;https://en.wikipedia.org/wiki/Cross_product&quot;&gt;cross product&lt;/a&gt;)è¿ç®—\( \times \)ï¼Œæœ¬æ˜¯3Dç©ºé—´ç‰¹æœ‰çš„ä¸€ç§å‘é‡äºŒå…ƒè¿ç®—ã€‚æ‰§è¡Œ\( \mathbf a \times \mathbf b \)ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªåŒæ—¶å’Œ\( \mathbf a ã€ \mathbf b \)æ­£äº¤çš„å‘é‡\( \mathbf c\)ï¼Œ\( \mathbf c\)çš„æ–¹å‘å¯ä»¥æŒ‰å³æ‰‹è§„åˆ™æ¨çŸ¥ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/10.png&quot; alt=&quot;10.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;å¯æŠŠ\( \mathbf a ã€ \mathbf b \)ç”¨æ ‡å‡†åŸº&lt;a href=&quot;https://en.wikipedia.org/wiki/Standard_basis&quot;&gt;Standard basis&lt;/a&gt; \( \mathbf iã€  \mathbf j ã€ \mathbf k\)è¡¨ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;\[ \mathbf a = u_1 \mathbf i + u_2 \mathbf j + u_3 \mathbf k \]&lt;/p&gt;

&lt;p&gt;\[ \mathbf b = v_1 \mathbf i + v_2 \mathbf j + v_3 \mathbf k \]&lt;/p&gt;

&lt;p&gt;æ­¤æ—¶ï¼Œ\( \mathbf a ã€ \mathbf b \)çš„å‰ç§¯å¯ä»¥ç”¨çŸ©é˜µç§©(determinant)è¡¨ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;\[ \mathbf a \times \mathbf b =    \left| \begin{matrix} \mathbf i \  \mathbf j \  \mathbf k \\  u_1 \   u_2 \  u_3 \\  v_1 \  v_2 \  v_3\\ \end{matrix} \right|  \]&lt;/p&gt;

&lt;p&gt;å±•å¼€è¿™ä¸ªå¼å­ï¼Œå¾—åˆ°å‘é‡å½¢å¼çš„å…¬å¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ \mathbf a \times \mathbf b =    \left| \begin{matrix} u_2 \  u_3 \\  v_2 \  v_3\\ \end{matrix} \right|  \mathbf i -    \left| \begin{matrix} u_1 \  u_3 \\  v_1 \  v_3\\ \end{matrix} \right|  \mathbf j +    \left| \begin{matrix} u_1 \  u_2 \\  v_1 \  v_2\\ \end{matrix} \right|  \mathbf k  \]&lt;/p&gt;

&lt;p&gt;å¯¹äº2Dç©ºé—´ä¸‹çš„\( \mathbf a ã€ \mathbf b \)ï¼Œå¯è®¤ä¸ºå®ƒä»¬æ˜¯zåˆ†éƒ¨ä¸º0çš„3Då‘é‡ï¼Œä»è€Œå¯ä»¥å¥—è¿›ä¸Šè¿°å…¬å¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ \mathbf a = u_1 \mathbf i + u_2 \mathbf j + 0 \mathbf k \]&lt;/p&gt;

&lt;p&gt;\[ \mathbf b = v_1 \mathbf i + v_2 \mathbf j + 0 \mathbf k \]&lt;/p&gt;

&lt;p&gt;\[ \mathbf a \times \mathbf b =    \left| \begin{matrix} u_2 \  u_3 \\  v_2 \  v_3\\ \end{matrix} \right|  \mathbf i -    \left| \begin{matrix} u_1 \  u_3 \\  v_1 \  v_3\\ \end{matrix} \right|  \mathbf j +    \left| \begin{matrix} u_1 \  u_2 \\  v_1 \  v_2\\ \end{matrix} \right|  \mathbf k  \]&lt;/p&gt;

&lt;p&gt;\[ = 0\mathbf i - 0\mathbf j +    \left| \begin{matrix} u_1 \  u_2 \\  v_1 \  v_2\\ \end{matrix} \right|  \mathbf k \]&lt;/p&gt;

&lt;p&gt;\[ =    \left| \begin{matrix} u_1 \  u_2 \\  v_1 \  v_2\\ \end{matrix} \right| \]&lt;/p&gt;

&lt;p&gt;\[ = u_1 v_2 - u_2 v_1 \]&lt;/p&gt;

&lt;p&gt;æœ€åä¸€æ­¥ç”¨åˆ°äº†2é˜¶çš„determinantå…¬å¼(&lt;a href=&quot;https://en.wikipedia.org/wiki/Determinant&quot;&gt;from wiki&lt;/a&gt;) ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/9.png&quot; alt=&quot;9.png&quot;&gt;  &lt;/p&gt;

&lt;p&gt;è¿™å°±æ˜¯æ‰€è°“çš„2Då‰ç§¯å…¬å¼äº†ï¼Œå…¶å®åªæ˜¯3Då‰ç§¯çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚&lt;/p&gt;

&lt;p&gt;2Då‰ç§¯å…¬å¼æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿè¯·æ³¨æ„ï¼Œ2Då‰ç§¯åå¾—åˆ°çš„æ˜¯ä¸€ä¸ªæ ‡é‡sã€‚è¿™ä¸ªæ ‡é‡çš„æ­£è´Ÿå·ï¼Œå°±å‘Šè¯‰äº†æˆ‘ä»¬\( \mathbf a \times \mathbf b \)å¾—åˆ°çš„å‘é‡( \( 0\mathbf i - 0\mathbf j + s\mathbf k \) )åœ¨zè½´ä¸Šçš„æœå‘ã€‚&lt;/p&gt;

&lt;p&gt;ä½†çŸ¥é“æœå‘ååˆæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿè¿™æ—¶ï¼Œè¦ç»“åˆå³æ‰‹åæ ‡ç³»æ¥ç†è§£ï¼ˆå¯å›é¡¾ä¸‹ä¸Šé¢çš„æ‰‹åŠ¿å›¾ï¼‰ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;å½“æ ‡é‡sç¬¦å·ä¸ºæ­£æ—¶ï¼Œæ ¹æ®å³æ‰‹åæ ‡ç³»è§„åˆ™ï¼Œå¯çŸ¥\( \mathbf b \)åœ¨\( \mathbf a \)çš„å·¦ä¾§ï¼ˆè®°ä½è§‚å¯Ÿè§†è§’æ˜¯ä»+zåˆ°-zï¼‰&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;å½“æ ‡é‡sç¬¦å·ä¸ºè´Ÿæ—¶ï¼Œæ ¹æ®å³æ‰‹åæ ‡ç³»è§„åˆ™ï¼Œå¯çŸ¥\( \mathbf b \)åœ¨\( \mathbf a \)çš„å³ä¾§&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç†è§£2Då‰ç§¯åï¼ŒGetSearchDirectionç†è§£èµ·æ¥å°±è½»æ¾äº†ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c++&quot; data-lang=&quot;c++&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// 2Då‰ç§¯å…¬å¼&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// è¿™2æ¡å…¬å¼å…¶å®æ˜¯ä¸ºäº†å¾—åˆ°å’Œaæ­£äº¤çš„å‘é‡ï¼Œsçš„å€¼ä¸€èˆ¬ä¸º1&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// b2Cross(a, 1.0)è¿”å›ä¸€ä¸ªåœ¨aå³ä¾§çš„æ­£äº¤å‘é‡&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// b2Cross(1.0, a)è¿”å›ä¸€ä¸ªåœ¨aå·¦ä¾§çš„æ­£äº¤å‘é‡&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;GetSearchDirection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ç›´æ¥å–w1çš„åæ–¹å‘å°±è¡Œäº†&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—2Då‰ç§¯&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sgn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sgn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; 
        &lt;span class=&quot;c1&quot;&gt;// -m_v1.wåœ¨e12å·¦ä¾§ï¼Œå³åŸç‚¹ä¹Ÿåœ¨å·¦ä¾§&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// -m_v1.wåœ¨e12å³ä¾§ï¼Œå³åŸç‚¹ä¹Ÿåœ¨å³ä¾§&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2_zero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;&lt;div id=&quot;3.3&quot;&gt;b2Simplex::Solve2&lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;Solve2ä¸»è¦ç›®çš„ï¼šæ‰¾å‡ºåŸç‚¹åœ¨å½“å‰è¿™ä¸ª1-simplexçš„å“ªä¸ªåŒºåŸŸã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼ŒåŒºåŸŸæ€»å…±æœ‰3ä¸ªï¼Œw1ã€w2ã€w12ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/8.png&quot; alt=&quot;8.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;w12å°±æ˜¯w1å’Œw2ä¸¤ä¸ªé¡¶ç‚¹å¤¹ä½çš„é‚£ç‰‡é»„è‰²ã€‚&lt;/p&gt;

&lt;p&gt;solve2çš„åŸç†æ˜¯ï¼Œé€šè¿‡æ±‚åŸç‚¹åœ¨w1w2çš„æŠ•å½±ç‚¹pï¼ˆæœ€è¿‘ç‚¹ï¼‰ï¼Œä»è€ŒçŸ¥é“åŸç‚¹å’Œçº¿æ®µw1w2çš„å…³ç³»ã€‚&lt;/p&gt;

&lt;p&gt;æŠ•å½±ç‚¹pæ—¢ç„¶åœ¨w1w2ä¸Šï¼Œé‚£ä¹ˆå¯ç”¨&lt;a href=&quot;https://en.wikipedia.org/wiki/Barycentric_coordinate_system&quot;&gt;è´¨å¿ƒåæ ‡å…¬å¼&lt;/a&gt;è¡¨ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;\[ (a_{1} + a_{2})\mathbf p = a_{1} \mathbf w_{1} + a_{2} \mathbf w_{2}  \]&lt;/p&gt;

&lt;p&gt;ä¸ºäº†å”¯ä¸€ç¡®å®šè¿™ä¸ªç‚¹pï¼Œå†åŠ å…¥é™åˆ¶æ¡ä»¶ï¼š&lt;/p&gt;

&lt;p&gt;\[ a_{1} + a_{2} = 1   \]&lt;/p&gt;

&lt;p&gt;ä¸Šå¼ç®€åŒ–ï¼š&lt;/p&gt;

&lt;p&gt;\[ \mathbf p = a_{1} \mathbf w_{1} + a_{2} \mathbf w_{2}  \]&lt;/p&gt;

&lt;p&gt;opï¼ˆå³å‘é‡\(\mathbf p\)ï¼‰å¿…ç„¶å‚ç›´äºw1w2ï¼Œæ‰€ä»¥æœ‰ï¼š&lt;/p&gt;

&lt;p&gt;\[  \mathbf e_{12} = \mathbf w_{2} - \mathbf  w_{1} \]&lt;/p&gt;

&lt;p&gt;\[ \mathbf p \cdot \mathbf e_{12} = 0\]&lt;/p&gt;

&lt;p&gt;æŠŠä¸Šé¢çš„\(\mathbf p\)ä»£å…¥ï¼Œå¾—åˆ°ï¼š&lt;/p&gt;

&lt;p&gt;\[ (a_{1} \mathbf w_{1} + a_{2} \mathbf w_{2}) \cdot \mathbf e_{12} = 0\]&lt;/p&gt;

&lt;p&gt;\[ a_{1} (\mathbf w_{1} \cdot \mathbf e_{12}) + a_{2} (\mathbf w_{2} \cdot \mathbf e_{12}) = 0\]&lt;/p&gt;

&lt;p&gt;è§£å¾—ï¼š&lt;/p&gt;

&lt;p&gt;\[ a_{1} = \frac { \mathbf w_{2} \cdot \mathbf e_{12} } { -\mathbf w_{1} \cdot \mathbf e_{12}  + \mathbf w_{2} \cdot \mathbf e_{12} } \]&lt;/p&gt;

&lt;p&gt;\[ a_{2} = \frac { -\mathbf w_{1} \cdot \mathbf e_{12} } { -\mathbf w_{1} \cdot \mathbf e_{12} + \mathbf w_{2} \cdot \mathbf e_{12} } \]&lt;/p&gt;

&lt;p&gt;è®¾:&lt;/p&gt;

&lt;p&gt;\[ d12\_2 = -\mathbf w_{1} \cdot \mathbf e_{12} \]&lt;/p&gt;

&lt;p&gt;\[ d12\_1 = \mathbf w_{2} \cdot \mathbf e_{12} \]&lt;/p&gt;

&lt;p&gt;\( a_{1} ã€ a_{2} \) å°±å¯ä»¥è¡¨ç¤ºæˆ:&lt;/p&gt;

&lt;p&gt;\[ a_1 = \frac { d12\_1 } { d12\_2  + d12\_1 } \]&lt;/p&gt;

&lt;p&gt;\[ a_2 = \frac { d12\_2 } { d12\_2 + d12\_1 } \]&lt;/p&gt;

&lt;p&gt;å› ä¸º\( a_1 ã€a_2 \)ä¹‹å’Œç­‰äº1ï¼Œæ‰€ä»¥\( a_1 ã€a_2 \)ä¸å¯èƒ½åŒæ—¶å°äº0ï¼Œå¯åˆ—å‡ºæ‰€æœ‰æƒ…å†µï¼š&lt;/p&gt;

&lt;p&gt;\(a_1 ã€a_2  \)éƒ½å¤§äº0æ—¶ï¼Œpç‚¹åœ¨çº¿æ®µw1w2é‡Œé¢ï¼›&lt;/p&gt;

&lt;p&gt;\(a_1 \) å°äº0æ—¶ï¼Œpåœ¨w2åŒºåŸŸé‡Œé¢ï¼›&lt;/p&gt;

&lt;p&gt;\(a_2 \) å°äº0æ—¶ï¼Œpåœ¨w1åŒºåŸŸé‡Œé¢ã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆåé¢2ä¸ªï¼Œä¸å¥½è§£é‡Šï¼Œæœ€å¥½è‡ªå·±ç”»å›¾ç†è§£ä¸‹ï¼‰&lt;/p&gt;

&lt;p&gt;è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸ªæ‹…å¿§ï¼šå¦‚æœd12_1ã€d12_2éƒ½å°äº0çš„è¯ï¼Œåˆ†æ¯ä¼šå°äº0ï¼Œç»“æœä¼šå¦‚ä½•ï¼Ÿ&lt;/p&gt;

&lt;p&gt;å®é™…ä¸Šæ˜¯ä¸å¯èƒ½çš„ï¼Œå¯ä»¥åè¯ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;\[ d12\_2 + d12\_1 &amp;lt; 0 \]&lt;/p&gt;

&lt;p&gt;\[ -\mathbf w_{1} \cdot \mathbf e_{12} +  \mathbf w_{2} \cdot \mathbf e_{12}  &amp;lt; 0 \]&lt;/p&gt;

&lt;p&gt;\[ ( \mathbf w_{2} - \mathbf w_{1} ) \cdot \mathbf e_{12}  &amp;lt; 0 \]&lt;/p&gt;

&lt;p&gt;\[ \mathbf e_{12} \cdot \mathbf e_{12}  &amp;lt; 0 \]&lt;/p&gt;

&lt;p&gt;\[ | \mathbf e_{12} |^{2} &amp;lt; 0 \]&lt;/p&gt;

&lt;p&gt;æ˜¾ç„¶ä¸æˆç«‹ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢å±•ç¤ºçš„Box2Dçš„Solve2ï¼Œå°±ç”¨åˆ°äº†è¯´åˆ°çš„è¿™äº›æ•°å­¦çŸ¥è¯†ã€‚å…¶ä¸­ï¼ŒSolve2ç”¨d12_2ã€d12_1çš„æ­£è´Ÿæ¥ç­‰ä»·è¡¨ç¤º\( a_1 ã€a_2 \)çš„æ­£è´Ÿã€‚&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c++&quot; data-lang=&quot;c++&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Simplex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Solve2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// w1 region&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// æ ¹æ®ä¸Šé¢çš„å…¬å¼ï¼Œå¯çŸ¥æ­¤æ—¶a2ä¹Ÿæ˜¯&amp;lt;=0&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// æ‰€ä»¥påœ¨w1åŒºåŸŸ&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ä¿ç•™w1ï¼Œå¹²æ‰w2ï¼Œå•çº¯å½¢é€€åŒ–æˆ0-simplex&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// w2 region&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// påœ¨w2åŒºåŸŸï¼Œé‚£ä¹ˆä¿ç•™w2ï¼Œå¹²æ‰w1ï¼Œå•çº¯å½¢é€€åŒ–æˆ0-simplex&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// påœ¨w2åŒºåŸŸ&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// ä¿ç•™ä¸‹æ¥çš„é¡¶ç‚¹éœ€è¦æ”¾åˆ°æ•°ç»„ç¬¬ä¸€ä¸ªä½ç½®&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// på¿…ç„¶åœ¨w1w2ä¸­é—´äº†ï¼Œæ±‚å‡ºa1ã€a2ï¼Œå¹¶åˆ†åˆ«ä¿å­˜è¿›m_v1 m_v2é‡Œ&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;&lt;div id=&quot;3.4&quot;&gt;b2Simplex::Solve3&lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;Solve3å¤§åŒå°å¼‚ï¼Œä¹Ÿæ˜¯å„ç§æ‰¾åŸç‚¹åœ¨simplexçš„å“ªä¸ªåŒºåŸŸï¼Œç”¨ä¸€ä¸ªå›¾æ¥è¡¨ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2018.3/11.png&quot; alt=&quot;11.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœåŸç‚¹è½åœ¨w1ã€w2ã€w3åŒºåŸŸï¼Œä¼šå¯¼è‡´simplexé€€åŒ–æˆ0-simplexï¼›&lt;/p&gt;

&lt;p&gt;å¦‚æœåŸç‚¹è½åœ¨e12ã€e13ã€e23åŒºåŸŸï¼Œä¼šå¯¼è‡´simplexé€€åŒ–æˆ1-simplexï¼›&lt;/p&gt;

&lt;p&gt;å¦åˆ™ï¼ŒåŸç‚¹å¿…ç„¶è½åœ¨ä¸‰è§’å½¢å†…éƒ¨ï¼Œsimplexä»ç„¶æ˜¯2-simplexã€‚&lt;/p&gt;

&lt;p&gt;è¿˜æœ‰å°±æ˜¯ï¼Œå› ä¸ºç°åœ¨æœ‰3ä¸ªé¡¶ç‚¹äº†ï¼Œè´¨å¿ƒåæ ‡å…¬å¼ä¼šéœ€è¦3ä¸ªå‚æ•°\( a_1 ã€a_2 ã€a_3\)ã€‚å¯ä»¥å‚è€ƒSolve2å°èŠ‚çš„æ–¹æ³•ï¼Œè§£å‡º3ä¸ªå‚æ•°ã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆæœ‰ç©ºå†æ›´æ–°è§£æ³•ï¼‰&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c++&quot; data-lang=&quot;c++&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Simplex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Solve3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1e12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2e12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w1e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e13&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1e13&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3e13&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d13_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3e13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d13_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w1e13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e23&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2e23&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3e23&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3e23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w2e23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// è¿™é‡Œçš„n123ã€d123_1ã€d123_2ã€d123_3éƒ½å’Œè´¨å¿ƒåæ ‡å…¬å¼æœ‰å…³&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Triangle123&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n123&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n123&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n123&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n123&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// w1 region&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d13_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// e12&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d12_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// e13&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d13_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d13_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d13&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d13_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d13_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d13_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d13_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// w2 region&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d12_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// w3 region&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d13_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// e23&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d23_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d23&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d23_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d23_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Must be in triangle123&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d123&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d123_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;m_v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;m_v2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;m_v3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d123_3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inv_d123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;&lt;div id=&quot;3.5&quot;&gt;b2DistanceProxy::GetSupport&lt;/div&gt;&lt;/h2&gt;

&lt;p&gt;b2DistanceProxyçš„GetSupportå’Œä¸Šé¢ç« èŠ‚ç»™å‡ºçš„supportä¼ªä»£ç ï¼Œå‡ ä¹æ˜¯ä¸€æ ·çš„ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c++&quot; data-lang=&quot;c++&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2DistanceProxy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetSupport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Vec2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bestIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bestValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_vertices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;float32&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b2Dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_vertices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bestValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;bestIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;bestValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bestIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1&gt;&lt;div id=&quot;4&quot;&gt;GJKçš„å…¶ä»–ç»†èŠ‚&lt;/div&gt;&lt;/h1&gt;

&lt;h2&gt;2D/3Dæ³›åŒ–å®ç°&lt;/h2&gt;

&lt;p&gt;è™½ç„¶è¯´GJKåŸç†æ²¡æœ‰å¯¹ç»´åº¦æœ‰ä»€ä¹ˆé™åˆ¶ï¼Œä½†2Dç‰ˆæœ¬çš„GJKä»£ç è¿˜æ˜¯å¾ˆéš¾ç›´æ¥æ³›åŒ–æˆ2D+3Dçš„ã€‚å› ä¸ºå…¶ä¸­æœ‰ä¸€äº›ç»†èŠ‚ï¼Œå¾ˆéš¾ç”¨ç»´æ•°å‚æ•°åŒ–ã€‚å…·ä½“æœ‰ä»€ä¹ˆå‘ï¼Œç­‰æˆ‘è¸©ä¸€éå†å›æ¥æ›´æ–°ã€‚&lt;/p&gt;

&lt;h2&gt;å‡ ä½•ä½“çš„å®šä¹‰ï¼šè¿ç»­orç¦»æ•£&lt;/h2&gt;

&lt;p&gt;ä»GJKç”¨åˆ°çš„æ•°å­¦çŸ¥è¯†æ¥çœ‹ï¼ŒGJKå¹¶ä¸è¦æ±‚è¾“å…¥çš„2ä¸ªå‡ ä½•ä½“å¿…é¡»æ˜¯ç¦»æ•£é¡¶ç‚¹å®šä¹‰çš„å‡ ä½•ä½“ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥GJKçš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼ŒGJKæ˜¯æ”¯æŒéç¦»æ•£å‡ ä½•ä½“çš„ç¢°æ’æ£€æµ‹çš„ï¼Œä¾‹å¦‚å‚æ•°æ–¹ç¨‹\(x^{2} + y^{2} = r^{2} \)å®šä¹‰çš„åœ†ï¼Œæˆ–è€…æ ·æ¡æ›²çº¿ã€NURBSæ›²çº¿å®šä¹‰çš„æ›²é¢å‡ ä½•ä½“ã€‚&lt;/p&gt;

&lt;p&gt;è‡³äºå¦‚ä½•æŠ½è±¡ï¼Œåˆ‡å…¥ç‚¹å°±æ˜¯GJKçš„supportå‡½æ•°ã€‚åªæœ‰supportå‡½æ•°ä½¿ç”¨åˆ°äº†è¾“å…¥å‚æ•°Shape på’Œqï¼Œæ‰€ä»¥ï¼Œå¯ä»¥é’ˆå¯¹éç¦»æ•£Shapeè®¾è®¡ç‰¹æ®Šçš„supportå‡½æ•°ï¼Œä»è€Œæ³›åŒ–GJKç®—æ³•ã€‚&lt;/p&gt;

&lt;h2&gt;GJKçš„æ—¶é—´å¤æ‚åº¦é—®é¢˜&lt;/h2&gt;

&lt;p&gt;GJKä¸­çš„æ–¹å‘å‘é‡\(d\)ï¼Œ\(d\)å¦‚ä½•é€‰å–ï¼ŒåŸºæœ¬å°±å†³å®šäº†GJKçš„æ”¶æ•›é€Ÿåº¦ã€‚&lt;/p&gt;

&lt;h1&gt;&lt;div id=&quot;5&quot;&gt;å‚è€ƒèµ„æ–™&lt;/div&gt;&lt;/h1&gt;

&lt;h2&gt;æ–‡å­—èµ„æ–™&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Gilbert%E2%80%93Johnson%E2%80%93Keerthi_distance_algorithm&quot;&gt;Gilbertâ€“Johnsonâ€“Keerthi distance algorithm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;file:///Users/wyman/Downloads/Tomiczkova.pdf&quot;&gt;Algorithms for the computation of the
Minkowski difference&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.dyn4j.org/2010/04/gjk-gilbert-johnson-keerthi/&quot;&gt;http://www.dyn4j.org/2010/04/gjk-gilbert-johnson-keerthi/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.haroldserrano.com/blog/visualizing-the-gjk-collision-algorithm&quot;&gt;Visualizing the GJK Collision detection algorithm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;PPTï¼š&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://slideplayer.com/slide/689954/&quot;&gt;http://slideplayer.com/slide/689954/&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;Youtubeè§†é¢‘èµ„æ–™&lt;/h2&gt;

&lt;p&gt;1ä¸ªå°æ—¶çš„è¯¾ç¨‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://caseymuratori.com/blog_0003&quot;&gt;https://caseymuratori.com/blog_0003&lt;/a&gt;&lt;/p&gt;

&lt;h1&gt;&lt;div id=&quot;5.1&quot;&gt;GJKå„ç§å®ç°&lt;/div&gt;&lt;/h1&gt;

&lt;p&gt;(Warning: å¦‚æœä¸èƒ½å…ˆå‚é€GJKçš„åŸç†ï¼Œçœ‹ä¸‹é¢è¿™äº›ä»£ç çš„æ—¶å€™æ˜¯éå¸¸æŠ˜ç£¨äººçš„)&lt;/p&gt;

&lt;h2&gt;2D&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;ä¸€ä»½æ¥è‡ª2000å¹´å·¦å³çš„ä»£ç ï¼Œå·¨å¤æ‚ï¼Œé˜…è¯»èµ·æ¥å¾ˆæœ‰å¿ƒç†éšœç¢ï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;http://www.cs.ox.ac.uk/people/stephen.cameron/distances/&quot;&gt;Computing the Distance between Objects&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.cs.ox.ac.uk/people/stephen.cameron/distances/gjk2.4/&quot;&gt;http://www.cs.ox.ac.uk/people/stephen.cameron/distances/gjk2.4/&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Box2Dï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/erincatto/Box2D/blob/master/Box2D/Box2D/Collision/b2Distance.cpp&quot;&gt;https://github.com/erincatto/Box2D/blob/master/Box2D/Box2D/Collision/b2Distance.cpp&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;gjk.cï¼Œ200å¤šè¡Œçº¯Cä»£ç å®ç°GJKï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/kroitor/gjk.c&quot;&gt;https://github.com/kroitor/gjk.c&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;dyn4jï¼Œä¸€ä¸ªjavaå†™çš„ç‰©ç†å¼•æ“ï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/dyn4j/dyn4j/blob/master/src/main/java/org/dyn4j/collision/narrowphase/Gjk.java&quot;&gt;https://github.com/dyn4j/dyn4j/blob/master/src/main/java/org/dyn4j/collision/narrowphase/Gjk.java&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;jså®ç°ï¼Œè¿™ä¸ªè‡ªå¸¦æ¼”ç¤ºç¨‹åºï¼Œå¾ˆå‰å®³ï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/juhl/collision-detection-2d&quot;&gt;https://github.com/juhl/collision-detection-2d&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;3D&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Bulletï¼Œé‡é‡çº§å¼•æ“ï¼Œå…¨å±€æœbtGjkPairDetectorå¯æ‰¾åˆ°GJKä»£ç &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/bulletphysics/bullet3&quot;&gt;https://github.com/bulletphysics/bullet3&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;reactphysics3dï¼Œéäº§å“çº§çš„è½»é‡ç‰©ç†å¼•æ“ï¼Œé€‚åˆå­¦ä¹ ç”¨ï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/DanielChappuis/reactphysics3d&quot;&gt;https://github.com/DanielChappuis/reactphysics3d&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Tue, 20 Mar 2018 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/collision-detection-2/</link>
        <guid isPermaLink="true">http://localhost:4000/collision-detection-2/</guid>
      </item>
    
      <item>
        <title>Canvasçš„transformå‡½æ•°ä¸2Dä»¿å°„å˜æ¢çŸ©é˜µåˆ†è§£</title>
        <description>&lt;p&gt;æœ€è¿‘å¶ç„¶æ¥è§¦äº†ä¸€ä¸‹canvasçš„2Dä»¿å°„å˜æ¢ã€‚å’Œ3Dä¸€æ ·ï¼Œcanvasæœ‰scaleã€translateã€rotateæ“ä½œï¼Œæœ¬è´¨ä¸Šè¿™3ä¸ªå‡½æ•°ä¹Ÿæ˜¯çŸ©é˜µä¹˜æ³•ã€‚&lt;/p&gt;

&lt;p&gt;canvasåº”è¯¥å†…ç½®äº†ä¸€å¥—çŸ©é˜µè¿ç®—ç³»ç»Ÿï¼Œå¹¶ä¸”canvaså†…å«æœ‰ä¸€ä¸ªä»¿å°„å˜æ¢çŸ©é˜µï¼ˆå¤§æ¦‚è®¤ä¸ºæ˜¯3x3=9ä¸ªæµ®ç‚¹æ•°å˜é‡å³å¯ï¼Œ2Dæ˜¯3x3çŸ©é˜µï¼Œ3Dæ˜¯4x4çŸ©é˜µï¼‰ã€‚æ¯æ¬¡è°ƒç”¨scaleã€translateã€rotateå°±æ˜¯å¯¹è¿™ä¸ªçŸ©é˜µåšçŸ©é˜µä¹˜æ³•ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–è¿˜æœ‰3ä¸ªå‡½æ•°å¯ä»¥æ§åˆ¶canvasçš„ä»¿å°„å˜æ¢ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;resetTransform é‡ç½®ä¸ºå•ä½çŸ©é˜µ&lt;/li&gt;
&lt;li&gt;transform(a,b,c,d,e,f) ä»¥a,b,c,d,e,fæ„é€ ä¸€ä¸ªä»¿å°„å˜æ¢çŸ©é˜µå¹¶ä¹˜åˆ°å½“å‰canvasçš„ä»¿å°„å˜æ¢çŸ©é˜µ&lt;/li&gt;
&lt;li&gt;setTransform(a,b,c,d,e,f) é‡ç½®ä¸ºå•ä½çŸ©é˜µå¹¶åº”ç”¨transform(a,b,c,d,e,f)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æˆ‘é‡åˆ°çš„éœ€æ±‚æ˜¯ï¼Œ&lt;strong&gt;å¦‚æœcanvasæ²¡æœ‰æä¾›transformå‡½æ•°ï¼Œæ€ä¹ˆç”¨scaleã€translateã€rotateä¸‰ä¸ªå‡½æ•°çš„ç»„åˆï¼Œæ¥æ¨¡æ‹Ÿtransformå‡½æ•°ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;

&lt;!--more--&gt;

&lt;h2&gt;è‡ªå®šä¹‰çš„transformå‡½æ•°å®ç°&lt;/h2&gt;

&lt;p&gt;å…ˆæŠ›å‡ºç­”æ¡ˆï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;PI&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;180&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;degree&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// æ—‹è½¬åº¦æ•°&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;sx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// x è½´ç¼©æ”¾å€æ•°&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;sy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// y è½´ç¼©æ”¾å€æ•°&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;PI&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;180&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// æ–œåˆ‡åº¦æ•° &lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;tx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// xè½´å¹³ç§»&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ty&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// yè½´å¹³ç§»&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;sx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;cos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;degree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;sx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;degree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;sx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;cos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;degree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;sy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;degree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;sx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;degree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;sy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;cos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;degree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;tx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;ty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transform&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;angle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;atan2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;denom&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;pow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;pow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;scaleX&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;denom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;scaleY&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;scaleX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;skewX&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;atan2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;denom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;skewY&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;translateX&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;translateY&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;angle&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;angle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;180&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;PI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;skewX&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;skewX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;scale&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;scaleX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;scaleY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;translate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;translateX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;translateY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    Outout:&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    angle 45&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    skewX 0&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    scale 0.5 2&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    translate 200 100&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    */&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;translateX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;translateY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;angle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;scale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;scaleX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;scaleY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;canvas&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;document&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;test2&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;canvas&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;getContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;2d&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fillRect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;font&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;30px Verdana&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fillText&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;Hello, World&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;90&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ä¸Šé¢ä»£ç å¤§æ„æ˜¯ï¼Œç”¨æˆ·è¾“å…¥ä»»æ„degreeï¼Œsxï¼Œ syï¼Œtï¼Œtxï¼Œtyï¼Œå¹¶è®¡ç®—å‡ºå®ƒä»¬çš„a,b,c,d,e,fï¼Œç„¶åè°ƒç”¨è¿™ä¸ªè‡ªå®šä¹‰transformå‡½æ•°ï¼Œå°±èƒ½å¾—åˆ°å’Œå†…ç½®çš„transformä¸€æ ·çš„å˜æ¢æ•ˆæœã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢å°†é€æ­¥è®²è§£transformå‡½æ•°æ€ä¹ˆå¾—æ¥ã€‚&lt;/p&gt;

&lt;h2&gt;2Dä»¿å°„å˜æ¢çŸ©é˜µçš„åˆ†è§£&lt;/h2&gt;

&lt;p&gt;transformçš„å‚æ•°a, b, c, d, e, fç»„æˆäº†ä¸€ä¸ª3x3ä»¿å°„å˜æ¢çŸ©é˜µAï¼š&lt;/p&gt;

&lt;p&gt;\( A =  \left[ \begin{matrix} a&amp;amp;c&amp;amp;e\\ b&amp;amp;d&amp;amp;f\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;è®¾æœ‰2ç»´å‘é‡\(\mathbf p=(x, y, 1)\)ï¼Œè®©å®ƒå·¦ä¹˜Aï¼Œå°±ä¼šå¾—åˆ°ç»è¿‡Aå˜æ¢åçš„å‘é‡\(\mathbf p&amp;#39;=(x&amp;#39;, y&amp;#39;, 1)\)ã€‚&lt;/p&gt;

&lt;p&gt;\( \mathbf p =  \left[ \begin{matrix} x\\ y\\ 1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;\( \mathbf p&amp;#39; = A\mathbf p  =  \left[ \begin{matrix} x&amp;#39;\\ y&amp;#39;\\ 1\\ \end{matrix} \right] =  \left[ \begin{matrix} a&amp;amp;c&amp;amp;e\\ b&amp;amp;d&amp;amp;f\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right]  \left[ \begin{matrix} x\\ y\\ 1\\ \end{matrix} \right] =  \left[ \begin{matrix} ax+cy+e\\ bx+dy+f\\ 1\\ \end{matrix} \right] \)&lt;/p&gt;

&lt;p&gt;ç°åœ¨é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆæŠŠAåˆ†è§£æˆT(translate)ã€R(rotate)ã€S(scale)ä¸‰ä¸ªçŸ©é˜µã€‚&lt;/p&gt;

&lt;h3&gt;æå–T&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆå…ˆæŠŠtranslateçŸ©é˜µæå–å‡ºæ¥ï¼š&lt;/p&gt;

&lt;p&gt;\( T =  \left[ \begin{matrix} 1&amp;amp;0&amp;amp;e\\ 0&amp;amp;1&amp;amp;f\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;æ˜¾ç„¶è¿™æ˜¯æ­£ç¡®çš„ï¼Œå¯ä»¥è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;\( \mathbf p&amp;#39; = T\mathbf p =  \left[ \begin{matrix} 1&amp;amp;0&amp;amp;e\\ 0&amp;amp;1&amp;amp;f\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right]  \left[ \begin{matrix} x\\ y\\ 1\\ \end{matrix} \right] =  \left[ \begin{matrix} x+e\\ y+f\\ 1\\ \end{matrix} \right] \)&lt;/p&gt;

&lt;p&gt;xåç§»äº†eï¼Œyåç§»äº†fã€‚&lt;/p&gt;

&lt;p&gt;å†è®¾ç­‰å¼ï¼šA = TQã€‚Qæ˜¯æœªçŸ¥çŸ©é˜µï¼Œä¸”QåŒ…å«äº†scaleã€rotateå˜æ¢ã€‚&lt;/p&gt;

&lt;p&gt;Qå¯ä»¥ç”¨å‚æ•°a, b, c, d, e, fè¡¨ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;\( Q =  \left[ \begin{matrix} a&amp;amp;c&amp;amp;0\\ b&amp;amp;d&amp;amp;0\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;éªŒè¯ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;\( TQ =  \left[ \begin{matrix} 1&amp;amp;0&amp;amp;e\\ 0&amp;amp;1&amp;amp;f\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right]  \left[ \begin{matrix} a&amp;amp;c&amp;amp;0\\ b&amp;amp;d&amp;amp;0\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right] \)&lt;/p&gt;

&lt;p&gt;\( =  \left[ \begin{matrix} a&amp;amp;c&amp;amp;e\\ b&amp;amp;d&amp;amp;f\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right] = A \)&lt;/p&gt;

&lt;h3&gt;åˆ†è§£Q&lt;/h3&gt;

&lt;p&gt;è®¾ Q = RSï¼ŒSæ˜¯scaleï¼ŒRæ˜¯rotateã€‚2Dçš„Rã€SçŸ©é˜µåˆ†åˆ«ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\( R =  \left[ \begin{matrix} cosÎ¸&amp;amp; -sinÎ¸&amp;amp; 0\\  sinÎ¸&amp;amp; cosÎ¸&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;\( S =  \left[ \begin{matrix} x&amp;amp; 0&amp;amp; 0\\  0&amp;amp; y&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;å…¶å®ï¼ŒQè¿˜å¯èƒ½åŒ…å«äº†shearæ–œåˆ‡å˜æ¢ã€‚ä¸€èˆ¬æ¥è¯´æ–œåˆ‡æ˜¯æ¯”è¾ƒå°‘è§åˆ°çš„ä¸€ç§å˜æ¢ï¼Œä¸”canvaså¹¶æ²¡æœ‰å•ç‹¬çš„shearå‡½æ•°ã€‚æ‰€ä»¥æœ¬æ–‡å¼€å¤´çš„ç›®æ ‡ï¼Œè‡ªå®šä¹‰customï¼Œæ€ä¹ˆå¼„éƒ½ä¸èƒ½å®ç°shearå˜æ¢ï¼ˆåªæœ‰scaleã€translateã€rotateå¯ç”¨ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ç°åœ¨è¦åˆ†è§£Qï¼Œå¯ä»¥æŠŠshearä¹Ÿä¸€å¹¶è€ƒè™‘ã€‚shearçŸ©é˜µå½¢å¼å¦‚ä¸‹ï¼›&lt;/p&gt;

&lt;p&gt;\( Shear =  \left[ \begin{matrix} 1&amp;amp; s&amp;amp; 0\\  t&amp;amp; 1&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;å¦‚æœæ²¡æœ‰shearå˜æ¢ï¼Œé‚£ä¹ˆs=t=0ã€‚&lt;/p&gt;

&lt;p&gt;åŒæ—¶ç”¨så’Œtæ˜¯ä¸å¯¹çš„ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…éœ€ä¸º0ã€‚ä¸‹é¢æ¨å¯¼çš„å‰ææ˜¯s != 0ï¼Œt = 0ã€‚&lt;/p&gt;

&lt;p&gt;ç»¼ä¸Šï¼Œå¾—åˆ°Q&amp;#39; = Rotate * Scale * Shear&lt;/p&gt;

&lt;p&gt;\( Q&amp;#39; = \left[ \begin{matrix} cosÎ¸&amp;amp; -sinÎ¸&amp;amp; 0\\  sinÎ¸&amp;amp; cosÎ¸&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]  \left[ \begin{matrix} x&amp;amp; 0&amp;amp; 0\\  0&amp;amp; y&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]  \left[ \begin{matrix} 1&amp;amp; s&amp;amp; 0\\  t&amp;amp; 1&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]   \)&lt;/p&gt;

&lt;p&gt;\( =   \left[ \begin{matrix} xcosÎ¸&amp;amp; -ysinÎ¸&amp;amp; 0\\  xsinÎ¸&amp;amp; ycosÎ¸&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]   \left[ \begin{matrix} 1&amp;amp; s&amp;amp; 0\\  t&amp;amp; 1&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right] \)&lt;/p&gt;

&lt;p&gt;\( =  \left[ \begin{matrix} xcosÎ¸ - tysinÎ¸&amp;amp; sxcosÎ¸ - ysinÎ¸&amp;amp; 0\\  xsinÎ¸ + tycosÎ¸&amp;amp; sxsinÎ¸ + ycosÎ¸&amp;amp; 0\\  0&amp;amp; 0&amp;amp; 1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;å†å›é¡¾ä¸Šä¸€å°èŠ‚çš„Qï¼š&lt;/p&gt;

&lt;p&gt;\( Q =  \left[ \begin{matrix} a&amp;amp;c&amp;amp;0\\ b&amp;amp;d&amp;amp;0\\ 0&amp;amp;0&amp;amp;1\\ \end{matrix} \right]  \)&lt;/p&gt;

&lt;p&gt;å¯¹æ¯”Qå’ŒQ&amp;#39;ï¼Œå¯ä»¥å¾—åˆ°æ–¹ç¨‹ç»„ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;\( a =  x cosÎ¸ - t y sinÎ¸ = x cosÎ¸  \)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;\( b = x sinÎ¸ + t y cosÎ¸ = x sinÎ¸  \)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;\( c = s x cosÎ¸ - y sinÎ¸ = sa - y sinÎ¸ = sa - y(b/x) \)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;\( d = s x sinÎ¸ + y cosÎ¸ = sb + y cosÎ¸ = sb + y(a/x) \)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;çœ‹èµ·æ¥æœ‰ç‚¹ä¹±ï¼Œæ…¢æ…¢æ‹†è§£ä¸‹å§:&lt;/p&gt;

&lt;p&gt;ä¸€äºŒç­‰å¼ç›¸é™¤è§£å‡ºÎ¸ï¼š&lt;/p&gt;

&lt;p&gt;\( tanÎ¸ = \frac { b } { a } \)&lt;/p&gt;

&lt;p&gt;\( Î¸ = atan2(b, a) \)&lt;/p&gt;

&lt;p&gt;ä¸€äºŒç­‰å¼åˆ†åˆ«å¹³æ–¹åç›¸åŠ ï¼Œè§£å‡ºxï¼š&lt;/p&gt;

&lt;p&gt;\( a^{2} + b^{2} = x^{2} \)&lt;/p&gt;

&lt;p&gt;\( x = \sqrt { a^{2} + b^{2} } \)&lt;/p&gt;

&lt;p&gt;ä¸‰å››ç­‰å¼æ¶ˆå»sï¼š&lt;/p&gt;

&lt;p&gt;\( c = sa - y(b/x) \)&lt;/p&gt;

&lt;p&gt;\( s = (c + y(b/x))/a \)&lt;/p&gt;

&lt;p&gt;\( d = sb + y(a/x) =  b(c + y(b/x))/a + y(a/x)  \)&lt;/p&gt;

&lt;p&gt;å¯¹ä¸Šå¼ä¸¤è¾¹ä¹˜aï¼š&lt;/p&gt;

&lt;p&gt;\( ad =  b(c + y(b/x)) + ay(a/x)  \)&lt;/p&gt;

&lt;p&gt;\( ad =  bc + by(b/x) + ay(a/x)  \)&lt;/p&gt;

&lt;p&gt;\( ad -  bc = by(b/x) + ay(a/x)  \)&lt;/p&gt;

&lt;p&gt;\( ad -  bc = y(b^{2}/x + a^{2}/x)  \)&lt;/p&gt;

&lt;p&gt;\( ad -  bc = y(a^{2} + b^{2})/ \sqrt { a^{2} + b^{2} }    \)&lt;/p&gt;

&lt;p&gt;\( ad -  bc = y \sqrt { a^{2} + b^{2} }    \)&lt;/p&gt;

&lt;p&gt;\( y = \frac { ad -  bc } {  \sqrt { a^{2} + b^{2} }  } \)&lt;/p&gt;

&lt;p&gt;ç„¶åå¯ä»¥æ±‚säº†ï¼š&lt;/p&gt;

&lt;p&gt;\( s = (c + y(b/x))/a \)&lt;/p&gt;

&lt;p&gt;\( s = \frac { c } { a } + \frac { yb } { xa } \)&lt;/p&gt;

&lt;p&gt;y/xä¸Šé¢å·²ç»æœ‰äº†ï¼Œä»£å…¥ï¼š&lt;/p&gt;

&lt;p&gt;\( s = \frac { c } { a } + \frac { (ad -  bc)b } { (a^{2} + b^{2})a } \)&lt;/p&gt;

&lt;p&gt;\( s = \frac { c(a^{2} + b^{2}) + (ad -  bc)b } { (a^{2} + b^{2})a } \)&lt;/p&gt;

&lt;p&gt;\( s = \frac { ca^{2} + cb^{2} + adb -  cb^{2} } { (a^{2} + b^{2})a } \)&lt;/p&gt;

&lt;p&gt;\( s = \frac { ca^{2} + adb } { (a^{2} + b^{2})a } \)&lt;/p&gt;

&lt;p&gt;\( s = \frac { a(ca + bd) } { (a^{2} + b^{2})a } \)&lt;/p&gt;

&lt;p&gt;\( s = \frac { ca + bd } { a^{2} + b^{2} } \)&lt;/p&gt;

&lt;p&gt;é€†å‘æ€ç»´ä¸€ä¸‹ï¼Œç°åœ¨å·²ç»æ±‚å‡ºæœªçŸ¥æ•°x,y,sx,sy,s,Î¸ï¼Œå®ƒä»¬éƒ½å¯ä»¥ç”¨a,b,c,d,e,fæ¥è¡¨ç¤ºã€‚&lt;/p&gt;

&lt;p&gt;é‚£ä¹ˆåè¿‡æ¥ï¼Œç”¨æˆ·è‡ªå·±æä¾›äº†x,y,sx,sy,s,Î¸ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ±‚å‡ºa,b,c,d,e,fï¼Œä»è€Œè°ƒç”¨è¿™ä¸ªè‡ªå®šä¹‰å‡½æ•°ã€‚&lt;/p&gt;

&lt;p&gt;å›å»ä¸Šé¢å†æ¯”å¯¹ä¸‹ä»£ç å’Œå…¬å¼å°±æ¸…æ¥šäº†ã€‚&lt;/p&gt;

&lt;h2&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;ç”¨è¿™ä¸ªè‡ªå®šä¹‰å‡½æ•°å°±èƒ½å‡ ä¹æ»¡è¶³éœ€æ±‚äº†ã€‚åªä¸è¿‡è¿™ä¸ªè‡ªå®šä¹‰å‡½æ•°æ˜¯ä¸èƒ½å®ç°æ–œåˆ‡æ•ˆæœçš„ï¼Œ&lt;/p&gt;

&lt;p&gt;å¯¹äºç¬¦åˆæ ‡å‡†çš„web jsï¼Œä¸€èˆ¬æ˜¯ç”¨transformå‡½æ•°æ¥åšæ–œåˆ‡ï¼ŒTRSå°±åˆ†åˆ«ç”¨translateã€rotateã€scaleå‡½æ•°æ¥åšã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœcanvaså†æä¾›ä¸€ä¸ªå•ç‹¬çš„skewå‡½æ•°å°±å®Œç¾äº†ã€‚&lt;/p&gt;

&lt;h2&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/5107134/find-the-rotation-and-skew-of-a-matrix-transformation/32125700#32125700&quot;&gt;stackoverflow - Find the Rotation and Skew of a Matrix transformation
&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/matthewmueller/unmatrix/blob/master/index.js&quot;&gt;unmatrix - parse(str) &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hg.mozilla.org/mozilla-central/file/7cb3e9795d04/layout/style/nsStyleAnimation.cpp&quot;&gt;DecomposeMatrix æ­¤ä»£ç æœ€åŸå§‹å‡ºå¤„ï¼ˆæœ‰æ³¨é‡Šï¼‰&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ã€ŠGRAPHICS GEMS II edited by JAMES ARVOã€‹&lt;/p&gt;
</description>
        <pubDate>Wed, 07 Feb 2018 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/linear-algebra-20/</link>
        <guid isPermaLink="true">http://localhost:4000/linear-algebra-20/</guid>
      </item>
    
      <item>
        <title>éª¨éª¼åŠ¨ç”»ä¸è’™çš®çŸ©é˜µ</title>
        <description>&lt;p&gt;ã€ŠGame Engine Architectureã€‹è¿™æœ¬ä¹¦é‡Œæœ€è®©æˆ‘æ¬£å–œçš„å°±æ˜¯åŠ¨ç”»ç›¸å…³çš„ç« èŠ‚äº†ï¼Œéå¸¸è¯¦ç»†ï¼Œæ¯”ä¸­æ–‡æœç´¢å¼•æ“èƒ½æœåˆ°çš„èµ„æ–™éƒ½è¦ç³»ç»Ÿã€å…¨é¢ã€‚æ®è¯´ä½œè€…ä»¥å‰å°±æ˜¯åšåŠ¨ç”»çš„ã€‚å…¶ä»–ç« èŠ‚ç›¸å¯¹çš„åªæ˜¯æŠ›ç –å¼•ç‰ï¼Œä¾‹å¦‚é˜´å½±ï¼Œåªå†™äº†å‡ é¡µã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡è¿™æœ¬ä¹¦å¹¶ç»“åˆgithubä¸Šçš„ozz-animationæºç ï¼ŒåŸºæœ¬ææ‡‚äº†éª¨éª¼è’™çš®åŠ¨ç”»çš„æ ¸å¿ƒåŸç†ã€‚ä¸‹é¢å°†ç®€å•åšä¸€ä»½ç¬”è®°ã€‚&lt;/p&gt;

&lt;!--more--&gt;

&lt;h3&gt;åŸºç¡€æ¦‚å¿µ&lt;/h3&gt;

&lt;p&gt;3Dç¾æœ¯äººå‘˜åˆ¶ä½œä¸€ä¸ªå¸¦éª¨éª¼åŠ¨ç”»çš„æ¨¡å‹æ—¶ï¼Œä¸»è¦è¦åˆ†2ä¸ªæ­¥éª¤ï¼Œä¸€æ˜¯å»ºæ¨¡ï¼ˆå¯èƒ½åŒ…æ‹¬ç”»è´´å›¾ï¼‰ï¼ŒäºŒæ˜¯ç»™æ¨¡å‹åŠ ä¸Šéª¨éª¼å¹¶åˆ¶ä½œéª¨éª¼åŠ¨ç”»ã€‚&lt;/p&gt;

&lt;p&gt;ç»™ä¸€ä¸ªæ¨¡å‹åŠ ä¸Šéª¨éª¼å‰ï¼Œä¸€èˆ¬è¦æ±‚è¿™ä¸ªæ¨¡å‹æ‘†æˆTå­—å‹ï¼Œæ‰æ–¹ä¾¿åŠ¨ä½œå¸ˆåŠ éª¨éª¼å’ŒåšåŠ¨ä½œã€‚æ­¤æ—¶ï¼Œ&lt;strong&gt;åŠ éª¨éª¼&lt;/strong&gt;æ“ä½œè¢«ç§°ä¸º&lt;strong&gt;éª¨éª¼ç»‘å®š(Skeleton Binding)&lt;/strong&gt;ï¼›æˆ–è€…ä»æ¨¡å‹è§’åº¦è®²å«åšï¼Œæ¨¡å‹&lt;strong&gt;è’™çš®(Model Skinning)&lt;/strong&gt;åˆ°éª¨éª¼ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªåˆå§‹éª¨éª¼æ‘†ä½ï¼Œå°±æ˜¯&lt;strong&gt;ç»‘å®šå§¿åŠ¿(Bind Poses)&lt;/strong&gt;ã€‚ä½†è¦æ³¨æ„ï¼ŒBind Posesæœ¬èº«åªè®°å½•äº†éª¨éª¼å„ä¸ªå…³èŠ‚çš„å§¿åŠ¿ä¿¡æ¯ï¼Œå¹¶ä¸åŒ…æ‹¬&lt;strong&gt;è’™çš®ä¿¡æ¯&lt;/strong&gt;ã€‚è’™çš®ä¿¡æ¯æ˜¯å­˜å‚¨äºæ¨¡å‹æ•°æ®é‡Œçš„ï¼Œå› ä¸ºæ‰€è°“è’™çš®ï¼Œå³æ˜¯è®©æ¯ä¸€ä¸ªé¡¶ç‚¹ç»‘å®šè‡³1-nä¸ªå…³èŠ‚ï¼Œè¿™nä¸ªå…³èŠ‚è¿åŠ¨çš„æ—¶å€™ï¼Œä¼šå½±å“åˆ°è¯¥é¡¶ç‚¹çš„å½“å‰ä½ç½®ã€‚&lt;/p&gt;

&lt;h3&gt;å±€éƒ¨å…³èŠ‚å§¿åŠ¿ Local Joint Poses&lt;/h3&gt;

&lt;p&gt;å…³èŠ‚å§¿åŠ¿åˆ†ä¸º&lt;strong&gt;å±€éƒ¨&lt;/strong&gt;å…³èŠ‚å§¿åŠ¿å’Œ&lt;strong&gt;å…¨å±€&lt;/strong&gt;å…³èŠ‚å§¿åŠ¿ã€‚å…ˆä»å±€éƒ¨å…³èŠ‚å§¿åŠ¿è¯´èµ·ã€‚&lt;/p&gt;

&lt;p&gt;å±€éƒ¨å…³èŠ‚å§¿åŠ¿æ˜¯ç›¸å¯¹ç›´å±çˆ¶å…³èŠ‚è€Œè¨€çš„ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªstrcutè¡¨ç¤º:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JointPose&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Quaternion&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// R å…³èŠ‚æ—‹è½¬ä¿¡æ¯&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Vector3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;trans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// T å…³èŠ‚ä½ç§»ä¿¡æ¯&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Vector3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// S å…³èŠ‚ç¼©æ”¾ä¿¡æ¯&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ä¸€ä¸ªå…³èŠ‚åªéœ€è¦å­˜ä¸€ç»„RTSä¿¡æ¯ã€‚è¿™3ä¸ªä¿¡æ¯å¯åˆ†åˆ«è½¬æ¢æˆ3ä¸ªçŸ©é˜µï¼Œå¹¶ä¸”å¯ä»¥åˆå¹¶æˆä¸€ä¸ªçŸ©é˜µã€‚åˆå¹¶åçš„çŸ©é˜µå°±è¢«ç§°ä¸ºå…³èŠ‚ä»¿å°„å˜æ¢çŸ©é˜µ\( P_{j} \)ï¼š&lt;/p&gt;

&lt;p&gt;\[ P_{j} =  \left[ \begin{matrix} S_{j}R_{j}&amp;amp;0\\ T_{j}&amp;amp;1\\ \end{matrix} \right] \]&lt;/p&gt;

&lt;p&gt;ï¼ˆæ³¨æ„ï¼ŒJointPoseå­˜çš„ä¸æ˜¯çŸ©é˜µï¼Œè€Œæ˜¯RTSï¼Œå³1ä¸ªå››å…ƒæ•°å’Œ2ä¸ªå‘é‡ã€‚ï¼‰&lt;/p&gt;

&lt;p&gt;ä¸€ä¸ªéª¨éª¼ï¼Œå°±æ˜¯æ‰€æœ‰å…³èŠ‚ä»¿å°„å˜æ¢çš„é›†åˆï¼š&lt;/p&gt;

&lt;p&gt;\[ P^{skel} = { P_{j} } | _{j=0}^{N-1} \]&lt;/p&gt;

&lt;p&gt;å³ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SkeletonPose&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jointCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å…³èŠ‚æ•°é‡&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;JointPose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;localPoses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å¤šä¸ªå±€éƒ¨å…³èŠ‚å§¿åŠ¿&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æŠŠ\( P_{j} \)åº”ç”¨åˆ°å…³èŠ‚jçš„å±€éƒ¨åæ ‡ç³»çš„æŸä¸ªç‚¹æˆ–å‘é‡\( v_{j} \)ï¼Œå°±èƒ½æŠŠå®ƒå˜æ¢åˆ°çˆ¶å…³èŠ‚pçš„åæ ‡ç³»ï¼š&lt;/p&gt;

&lt;p&gt;\[ v_{p} =  v_{j} P_{j} \]&lt;/p&gt;

&lt;p&gt;ä¾‹å¦‚å‡è®¾æœ‰\( v_{j} = (0,0,0) \)ï¼Œè¡¨ç¤ºæ˜¯å…³èŠ‚jçš„å±€éƒ¨åæ ‡ç³»çš„åŸç‚¹ï¼Œ\(P_{j} \)æ˜¯ä¸€ä¸ªTranslate(100, 0, 0)ï¼Œé‚£ä¹ˆ\( P_{j} v_{j}  \) çš„ç»“æœå°±æ˜¯(100, 0, 0)ï¼Œå³\( v_{p} \)è¡¨ç¤ºçˆ¶å…³èŠ‚påæ ‡ç³»ä¸‹çš„åæ ‡(100,0,0)ã€‚&lt;/p&gt;

&lt;p&gt;å¯ä»¥å®šä¹‰å­å…³èŠ‚jåˆ°çˆ¶å…³èŠ‚çš„å˜æ¢ä¸º\( (P_{C\to P})j \)ã€‚è¿™æ ·çš„å½¢å¼ä¸å¤ªå¥½çœ‹ï¼Œå¯ä»¥æ¢ä¸€ç§ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªå‡½æ•°p(j)ï¼Œp(j)è¿”å›å…³èŠ‚jçš„çˆ¶å…³èŠ‚ç´¢å¼•ã€‚é‚£ä¹ˆ\( (P_{C\to P})j \) å¯ä»¥å†™æˆ \( P_{j\to p(j)} \)ã€‚&lt;/p&gt;

&lt;h3&gt;å…¨å±€å…³èŠ‚å§¿åŠ¿ Global Joint Poses&lt;/h3&gt;

&lt;p&gt;å±€éƒ¨å…³èŠ‚å§¿åŠ¿æ˜¯ä¸€ç§åŸå§‹ä¿¡æ¯ï¼Œå®é™…ä¸Šåœ¨æ¸²æŸ“è’™çš®åŠ¨ç”»å‰ï¼Œéœ€è¦åšé¢„å¤„ç†ï¼ŒæŠŠå±€éƒ¨å…³èŠ‚å§¿åŠ¿è½¬æ¢æˆå…¨å±€å…³èŠ‚å§¿åŠ¿ã€‚&lt;/p&gt;

&lt;p&gt;å…¨å±€å…³èŠ‚å§¿åŠ¿å˜æ¢ï¼ŒæŒ‡çš„æ˜¯æŠŠå…³èŠ‚å§¿åŠ¿ï¼Œç”¨&lt;strong&gt;æ¨¡å‹ç©ºé—´åæ ‡ç³»&lt;/strong&gt;è¡¨ç¤ºã€‚é¦–å…ˆå®šä¹‰\( p(0) \equiv M \)ï¼Œå³æ ¹å…³èŠ‚çš„çˆ¶èŠ‚ç‚¹ä¸ºæ¨¡å‹ç©ºé—´ã€‚&lt;/p&gt;

&lt;p&gt;æ¯ä¸ªå…³èŠ‚jçš„å…¨å±€å…³èŠ‚å§¿åŠ¿å˜æ¢Pï¼Œå¯ä»¥ç”¨åˆšæ‰çš„ \( P_{j\to p(j)} \)æ¥è¡¨ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;\[ P_{2\to M} = P_{2\to 1} P_{1\to 0} P_{0\to M} \]&lt;/p&gt;

&lt;p&gt;\[ P_{j\to M} = \prod _{i=j}^{0} P_{i\to p(i)} \]&lt;/p&gt;

&lt;p&gt;å¯¹æ¯ä¸ªå…³èŠ‚éƒ½åšä¸€éè¿™ä¸ªå…¬å¼ï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ªå…¨å±€å…³èŠ‚å§¿åŠ¿æ•°ç»„ã€‚ç„¶åå°±å¯ä»¥å†™å…¥SkeletonPoseï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SkeletonPose&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jointCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å…³èŠ‚æ•°é‡&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;JointPose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;localPoses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å¤šä¸ªå±€éƒ¨å…³èŠ‚å§¿åŠ¿ JointPose&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Matrix44&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;globalPoses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å¤šä¸ªå…¨å±€å…³èŠ‚å§¿åŠ¿ å…¨å±€å…³èŠ‚å§¿åŠ¿çš„å­˜å‚¨ï¼Œå¹¶ä¸åªé™å®šäºç”¨RTSï¼Œè€Œæ˜¯æ—¢å¯ä»¥ç”¨RTSä¹Ÿå¯ä»¥ç”¨çŸ©é˜µã€‚å› ä¸ºå®æ—¶æ¸²æŸ“é‡ŒçŸ©é˜µæ›´é€šç”¨å¿«é€Ÿï¼Œæ‰€ä»¥å¾—å­˜æˆçŸ©é˜µã€‚&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;ç»‘å®šå§¿åŠ¿çŸ©é˜µã€ç»‘å®šå§¿åŠ¿é€†çŸ©é˜µ Bind Poses Matrix ã€Inversed Bind Poses Matrix&lt;/h3&gt;

&lt;p&gt;å®šä¹‰çŸ©é˜µ \( B_{j\to M} \)ä¸ºå…³èŠ‚jåœ¨æ¨¡å‹ç©ºé—´çš„&lt;strong&gt;å…¨å±€ç»‘å®šå§¿åŠ¿çŸ©é˜µ&lt;/strong&gt;ã€‚æ ¹æ®ä¸Šæ–‡ï¼Œ \( \mathbf v B_{j\to M} \) å¯ä»¥æŠŠ\(  \mathbf v \)ä»å…³èŠ‚jçš„å±€éƒ¨ç©ºé—´å˜æ¢åˆ°æ¨¡å‹ç©ºé—´ã€‚&lt;/p&gt;

&lt;p&gt;åè¿‡æ¥è¯´ï¼Œè¦æŠŠä¸€ä¸ªç‚¹æˆ–å‘é‡ï¼ˆæƒ³è±¡ä¸‹æ¨¡å‹çš„ä»»æ„ä¸€ä¸ªé¡¶ç‚¹ï¼‰ï¼Œå˜æ¢åˆ°å…³èŠ‚jçš„ç©ºé—´ï¼Œå°±æ˜¯ï¼š&lt;/p&gt;

&lt;p&gt;\[ \mathbf v&amp;#39; (B_{j\to M})^{-1} \] &lt;/p&gt;

&lt;p&gt;\( (B_{j\to M})^{-1}  \)å°±æ˜¯&lt;strong&gt;ç»‘å®šå§¿åŠ¿é€†çŸ©é˜µ&lt;/strong&gt;ã€‚å¹¶ä¸”æœ‰ï¼š&lt;/p&gt;

&lt;p&gt;\[ (B_{j\to M})^{-1} = B_{M\to j} \] &lt;/p&gt;

&lt;p&gt;å†å®šä¹‰\(\mathbf v _{M}^{B} \)ä¸ºæ¨¡å‹ä»»æ„é¡¶ç‚¹våœ¨&lt;strong&gt;ç»‘å®šå§¿åŠ¿&lt;/strong&gt;çš„æ¨¡å‹ç©ºé—´åæ ‡ï¼Œ è€Œ \(\mathbf v _{M}^{C} \) ä¸ºåœ¨&lt;strong&gt;å½“å‰å§¿åŠ¿&lt;/strong&gt;çš„æ¨¡å‹ç©ºé—´åæ ‡ã€‚å¦‚æœè¦æ±‚\(\mathbf v _{M}^{B} \)åœ¨å…³èŠ‚jçš„å±€éƒ¨ç©ºé—´åæ ‡\( v_{j} \)ï¼Œåˆ™å…¬å¼ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\[ \mathbf v _{j} = \mathbf v _{M}^{B} B_{M\to j} = \mathbf v _{M}^{B} (B_{j\to M})^{-1}  \] &lt;/p&gt;

&lt;p&gt;ç„¶åå†ä¹˜ä»¥å½“å‰å§¿åŠ¿çš„å§¿åŠ¿çŸ©é˜µCï¼Œå¾—åˆ°å½“å‰å§¿åŠ¿çš„æ¨¡å‹ç©ºé—´åæ ‡ \(\mathbf v _{M}^{C} \)ï¼š&lt;/p&gt;

&lt;p&gt;\[ v _{M}^{C} = \mathbf v _{j} C_{j \to M}  \] &lt;/p&gt;

&lt;h3&gt;è’™çš®çŸ©é˜µ Skinning Matrix&lt;/h3&gt;

&lt;p&gt;\[ v _{M}^{C} = \mathbf v _{j} C_{j \to M}  = \mathbf v _{M}^{B} (B_{j\to M})^{-1}  C_{j \to M} =   \mathbf v _{M}^{B}  K_{j} \] &lt;/p&gt;

&lt;p&gt;\[ K_{j} = (B_{j\to M})^{-1}  C_{j \to M} \]&lt;/p&gt;

&lt;p&gt;\( K_{j} \) å°±æ˜¯å…³èŠ‚jçš„è’™çš®çŸ©é˜µäº†ã€‚&lt;/p&gt;

&lt;p&gt;ozz-animationä¸­çš„ç®—KçŸ©é˜µçš„ä»£ç ç‰‡æ®µï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;models&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;skinning_matrices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;models&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mesh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;inverse_bind_poses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;models[j]å°±æ˜¯å½“å‰å§¿åŠ¿å½“å‰æ—¶åˆ»ç¬¬jä¸ªå…³èŠ‚çš„\( C_{j \to M}\)ã€‚&lt;/p&gt;

&lt;p&gt;mesh.inverse_bind_poses[j]å°±æ˜¯\( (B_{j\to M})^{-1} \)ï¼Œå¯è§ï¼Œè¿™ä¸ªé€†çŸ©é˜µæ˜¯é¢„å…ˆç®—å¥½çš„ï¼Œæ¯”è¿è¡Œæ—¶å†ç®—é€†çŸ©é˜µè¦å¿«å¾—å¤šï¼Œä¸€èˆ¬çš„è’™çš®åŠ¨ç”»å¼•æ“éƒ½æ˜¯è¿™æ ·åšã€‚&lt;/p&gt;

&lt;p&gt;æ³¨æ„è¿™é‡Œçš„ä¹˜æ³•é¡ºåºå’Œå…¬å¼ç›¸åï¼ˆå…¬å¼æ˜¯å³ä¹˜ï¼Œä¸€èˆ¬OGLç¨‹åºä¸­æ˜¯ç”¨å·¦ä¹˜ï¼‰ã€‚&lt;/p&gt;
</description>
        <pubDate>Thu, 04 Jan 2018 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/linear-algebra-19/</link>
        <guid isPermaLink="true">http://localhost:4000/linear-algebra-19/</guid>
      </item>
    
      <item>
        <title>Bounding Volume Hierachy of pbrt è§£æ(2) HLBVH</title>
        <description>&lt;h2&gt;HLBVH&lt;/h2&gt;

&lt;p&gt;ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº†recursiveBuildå‡½æ•°ï¼Œå®ƒå¯¹é™æ€åœºæ™¯åšäº†ä¸€æ¬¡è‡ªé¡¶å‘ä¸‹çš„BVHæ„é€ ï¼Œä¸”ä½¿ç”¨äº†ä¸€ä¸ªå«SAHçš„åˆ‡åˆ†æŠ€æœ¯ã€‚&lt;/p&gt;

&lt;p&gt;recursiveBuildæœ‰2ä¸ªç¼ºç‚¹ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;SAHçš„è®¡ç®—æ˜¯\(O(n^{2}) \)çš„ï¼Œä¸”å‡ ä¹æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½è¦åšSAHï¼Œæ€§èƒ½å¹¶ä¸æ˜¯å¾ˆç†æƒ³ï¼›&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;è‡ªé¡¶å‘ä¸‹åœ°æ„é€ BVHï¼Œå¾ˆéš¾åº”ç”¨å¹¶è¡Œè®¡ç®—æ¥ä¼˜å…ˆæ€§èƒ½ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;äºæ˜¯ä½œè€…åˆå‘æ˜äº†æ›´å¤æ‚çš„HLBVHBuildï¼Œå³ Hierarchical Linear Bounding Volume Hierarchyã€‚&lt;/p&gt;

&lt;!--more--&gt;

&lt;h2&gt;è«é¡¿ç  &lt;a href=&quot;https://en.wikipedia.org/wiki/Z-order_curve&quot;&gt;Morton Code&lt;/a&gt;&lt;/h2&gt;

&lt;p&gt;è¦ç†è§£HLBVHï¼Œé¦–å…ˆè¦å­¦ä¸€ä¸‹è«é¡¿ç ã€‚&lt;/p&gt;

&lt;h3&gt;LeftShift3&lt;/h3&gt;

&lt;p&gt;LeftShift3å‡½æ•°ï¼š è¾“å…¥ä¸€ä¸ª32ä½æ­£æ•´æ•°ï¼ˆè¿™ä¸ªæ•°å®é™…ä¸Šå¿…é¡»å°äºç­‰äº1&amp;lt;&amp;lt;10å³1024ï¼‰ï¼Œå‡½æ•°ä¼šæŠŠç¬¬iä½çš„å€¼å†™å…¥åˆ°ç¬¬3iä½ï¼Œç„¶åæŠŠå…¶ä»–æ— å…³çš„ä½æ¸…0ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸ºè¾“å…¥çš„æ•°å°äºç­‰äº1&amp;lt;&amp;lt;10ï¼Œå³åªæœ‰10ä¸ªæœ‰æ•ˆbit[0,1,2,Â·Â·Â·,9]ï¼Œæœ€å¤§çš„æ˜¯ç¬¬9bitï¼Œ9*3=27ï¼Œæ‰€ä»¥27bitä¹‹åçš„æœ€å4ä¸ªbits [28, 29, 30 ,31]ï¼Œå¿…ç„¶éƒ½æ˜¯0ã€‚ä¸‹é¢å‡½æ•°çš„æ³¨é‡Šä¹Ÿå·²æ ‡æ˜ã€‚&lt;/p&gt;

&lt;p&gt;ç¤ºæ„å›¾ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.12/1.png&quot; alt=&quot;1.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;ï¼ˆfrom pbrt v3)&lt;/p&gt;

&lt;p&gt;å®ç°ä»£ç å¦‚ä¸‹ï¼Œç”¨äº†ä½è¿ç®—æŠ€å·§ï¼Œéœ€è¦æ…¢æ…¢ç†è§£ï¼ˆçœ‹æ³¨é‡Šï¼Œæ¯ä¸€è½®å˜æ¢éƒ½æ˜¯ä¸€æ¬¡åˆ†éš”ï¼Œå˜æ¢åéƒ½ç»™å‡ºäº†æœ‰æ•ˆä½çš„æ–°ä½ç½®ï¼‰ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;LeftShift3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b00000011000000000000000011111111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// x = ---- --98 ---- ---- ---- ---- 7654 3210&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b00000011000000001111000000001111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// x = ---- --98 ---- ---- 7654 ---- ---- 3210&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b00000011000011000011000011000011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// x = ---- --98 ---- 76-- --54 ---- 32-- --10&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b00001001001001001001001001001001&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// x = ---- 9--8 --7- -6-- 5--4 --3- -2-- 1--0&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;EncodeMorton3&lt;/h3&gt;

&lt;p&gt;ç†è§£äº†LeftShift3åå†æ¥ç†è§£EncodeMorton3å°±å¾ˆç®€å•äº†ï¼Œå°±ä¸€è¡Œä»£ç ï¼š&lt;/p&gt;

&lt;p&gt;(LeftShift3(v.z) &amp;lt;&amp;lt; 2) | (LeftShift3(v.y) &amp;lt;&amp;lt; 1) | LeftShift3(v.x);&lt;/p&gt;

&lt;p&gt;è°ƒç”¨äº†ä¸‰æ¬¡LeftShift3ï¼Œåˆ†åˆ«è¾“å…¥äº†å‘é‡vçš„xã€yã€zåˆ†é‡ã€‚å› ä¸ºLeftShift3ä½œç”¨æ˜¯ç”¨2ä¸ª0bitåˆ†å‰²æœ‰æ•ˆä½ï¼Œæ‰€ä»¥EncodeMorton3é‡Œï¼ŒLeftShift3(v.y) éœ€è¦æ•´ä½“å·¦ç§»1ä¸ªbitï¼ŒLeftShift3(v.z)åˆ™æ˜¯2ä¸ªbitï¼Œå¡«æ»¡äº†æ€»å…±3 * 10 = 30ä¸ªbitï¼ˆè¿˜æœ‰2ä¸ª0bitå¯ä¸ç®¡ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å®ç°ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;EncodeMorton3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Vector3dF&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;z&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;z&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LeftShift3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;z&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LeftShift3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LeftShift3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ç¤ºæ„å›¾ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.12/2.png&quot; alt=&quot;2.png&quot;&gt;&lt;/p&gt;

&lt;h2&gt;HLBVHBuild æ¦‚è§ˆ&lt;/h2&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HLBVHBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ComponentHandle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;MemoryArena&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ObjectID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 1. è®¡ç®—æ‰€æœ‰ç‰©ä½“ä¸­å¿ƒåæ ‡çš„åŒ…å›´ç›’&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;pi&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 2. å¹¶è¡Œè®¡ç®—æ¯æ‰€æœ‰ç‰©ä½“çš„MortonObjä¿¡æ¯&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ParallelFor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// è«é¡¿ç å…±10ä½&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonBits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonScale&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonBits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// centroidOffsetæ˜¯è¯¥objä¸­å¿ƒåœ¨åŒ…å›´ç›’é‡Œçš„ç™¾åˆ†æ¯”åæ ‡&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Vector3dF&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// æŠŠç™¾åˆ†æ¯”åæ ‡æ˜ å°„åˆ°[0, 1024]ï¼Œç„¶åç¼–æˆè«é¡¿ç &lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EncodeMorton3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonScale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 3. mortonObjsæ•°ç»„åšåŸºæ•°æ’åº&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;RadixSort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 4. æŒ‰ç…§è«é¡¿ç çš„é«˜ä½æ˜¯å¦ä¸€æ ·ï¼ˆéƒ½å±äºåŒä¸€ä¸ªgridï¼‰ï¼Œå¯¹æ‰€æœ‰ç‰©ä½“åˆ†ç»„&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// å¦‚æœç‰©ä½“åˆ†å¸ƒå¾ˆç¨€ç–çš„è¯ï¼Œå°±æ˜¯ä¸€ä¸ªç‰©ä½“ä¸€ä¸ªtreelet, nObjsä¸º1&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ï¼ˆtreeletå¯ä»¥å«åšå¹¼æ ‘ï¼Œæ„æŒ‡æ•´ä¸ªBVHæ ‘çš„ä¸‹å±‚éƒ¨åˆ†çš„å•ä¸ªå­æ ‘ï¼‰&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// è¢«maskä¸º1çš„bitsæœ‰12ä¸ªï¼Œæ‰€ä»¥æ€»å…±æœ‰2^12=4096ä¸ªgrid ï¼ˆtreeletï¼‰&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// å› ä¸ºæœ‰3ä¸ªç»´åº¦ï¼Œæ‰€ä»¥å•ç»´åº¦ä¸Šæ˜¯2^4=16ä¸ªgrid&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LBVHTreelet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletsToBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b00111111111111000000000000000000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxBVHNodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Alloc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxBVHNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;treeletsToBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nodes&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 5.å¼€å§‹æ„é€ BVHäº†&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 5.1 è¿™æ®µä»£ç æœ€å…³é”®çš„å°±æ˜¯å¹¶è¡Œè°ƒç”¨emitLBVHï¼Œå’Œç»Ÿè®¡totalNodes&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// æ³¨æ„ï¼Œè¿™é‡Œæ„å»ºäº†nä¸ªBVHå­æ ‘ï¼Œn=treeletsToBuild.size()&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ä¸‹ä¸€ä¸ªæ­¥éª¤ä¼šæŠŠè¿™nä¸ªBVHå­æ ‘å½“æˆnä¸ªç‰©ä½“ï¼Œå’ŒrecursiveBuildä¸€æ ·è‡ªé¡¶å‘ä¸‹æ„å»ºBVH&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;atomic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;atomicTotal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ParallelFor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Generate _i_th LBVH treelet&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nodesCreated&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstBitIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;29&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;LBVHTreelet&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletsToBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;emitLBVH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;startIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nodesCreated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orderedObjsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstBitIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;atomicTotal&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nodesCreated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletsToBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;atomicTotal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 5.2 æŠŠstd::vector&amp;lt;LBVHTreelet&amp;gt;çš„buildNodes æ”¾è¿› finishedTreelets&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finishedTreelets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;finishedTreelets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reserve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeletsToBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LBVHTreelet&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;treelet&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletsToBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;finishedTreelets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treelet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 5.3 æ„é€ BVHçš„ä¸Šå±‚éƒ¨åˆ†&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;buildUpperSAH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finishedTreelets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finishedTreelets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;RadixSort&lt;/h3&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;RadixSort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tempVector&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitsPerPass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nBits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitsPerPass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nPasses&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitsPerPass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nPasses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Perform one pass of radix sort, sorting _bitsPerPass_ bits&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lowBit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitsPerPass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// Set in and out vector pointers for radix sort pass&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;tempVector&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;out&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tempVector&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// Count number of zero bits in array for current radix sort bit&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitsPerPass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucketCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitMask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitsPerPass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lowBit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitMask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bucket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bucketCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// Compute starting index in output array for each bucket&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;outIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;outIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;outIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;outIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucketCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// Store sorted values in output array&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lowBit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitMask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;outIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Copy final result from _tempVector_, if needed&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nPasses&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tempVector&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;emitLBVH&lt;/h3&gt;

&lt;p&gt;emitLBVHä¼šé€’å½’è°ƒç”¨è‡ªå·±ï¼Œè‡ªé¡¶å‘ä¸‹æ„å»ºBVHæ ‘ã€‚&lt;/p&gt;

&lt;p&gt;æ³¨æ„ï¼ŒemitLBVHä¾ç„¶é‡‡ç”¨è‡ªé¡¶å‘ä¸‹çš„æ„å»ºæµç¨‹ï¼Œä½†æ˜¯å´å¯ä»¥å¤šçº¿ç¨‹å¹¶è¡Œæ„å»ºn(1&amp;lt;=n&amp;lt;=4096)ä¸ªgridçš„BVHï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–ç‚¹ï¼›ç¬¬äºŒä¸ªæ€§èƒ½ä¼˜åŒ–ç‚¹ï¼Œåœ¨äºemitLBVHæ„é€ BVHæ˜¯çº¿æ€§çš„ï¼Œå³O(n)æ—¶é—´å¤æ‚åº¦ï¼Œè¿™å½’åŠŸäºå‰é¢çš„è«é¡¿ç æ’åºã€‚&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emitLBVH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ComponentHandle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;MortonObj&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ObjectID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;atomic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orderedObjsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bitIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxObjsInNode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Create and return leaf node of LBVH treelet&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// å¯¹orderedObjsOffsetåšåŸå­æ“ä½œï¼š+=nObjsã€‚å¹¶è¿”å›+=å‰çš„å€¼&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjsOffset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fetch_add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;InitLeaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitIndex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// å¦‚æœç¬¬ä¸€ä¸ªç‰©ä½“å’Œæœ€åä¸€ä¸ªç‰©ä½“çš„mask bitæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆè¿™æ‰¹ç‰©ä½“ä½ç½®å¾ˆé›†ä¸­ï¼Œå¯ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ª mask bit&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;emitLBVH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;bitIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// äºŒåˆ†æŸ¥æ‰¾åˆ‡åˆ†ä½ç½®ï¼Œå³mask bitå‘ç”Ÿâ€˜çªå˜â€™çš„ç‰©ä½“çš„ç´¢å¼•&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;searchStart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;searchEnd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;searchStart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;searchEnd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;searchStart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;searchEnd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;searchStart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;searchEnd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;searchStart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt;
                &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;searchStart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt;
                    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;searchEnd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;searchEnd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;splitOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;searchEnd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splitOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splitOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splitOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;


        &lt;span class=&quot;c1&quot;&gt;// æ‰¾åˆ°åˆ‡åˆ†ç‚¹äº†ï¼Œç°åœ¨å»ºç«‹ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹nodeï¼Œå¹¶å¯¹åˆ‡åˆ†ç‚¹å·¦å³ä¸¤æ‰¹ç‰©ä½“é€’å½’è°ƒç”¨emitLBVHï¼Œå»ºç«‹å­æ ‘&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å†…éƒ¨èŠ‚ç‚¹&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// lbvh[0]å’Œlbvh[1]åˆ†åˆ«æ˜¯nodeçš„å·¦å³å­©å­èŠ‚ç‚¹&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lbvh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;emitLBVH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;splitOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;bitIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;emitLBVH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mortonObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splitOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;splitOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;bitIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// è¿™ä¸ªmask bitå¯¹åº”çš„æ˜¯å“ªæ¡åæ ‡è½´&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Axis&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;axis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Axis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bitIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;InitInterior&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;axis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lbvh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lbvh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;buildUpperSAH&lt;/h3&gt;

&lt;p&gt;å¯¹æ‰€æœ‰treeletï¼Œè‡ªé¡¶å‘ä¸‹æ„å»ºBVHçš„ä¸Šå±‚éƒ¨åˆ†ï¼Œç”¨äº†é€’å½’ã€‚&lt;/p&gt;

&lt;p&gt;ç¬¬ä¸€æ¬¡è°ƒç”¨buildUpperSAHåˆ›å»ºçš„æ˜¯æ ¹èŠ‚ç‚¹ï¼ŒåŒ…å«æ‰€æœ‰treeletï¼›&lt;/p&gt;

&lt;p&gt;å¦‚æœnNodesä¸º1ï¼Œé‚£ä¹ˆå·²ç»åˆ°è¾¾æŸä¸ªtreeletï¼Œç»ˆæ­¢é€’å½’ï¼›&lt;/p&gt;

&lt;p&gt;å¦‚æœnNodes &amp;gt; 1ï¼Œåˆ›å»ºå†…éƒ¨èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨2æ¬¡buildUpperSAHï¼Œåˆ›å»ºè¯¥å†…éƒ¨èŠ‚ç‚¹çš„å·¦å³å­æ ‘ã€‚&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buildUpperSAH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MemoryArena&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nNodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nNodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å·²ç»åˆ°åº•äº†ï¼Œç»ˆæ­¢é€’å½’&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Alloc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Compute bounds of all nodes under this HLBVH node&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Compute bound of HLBVH node centroids, choose split dimension _dim_&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Vector3dF&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
            &lt;span class=&quot;mf&quot;&gt;0.5f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Axis&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MaximumExtent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// FIXME: if this hits, what do we need to do?&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Make sure the SAH split below does something... ?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—buckets, å¯å‚è€ƒrecursiveBuild&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;BucketInfo&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
            &lt;span class=&quot;mf&quot;&gt;0.5f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]));&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;computeCosts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.125f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCostSplitBucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;findMinCost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;minCost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;minCostSplitBucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// æ¯ä¸ªtreeletæ‹¿è‡ªå·±çš„bucketå€¼å’ŒminCostSplitBucketæ¯”è¾ƒå¤§å°ï¼Œåˆ‡åˆ†æˆ2éƒ¨åˆ†&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pmid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;partition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]));&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCostSplitBucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pmid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;InitInterior&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildUpperSAH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;buildUpperSAH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;treeletRoots&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;HLBVHBuildçš„ç‰¹ç‚¹ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;æŠŠæ•´ä¸ªBVHæ ‘çš„æ„å»ºï¼Œæ‹†æˆä¸Šå±‚ã€ä¸‹å±‚ä¸¤éƒ¨åˆ†å·¥ä½œï¼š&lt;/p&gt;

&lt;p&gt;ä¸‹å±‚ï¼šå¹¶è¡Œæ„å»ºtreeletï¼ˆå¹¼æ ‘ï¼‰&lt;/p&gt;

&lt;p&gt;ä¸Šå±‚ï¼šæŠŠæ„å»ºå¥½çš„æ‰€æœ‰treeletä½œä¸ºå¶å­èŠ‚ç‚¹ï¼Œè¿›è€Œæ„é€ BVHä¸Šå±‚éƒ¨åˆ†&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;å’ŒrecursiveBuildï¼Œä¾ç„¶è¿˜æ˜¯ç”¨è‡ªé¡¶å‘ä¸‹çš„æ„é€ æµç¨‹ï¼ˆä¸Šå±‚ã€ä¸‹å±‚éƒ½æ˜¯ï¼‰&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;HLBVHBuildçš„ä¸Šå±‚éƒ¨åˆ†è®¡ç®—å’ŒrecursiveBuildåŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆæ”¹è¿›ï¼Œä¸€æ ·ç”¨äº†SAHç®—æ³•&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;HLBVHBuildçš„ä¸‹å±‚éƒ¨åˆ†è®¡ç®—æ‰æ˜¯æ€§èƒ½å…³é”®ä¹‹å¤„ï¼š&lt;/p&gt;

&lt;p&gt;å…³é”®ç‚¹1ï¼šå¯¹æ‰€æœ‰ç‰©ä½“è¿›è¡Œäº†è«é¡¿ç¼–ç ï¼Œè«é¡¿ç¼–ç åç”¨äº†è‡ªå®šä¹‰çš„é«˜æ•ˆåŸºæ•°æ’åºï¼Œç„¶åå°±å¯ä»¥å¿«é€ŸæŠŠæ‰€æœ‰ç‰©ä½“æ ¹æ®ç©ºé—´ä½ç½®åˆ†ç»„ï¼Œç”Ÿæˆtreelet&lt;/p&gt;

&lt;p&gt;å…³é”®ç‚¹2: ç”¨äº†å¤šçº¿ç¨‹ä»è€Œå¹¶è¡Œæ„å»ºtreeletçš„BVHç»“æ„&lt;/p&gt;

&lt;p&gt;å…³é”®ç‚¹3ï¼šæ¯ä¸ªtreeletè¿˜å¯ä»¥åˆ©ç”¨æ’å¥½åºçš„è«é¡¿ç ä¿¡æ¯ï¼Œçº¿æ€§ï¼ˆO(n)å¤æ‚åº¦ï¼‰æ„å»ºtreeletçš„BVHç»“æ„&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ€»ä¹‹ï¼ŒHLBVHBuildå®é™…ä¸Šæ˜¯åœ¨recursiveBuildçš„åŸºç¡€ä¸Šï¼Œåšäº†æ”¹è¿›çš„ç‰ˆæœ¬ï¼Œå› ä¸ºHLBVHBuildçš„ä¸Šå±‚éƒ¨åˆ†å°±ç›¸å½“äºrecursiveBuildã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼ŒHLBVHBuildä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯è‡ªåº•å‘ä¸Šçš„ç®—æ³•ï¼Œå› ä¸ºæ˜¯å…ˆéå†äº†æ‰€æœ‰ç‰©ä½“ç®—è«é¡¿ç å¹¶æ„å»ºå„ä¸ªtreeletã€‚&lt;/p&gt;
</description>
        <pubDate>Wed, 20 Dec 2017 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/bvh-2/</link>
        <guid isPermaLink="true">http://localhost:4000/bvh-2/</guid>
      </item>
    
      <item>
        <title>Bounding Volume Hierachy of pbrt è§£æ(1)</title>
        <description>&lt;h2&gt;äºŒå‰æ ‘BVH&lt;/h2&gt;

&lt;p&gt;BVHæ˜¯ç©ºé—´åˆ‡åˆ†æŠ€æœ¯ä¹‹ä¸€ï¼Œé™¤äº†BVHä¹‹å¤–è¿˜æœ‰kdtreeã€octreeã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢å…ˆä»¥é™æ€åœºæ™¯ä¸ºä¾‹ï¼Œè®²è§£BVHçš„ç”Ÿæˆç®—æ³•ã€‚&lt;/p&gt;

&lt;!--more--&gt;

&lt;h2&gt;é™æ€åœºæ™¯ç”ŸæˆBVH&lt;/h2&gt;

&lt;h3&gt;åˆå§‹åŒ–&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆè¦ç¡®ä¿åœºæ™¯é‡Œçš„3då¯¹è±¡éƒ½å¯ä»¥ç®—å‡ºå®ƒçš„AABBç›’ï¼ˆä¸‹é¢ç®€ç§°BBoxï¼‰ï¼ˆæ¨¡å‹ç©ºé—´ï¼‰ï¼Œç„¶åç»è¿‡scene graphä»¥åŠè‡ªèº«çš„æ¨¡å‹çŸ©é˜µï¼ŒæŠŠåŒ…å›´ç›’å˜æ¢åˆ°ä¸–ç•Œç©ºé—´ï¼Œç§°ä¹‹ä¸ºworld boundã€‚&lt;/p&gt;

&lt;p&gt;ä»£ç ç‰‡æ®µâ€”â€”æ‰¾å‡ºå¾…è®¡ç®—çš„æ‰€æœ‰3då¯¹è±¡ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ObjectID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// æ‰€æœ‰3då¯¹è±¡çš„idåˆ—è¡¨&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objScene&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filterFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;filterFunc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objScene&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objScene&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hasComponent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SpatialData&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objScene&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hasComponent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MeshRef&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ObjectID&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objScene&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sgNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objScene&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;component&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SceneGraphNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;childObjID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sgNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;childObj&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_objMgr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;childObjID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;filterFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;childObj&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// æ ‘é€’å½’&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt; 
&lt;span class=&quot;n&quot;&gt;filterFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objScene&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ä»£ç ç‰‡æ®µâ€”â€”é¢„å…ˆç®—å‡ºæ‰€æœ‰ç‰©ä½“çš„world boundï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ObjectID&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;obj&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_objMgr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;meshRef&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;obj&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;component&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MeshRef&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;spatialData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;obj&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;component&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SpatialData&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mesh&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mesh&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;meshSet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getMesh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;meshRef&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;meshID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bound&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mesh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Bound&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;worldBound&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;spatialData&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;o2w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bound&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;worldBound&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ä»£ç ç‰‡æ®µâ€”â€”BVHç”Ÿæˆæµç¨‹ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// ç»Ÿè®¡æ€»å…±åŠ¨æ€åˆ›å»ºäº†å¤šå°‘ä¸ªBVHBuildNode&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ObjectID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reserve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// åˆ†é…ç©ºé—´ &lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// 2ç§æ„é€ ç®—æ³•ï¼Œé€‰1&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splitMethod&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SplitMethod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HLBVH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HLBVHBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;recursiveBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// æ„é€ å®Œæ¯•&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// è®¡ç®—ç”¨æ·±åº¦ä¼˜å…ˆéå†è¡¨ç¤ºçš„BVHäºŒå‰æ ‘æ•°ç»„&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AllocAligned&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LinearBVHNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;flattenBVHTree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;å¯ä»¥å‘ç°ï¼ŒBVHçš„æ ¸å¿ƒç®—æ³•ä»£ç å°±åœ¨recursiveBuildå’ŒHLBVHBuildé‡Œé¢äº†ã€‚&lt;/p&gt;

&lt;h3&gt;ç›¸å…³æ•°æ®ç»“æ„&lt;/h3&gt;

&lt;p&gt;BVHBuildNode:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// ç”ŸæˆBVHçš„è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°è¿™ä¸ªstructï¼Œä»£è¡¨BVHçš„ä¸€ä¸ªèŠ‚ç‚¹&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// è¯¥å­æ ‘çš„åŒ…å›´ç›’ &lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å·¦å³å­©å­èŠ‚ç‚¹&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Axis&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;splitAxis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// æ˜¯åˆ‡äº†å“ªæ¡åæ ‡è½´&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹çš„è¯ï¼Œè¿™2ä¸ªå˜é‡è®°å½•äº†è¢«åŒ…å«çš„3dç‰©ä½“&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// æŠŠnodeåˆå§‹åŒ–ä¸ºå¶å­èŠ‚ç‚¹&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InitLeaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nullptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// æŠŠnodeåˆå§‹åŒ–ä¸ºå†…éƒ¨èŠ‚ç‚¹&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InitInterior&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Axis&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;axis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splitAxis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;axis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;BVHObjInfo:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.5f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.5f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// è®°å½•è¿™ä¸ª3då¯¹è±¡åœ¨bvhAccel-&amp;gt;objsæ•°ç»„çš„ä½ç½®&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Vector3dF&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// åŒ…å›´ç›’ä¸­å¿ƒåæ ‡&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;recursiveBuild&lt;/h3&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;recursiveBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ComponentHandle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;n&quot;&gt;MemoryArena&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ObjectID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Alloc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BVHBuildNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// è®¡æ•°&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// [start, end) åŒºé—´å†…æ‰€æœ‰ç‰©ä½“çš„åŒ…å›´ç›’çš„å¹¶é›†åŒ…å›´ç›’&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// [start, end)åŒºé—´å†…çš„ç‰©ä½“æ•°é‡&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å¦‚æœåªæœ‰ä¸€ä¸ªç‰©ä½“ï¼Œé‚£å°±æŠŠnodeè®¾ç½®ä¸ºå¶èŠ‚ç‚¹&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;InitLeaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;Â·Â·Â·Â·Â·Â·&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// B&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;B:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// è®¡ç®—[start, end)é‡Œçš„ç‰©ä½“åŒ…å›´ç›’ä¸­å¿ƒåæ ‡çš„åŒ…å›´ç›’&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//  æŠŠè¾¹é•¿æœ€é•¿çš„åæ ‡è½´ä½œä¸ºåˆ‡åˆ†è½´&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Axis&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MaximumExtent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Partition objs into two sets and build children&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// åœ¨è¾¹é•¿æœ€é•¿çš„è½´ä¸Šï¼Œç«Ÿç„¶pMaxå’ŒpMinè¿˜ç›¸ç­‰ï¼Œè¯´æ˜åŒ…å›´ç›’ä¸­å¿ƒéƒ½é‡å äº†ï¼Œ&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// æŠŠè¿™äº›ç‰©ä½“éƒ½å½’å…¥åŒä¸ªå¶å­èŠ‚ç‚¹&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;InitLeaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ï¼ˆå’Œä¸Šé¢é‚£æ®µä»£ç ä¸€æ¨¡ä¸€æ ·ï¼‰&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;Â·Â·Â·Â·Â·Â·&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// C&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;åˆ°äº†Cï¼Œå°±çœŸçš„è¦åš&lt;strong&gt;ç©ºé—´åˆ‡åˆ†&lt;/strong&gt;äº†ï¼Œéœ€è¦æ ¹æ®SplitMethodé€‰æ‹©åˆ‡åˆ†ç®—æ³•ã€‚&lt;/p&gt;

&lt;p&gt;C:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// é»˜è®¤mid&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// è¿™ä¸ªswitchçš„ä½œç”¨å°±æ˜¯æŠŠ[start,end)çš„ç‰©ä½“åˆ‡åˆ†å¼€ï¼Œå¹¶æŠŠåˆ‡åˆ†ä½ç½®è®°åˆ°mid&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ä»è€Œå¯ä»¥å¯¹åˆ‡å‡ºæ¥çš„2ä¸ªå­æ ‘ç»§ç»­build&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splitMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SplitMethod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;Middle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; 
        &lt;span class=&quot;c1&quot;&gt;// ä¸­å¿ƒåˆ‡åˆ†æ³•&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// pmidæ˜¯æœ€é•¿è¾¹çš„è¾¹ä¸­å¿ƒç‚¹&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pmid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// æŠŠ[start, end)é‡Œçš„ç‰©ä½“æŒ‰pmidåˆ‡åˆ†ï¼Œå°äºpmidçš„åœ¨å‰é¢&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// æ³¨æ„ï¼Œpartitionå¹¶ä¸æ˜¯æ’åº&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;midPtr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;partition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pmid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pmid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;midPtr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// midPtræŒ‡å‘äº†pmidå³ä¾§ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åè½¬æˆæ•°ç»„ä¸‹æ ‡mid&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// å¦‚æœmidç­‰äºstartæˆ–endï¼Œè¯´æ˜è¿™äº›ç‰©ä½“è¦ä¹ˆéƒ½åœ¨pmidå·¦ä¾§ï¼Œè¦ä¹ˆéƒ½åœ¨å³ä¾§ï¼Œåˆ‡åˆ†æ— æ„ä¹‰&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// æ‰€ä»¥ä¸èƒ½breakï¼Œç»§ç»­è¿›å…¥EqualCountsåˆ‡åˆ†&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ï¼ˆä½†æŒ‰ç…§å‰é¢çš„é€»è¾‘æ¥çœ‹ï¼Œè¿™é‡Œä¸åº”è¯¥ä¸€ä¸ªéƒ½åˆ‡åˆ†ä¸å‡ºæ¥ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªä¿é™©æªæ–½ï¼‰&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SplitMethod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;EqualCounts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// æŒ‰ç…§æ•°é‡å¯¹åŠåˆ‡&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// nth_elementæ˜¯åæ’åºï¼Œä¿è¯æ¯”midå°çš„éƒ½æ’åœ¨midä¹‹å‰ï¼Œæ¯”midå¤§çš„éƒ½åœ¨midä¹‹åï¼Œä½†ä¸ä¿è¯æœ‰åº&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nth_element&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SplitMethod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;SAH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;Â·Â·Â·Â·&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// D&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// é€’å½’æ„é€ å­æ ‘&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;InitInterior&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;recursiveBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;recursiveBuild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arena&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;totalNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Dï¼Œæ˜¯åŸºäºæ¦‚ç‡ã€è¡¨é¢ç§¯çš„å¯å‘å¼åˆ‡åˆ†æ³•SAH(Surface Area Heuristic)ï¼Œè¦ç”¨åˆ°ä¸€æ¡å…¬å¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ cost(A, B) = t_{trav} + P_{A} \sum _{i=1}^{N_{A} } t_{isect}(a_{i}) + P_{B} \sum _{i=1}^{N_{B} } t_{isect}(b_{i})  \]&lt;/p&gt;

&lt;p&gt;cost(A, B)æ˜¯rayå’Œè¿™ä¸ªå†…éƒ¨èŠ‚ç‚¹åšç›¸äº¤è®¡ç®—çš„æ—¶é—´å¼€é”€ï¼›&lt;/p&gt;

&lt;p&gt;\( P_{A} ã€ P_{B}\) åˆ†åˆ«æ˜¯rayç»è¿‡Aã€Bå­æ ‘çš„æ¦‚ç‡ï¼›&lt;/p&gt;

&lt;p&gt;\( N_{A} ã€N_{B}\) åˆ†åˆ«æ˜¯Aã€Bå­æ ‘çš„ç‰©ä½“çš„æ•°é‡ï¼›&lt;/p&gt;

&lt;p&gt;\( t_{trav} \) æ˜¯éå†ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶é—´å¼€é”€ï¼Œ\( t_{isect}(a_{i}) ã€ t_{isect}(b_{i}) \) åˆ†åˆ«æ˜¯rayå’Œå­æ ‘æŸä¸ªå¯¹è±¡åŒ…å›´ç›’åšç›¸äº¤è®¡ç®—çš„æ—¶é—´å¼€é”€ã€‚å¯ä»¥ç®€å•å‡è®¾\(t_{trav}ã€t_{isect}\)éƒ½æ˜¯å¸¸æ•°1ã€‚é‚£ä¹ˆä¸Šå¼ç®€åŒ–æˆï¼š&lt;/p&gt;

&lt;p&gt;\[ cost(A, B) = 1 + P_{A} \sum _{i=1}^{N_{A} } 1  + P_{B} \sum _{i=1}^{N_{B} } 1 =  1 + P_{A} N_{A} + P_{B} N_{B} \]&lt;/p&gt;

&lt;p&gt;\( P_{A} ã€ P_{B}\) å¯ä»¥ç”¨è¡¨é¢ç§¯æ¯”æ¥æ±‚å‡ºï¼š&lt;/p&gt;

&lt;p&gt;\[ P_{A} = \frac {S_{A} }{S_{parent } }\]&lt;/p&gt;

&lt;p&gt;\[ P_{B} = \frac {S_{B} }{S_{parent } }\]&lt;/p&gt;

&lt;p&gt;ç„¶åå°±æ˜¯åº”ç”¨é—®é¢˜ï¼Œå› ä¸ºåˆ‡åˆ†çš„æœ€ä¼˜ä½ç½®å¹¶ä¸èƒ½ç›´æ¥å¾—åˆ°ï¼Œéœ€è¦å¯¹æ‰€æœ‰å¯åˆ‡åˆ†ç‚¹éƒ½åšè¿™æ¡å…¬å¼ç®—å‡ºcostï¼Œç„¶åå–é‚£ä¸ªæœ€å°å€¼ã€‚&lt;/p&gt;

&lt;p&gt;æ˜¾ç„¶è¿™å¾ˆæš´åŠ›ï¼Œæ‰€ä»¥pbrtä½œè€…è®¾è®¡äº†bucketæœºåˆ¶ï¼Œå…¶å®å°±æ˜¯æŠŠç›¸é‚»çš„ç‰©ä½“æ†ç»‘æ‰“åŒ…ï¼Œå½“ä½œä¸€ä¸ªæ•´ä½“ï¼Œå†æ¥éå†å„ä¸ªåˆ‡åˆ†ç‚¹ç®—costã€‚&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å¦‚æœç”¨äº†SAHä½†è¿™ä¸ªèŠ‚ç‚¹åªæœ‰2ä¸ªç‰©ä½“ï¼Œå°±æ²¡å¿…è¦ç®—SAHäº†ï¼Œç›´æ¥åˆ‡&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nth_element&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;constexpr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BucketInfo&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// åˆå§‹åŒ–bucket&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—åˆ‡åˆ†å¼€é”€&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;BBox&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;count0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;count1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;b0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;count0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;b1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Union&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;count1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;count0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SurfaceArea&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;count1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SurfaceArea&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SurfaceArea&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// çº¿æ€§éå†ï¼Œæ‰¾å‡ºcostæœ€å°çš„&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCost&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCostSplitBucket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;minCost&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;minCostSplitBucket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;leafCost&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// å¦‚æœæ•°é‡æ¯”maxObjsInNodeå¤§ æˆ–è€… åˆ‡åˆ†å¼€é”€æ¯”ç›´æ¥å¼„æˆå¶å­èŠ‚ç‚¹å¼€é”€å°ï¼Œå°±åšåˆ‡åˆ†&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxObjsInNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCost&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;leafCost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pmid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;partition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;](&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BVHObjInfo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;centroidBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;centroid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nBuckets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;minCostSplitBucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pmid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// å¦åˆ™ï¼Œå¼„æˆå¶å­èŠ‚ç‚¹å°±è¡Œäº†ï¼ˆè¿™æ®µä»£ç å‡ºç°ç¬¬ä¸‰æ¬¡äº†ï¼‰&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;orderedObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bvhAccel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;InitLeaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstObjOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nObjs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
        <pubDate>Wed, 20 Dec 2017 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/bvh-1/</link>
        <guid isPermaLink="true">http://localhost:4000/bvh-1/</guid>
      </item>
    
      <item>
        <title>æ–¹å·®é˜´å½±è´´å›¾ä¸åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼</title>
        <description>&lt;p&gt;è¦ç†è§£æ–¹å·®é˜´å½±è´´å›¾çš„æ¥é¾™å»è„‰ï¼Œå¿…é¡»å…ˆæ·±åˆ»ç†è§£æ¦‚ç‡è®ºä¸­çš„å‡ ä¸ªæ¦‚å¿µï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;çŸ©(Moment)&lt;/li&gt;
&lt;li&gt;æ•°å­¦æœŸæœ›(Mean)&lt;/li&gt;
&lt;li&gt;æ–¹å·®(Variance)&lt;/li&gt;
&lt;li&gt;é©¬å¯å¤«ä¸ç­‰å¼ (Markov&amp;#39;s Inequality)&lt;/li&gt;
&lt;li&gt;åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼ (Chebyshev&amp;#39;s inequality)&lt;/li&gt;
&lt;li&gt;åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼çš„one-tailedç‰ˆæœ¬ (one-tailed version of Chebyshev&amp;#39;s inequality)&lt;/li&gt;
&lt;/ul&gt;

&lt;!--more--&gt;

&lt;h2&gt;çŸ©(Moment)&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Moment_(mathematics)&quot;&gt;https://en.wikipedia.org/wiki/Moment_(mathematics)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç»™å®šå…³äºå®å˜é‡xã€å¸¸æ•°cçš„å®å€¼è¿ç»­å‡½æ•°f(x)ï¼Œå®ƒçš„né˜¶çŸ©ï¼ˆn-th moment)çš„å…¬å¼æ˜¯ï¼š&lt;/p&gt;

&lt;p&gt;\[ \mu ^{n} = \int _{-\infty }^{ +\infty  } (x - c)^{n} f(x) dx \] &lt;/p&gt;

&lt;h2&gt;æ•°å­¦æœŸæœ›(Mean)&lt;/h2&gt;

&lt;p&gt;å½“c = 0ï¼Œn = 1æ—¶ï¼Œä¸Šè¿°å…¬å¼å˜æˆï¼š&lt;/p&gt;

&lt;p&gt;\[ \mu = \int _{-\infty }^{ +\infty  } x f(x) dx \] &lt;/p&gt;

&lt;p&gt;è¿™ä¹Ÿå°±æ˜¯æ•°å­¦æœŸæœ›(Mean)çš„ç§¯åˆ†å…¬å¼ã€‚&lt;/p&gt;

&lt;h2&gt;æ–¹å·®(Variance)&lt;/h2&gt;

&lt;p&gt;å½“\(c = \mu\)æ—¶ï¼Œné˜¶çŸ©å¯ç§°ä¸º&lt;strong&gt;né˜¶ä¸­å¿ƒçŸ©&lt;/strong&gt;ï¼›å½“\(c = \muï¼Œn = 2\)æ—¶ï¼Œ2é˜¶ä¸­å¿ƒçŸ©çš„å…¬å¼ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\[ \mu ^{2} =  \int _{-\infty }^{ +\infty  } (x - \mu )^{ 2 } f(x) dx \] &lt;/p&gt;

&lt;p&gt;è¿™å…¶å®å°±æ˜¯æ–¹å·®(Variance)çš„ç§¯åˆ†å…¬å¼ã€‚ä¸‹é¢ä½œç®€å•æ¨å¯¼ã€‚&lt;/p&gt;

&lt;p&gt;æ–¹å·®çš„å®šä¹‰å¼ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\[ Var(X) = E[(X - \mu)^{2}] =  E[(X - E[X])^{2}] = \sigma ^{2}  \]&lt;/p&gt;

&lt;p&gt;å¯ä»¥æ¨å‡ºï¼š&lt;/p&gt;

&lt;p&gt;\[ Var(X) = E[X^{2} - 2 X E[X] + E[X]^{2} ] \]&lt;/p&gt;

&lt;p&gt;\[ = E[X^{2}] - 2 E[X] E[X] + E[X]^{2} \]&lt;/p&gt;

&lt;p&gt;\[ = E[X^{2}] -  E[X]^{2} \]&lt;/p&gt;

&lt;p&gt;è€Œ2é˜¶ä¸­å¿ƒçŸ©å…¬å¼å¯ä»¥æ¨å‡ºï¼š&lt;/p&gt;

&lt;p&gt;\[ \int (x - \mu )^{ 2 } f(x) dx \] &lt;/p&gt;

&lt;p&gt;\[ = \int x^{ 2 } f(x) dx - 2\mu \int x f(x) dx + \int \mu ^{ 2 } f(x) dx \] &lt;/p&gt;

&lt;p&gt;\[ = \int x^{ 2 } f(x) dx - 2\mu \cdot \mu + \mu ^{ 2 } \] &lt;/p&gt;

&lt;p&gt;\[ = \int x^{ 2 } f(x) dx - \mu ^{ 2 } \] &lt;/p&gt;

&lt;p&gt;\[ =E[X^{ 2 }] - E[X] ^{ 2 } \] &lt;/p&gt;

&lt;h2&gt;é©¬å¯å¤«ä¸ç­‰å¼ (Markov&amp;#39;s Inequality)&lt;/h2&gt;

&lt;p&gt;è®¾Xæ˜¯éè´Ÿçš„éšæœºå˜é‡ï¼Œä¸”æœ‰a &amp;gt; 0ï¼Œé‚£ä¹ˆXå¤§äºç­‰äºaçš„æ¦‚ç‡ä¸è¶…è¿‡Xçš„æ•°å­¦æœŸæœ›é™¤ä»¥aï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{ X \geq a } \leq \frac { E[X] }{ a } \]&lt;/p&gt;

&lt;p&gt;ï¼ˆNoteï¼šè¿™é‡Œçš„Pæ˜¯æŒ‡æ¦‚ç‡ï¼‰&lt;/p&gt;

&lt;h3&gt;è¯æ˜ï¼š&lt;/h3&gt;

&lt;p&gt;è¯æ˜å‰éœ€è¦å…ˆç†è§£ä¸€ä¸ªæ¦‚å¿µï¼šç¤ºæ€§å‡½æ•°ï¼ˆIndicatorï¼‰ã€‚å¯¹äºä»»æ„äº‹ä»¶eï¼Œå½“eå‘ç”Ÿæ—¶ï¼Œ\( I _{e}  = 1\)ï¼Œ å½“Eæ²¡å‘ç”Ÿæ—¶ï¼Œ\( I _{e} = 0\)ã€‚&lt;/p&gt;

&lt;p&gt;é‚£ä¹ˆæŠŠ\( X \geq a \)å½“ä½œä¸€ä¸ªäº‹ä»¶eï¼Œå½“eå‘ç”Ÿæ—¶ï¼Œæœ‰ï¼š&lt;/p&gt;

&lt;p&gt;\[  I _{ X \geq a }  = 1  \]&lt;/p&gt;

&lt;p&gt;\[   a I _{ X \geq a } \leq X   \]&lt;/p&gt;

&lt;p&gt;ä¸¤è¾¹åŒæ—¶å˜æˆæ•°å­¦æœŸæœ›ï¼Œä¸ç­‰å¼ä¾ç„¶æˆç«‹ï¼š&lt;/p&gt;

&lt;p&gt;\[   E[a I _{ X \geq a }] \leq E[X]   \]&lt;/p&gt;

&lt;p&gt;åˆå› ä¸ºæ•°å­¦æœŸæœ›çš„çº¿æ€§å…³ç³»ï¼Œæœ‰ï¼š&lt;/p&gt;

&lt;p&gt;\[  E[a I _{ X \geq a }] = a \cdot E[I _{ X \geq a }]   \]&lt;/p&gt;

&lt;p&gt;åˆå› ä¸ºå‡½æ•°\( I _{ X \geq a } \)çš„å–å€¼åªæœ‰2ç§ï¼Œæ‰€ä»¥å¯ç›´æ¥å¾—åˆ°ï¼š&lt;/p&gt;

&lt;p&gt;\[  a \cdot E[I _{ X \geq a }] = a \cdot ( 1\cdot P _{ X \geq a } + 0\cdot P _{ X \lt a }   ) \]&lt;/p&gt;

&lt;p&gt;\[  = a \cdot P _{ X \geq a } \]&lt;/p&gt;

&lt;p&gt;ç»¼ä¸Šï¼Œå°±å¾—åˆ°äº†ï¼š&lt;/p&gt;

&lt;p&gt;\[   a \cdot P _{ X \geq a } \leq E[X]   \]&lt;/p&gt;

&lt;p&gt;\[ P _{ X \geq a } \leq \frac { E[X] }{ a } \]&lt;/p&gt;

&lt;h2&gt;åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼ (Chebyshev&amp;#39;s inequality)&lt;/h2&gt;

&lt;p&gt;è®¾æœ‰éšæœºå˜é‡Xä»¥åŠå®ƒçš„æ•°å­¦æœŸæœ›\(\mu \) ã€æœ‰é™ä¸”ä¸ç­‰äº0çš„æ–¹å·®\( \sigma ^{2} \)ï¼Œå¯¹äºä»»æ„&amp;gt;0çš„å®æ•°kï¼Œä»¥ä¸‹ä¸ç­‰å¼æˆç«‹ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{ | X - \mu | \geq k\sigma } \leq \frac { 1 }{ k^{2} } \]&lt;/p&gt;

&lt;p&gt;ï¼ˆNoteï¼šè¿™é‡Œçš„Pæ˜¯æŒ‡æ¦‚ç‡ï¼‰&lt;/p&gt;

&lt;p&gt;è¿™å°±æ˜¯åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼ã€‚å…¶ä¸­ï¼Œå› ä¸ºæ¦‚ç‡Pæ°¸è¿œå°äºç­‰äº1ï¼Œæ‰€ä»¥kå€¼è¦å¤§äº1è¿™ä¸ªä¸ç­‰å¼æ‰æœ‰æ„ä¹‰ã€‚&lt;/p&gt;

&lt;h3&gt;è¯æ˜ï¼š&lt;/h3&gt;

&lt;p&gt;è®¾æœ‰éšæœºå˜é‡\( Y = (X - \mu )^{2} \) ä»¥åŠ \( a = (k\sigma )^{2} \)ï¼Œä»£å…¥é©¬å¯å¤«ä¸ç­‰å¼åï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{ Y \geq a } \leq \frac { E[Y] }{ a } \]&lt;/p&gt;

&lt;p&gt;\[ P _{ (X - \mu )^{2} \geq (k\sigma )^{2} } \leq \frac { E[(X - \mu )^{2}] }{ (k\sigma )^{2} } \]&lt;/p&gt;

&lt;p&gt;å›é¡¾ä¸‹æ–¹å·®å…¬å¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ Var(X) = E[(X - \mu)^{2}] = \sigma ^{2} \]&lt;/p&gt;

&lt;p&gt;æ˜¾ç„¶æœ‰ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{ (X - \mu )^{2} \geq (k\sigma )^{2} } \leq \frac { E[(X - \mu )^{2}] }{ (k\sigma )^{2} } = \frac { \sigma ^{2} }{ (k\sigma )^{2} } = \frac { 1 }{ k^{2} } \]&lt;/p&gt;

&lt;p&gt;å·¦è¾¹çš„å¼å­å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ï¼š&lt;/p&gt;

&lt;p&gt;\[ (X - \mu )^{2} \geq (k\sigma )^{2}  \]&lt;/p&gt;

&lt;p&gt;\[ |X - \mu | \geq k\sigma  \]&lt;/p&gt;

&lt;p&gt;ï¼ˆå³è¾¹æ²¡æœ‰ç»å¯¹å€¼æ˜¯å› ä¸ºæœ‰å‰ææ¡ä»¶k&amp;gt;0ï¼Œå³ä½¿æ ‡å‡†å·®\(\sigma &amp;lt; 0 \)è¯¥ç­‰å¼ä¾ç„¶æˆç«‹ )&lt;/p&gt;

&lt;p&gt;äºæ˜¯åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼æˆç«‹ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{ | X - \mu | \geq k\sigma } \leq \frac { 1 }{ k^{2} } \]&lt;/p&gt;

&lt;h2&gt;åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼çš„one-tailedç‰ˆæœ¬&lt;/h2&gt;

&lt;p&gt;åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼çš„one-tailedç‰ˆæœ¬å…¶å®å°±æ˜¯&lt;strong&gt;åæ³°åˆ©ä¸ç­‰å¼&lt;/strong&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Cantelli%27s_inequality&quot;&gt;Cantelli&amp;#39;s inequality&lt;/a&gt;ã€‚åæ³°åˆ©ä¸ç­‰å¼å…¬å¼å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.11/1.png&quot; alt=&quot;1.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;(from wikiï¼ŒPrç­‰ä»·äºä¸Šæ–‡çš„Pï¼‰&lt;/p&gt;

&lt;p&gt;è€Œåˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼çš„one-tailedç‰ˆæœ¬å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{  X - \mu  \geq t } \leq \frac { \sigma ^{2} }{ \sigma ^{2} + t ^{2} } ï¼Œt  &amp;gt; 0 \] &lt;/p&gt;

&lt;p&gt;ä¸€æ¨¡ä¸€æ ·çš„ã€‚&lt;/p&gt;

&lt;h3&gt;è¯æ˜ï¼š&lt;/h3&gt;

&lt;p&gt;è¦è¯æ˜one-tailedå…¬å¼ï¼Œè¦ç”¨åˆ°é©¬å¯å¤«ä¸ç­‰å¼ã€‚é¦–å…ˆå®šä¹‰\(Y = X - \mu \)ï¼Œé‚£ä¹ˆå°±æœ‰\(E[Y] = E[X - \mu ] = E[X]- E[\mu ] = \mu - \mu = 0\)ï¼Œä»¥åŠï¼š\( Var[Y] = Var[X - \mu ] = Var[X] - Var[\mu ] = Var[X]  - 0 = Var[X] \)ã€‚&lt;/p&gt;

&lt;p&gt;äºæ˜¯ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{  Y \geq t } = P _{  Y + \mu \geq t + \mu } \leq P _{  (Y + \mu)^{2} \geq (t + \mu)^{2}  }  \]&lt;/p&gt;

&lt;p&gt;è¿™æ—¶å€™ç”¨ä¸Šé©¬å¯å¤«ä¸ç­‰å¼ \( P _{ X \geq a } \leq \frac { E[X] }{ a } \)ï¼Œå¾—åˆ°ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{  (Y + \mu)^{2} \geq (t + \mu)^{2}  } \leq \frac { E[(Y + \mu)^{2}] }{ (t + \mu)^{2} } \]&lt;/p&gt;

&lt;p&gt;å†ç”¨ä¸Šæ–¹å·®å…¬å¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ E[(Y + \mu)^{2}] = Var[Y + \mu] + E[Y + \mu]^{2}   \]&lt;/p&gt;

&lt;p&gt;\[ = Var[Y] + Var[\mu] + E[Y + \mu]^{2}   \]&lt;/p&gt;

&lt;p&gt;\[ = \sigma ^{2} + 0 + (E[Y] + E[\mu])^{2}   \]&lt;/p&gt;

&lt;p&gt;\[ = \sigma ^{2} + (0 + E[\mu])^{2}   \]&lt;/p&gt;

&lt;p&gt;\[ = \sigma ^{2} + \mu ^{2}   \]&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥æœ‰ï¼š&lt;/p&gt;

&lt;p&gt;\[  P _{  Y \geq t } \leq \frac { \sigma ^{2} + \mu ^{2} }{ (t + \mu)^{2} } \]&lt;/p&gt;

&lt;p&gt;æ¥ç€ä»¤ \( \phi(\mu ) = \frac { \sigma ^{2} + \mu ^{2} }{ (t + \mu)^{2} } \)ï¼Œæ±‚å¯¼\( \phi &amp;#39;(\mu ) = 0\)æ—¶çš„\( \mu \)å€¼ã€‚è¿™ä¸ªå¯¼æ•°ç®—èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘æ‰¾äº†ä¸ªåœ¨çº¿å¯¼æ•°è®¡ç®—å·¥å…·æ¥è¾…åŠ©ä¸‹ï¼ˆè¿™ä¸æ˜¯å¹¿å‘Šï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å…ˆè¿›å…¥&lt;a href=&quot;http://zh.numberempire.com/derivativecalculator.php&quot;&gt;http://zh.numberempire.com/derivativecalculator.php&lt;/a&gt;ï¼Œè¾“å…¥ï¼š (a^2+x^2)/((b+x)^2)ï¼Œå¾—åˆ°å¯¼æ•°å…¬å¼ï¼š (2*b*x-2*a^2)/(x^3+3*b*x^2+3*b^2*x+b^3)ã€‚&lt;/p&gt;

&lt;p&gt;aå°±æ˜¯\( \sigma \)ï¼Œbå°±æ˜¯tï¼Œxå°±æ˜¯\(\mu \)ï¼ŒæŠŠè¿™ä¸ªå¼å­å¼„æˆlatexï¼š&lt;/p&gt;

&lt;p&gt;\[ \phi &amp;#39;(\mu ) = \frac { 2bx - 2a^{2} }{ x^{3} + 3bx^{2} + 3b^{2}x + b^{3} } = 0 \]&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªæ–¹ç¨‹ä¹Ÿæ˜¯å¤æ‚ï¼Œç»§ç»­ç”¨å·¥å…·æ¥ç®—å°±å¥½äº†ã€‚&lt;/p&gt;

&lt;p&gt;è¿›å…¥&lt;a href=&quot;http://zh.numberempire.com/equationsolver.php&quot;&gt;http://zh.numberempire.com/equationsolver.php&lt;/a&gt;ï¼Œ&lt;/p&gt;

&lt;p&gt;è¾“å…¥ï¼š(2*b*x-2*a^2)/(x^3+3*b*x^2+3*b^2*x+b^3) = 0ï¼Œ&lt;/p&gt;

&lt;p&gt;å¾—åˆ°ï¼š\( x = \frac { a^{2} } { b } \) ï¼Œå³ï¼š&lt;/p&gt;

&lt;p&gt;\[ \mu = \frac { \sigma ^{2} } { t }  \]&lt;/p&gt;

&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´å½“\( \mu = \frac { \sigma ^{2} } { t }  \)æ—¶ï¼Œ\(  \phi(\mu ) \)å–å¾—æœ€å°å€¼ã€‚è€Œåˆå› ä¸ºå¯¹ä»»æ„çš„\( \mu \)ï¼Œæ¦‚ç‡\( P _{  Y \geq t } \) éƒ½ä¸è¶…è¿‡\(  \phi(\mu ) \)ï¼Œæ‰€ä»¥åŸå…ˆçš„ä¸ç­‰å¼å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–æˆï¼š&lt;/p&gt;

&lt;p&gt;\[  P _{  Y \geq t } \leq \frac { \sigma ^{2} + \mu_{ * } ^{2} }{ (t + \mu _{ * } )^{2} }  = \frac { \sigma ^{2} + (\frac { \sigma ^{2} } { t }) ^{2} }{ (t + \frac { \sigma ^{2} } { t } )^{2} } \]&lt;/p&gt;

&lt;p&gt;å³è¾¹çš„å¼å­ç»§ç»­ç®€åŒ–ï¼›&lt;/p&gt;

&lt;p&gt;\[ \frac { \sigma ^{2} + (\frac { \sigma ^{2} } { t }) ^{2} }{ (t + \frac { \sigma ^{2} } { t } )^{2} }  = \frac {  \frac { \sigma ^{2}t^{2} +\sigma ^{4} } { t^{2} }         } {  \frac { (t^{2} + \sigma ^{2})^{2}  } { t^{2} }     }  = \frac { \sigma ^{2}t^{2} +\sigma ^{4} } { (t^{2} + \sigma ^{2})^{2} } =   \frac { \sigma ^{2} } { t^{2} + \sigma ^{2} } \]&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥ï¼š&lt;/p&gt;

&lt;p&gt;\[  P _{  Y \geq t } =  P _{  X - \mu \geq t } \leq  \frac { \sigma ^{2} } { t^{2} + \sigma ^{2} } \]&lt;/p&gt;

&lt;p&gt;å¾—è¯ã€‚&lt;/p&gt;

&lt;h1&gt;æ–¹å·®é˜´å½±è´´å›¾(VSM)&lt;/h1&gt;

&lt;p&gt;ç”ŸæˆVSMï¼Œç›¸æ¯”SSM(Standard Shadow Map)ï¼Œé™¤äº†æŠŠæ·±åº¦då­˜åˆ°æ·±åº¦å›¾ï¼Œè¿˜è¦å¤šå­˜ä¸€ä¸ªd*dã€‚ä¼¼ä¹çœ‹èµ·æ¥æœ‰ç‚¹è ¢ï¼Œæ˜æ˜æœ‰däº†ï¼Œè¦ç”¨då¹³æ–¹ä¸å°±æ˜¯è¿ç®—çš„æ—¶å€™d*då°±è¡Œäº†å˜›ã€‚å…¶å®VSMçš„åŸç†è¿˜å¾—ç»“åˆä¸€äº›ç¡¬ä»¶çŸ¥è¯†æ¥ç†è§£ã€‚ç›¸æ¯”SSMæ˜¯å•é€šé“è´´å›¾ï¼ŒVSMåˆ™æ˜¯åŒé€šé“è´´å›¾ï¼Œå¹¶ä¸”VSMåœ¨ç”¨äºå…‰ç…§è®¡ç®—å‰ï¼Œ&lt;strong&gt;å¯ä»¥åšçº¹ç†è¿‡æ»¤æˆ–æŠ—é”¯é½¿å¤„ç†&lt;/strong&gt;ï¼Œçº¹ç†è¿‡æ»¤ï¼Œç›¸å½“äºçº¹ç†è¢«æ¨¡ç³ŠåŒ–ï¼ˆVSMèƒ½å®ç°è½¯é˜´å½±çš„å…³é”®ä¹‹å¤„ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;SSMå¹¶ä¸èƒ½è¢«æ¨¡ç³Šï¼Œè€ŒVSMèƒ½æ¨¡ç³ŠåŒ–çš„å¥½å¤„å°±å…ˆä¸è¯´äº†ã€‚æ¨¡ç³ŠåŒ–åï¼Œdå’Œdå¹³æ–¹çš„å€¼å°±åœ¨ä¸€å®šèŒƒå›´å†…åšäº†åç§»ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¾ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;æ¨¡ç³Šå‰çš„æ·±åº¦då’Œdå¹³æ–¹åˆ†åˆ«ä¸ºxå’Œ\( x^{2} \)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;æ¨¡ç³Šåçš„æ·±åº¦då’Œdå¹³æ–¹åˆ†åˆ«ä¸ºä¸€é˜¶çŸ©M1ï¼ˆxçš„æ•°å­¦æœŸæœ›ï¼‰å’Œä¸€é˜¶çŸ©M2ï¼ˆ\( x^{2} \)çš„æ•°å­¦æœŸæœ›ï¼‰&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å†ç”¨ä¸Šå‰é¢ç»™å‡ºçš„æ–¹å·®å…¬å¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ Var(X) = E[X^{2}] -  E[X]^{2} \]&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥å¯¹äºæ¨¡ç³Šå‰çš„xï¼ˆçœŸå®æ·±åº¦ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ±‚å‡ºå®ƒçš„æ•°å­¦æœŸæœ›å’Œæ–¹å·®ï¼š&lt;/p&gt;

&lt;p&gt;\[ \mu = E(x) = M1 \]&lt;/p&gt;

&lt;p&gt;\[ \sigma ^{2} = Var(x) = E[x^{2}] -  E[x]^{2} = M2 - M1^{2} \]&lt;/p&gt;

&lt;p&gt;åˆ°äº†è¿™é‡Œï¼ŒVSMçš„åŸç†å·²ç»ç›¸å½“æ¸…æ¥šäº†ï¼šå…ˆæ˜¯å­˜äº†åŸå§‹çš„æ·±åº¦xå’Œxå¹³æ–¹ï¼Œç„¶ååˆå¯¹xå’Œxå¹³æ–¹åšäº†ä¸€äº›åäº‹ï¼ˆå¯¹æˆ‘ä»¬æ¥è¯´æ˜¯å¥½äº‹ï¼‰ï¼šæŠŠxå’Œxå¹³æ–¹ç¨å¾®æ…æµ‘äº†ï¼Œæ…æµ‘äº†åæƒ³æ¢å¤åŸå§‹çš„xæ˜¯ä¸å¯èƒ½äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ…æµ‘åçš„xå’Œxå¹³æ–¹ï¼ˆä¸€ã€äºŒé˜¶çŸ©ï¼‰ï¼Œç®—å‡ºxçš„&lt;strong&gt;æ–¹å·®&lt;/strong&gt;ï¼Œå†ç»“åˆæ…æµ‘åçš„xï¼ˆxçš„æ•°å­¦æœŸæœ›ï¼Œä¸€é˜¶çŸ©ï¼‰ï¼Œå°±èƒ½å¯¹åŸå§‹çš„xåšæ¦‚ç‡ä¼°è®¡ã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆæ·±åº¦å€¼è¶Šå¤§å°±è¶Šæ·±ï¼Œè¶Šæ¥è¿‘1ï¼Œå³è¶Šç™½ï¼Œæ‰€ä»¥é è¿‘æ‘„åƒæœºçš„æ·±åº¦åç™½è‰²ï¼Œè¿œå¤„çš„åé»‘è‰²ï¼‰&lt;/p&gt;

&lt;p&gt;ä½†è¿˜æ²¡å®Œï¼ŒVSMè¿˜å’Œåˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼çš„one-tailedç‰ˆæœ¬æœ‰å…³ç³»ã€‚é¦–å…ˆæ‹¿å‡ºè¯¥å…¬å¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{  X - \mu  \geq t } \leq \frac { \sigma ^{2} }{ \sigma ^{2} + t ^{2} } ï¼Œt  &amp;gt; 0 \] &lt;/p&gt;

&lt;p&gt;è®¾\( t&amp;#39; = t - \mu ï¼Œt &amp;gt; \mu &amp;gt; 0 \)ï¼Œä»£å…¥ä¸Šå¼ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{  X - \mu  \geq t&amp;#39; } \leq \frac { \sigma ^{2} }{ \sigma ^{2} + t&amp;#39; ^{2} }  \] &lt;/p&gt;

&lt;p&gt;\[ P _{  X - \mu  \geq t - \mu } \leq \frac { \sigma ^{2} }{ \sigma ^{2} + (t - \mu) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;\[ P _{  X \geq t } \leq \frac { \sigma ^{2} }{ \sigma ^{2} + (t - \mu) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;ï¼ˆåœ¨&lt;a href=&quot;http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.104.2569&amp;rep=rep1&amp;type=pdf&quot;&gt;Variance Shadow Maps&lt;/a&gt; è®ºæ–‡ä¸­å°±ä¼šçœ‹åˆ°è¿™ä¸ªä¸ç­‰å¼ï¼‰&lt;/p&gt;

&lt;p&gt;ä¸‹é¢çš„å°±æŒ‰ç…§è®ºæ–‡çš„æ€è·¯è®²ã€‚å‡å®šä¸€ä¸ª3dåœºæ™¯é‡Œæœ‰ä¸€å—æŒ¡æ¿ï¼ˆOccluder)ï¼Œäº§ç”Ÿäº†é˜´å½±ï¼ˆVSMï¼‰ï¼Œç„¶ååœ¨fragment shaderé‡Œå¯¹æŸä¸€ä¸ªfragmentåšé˜´å½±è®¡ç®—ï¼Œè¿™æ—¶å€™fragmentå¯èƒ½è¢«é®æŒ¡ï¼Œä¹Ÿå¯èƒ½æ²¡è¢«é®æŒ¡ï¼ˆè–›å®šè°”çš„çŒ«ï¼Ÿï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆæŠŠfragPosè½¬æ¢åˆ°light spaceä¸‹ï¼Œä»è€Œå–å‡ºè¿‡è¿‡æ»¤åçš„VSMé‡Œçš„æ·±åº¦ï¼Œç§°ä¸º\(d_{1}\)ã€‚è€ŒfragPoså½“å‰åœ¨light placeçš„æ·±åº¦åˆ™ç§°ä¸º\(d_{2} \)ã€‚ \( P _{  X \geq t } \)é‡Œçš„Xåˆ™æ˜¯VSMé‡Œæœªè¿‡æ»¤å‰çš„æ·±åº¦ã€‚&lt;/p&gt;

&lt;p&gt;æŠŠtå½“æˆ\(d_{2} \)ï¼Œå†åŠ ä¸Šç”¨å‰é¢çš„å…¬å¼ç®—å‡ºæ¥çš„æ•°å­¦æœŸæœ›\(\mu \)å’Œæ–¹å·®\(\sigma  ^{2} \)ï¼Œå°±å¯ä»¥ç¡®å®šï¼Œä»»æ„Xè¶…è¿‡\(d_{2} \)çš„æ¦‚ç‡ï¼Œä¸å¤§äº\( \frac { \sigma ^{2} }{ \sigma ^{2} + (t - \mu) ^{2} }  \)ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªåªæ˜¯æˆ‘ä»¬éœ€è¦çš„æ¦‚ç‡çš„ä¸Šç•Œï¼Œ \( P _{  X \geq t } \)å¹¶ä¸èƒ½è¢«å‡†ç¡®ç®—å‡ºæ¥ã€‚&lt;/p&gt;

&lt;p&gt;å†è®¾è¿™ä¸ªè¡¨ç¤ºfragæ²¡æœ‰è¢«æŒ¡æ¿é®æŒ¡çš„å®é™…æ¦‚ç‡\( P_{  X \geq t } \)ä¸ºpï¼Œé‚£ä¹ˆfragçš„dï¼ˆå³Xï¼‰çš„æ•°å­¦æœŸæœ›ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\[ \mu = E(x) = p d_{2} + (1 - p)d_{1} \]&lt;/p&gt;

&lt;p&gt;ï¼ˆè¿™é‡Œå¯ä»¥è¿™æ ·ç†è§£ï¼šå½“p=1æ—¶ï¼ŒæœŸæœ›å€¼ä¸º\(d_{2}\)ï¼Œå³fragPosLightSpace.zï¼Œè¡¨ç¤ºfragåœ¨light spaceæ·±åº¦å’Œåœ¨VSMçš„æ·±åº¦å®Œå…¨æ— å…³ï¼Œå³å®Œå…¨æ²¡æœ‰è¢«é®æŒ¡ï¼Œ0%çš„é˜´å½±ï¼›å½“p=0æ—¶ï¼ŒæœŸæœ›å€¼ä¸º\(d_{1}\)ï¼Œå³åœ¨light spaceæ·±åº¦ç»å¯¹ç­‰äºåœ¨VSMçš„æ·±åº¦ï¼Œè¡¨ç¤ºè¢«å®Œå…¨é®æŒ¡ï¼Œ100%çš„é˜´å½±)&lt;/p&gt;

&lt;p&gt;\(d^{2}\)çš„æ•°å­¦æœŸæœ›ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\[  E(x^{2}) = p d_{2}^{2} + (1 - p)d_{1}^{2} \]&lt;/p&gt;

&lt;p&gt;dçš„æ–¹å·®ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\[ \sigma ^{2} = E[x^{2}] -  E[x]^{2}  = p d_{2}^{2} + (1 - p)d_{1}^{2} - (p d_{2} + (1 - p)d_{1} )^{2} \]&lt;/p&gt;

&lt;p&gt;\[ = p d_{2}^{2} + (1 - p)d_{1}^{2} - p^{2} d_{2}^{2} - 2p(1 - p)d_{1} d_{2} - (1 - p)^{2} d_{1} ^{2} \]&lt;/p&gt;

&lt;p&gt;\[ = (p - p^{2}) d_{2}^{2} + (1 - p)(d_{1}^{2} - 2pd_{1} d_{2} - (1 - p)d_{1}^{2} ) \]&lt;/p&gt;

&lt;p&gt;\[ = (p - p^{2}) d_{2}^{2} + (1 - p)(d_{1}^{2} - 2pd_{1} d_{2} - d_{1}^{2} + pd_{1}^{2} ) \]&lt;/p&gt;

&lt;p&gt;\[ = (p - p^{2}) d_{2}^{2} + (1 - p)( - 2pd_{1} d_{2}  + pd_{1}^{2} ) \]&lt;/p&gt;

&lt;p&gt;\[ = (p - p^{2}) d_{2}^{2} + (p - p^{2})( - 2d_{1} d_{2}  + d_{1}^{2} ) \]&lt;/p&gt;

&lt;p&gt;\[ = (p - p^{2})(d_{2}^{2}  - 2d_{1} d_{2}  + d_{1}^{2} ) \]&lt;/p&gt;

&lt;p&gt;\[ = (p - p^{2})(d_{2} - d_{1})^{2} \]&lt;/p&gt;

&lt;p&gt;æŠŠè¿™äº›å‚æ•°éƒ½ä»£å…¥åˆ°ä¸Šé¢çš„ä¸ç­‰å¼ï¼Œæ±‚å‡º\(p_{max}(d_{2}) \)ï¼š&lt;/p&gt;

&lt;p&gt;\[ P _{max}(d_{2}) = \frac { \sigma ^{2} }{ \sigma ^{2} + (d_{2} - \mu) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;\[ = \frac { (p - p^{2})(d_{2} - d_{1})^{2} }{ (p - p^{2})(d_{2} - d_{1})^{2} + ( p d_{2} + (1 - p)d_{1}  - d_{2} ) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;\[ = \frac { (p - p^{2})(d_{2} - d_{1})^{2} }{ (p - p^{2})(d_{2} - d_{1})^{2} +(1 - p) ^{2} (d_{2} - d_{1} ) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;\[ = \frac { p - p^{2} }{ (p - p^{2}) +(1 - p) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;\[ = \frac { p - p^{2} }{ (p - p^{2}) +(1 - p) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;\[ = \frac { p - p^{2} }{ 1 - p }  \] &lt;/p&gt;

&lt;p&gt;\[ = p \] &lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ä¹Ÿå°±æ˜¯è¯´ï¼Œ\( P_{ max }( X \geq d_{2}) \) è¿™ä¸ªæœ€å¤§å€¼å°±åˆšå¥½æ˜¯æˆ‘ä»¬æƒ³è¦æ±‚çš„\( P( X \geq d_{2}) \) ï¼&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;\[ P _{  X \geq t } \leq \frac { \sigma ^{2} }{ \sigma ^{2} + (t - \mu) ^{2} }  \] &lt;/p&gt;

&lt;p&gt;&lt;strong&gt;è¿™é‡Œçš„\( \leq \) åˆšå¥½æ˜¯\( = \)ï¼Œä¸ç­‰å¼å˜æˆäº†ç­‰å¼ã€‚Amazingï¼&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ç†è®ºåˆ°æ­¤ä¸ºæ­¢ï¼Œå‰©ä¸‹çš„å°±æ˜¯å·¥ç¨‹é—®é¢˜äº†ã€‚&lt;/p&gt;

&lt;h1&gt;å·¥ç¨‹å®ç°&lt;/h1&gt;

&lt;p&gt;å¦‚æœä½ çš„å·¥ç¨‹é‡Œå·²ç»å®ç°äº†Standard Shadow Mapï¼Œé‚£ä¹ˆåªéœ€è¦å‡ ä¸ªæ­¥éª¤å³å¯å®ç°åŸºæœ¬çš„VSMï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æŠŠShadow Map Bufferæ”¹ä¸ºè¾“å‡ºdepthå’Œdepthå¹³æ–¹åˆ°é¢œè‰²bufferã€‚å¯èƒ½éœ€è¦å…ˆä¿®æ”¹RTçš„åˆ›å»ºä»£ç ï¼Œä¸‹é¢ä»¥OpenGL 4.xä¸ºä¾‹ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// 32ä½é«˜ç²¾åº¦åŒé€šé“çº¹ç† ç”¨æ¥å­˜moment1å’Œmoment2&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;glTexImage2D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GL_TEXTURE_2D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_RG32F&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_RG&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_FLOAT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ç„¶åä¿®æ”¹shadow mapç€è‰²å™¨ï¼š&lt;/p&gt;

&lt;p&gt;vs:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;#version 410 core&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;layout&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;uniform&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mat4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lightPV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;uniform&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mat4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gl_Position&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lightPV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;model&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;fs:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;#version 410 core&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v_position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;out&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;outColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;             
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v_position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;z&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v_position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// TO NDC [0, 1]&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moment1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// ä¸€é˜¶çŸ©&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moment2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// äºŒé˜¶çŸ©&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dFdx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dFdy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;moment2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.25&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// è§£å†³acneé—®é¢˜&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;outColor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;moment1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moment2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;å¯ä»¥æ¸²æŸ“ä¸‹Shadow Mapæ˜¯å¦æ­£å¸¸:&lt;/p&gt;

&lt;p&gt;rgé€šé“ä¸€èµ·è¾“å‡ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.11/2.png&quot; alt=&quot;2.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;åªæœ‰ré€šé“(moment1):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.11/3.png&quot; alt=&quot;3.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;åªæœ‰gé€šé“(moment2):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.11/4.png&quot; alt=&quot;4.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;ç„¶åæ˜¯åº”ç”¨çš„é—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹lighting shaderé‡Œçš„é˜´å½±è®¡ç®—ä»£ç ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// åªè´´ä¸‹æ ¸å¿ƒä»£ç ï¼š&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;uniform&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sampler2D&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shadowMap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥ç®—å‡ºä¸Šæ–‡è¯´çš„Pmax&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;chebyshevUpperBound&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sampler2D&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shadowMap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moments&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shadowMap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Surface is fully lit. as the current fragment is before the light occluder&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// The fragment is either in shadow or penumbra. We now use chebyshev&amp;#39;s upperBound to check&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// How likely this pixel is to be lit (p_max)&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;variance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;moments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//variance = max(variance, 0.000002);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;variance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;variance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.00002&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d_minus_mean&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p_max&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;variance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;variance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d_minus_mean&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d_minus_mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p_max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// è¿”å›é˜´å½±ç™¾åˆ†æ¯”[0,1], ç„¶åæ‹¿å»ä¹˜ä»¥å…‰ç…§é¢œè‰²å³å¯&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;ShadowCalculation_Dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vec3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fragPos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Light&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;light&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fragPosLightSpace&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;light&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lightPV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fragPos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// perform perspective divide&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;vec3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;projCoords&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fragPosLightSpace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xyz&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fragPosLightSpace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// transform to [0,1] range&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;projCoords&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;projCoords&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentDepth&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;projCoords&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;z&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;shadow&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chebyshevUpperBound&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shadowMap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentDepth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;projCoords&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shadow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æœ€ç»ˆæ•ˆæœ:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.11/5.png&quot; alt=&quot;5.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;è¿™é‡Œå¯ä»¥çœ‹åˆ°é˜´å½±è¾¹ç¼˜æ˜¯å˜æ¨¡ç³Šäº†çš„ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰é”¯é½¿ã€‚å¯ä»¥è¿›ä¸€æ­¥å¯¹shadow mapåšbluræ¥å®ç°è½¯åŒ–ã€‚&lt;/p&gt;
</description>
        <pubDate>Fri, 17 Nov 2017 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/shadow-1/</link>
        <guid isPermaLink="true">http://localhost:4000/shadow-1/</guid>
      </item>
    
      <item>
        <title>ç°ä»£æŠ—é”¯é½¿æŠ€æœ¯â€”â€”PPAAä¸­çš„æ–°æ˜ŸSMAA</title>
        <description>&lt;h1&gt;PPAA&lt;/h1&gt;

&lt;p&gt;æ‰€è°“PPAAï¼ˆPost Process Antialiasing)ï¼Œä¹Ÿå«FBAAï¼ˆFilter-Based Antialiasingï¼‰ï¼Œæ˜¯åŸºäºåå¤„ç†çš„å„ç§æŠ—é”¯é½¿æŠ€æœ¯çš„ç»Ÿç§°ã€‚åœ¨PPAAä¹‹å‰ï¼Œä¸»æµAAæŠ€æœ¯æ˜¯MSAAï¼ˆMultiSamples AAï¼‰ã€SSAAï¼ˆSuperSamples AAï¼‰ã€‚SSAAæ˜¯AAä¸­æœ€æš´åŠ›ä¹Ÿæ˜¯æœ€å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œè€ŒMSAAæ˜¯ä¸ç¡¬ä»¶ç´§å¯†ç»“åˆçš„built-in AAã€‚å¯¹äºforward renderingæ¥è¯´ï¼ŒMSAAå‡ ä¹æ˜¯å”¯ä¸€çš„é€‰æ‹©ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶è€Œï¼ŒMSAAè¿™ç§å¤è€çš„ã€built-inçš„æŠ€æœ¯ï¼Œå·²ç»ä¸å¤ªèƒ½æ»¡è¶³ç°ä»£æ¸²æŸ“å™¨çš„éœ€æ±‚äº†ã€‚å®ƒæœ‰ä¸¤å¤§é—®é¢˜ï¼Œä¸€æ˜¯MSAAä¼šæœ‰å¤šä½™çš„AAè®¡ç®—ï¼ŒäºŒæ˜¯MSAAä¸é€‚ç”¨äºdeferred renderingã€‚&lt;/p&gt;

&lt;p&gt;é‰´äºMSAAçš„ä¸è¶³ï¼ŒPPAAå°±è“¬å‹ƒå‘å±•èµ·æ¥äº†ã€‚PPAAå¼ºå¤§ä¹‹å¤„åœ¨äºå¯ä»¥è‡ªå®šä¹‰ã€ä¸”ç¡¬ä»¶æ— å…³ã€å…¼å®¹forwardï¼deferï¼Œæ‰€ä»¥åŸºäºPPAAçš„ç®—æ³•éå¸¸å¤šã€‚è€Œå…¶ä¸­çš„ç¿˜æ¥šï¼ŒSMAA(Subpixel Morphological Antialiasing)ï¼Œæ€§èƒ½ä»¥åŠAAè´¨é‡éƒ½å¾ˆä¸é”™ã€‚æœ¬æ–‡å°†ç€é‡ä»‹ç»SMAAã€‚&lt;/p&gt;

&lt;!--more--&gt;

&lt;p&gt;å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒSMAAçš„å‰èº«æ˜¯Jimenez&amp;#39;s MLAAï¼Œä¹Ÿæ˜¯åŒä¸€ä¸ªå›¢é˜Ÿåšå‡ºæ¥çš„ï¼ŒSMAAå¯ä»¥è®¤ä¸ºæ˜¯åœ¨è´¨é‡å’Œæ€§èƒ½ä¸¤æ–¹é¢éƒ½è¶…è¶ŠJimenez&amp;#39;s MLAAçš„ä¸€ä¸ªè¿›åŒ–ç‰ˆã€‚æ‰€ä»¥å¯ä»¥å…ˆé˜…è¯»Jimenez&amp;#39;s MLAAçš„è®ºæ–‡å†æ¥å­¦ä¹ SMAAã€‚&lt;/p&gt;

&lt;h1&gt;SMAA&lt;/h1&gt;

&lt;p&gt;SMAAçš„æ¨¡å¼å¤„ç†è¾ƒä¹‹MLAAæœ‰äº†æ–°çš„æ”¹è¿›ã€‚MLAAçš„æ–¹æ³•ï¼Œå¯¹sharpç‰©ä½“çš„è½®å»“çš„&amp;quot;è¾¹è§’&amp;quot;å’Œ&amp;quot;é”¯é½¿è§’&amp;quot;å¹¶ä¸èƒ½åŒºåˆ†ï¼Œå¯¼è‡´è¾¹è§’ä¹Ÿè¢«å½“ä½œé”¯é½¿è§’å¤„ç†ï¼Œå¯¼è‡´è¾¹è§’è¢«ä¿®æˆäº†åœ†è§’ã€‚è€ŒSMAAä¸­ï¼Œåšäº†è¿›ä¸€æ­¥çš„è§‚å¯Ÿï¼šå¯¹äºé”¯é½¿è§’ï¼Œå¤§å°ä¸è¶…è¿‡ä¸€ä¸ªåƒç´ ï¼Œè€Œsharpçš„è¾¹è§’å¾ˆå¤§å‡ ç‡è¶…è¿‡1ä¸ªåƒç´ ã€‚å› æ­¤ï¼ŒSMAAåˆ¤æ–­é”¯é½¿è§’éœ€è¦è®¡ç®—2ä¸ªåƒç´ é•¿åº¦çš„èŒƒå›´ï¼Œä¹Ÿä»è€Œè¯†åˆ«å‡ºçœŸçš„è¾¹è§’ã€‚ä½†ä¹Ÿå°±ä½¿å¾—SMAAçš„ç®—æ³•æä¸ºå¤æ‚ã€‚&lt;/p&gt;

&lt;p&gt;SMAAæ€»å…±3ä¸ªpassï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Pass 1ï¼Œç®—edgeTex&lt;/li&gt;
&lt;li&gt;Pass 2ï¼Œç”¨edgeTexç®—weightTex&lt;/li&gt;
&lt;li&gt;Pass 3ï¼Œç”¨weightTexæ··åˆåŸå§‹å›¾åƒï¼Œå¾—åˆ°æŠ—é”¯é½¿å›¾åƒ&lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;è¾¹ç¼˜çº¹ç†çš„è®¡ç®— Edge Detection (edgeTex) ï¼ˆPass 1ï¼‰&lt;/h2&gt;

&lt;p&gt;é”¯é½¿é—®é¢˜ä½“ç°åœ¨å›¾åƒä¸Šå‡ ä½•ç‰©ä½“çš„è¾¹ç¼˜å¤„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœèƒ½å‡†ç¡®åœ°post processå‡ºå›¾åƒä¸Šå“ªäº›åœ°æ–¹æ˜¯è¾¹ï¼Œå“ªäº›åœ°æ–¹ä¸æ˜¯ã€‚æ£€æµ‹è¿‡å°‘ï¼Œé”¯é½¿è¾¹å°±ä¼šæ®‹ç•™ï¼›æ£€æµ‹è¿‡å¤šï¼Œå›¾åƒå°±ä¼šç³Šã€‚ä¸ºæ¥æ›´å¥½åœ°æå‡AAè´¨é‡ï¼ŒSMAAè¾¹ç¼˜æ£€æµ‹ç®—æ³•çš„é€‰å–éå¸¸å…³é”®ã€‚&lt;/p&gt;

&lt;p&gt;ç›¸æ¯”åŸºäºnormal mapã€depth mapï¼ŒåŸºäºé¢œè‰²çš„è¾¹ç¼˜æ£€æµ‹å°¤ä½³ã€‚ä¸€æ˜¯å› ä¸ºï¼Œé¢œè‰²ä¿¡æ¯å®¹æ˜“è·å¾—ï¼Œè€Œæ·±åº¦å›¾ï¼æ³•çº¿å›¾ç›¸å¯¹éš¾è·å¾—ï¼Œä¾‹å¦‚å¯¹äºå›¾åƒå¤„ç†é¢†å–ï¼Œç”¨æˆ·æä¾›çš„åªæœ‰ç…§ç‰‡è€Œå·²ï¼›äºŒæ˜¯å› ä¸ºå®ƒè¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹ï¼šå¯¹äºåšäº†shadingåæ‰äº§ç”Ÿçš„é”¯é½¿ï¼Œä¹Ÿä¸€æ ·èƒ½å¤„ç†ï¼ˆä¾‹å¦‚æœ‰æ¢¯åº¦çš„toon shadingï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;SMAAé¦–æ¨çš„æ˜¯åŸºäºLumaï¼ˆäº®åº¦ï¼‰çš„è¾¹ç¼˜æ£€æµ‹ç®—æ³•ã€‚&lt;/p&gt;

&lt;p&gt;1ï¼Œvertex shaderï¼Œæ ¹æ®çº¹ç†åæ ‡è¾“å‡º3ç»„offsetï¼Œæ¯ç»„2ä¸ªè¾¹ï¼Œæ€»å…±6ä¸ªè¾¹è¦æ£€æµ‹ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SMAA_RT_METRICS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imgSize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imgSize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imgSize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imgSize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fma&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SMAA_RT_METRICS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xyxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texCoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xyxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Left / Top Edge&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fma&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SMAA_RT_METRICS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xyxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texCoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xyxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Right / Bottom Edge&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fma&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SMAA_RT_METRICS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xyxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texCoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xyxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Leftx2 / Topx2 Edge&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;../images/2017.10/smaa1.png&quot; alt=&quot;smaa1.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;2ï¼Œfragment shaderï¼Œå…ˆæ±‚å‡ºå½“å‰fragmentçš„lumaå€¼ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;// Calculate lumas:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;float3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.2126&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.7152&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0722&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;L&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colorTex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ï¼ˆRGB-&amp;gt;lumaçš„å…¬å¼æ¥è‡ªwiki &lt;a href=&quot;https://en.wikipedia.org/wiki/Relative_luminance&quot;&gt;https://en.wikipedia.org/wiki/Relative_luminance&lt;/a&gt;  ï¼‰&lt;/p&gt;

&lt;p&gt;3ï¼Œç®—Leftå’ŒTopçš„lumaå€¼ï¼Œä»¥åŠç®—Leftå’ŒLçš„å·®å€¼delta.xã€Topå’ŒLçš„å·®å€¼delta.yï¼›å¦‚æœdelta.x &amp;lt; threshold.xï¼Œedges.xå°±ç­‰äº0.0ï¼Œä»£è¡¨ä¸æ˜¯è¾¹ï¼ˆå› ä¸ºå·®å€¼å¾ˆå°ï¼Œå³äº®åº¦å·®å¼‚å°ï¼‰ï¼Œyæ–¹å‘åŒç†ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Lleft&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colorTex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Ltop&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colorTex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;float4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;L&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;float2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lleft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Ltop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;step&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;threshold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;float2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;discard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å¦‚æœ2ä¸ªæ–¹å‘éƒ½æ²¡æœ‰è¾¹ï¼Œå°±å¯ä»¥æ’é™¤è¿™ä¸ªfragmentäº†&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;å¦‚æœLeftæˆ–Topè‡³å°‘æœ‰ä¸€ä¸ªæ˜¯è¾¹ï¼Œå°±å†è¿›ä¸€æ­¥åšæ£€æµ‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—Right Bottomçš„lumaå·®å€¼&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Lright&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colorTex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Lbottom&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colorTex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zw&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;L&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;float2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lright&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Lbottom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// å’Œç®—delta.xyè¿‡ç¨‹å·®ä¸å¤š&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// åˆ†åˆ«ç®—å‡ºxã€yæ–¹å‘çš„æœ€å¤§lumaå·®å€¼&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;float2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxDelta&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// ç®—å‡º Left x2 and Top x2 çš„luma:&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Lleftleft&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colorTex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Ltoptop&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colorTex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ç®—å‡ºLeftå’ŒLeft x2çš„lumaå·®å€¼ã€Topå’ŒTop x2çš„lumaå·®å€¼&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zw&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lleft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Ltop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;float2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lleftleft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Ltoptop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Calculate the final maximum delta:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// xã€yæ–¹å‘åˆ†åˆ«æœ€ç»ˆçš„æœ€å¤§lumaå·®å€¼&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;maxDelta&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// xã€yä¸¤ä¸ªæ–¹å‘ä¸­å–å…¶ä¸­æœ€å¤§çš„lumaå·®å€¼&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finalDelta&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Local contrast adaptation:&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Leftã€Topäº®åº¦å·®å€¼*2åéœ€è¶…è¿‡finalDeltaæ‰çœŸçš„æ˜¯è¾¹&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;step&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;finalDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;æƒé‡çº¹ç†çš„è®¡ç®— Blending Weight Calculation (weightTex)ï¼ˆPass 2ï¼‰&lt;/h2&gt;

&lt;p&gt;æœ€å¤æ‚çš„ä¸€ä¸ªpassï¼Œéœ€è¦åˆ†æˆå¤šä¸ªéƒ¨åˆ†è®²è§£ã€‚&lt;/p&gt;

&lt;h3&gt;é¢„ç”ŸæˆsearchTex&lt;/h3&gt;

&lt;p&gt;æ ¹æ®å½“å‰åƒç´ åæ ‡ï¼Œæœç´¢å½“å‰è¿™ä¸ªåƒç´ å¯¹åº”çš„è¾¹çš„2ä¸ªç«¯ç‚¹ï¼Œæ±‚å‡º2ä¸ªè·ç¦»å€¼\(d_{1}ã€d_{2}\)ï¼Œæ˜¯å®ç°æ¨¡å¼åˆ†ç±»çš„å…³é”®ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸ºedgeTexå·²ç»åŒ…å«äº†è¾¹çš„ä¿¡æ¯ï¼Œå¦‚æœç›´æ¥æš´åŠ›æœç´¢ç«¯ç‚¹ï¼Œå°±éœ€è¦å¯¹edgeTexåšéå¸¸å¤šæ¬¡çš„çº¹ç†é‡‡æ ·ï¼ˆæˆ‘æ²¡æé”™çš„è¯ï¼Œæ¬¡æ•°åº”è¯¥ç­‰äº\(d_{1} + d_{2}\)  ï¼‰ã€‚åœ¨Jimenez&amp;#39;s MLAAä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªå«bilinear filteringçš„æœç´¢æŠ€å·§ï¼Œèƒ½å¤§çº¦å‡å°‘ä¸€åŠçš„çº¹ç†é‡‡æ ·æ•°ã€‚åŸç†å¤§è‡´å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;å‡è®¾æœ‰2ä¸ªè¦é‡‡æ ·çš„ç›¸é‚»åƒç´ ç‚¹ï¼Œç°åœ¨ç›®æ ‡æ˜¯ç”¨ä¸€æ¬¡é‡‡æ ·å¾—åˆ°è¿™2ä¸ªç‚¹çš„&amp;#39;è¾¹&amp;#39;å€¼ï¼š\(b_{1}ã€b_{2}\) ï¼ˆè¦ä¹ˆç­‰äº0è¦ä¹ˆç­‰äº1ï¼Œä»£è¡¨æœ‰æ— è¾¹ï¼‰ã€‚é¦–å…ˆå¾—æŠŠè¿™ä¸ªedgeTexçº¹ç†çš„è¿‡æ»¤è®¾ç½®ï¼Œè®¾ç½®æˆGL_LINEARã€‚è¿™æ ·å°±å¯ä»¥åˆ©ç”¨GPUçš„æ’å€¼æœºåˆ¶ï¼Œé€šè¿‡æ±‚2ä¸ªåƒç´ ç‚¹è¿çº¿ä¸Šçš„æŸä¸€ä¸ªä¸­é—´ç‚¹xçš„çº¹ç†åæ ‡ï¼Œåšä¸€æ¬¡é‡‡æ ·ï¼Œå¾—åˆ°ä¸€ä¸ª[0,1]ä¹‹é—´çš„å€¼ã€‚æœ‰äº†è¿™ä¸ªå€¼åï¼Œæ˜¯èƒ½å¤Ÿæ¢å¤å‡º\(b_{1}ã€b_{2}\) çš„å€¼çš„ã€‚æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Ÿæ•°å­¦åŸç†æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;

&lt;p&gt;\[ f_{x}(b_{1},b_{2},x) = x\cdot b_{1} + (1 - x)\cdot b_{2}ï¼Œb_{1} = 0ï¼1ï¼Œb_{2} = 0ï¼1 \]&lt;/p&gt;

&lt;p&gt;ï¼ˆå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨shaderé‡Œéœ€è¦æŠŠ \( x\cdot b_{1} + (1 - x)\cdot b_{2} \)å˜æ¢æˆ \( x\cdot (b_{1} - b_{2} ) + b_{2} \)ï¼Œå³lerpå½¢å¼ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡ä¹˜æ³•è¿ç®—ï¼‰&lt;/p&gt;

&lt;p&gt;å‡è®¾æˆ‘ä»¬å…ˆå–x=0.5ï¼Œé‚£ä¹ˆfçš„å–å€¼èŒƒå›´ä¸º[0, 0.5, 1]ï¼Œå…·ä½“çš„æ˜ å°„å…³ç³»ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;\( b_{1}\ \ \ b_{2}\ \ \ â€”â€” \ \ \ f \)&lt;/p&gt;

&lt;p&gt;\( 0\ \ \ \ \ 0\ \ \ \ â€”â€” \ \ \ 0 \)&lt;/p&gt;

&lt;p&gt;\( 0\ \ \ \ \ 1\ \ \ \ â€”â€” \ \ \ 0.5 \)&lt;/p&gt;

&lt;p&gt;\( 1\ \ \ \ \ 0\ \ \ \ â€”â€” \ \ \ 0.5 \)&lt;/p&gt;

&lt;p&gt;\( 1\ \ \ \ \ 1\ \ \ \ â€”â€” \ \ \ 1 \)&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°å·¦å³ä¸¤è¾¹å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œ0.5å¯¹åº”äº†2ç§æƒ…å†µã€‚é‚£ä¹ˆå‡è®¾æˆ‘ä»¬å†å–åˆ«çš„å€¼ï¼Œä¸”æ»¡è¶³\(x \neq 0.5ï¼Œx \neq 0 ï¼Œx \neq 1 \)ï¼Œé‚£ä¹ˆæœ‰ï¼š&lt;/p&gt;

&lt;p&gt;\( b_{1}\ \ \ b_{2}\ \ \ â€”â€” \ \ \ f \)&lt;/p&gt;

&lt;p&gt;\( 0\ \ \ \ \ 0\ \ \ \ â€”â€” \ \ \ 0 \)&lt;/p&gt;

&lt;p&gt;\( 0\ \ \ \ \ 1\ \ \ \ â€”â€” \ \ \ 1 - x \)&lt;/p&gt;

&lt;p&gt;\( 1\ \ \ \ \ 0\ \ \ \ â€”â€” \ \ \ x \)&lt;/p&gt;

&lt;p&gt;\( 1\ \ \ \ \ 1\ \ \ \ â€”â€” \ \ \ 1 \)&lt;/p&gt;

&lt;p&gt;ç¥å¥‡çš„äº‹æƒ…å‘ç”Ÿäº†ï¼Œå·¦å³ä¸¤è¾¹æ»¡è¶³äº†ä¸€ä¸€å¯¹åº”å…³ç³»ï¼ä¹Ÿå°±æ˜¯è¯´ï¼Œåªéœ€è¦çŸ¥é“xçš„å€¼ï¼Œå°±èƒ½&amp;#39;è§£ç &amp;#39;å‡º\(b_{1}ã€b_{2}\)çš„å€¼ï¼&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªbilinear filteringè™½å¥½ï¼Œä½†å®ƒåªèƒ½æœç´¢ä¸€ä¸ªæ–¹å‘ï¼ˆä¸€ç»´ï¼‰ã€‚è€Œåœ¨SMAAä¸­ï¼Œå› ä¸ºéœ€è¦è¿›ä¸€æ­¥åšå¥½æ¨¡å¼åˆ†ç±»ï¼Œéœ€è¦æ”¯æŒäºŒç»´çš„edgeTexæœç´¢ã€‚æ‰€ä»¥SMAAæ‹“å±•äº†bilinear filteringåˆ°äº†äºŒç»´ï¼š&lt;/p&gt;

&lt;p&gt;\[ f_{xy}(b_{1},b_{2},b_{3},b_{4},x,y) = f_{x}(b_{1},b_{2},x) \cdot y + f_{x}(b_{3},b_{4},x) \cdot (1 - y) \]&lt;/p&gt;

&lt;p&gt;è¿™é‡Œå¢åŠ äº†ä¸€ä¸ªyï¼Œyå’Œxæ˜¯ç±»ä¼¼çš„ï¼Œéœ€è¦èµ‹äºˆä¸€ä¸ªä¸ç­‰äº0.5çš„å€¼ï¼Œä½†éœ€è¦é™„åŠ ä¸€ä¸ªé™åˆ¶æ˜¯y = 0.5xï¼ˆå¯ä»¥å‡è®¾y!=0.5xå»æ¨å¯¼ä¸Šé¢çš„å…¬å¼ï¼Œä¼šå¾—åˆ°æ— æ³•ä¸€ä¸€å¯¹åº”çš„æƒ…å†µï¼‰ã€‚è¿™æ ·æ‹“å±•åï¼Œå°±å¯ä»¥ç”¨2ä¸ªå¸¸é‡å€¼xã€yï¼Œå¯¹\(b_{1}ã€b_{2}ã€b_{3}ã€b_{4}\)æ‰€æœ‰ç»„åˆç¼–ç å‡º\(2^{4} \)å…±16ç§å–å€¼æƒ…å†µã€‚ä¹Ÿå°±æ˜¯ä¾ç„¶å¯ä»¥ç”¨ä¸€ä¸ªfå€¼ï¼Œåå‘æ‰¾å‡º\(b_{1}ã€b_{2}ã€b_{3}ã€b_{4}\)ï¼&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªæ˜ å°„å…³ç³»å¯ä»¥æ‰“è¡¨åˆ°ä»£ç é‡Œå‡å°‘shaderè®¡ç®—ï¼Œä½†è¿™æ ·è¿˜ä¸å¤Ÿï¼ŒSMAAåšå•¦è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œå‡å°‘äº†å¯¹è¿™ä¸ªæ˜ å°„è¡¨çš„è®¿é—®ã€‚ä½œè€…å†™äº†ä¸€ä¸ªè„šæœ¬æ¥ç”Ÿæˆä¸€ä¸ªå«searchTexçš„ä¸œè¥¿ã€‚å…ˆè®²ä¸€ä¸‹ç”Ÿæˆæ­¥éª¤å†è¯´ç”¨æ³•ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆï¼Œç¡®å®šäº†åˆšæ‰æåˆ°çš„å¸¸é‡xï¼Œyçš„å€¼ï¼Œxç­‰äº0.25ï¼Œyç­‰äº0.5x=0.125ã€‚ç„¶åæšä¸¾16ç§æƒ…å†µï¼Œè°ƒç”¨bilinearå‡½æ•°ï¼Œç”Ÿæˆæ˜ å°„è¡¨:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# Interpolates between two values:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Calculates the bilinear fetch for a certain edge combination:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# e[0]       e[1]&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#          x &amp;lt;-------- Sample position:    (-0.25,-0.125)&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# e[2]       e[3] &amp;lt;--- Current pixel [3]:  (  0.0, 0.0  )&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.125&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This dict returns which edges are active for a certain bilinear fetch:&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# (it&amp;#39;s the reverse lookup of the bilinear function)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.0&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.65625&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.21875&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.875&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.09375&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.75&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.3125&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.96875&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.03125&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.6875&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.25&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.90625&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.125&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.78125&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.34375&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bilinear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 1.0&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ç„¶åè§‚å¯Ÿ16ä¸ªbilinearå€¼ï¼Œå‘ç°å®ƒä»¬æœ‰æœ€å¤§å…¬çº¦æ•°0.03125ï¼Œäºæ˜¯ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ªå¤§å°ä¸º33 x 33çš„æ•°ç»„ï¼ˆè¿™æ˜¯å› ä¸º33 = 1 / 0.03125 + 1ï¼‰ï¼Œåˆå› ä¸ºæœç´¢çš„æ˜¯lineï¼Œéœ€è¦åˆ†å·¦å³ï¼ˆä¹Ÿåªæœ‰å·¦å³2ä¸ªæ–¹å‘ï¼‰ï¼Œæ‰€ä»¥æ•°ç»„è¦ä¹˜2ï¼Œå˜æˆ66 x 33ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶åå¼€å§‹æšä¸¾æ‰€æœ‰patternï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# Calculate delta distances to the left:&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;RGB&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;66&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.03125&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.03125&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;127&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deltaLeft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# Maximize dynamic range to help compression&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;putpixel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;#debug(&amp;quot;left: &amp;quot;, texcoord, val, *edges)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Calculate delta distances to the right:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.03125&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.03125&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;127&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deltaRight&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edges&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# Maximize dynamic range to help compression&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;putpixel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;#debug(&amp;quot;right: &amp;quot;, texcoord, val, *edges)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;å…¶ä¸­çš„if texcoord[0] in edge and texcoord[1] in edgeæ„æ€æ˜¯å½“å‰è¿™2ä¸ªçº¹ç†åæ ‡x yï¼Œéƒ½åˆšå¥½æ˜¯ä¸€ä¸ªfï¼Œfå°±å¯¹åº”äº†æŸå››ä¸ªboolå€¼ï¼Œ2ä¸ªfå°±ç»„æˆä¸€ä¸ªpatternã€‚edges = edge[texcoord[0]], edge[texcoord[1]]ï¼Œåˆ†åˆ«è§£ç å‡ºäº†x yæ–¹å‘çš„4ä¸ªboolå€¼ã€‚æ¥ç€æ˜¯å¦å¤–ä¸¤ä¸ªå‡½æ•°:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# Delta distance to add in the last step of searches to the left:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;deltaLeft&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;top&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# If there is an edge, continue:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;top&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# If we previously found an edge, there is another edge and no crossing&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# edges, continue:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;top&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Delta distance to add in the last step of searches to the right:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;deltaRight&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;top&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# If there is an edge, and no crossing edges, continue:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;top&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# If we previously found an edge, there is another edge and no crossing&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# edges, continue:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;top&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;deltaLeftï¼Œå°±æ˜¯æ ¹æ®x yæ–¹å‘2ç»„boolå€¼ï¼Œç®—å‡ºä¸€ä¸ªé•¿åº¦è¡¥å……å€¼dï¼Œdçš„å–å€¼èŒƒå›´æ˜¯0/1/2ã€‚top[3]æ˜¯æŒ‡å½“å‰åƒç´ åœ¨yæ–¹å‘ä¸Šçš„boolå€¼ï¼Œå¦‚æœä¸º0ï¼Œå°±æ˜¯æ²¡è¾¹ï¼Œd = 0ï¼›å¦‚æœä¸º1ï¼Œå°±æ˜¯æœ‰è¾¹ï¼Œé‚£ä¹ˆd = 1ï¼›å†å¦‚æœtop[2]ä¹Ÿæœ‰è¾¹ï¼Œä¸”xæ–¹å‘æ²¡æœ‰è¾¹(æ²¡æœ‰äº¤å‰è¾¹)ï¼Œé‚£ä¹ˆd = 2ã€‚deltaRightè¿‡ç¨‹ç±»ä¼¼ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œä¸Šé¢çš„æ˜¯topï¼Œä¸‹é¢çš„æ˜¯leftï¼Œæ ‡ç»¿è‰²ï¼çº¢è‰²çš„æ˜¯è¾¹ï¼Œé‚£ä¹ˆç»è¿‡deltaLeftè¿ç®—åï¼Œä¸‹é¢çš„patternä¼šå¾—åˆ°d=1(æœ‰äº¤å‰è¾¹)ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/e1.png&quot; alt=&quot;e1.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/e2.png&quot; alt=&quot;e2.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;æ±‚å‡ºdåï¼Œ val = 127 * dï¼ŒæŠŠdæ˜ å°„åˆ°0ï¼127/254ï¼Œç„¶åå°±å¯ä»¥å¡«å…¥åˆ°searchTexäº†ï¼Œç›¸å½“äºæ˜¯åœ¨ç”Ÿæˆä¸€å¼ ä¸‰å€¼çš„ç°åº¦å€¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/searchTex.png&quot; alt=&quot;searchTex.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;è§‚å¯ŸsearchTexå‘ç°ï¼Œè¿™å›¾æœ‰å¾ˆå¤§éƒ¨åˆ†æ˜¯å…¨é»‘çš„ã€‚ç•¥æ˜¾å¤šä½™ï¼Œäºæ˜¯ä½œè€…è¡¥å……äº†ä¸€ä¸ªè£å‰ªæ“ä½œï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;crop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;17&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transpose&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FLIP_TOP_BOTTOM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æŠŠä¸Šé¢çš„17è¡Œé»‘è‰²åŒºåŸŸéƒ½è£æ‰ï¼ŒsearchTexå°±å˜æˆäº†64x16çš„å¤§å°ï¼Œç¬¦åˆ2çš„å¹‚æ¬¡æ–¹ï¼Œæ›´è¿·ä½ æ›´ä¼˜é›…ã€‚ç¬¬äºŒè¡Œä»£ç åšäº†ä¸ªä¸Šä¸‹ç¿»è½¬ï¼Œç”¨æ„ä¸æ˜ã€‚æœ€ç»ˆçš„searchTexå¦‚ä¸‹:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/searchTex2.png&quot; alt=&quot;searchTex2.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;searchTexä¼šç”¨åœ¨æ¨ªå‘å’Œçºµå‘çš„æœç´¢ä¸­ã€‚&lt;/p&gt;

&lt;h3&gt;é¢„ç”ŸæˆareaTex&lt;/h3&gt;

&lt;p&gt;areaTexæ˜¯ç”¨æ¥å¿«é€Ÿç®—å‡ºé¢ç§¯æ¯”ï¼Œå³æ··åˆæƒé‡çš„ã€‚AreaTexçš„ç”Ÿæˆæ­¥éª¤æ¯”searchTexæ›´å¤æ‚ï¼Œä½œè€…æ›´æ˜¯ç”¨äº†å¤šçº¿ç¨‹æ¥åšã€‚ä¸ºäº†ç ´è§£areaTexçš„é­”æ³•åŸç†ï¼Œéœ€è¦æ…¢æ…¢å‰–æAreaTex.pyã€‚å°½ç®¡AreaTex.pyå·²ç»æœ‰ä¸å°‘æ³¨é‡Šï¼Œä½†è¿˜æ˜¯å¾ˆéš¾ç†è§£ã€‚&lt;/p&gt;

&lt;p&gt;å…ˆæ¥çœ‹areaTexé•¿å•¥æ ·ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/areaTex.png&quot; alt=&quot;areaTex.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;å®ƒåˆ†å·¦å³ä¸¤åˆ—ï¼Œå·¦è¾¹ä¸€åˆ—ä¸ƒä¸ªå¤§æ ¼ï¼ˆé»„è‰²æ¡†ä»£è¡¨ç¬¬ä¸€ä¸ªå¤§æ ¼ï¼‰ï¼Œæ¯ä¸ªå¤§æ ¼åŒ…å«16ä¸ªpatternçš„areaçº¹ç†ï¼Œå³è¾¹ä¸€åˆ—ç±»ä¼¼ï¼Œä½†åªæœ‰äº”ä¸ªå¤§æ ¼ï¼ˆè“è‰²æ¡†ï¼‰ã€‚æœ‰æ„æ€çš„æ˜¯é»„æ¡†å¤§æ ¼æ˜¯æœ‰é•‚ç©ºçš„ï¼Œç†åº”å¯ä»¥æ”¾5*5=25ä¸ªå°æ ¼ï¼Œä½†åªæ”¾äº†16ä¸ªï¼Œæ‰€ä»¥æœ‰ä¸ªåå­—æ¶çš„é»‘è‰²åŒºåŸŸï¼ˆåŸå› å’Œbinear filteringæœ‰å…³ï¼‰ã€‚å› ä¸ºareaTexæœ‰4ä¸ªç»´åº¦ï¼š orthoè¿˜æ˜¯diagã€å“ªä¸€ä¸ªå¤§æ ¼ã€å“ªä¸€ä¸ªå°æ ¼ã€çº¹ç†åæ ‡ï¼Œæ‰€ä»¥areaTexæ˜¯ä¸€ä¸ª4Dçš„çº¹ç†ã€‚&lt;/p&gt;

&lt;p&gt;æ ‡è®°ä¸‹16ä¸ªpatternåœ¨å¤§æ ¼é‡Œçš„ä½ç½®ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/areaTex2.png&quot; alt=&quot;areaTex2.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;ï¼ˆå€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¯¹äºSMAA 1xï¼Œåªä¼šç”¨åˆ°ç¬¬ä¸€æ’è¿™2ä¸ªå¤§æ ¼ã€‚ï¼‰&lt;/p&gt;

&lt;p&gt;å¯¹äºorhtoã€å¹¶ä¸”åªç”¨SMAA 1xçš„æƒ…å†µï¼ŒæŸ¥è¯¢areaTexéœ€è¦è¿™ä¹ˆäº›å‚æ•°ï¼šå½“å‰åƒç´ ç‚¹çš„edge lineçš„leftæ–¹å‘å’Œrightæ–¹å‘æœ«å°¾çš„è¾¹å€¼e1ã€e2ä»¥åŠé•¿åº¦å€¼d1ã€d2ã€‚e1ã€e2ç”¨æ¥å®šä½å¤§æ ¼ä¸­çš„å°æ ¼ï¼Œd1ã€d2ç”¨æ¥å®šä½å°æ ¼é‡Œçš„åƒç´ ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;æ³¨æ„ï¼Œå› ä¸ºareaTexåˆ†è¾¨ç‡æœ‰é™ï¼Œå¹¶ä¸”éœ€è¦ç”¨é•¿åº¦å€¼å»ç´¢å¼•ï¼Œæ‰€ä»¥å¯¹äºè¶…é•¿çš„é”¯é½¿è¾¹ï¼Œå°±è¡Œä¸é€šäº†ã€‚ä½œè€…ä¹ŸåŠ äº†ä¸€ä¸ª#define SMAA_MAX_SEARCH_STEPS 32ã€‚32å°±æ˜¯å°æ ¼çš„è¾¹é•¿çš„ä¸€åŠï¼Œå› ä¸ºåšäº†ä¸€ä¸ªsqrtçš„å‹ç¼©ã€‚&lt;/p&gt;

&lt;p&gt;areaTexçš„ä½¿ç”¨åœ°æ–¹æå°‘ï¼Œåªæœ‰åœ¨pass2è°ƒç”¨äº†ä¸¤æ¬¡SMAAAreaã€‚æ‰€ä»¥å…³é”®çš„åœ°æ–¹æ˜¯areaTexçš„åŸç†å’Œç”Ÿæˆï¼ˆAreaTex.pyï¼‰ã€ä»¥åŠSMAAAreaéœ€è¦çš„å‚æ•°çš„è®¡ç®—ã€‚&lt;/p&gt;

&lt;p&gt;areaTexçš„ç”Ÿæˆæ˜¯brute forceçš„ï¼Œéå†æ¯ä¸€ä¸ªsubsample offsetã€æ¯ä¸€ä¸ªpatternã€æ¯ä¸€ä¸ªleft distanceã€æ¯ä¸€ä¸ªright distanceï¼Œç„¶åç®—å‡ºleftã€rightæ–¹å‘4ä¸ªé¢ç§¯å­˜åˆ°weightTexï¼Œå°±å¯ä»¥ç»™pass 3ç”¨äº†ã€‚&lt;/p&gt;

&lt;p&gt;å…ˆçœ‹å¦‚ä½•ç”ŸæˆOrthoï¼ˆå·¦è¾¹åˆ—ï¼‰çš„ä¸€ä¸ªå°æ ¼ï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;tex2dortho&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# å¯¹å“ªä¸€ä¸ªoffsetã€å“ªä¸€ä¸ªpatternåšç”Ÿæˆï¼ŒSMAA 1xçš„è¯åªéœ€è¦è®¤ä¸ºoffsetä¸º0&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SIZE_ORTHO&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# æœ¬æ¥åªæœ‰SIZE_ORTHOå¤§å°ï¼Œè¿™é‡Œå·å·æ”¾å¤§ä¸€å€æ¥è®¡ç®—ï¼Œæœ€ç»ˆä¼šè¢«å‹ç¼©å›SIZE_ORTHOæ”¾è¿›4Dçº¹ç†é‡Œ&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;tex2d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;RGBA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;# x yä»£è¡¨left distance å’Œ right distance&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;areaortho&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# p[0] p[1]å°±æ˜¯ä¸€ä¸ªedgeå…³è”çš„2ä¸ªåƒç´ çš„aå€¼äº†&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;tex2d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;putpixel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;bytes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;tex2d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;TGA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;å…³é”®çš„areaorthoï¼š&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# Calculates the area for a given pattern and distances to the left and to the&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# right, biased by an offset:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;areaortho&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Calculates the area under the line p1-&amp;gt;p2, for the pixel x..x+1:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;......&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# o1           |&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#      .-------Â´&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# o2   |&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#      &amp;lt;---d---&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    ------&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   &lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   .------&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# We only offset L patterns in the crossing edge side, to make it&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# converge with the unfiltered pattern 0 (we don&amp;#39;t want to filter the&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# pattern 0 to avoid artifacts).&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    ------.&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   .------.&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;smootharea&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   `------&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          &lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   +------&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      &lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   `------.&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# A problem of not offseting L patterns (see above), is that for certain&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# max search distances, the pixels in the center of a Z pattern will&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# detect the full Z pattern, while the pixels in the sides will detect a&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# L pattern. To avoid discontinuities, we blend the full offsetted Z&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# revectorization with partially offsetted L patterns.&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   +------.&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    ------Â´&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   &lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   .------Â´&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    ------+&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   .------+&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   `------Â´&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   &lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vec2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;smootharea&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   +------Â´&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   `------+&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#          |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pattern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   +------+&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#   |      |&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ï¼ˆä»£ç è´´è¿›æ¥åæ’ç‰ˆä¹±æ¥= =ï¼‰&lt;/p&gt;

&lt;p&gt;è¿™é‡Œé¢æ ¹æ®patternçš„å€¼åšæ¥16ä¸ªåˆ†æ”¯åˆ¤æ–­ï¼Œä¸ºä»€ä¹ˆæ˜¯16ï¼Œçœ‹æ³¨é‡Šçš„å›¾å°±çŸ¥é“äº†ï¼Œ4ä¸ªè¾¹å€¼\(e_{1}ã€e_{2}ã€e_{3}ã€e_{4}\)çš„ç»„åˆéƒ½è¦æšä¸¾å‡ºæ¥ï¼Œæ¯ä¸ªeå–å€¼0æˆ–1ï¼Œæ‰€ä»¥æœ‰2çš„4æ¬¡æ–¹å…±16ç§æƒ…å†µã€‚&lt;/p&gt;

&lt;p&gt;ä¸­é—´çš„æ¨ªæ ä»£è¡¨åœ¨searchçš„æ—¶å€™çš„å½“å‰lineï¼Œé•¿åº¦ç­‰äºå½“å‰åƒç´ å·¦è¾¹ç¼˜åˆ°å·¦ç«¯ç‚¹+å³è¾¹ç¼˜åˆ°å³ç«¯ç‚¹+è‡ªå·±çš„å®½åº¦1ï¼Œå³d=left+right+1ã€‚&lt;/p&gt;

&lt;p&gt;// å› ä¸ºSMAA 1xçš„offsetä¸º0ï¼Œæ‰€ä»¥ o1 = 0.5ï¼Œ o2 = 0.5 - 1.0 = -0.5ï¼Œä»£è¡¨o1å½“å‰åƒç´ çš„ä¸Šè¾¹ç¼˜è·ç¦»ä¸­å¿ƒ0.5ä¸ªåƒç´ è·ç¦»ï¼Œo2æ˜¯-0.5è·ç¦»ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ä¸€å‹patternï¼š1&lt;/strong&gt;ã€‚å¯¹äºpattern 0ï¼Œå·¦å³éƒ½æ²¡æœ‰crossing edgeï¼Œæ˜¯å®Œç¾çš„ç›´çº¿ï¼Œä¸éœ€è¦æŠ—é”¯é½¿ï¼Œæ‰€ä»¥è¿”å›äº†ä¸¤ä¸ª0ï¼›&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Lå‹patternï¼š1ã€2ã€4ã€8&lt;/strong&gt;ã€‚å¯¹äºpattern 1ï¼Œå…ˆåšäº†ä¸€ä¸ªåˆ¤æ–­if left &amp;lt;= rightï¼Œè¿™æ˜¯ä¸ºäº†æ”¶æ•›åˆ°pattern 0ï¼Œå½“leftæ¯”rightå°ï¼Œä¸”æ˜¯è¿™ä¸ªLå‹patternï¼Œé‚£ä¹ˆå½“å‰åƒç´ æ‰éœ€è¦åšæ··åˆï¼Œä¹Ÿå°±éœ€è¦è®¡ç®—é¢ç§¯ã€‚æ³¨é‡Šä¹Ÿå†™ç€åªå¯¹Lå‹patternçš„crossing edgeä¸€ä¾§åšè®¡ç®—ã€‚pattern 2ã€4ã€8ï¼Œå°±æ˜¯pattern 1çš„3ç§é•œåƒæƒ…å†µäº†ï¼ŒåŒç†ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;å’Œä¸€å‹patternè¾“å‡ºä¸€æ ·çš„patternï¼š5ã€10ã€15&lt;/strong&gt;ã€‚è§‚å¯Ÿè¿™å‡ ä¸ªpatternå¯ä»¥å‘ç°æœ‰ä¸Šä¸‹å¯¹ç§°æ€§ï¼Œç­‰äº2ä¸ªLå åŠ ï¼Œäº’ç›¸æŠµæ¶ˆæ‰äº†ã€‚è¿”å›ä¸¤ä¸ª0.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Uå‹patternï¼š3ã€12&lt;/strong&gt;ã€‚å¯¹äº3ï¼Œå°±æ˜¯1ã€2çš„å åŠ ï¼ŒåŒæ—¶åšäº†1å’Œ2çš„é¢ç§¯è®¡ç®—ï¼Œå†smoothï¼Œå†æ··åˆï¼›åŒç†ï¼Œ12å°±æ˜¯4ã€8çš„å åŠ äº†ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Zå‹patternï¼š6ã€9&lt;/strong&gt;ã€‚å¯¹äºSMAA 1xï¼Œå³offset=0ï¼ŒZå‹pattern 6ç­‰åŒäºhå‹pattern 7ï¼ŒZå‹pattern 9ç­‰åŒäºhå‹pattern 13ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;hå‹patternï¼š7ã€11ã€13ã€14&lt;/strong&gt;ã€‚ç›¸å½“ç›´ç™½çš„areaå‡½æ•°è°ƒç”¨ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä½œè€…ç»˜åˆ¶çš„ä¸€å¼ patternå›¾ï¼ˆå°±æ˜¯å·¦åˆ—çš„ç¬¬ä¸€ä¸ªå¤§æ ¼ï¼‰ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/area.png&quot; alt=&quot;area.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;è§‚å¯Ÿæ­¤å›¾å’Œå¯¹åº”åˆ†æ”¯ä»£ç ï¼Œå¯ä»¥å‘ç°areaå‡½æ•°çš„åæ ‡ç³»åŸç‚¹æ˜¯åœ¨leftå¤„ï¼Œå³æœ€å·¦è¾¹edgeé‚£é‡Œã€‚ä»¥è¿™é‡Œä¸ºåŸç‚¹ï¼Œ+xæ–¹å‘æœå³ï¼Œ+yæ–¹å‘æœä¸‹ã€‚&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# Calculates the area under the line p1-&amp;gt;p2, for the pixel x..x+1:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;area&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;x1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;x2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;y1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;y2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;inside&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# çº¿æ®µ[x,x+1]å’Œ[p1,p2]éœ€è¦é‡å &lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inside&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;istrapezoid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;copysign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;copysign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; 
                        &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1e-4&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1e-4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
        &lt;span class=&quot;c1&quot;&gt;# è®¡ç®—æ˜¯ä¸æ˜¯æ¢¯å½¢ï¼ˆy1å’Œy2åŒæ­£è´Ÿå·ï¼‰ï¼ç›´è§’å½¢ï¼ˆy1æˆ–y2çš„é•¿åº¦ä¸º0ï¼‰&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;istrapezoid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# æ¢¯å½¢é¢ç§¯å…¬å¼ï¼š0.5 * h * (ä¸Šåº•+ä¸‹åº•) = 0.5 * 1 * (y1 + y2)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# y1å’Œy2éƒ½åœ¨top edgeçº¿ä¸‹æ–¹&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# [p1,p2]å’Œtop edgeäº¤å‰äº†ï¼Œå½¢æˆ2ä¸ªä¸‰è§’å½¢&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;modf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;modf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;å‡½æ•°è¯´æ˜å†™ç€areaå‡½æ•°ç®—çš„æ˜¯p1åˆ°p2è¿™æ¡çº¿æ®µä¸‹ï¼Œxåˆ°x+1èŒƒå›´å†…çš„é¢ç§¯ï¼Œxå‚æ•°å…¶å®å°±æ˜¯ç­‰äºleftï¼Œå› ä¸º16ä¸ªpatternéƒ½æ˜¯ä¼ å…¥äº†leftã€‚æ‰€ä»¥[x, x+1]å°±æ˜¯[leftï¼Œleft+1]ï¼Œåˆå› ä¸ºåæ ‡ç³»åŸç‚¹åœ¨æœ€å·¦è¾¹ï¼Œ[leftï¼Œleft+1]æŒ‡çš„å…¶å®å°±æ˜¯å½“å‰åƒç´ çš„å·¦è¾¹ç•Œå’Œå³è¾¹ç•Œï¼ˆä¸€ä¸ªåƒç´ çš„å®½åº¦ä¸º1ï¼‰ã€‚æ‰€ä»¥areaçš„ä»»åŠ¡å°±æ˜¯è¦ç®—å‡ºp1-p2æŠŠå½“å‰åƒç´ åˆ‡å¼€äº†å¤šå¤§é¢ç§¯ã€‚&lt;/p&gt;

&lt;p&gt;å†å°±æ˜¯æ–œå‘çš„æƒ…å†µï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/area_diag.png&quot; alt=&quot;area_diag.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœèƒ½å®Œå…¨ç†è§£orthoçš„æƒ…å†µï¼Œdiagçš„å°±è§¦ç±»æ—é€šäº†ã€‚è¿™é‡Œæš‚æ—¶è·³è¿‡ã€‚ï¼ˆè¿™å¥—SMAAå¤ªå¤šç»†èŠ‚äº†ï¼Œæ¯ä¸ªç‚¹éƒ½ææ‡‚å®åœ¨ä¸å®¹æ˜“ï¼‰&lt;/p&gt;

&lt;h3&gt;searchç®—æ³•&lt;/h3&gt;

&lt;p&gt;(å¾…ç»­)&lt;/p&gt;

&lt;h2&gt;ç”¨weightTexæ··åˆåŸå›¾åƒï¼ˆPass 3ï¼‰&lt;/h2&gt;

&lt;h1&gt;æ€»ç»“&lt;/h1&gt;

&lt;p&gt;SMAAçš„ä¼˜ç‚¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¼ºé…ç½®æ€§ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å†³å®šä½¿ç”¨SMAA 1x/SMAA t2x/SMAA 4x&lt;/li&gt;
&lt;li&gt;SMAA 4xçš„æ€§èƒ½å’Œè´¨é‡è¶³ä»¥æŠ—è¡¡SSAAï¼Œä½é…çš„SMAA 1xå¯¹ä½ç«¯æœºä¹Ÿè¶³å¤Ÿç”¨äº†&lt;/li&gt;
&lt;li&gt;æ”¯æŒdeferæ¡†æ¶&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;SMAAçš„ç¼ºç‚¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æµç¨‹å¤ªå¤æ‚ï¼Œä»£ç å„ç§trickï¼Œä»…è¯»è®ºæ–‡æ˜¯çœ‹ä¸æ‡‚ä»£ç çš„ã€‚åªèƒ½è¾¹çœ‹ä»£ç è¾¹è¯»è®ºæ–‡ï¼Œç»“åˆåœ°å»ç†è§£ã€‚&lt;/li&gt;
&lt;li&gt;éœ€è¦é¢„ç”ŸæˆareaTexã€searchTexï¼Œç»´æŠ¤shaderä¹‹å¤–è¿˜å¾—ç»´æŠ¤2ä¸ªpyè„šæœ¬ï¼Œå®šåˆ¶ä¿®æ”¹SMAAæ¯”è¾ƒå¤æ‚ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æˆ‘è¯´çš„ç¼ºç‚¹å¯èƒ½æ¯”è¾ƒnaiveï¼Œè¯´ä¸å®šå¯¹å¤§ä½¬æ¥è¯´è¿™å¥—SMAAå¹¶ä¸å¤æ‚ã€‚&lt;/p&gt;

&lt;p&gt;æœ¬æ–‡ä»…ä»‹ç»SMAA 1xçš„æŠ€æœ¯åŸç†ï¼Œè‡³äºSMAA t2xå’ŒSMAA 4xéœ€è¦ç”¨åˆ°temporal reprojectionå’Œsupersampliingï¼Œå°±æ˜¯æ›´è¿›ä¸€æ­¥çš„è¯é¢˜äº†ã€‚&lt;/p&gt;

&lt;h1&gt;æœ€ç»ˆæ•ˆæœ&lt;/h1&gt;

&lt;p&gt;åŸå§‹å›¾åƒ:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/alias.png&quot; alt=&quot;alias.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;ç»è¿‡SMAA 1xè¿‡æ»¤å:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../images/2017.10/antialias.png&quot; alt=&quot;antialias.png&quot;&gt;&lt;/p&gt;

&lt;h1&gt;èµ„æ–™&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;http://www.iryoku.com/smaa/&quot;&gt;http://www.iryoku.com/smaa/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.iryoku.com/mlaa/&quot;&gt;http://www.iryoku.com/mlaa/&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Sun, 22 Oct 2017 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/antialiasing/</link>
        <guid isPermaLink="true">http://localhost:4000/antialiasing/</guid>
      </item>
    
  </channel>
</rss>