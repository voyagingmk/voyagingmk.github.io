<!DOCTYPE html>
<html>
  <head>
    <title>《计算机网络-自顶向下方法》笔记 – Wyman的技术博客 – 写作主题覆盖：游戏开发技术、图形学、机器学习。QQ：234707482</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>
    <meta name="baidu-site-verification" content="0OpfO1OtHA" />
    
    <meta name="description" content="" />
    <meta property="og:description" content="" />
    
    <meta name="author" content="Wyman的技术博客" />

    
    <meta property="og:title" content="《计算机网络-自顶向下方法》笔记" />
    <meta property="twitter:title" content="《计算机网络-自顶向下方法》笔记" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Wyman的技术博客 - 写作主题覆盖：游戏开发技术、图形学、机器学习。QQ：234707482" href="/feed.xml" />

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-65954265-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/network/',
		  'title': '《计算机网络-自顶向下方法》笔记'
		});
	</script>
	<!-- End Google Analytics -->
	<!-- Baidu Analytics -->
	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?0dc968591d8c64196a37eca9ca4f86b3";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
	<!-- End Baidu Analytics -->

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://www.qiujiawei.com/images/avatar.jpg" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Wyman的技术博客</a></h1>
            <p class="site-description">写作主题覆盖：游戏开发技术、图形学、机器学习。QQ：234707482</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>《计算机网络-自顶向下方法》笔记</h1>
  <h3>Tags: <a href="/tag/c%2B%2B/" rel="tag">c++</a></h3>
  <div class="entry">
    <!--more-->

<h1>网络层</h1>

<ul>
<li>是否对ip包分片，取决于输出链路的mtu，如果包大小大于mtu（可能500多到1500字节），那么就会自动分片</li>
<li>分片有3个不可或缺字段：ip包的唯一标识（ID)、字节偏移offset、结束标志（0或1，1表示还没结束，0表示当前已是最后一个片）</li>
<li>分片是ipv4的机制，且有安全问题，ipv6没有分片，杜绝了安全隐患</li>
<li><p>分片重组是在目的地端主机上进行的，路由器只可能做分片，而不会做重组</p></li>
<li><p>主机和物理链路之间的边界叫做接口</p></li>
<li><p>每个接口有自己的ip地址，所以ip地址技术是与接口关联，而不是和主机或路由器</p></li>
<li><p>子网：直接互联并与其他网络岛隔离的主机接口+路由器接口组成子网</p></li>
<li><p>子网掩码：例如223.1.1.0/24，/24就是子网掩码</p></li>
<li><p>网络层有三个主要组件：IP协议、路由选择协议(RIP、OSPF、BGP）、因特网控制报文协议ICMP</p></li>
</ul>

<p>查看和修改系统的mtu值：</p>

<p>查看：</p>

<p>ifconfig eth0</p>

<p>修改：</p>

<p>ifconfig eth0 mtu 1460</p>

<h2>DHCP动态主机配置协议</h2>

<p>四大步骤：</p>

<ol>
<li>DHCP发现报文，用UDP，端口67，src ip为0.0.0.0，dst ip为255.255.255.255，广播一个发现报文，报文里包含一个事物ID。</li>
<li>DHCP提供报文，DHCP服务器收到广播而来的发现报文后，用一个提供报文做响应，src ip为自己的ip，dst ip为255.255.255.255，也是广播。因为DHCP服务器不一定唯一，所以客户机有选择权。提供报文包含，收到的发现报文的事物ID、向客户推荐的IP地址、IP地址的掩码、IP地址租用期（address lease time），租用期一般为几小时到几天。</li>
<li>DHCP请求报文，客户机从1到多个提供报文中选择一个，并向该服务器发送DHCP请求报文。</li>
<li>DHCP ACK报文，就是第三步的响应报文，告诉客户配置参数。</li>
</ol>

<p>第四步完成后，客户就可以在租用期里使用这个ip。另外，DHCP也有延长租用期的办法。</p>

<h2>NAT网络地址转换</h2>

<ul>
<li>NAT是用来解决ipv4的ip地址不够用问题的</li>
<li>NAT会使得外部主机不能直接访问内网主机（内网主机不可见），因为内网主机没有自己的全球唯一ip地址</li>
<li>NAT用一张转换表来双向转发数据包</li>
<li>内网主机可以主动访问外网，反过来就不行</li>
<li>NAT的存在对实现p2p应用很不好</li>
<li>应用NAT穿越技术，可以改善p2p应用的通讯问题</li>
</ul>

<p>NAT穿越：<a href="https://www.jianshu.com/p/84e8c78ca61d">https://www.jianshu.com/p/84e8c78ca61d</a></p>

<h2>ICMP控制报文协议</h2>

<ul>
<li>常用于差错报告，例如目的地不可达时，中间路由器就会返回类型3的ICMP报文</li>
<li>ICMP协议是建立在IP协议上面的，因为是用IP分组承载的。类似TCP、UDP。但一般认为ICMP是属于网络层的协议。</li>
<li>ICMP报文组成：类型、编码。编码可理解为大类型里的子类型。<a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol">wiki</a></li>
</ul>

<p>ping程序： 发一个ICMP[8,0]报文，目的主机发回一个ICMP[0,0]的报文。</p>

<p>源抑制报文：从wiki可以看到已经deprecated了，最初是用来做拥塞控制的，不过tcp自己有拥塞控制，所以没卵用。</p>

<p>traceroute：原理就是发送一系列IP数据报，每个数据报携带UDP报文，目的地ip为目标主机，端口号设置为不可达的端口号。关键的，第一个数据报的TTL设为1，第二个的TTL为2，以此类推。当第n个数据报到达第n台路由器时，第n台路由器发现这个数据报的TTL正好过期，然后就会发给源主机一个ICMP[11,0]，携带了该路由器的ip地址。然后每个数据报都设置了定时器，收到回复时就可以算出往返延迟RTT。</p>

<p>traceroute还有个问题是何时停止发送udp报文，这是通过ICMP的类型和编码字段判断的，因为如果目的地主机在线，那么最终会返回一个ICMP[3,3]，表示目的主机端口不可达。</p>

<h2>ipv6</h2>

<p>改进：</p>

<ul>
<li>去掉了分片功能，因为分片功能是耗时操作，去掉后能提高路由器性能</li>
<li>没有分片后，如果包太大，就无法发进链路层，只能丢弃，并返回ICMP差错报文，让发送方重新发一个小的</li>
<li>去掉了首部校验和，因为传输层协议、链路层协议也会做校验和，所以多余了。另外，因为IP头部有个动态的跳数，会导致每次修改跳数都得重新计算校验和，影响性能。</li>
<li>选项字段从IP首部去掉，但依然可以存在选项，方法是用“下一个头部”字段来实现，就是说选项信息是一个可选的头部。</li>
<li>去掉了选项后，ipv6的头部就是定长的40字节，非常高效。</li>
</ul>

<p>2个ipv6主机之间通讯，可能会经过一段由仅支持ipv4的主机组成的路径，这时可以用隧道技术，把ipv6分组，放到ipv4分组的有效载荷里。</p>

<h2>路由选择算法</h2>

<p>全局式算法：路由器拥有网络拓扑信息、连通信息、链路费用信息，从而算出最优路径。也称为链路状态算法。链路费用一般取决于链路承载流量。</p>

<p>分散式算法：路由器没有网络链路信息，而只需要拥有和路由器直接相连链路的费用信息就可开始工作。通过迭代、和邻居交换信息，就能逐渐计算出到达某目的地结点的最低费用路径。</p>

<p>静态算法：依靠人工。</p>

<p>动态算法：拓扑或负载变化时更新。不过容易受<strong>路由选择循环、路由震荡</strong>影响。</p>

<p>负载敏感算法：链路费用会动态地变化，以反映链路拥塞情况。</p>

<p>负载迟钝算法：相反的，对拥塞不敏感，费用固定。更普遍可行的方法。</p>

<p>路由震荡：用随机化的链路通告时间，可以改善震荡。</p>

<p>LS链路状态算法：基于无向图最短路算法。最坏情况n平方。</p>

<p>DV距离向量算法：是一种迭代、异步、分布式的算法。</p>

<h2>互联网当前的路由算法</h2>

<h3>RIP，<strong>路由选择信息协议</strong></h3>

<ul>
<li>路由选择表（routing table），也叫RIP表，包含该路由器的距离向量、转发表。</li>
<li>目的子网，就是把目的地路由器当成一个子网网络</li>
<li>跳数，理解为到目的子网的链接边数即可</li>
</ul>

<p>转发表的结构：目的子网，下一台路由器，到目的子网的跳数。每个子网占一行。</p>

<p>转发表的状态是迭代的，不可能是实时获得整个网络的状态信息。</p>

<p>邻居路由器之间会互相通告最新的转发表信息。大概30秒一次。</p>

<p>如果邻居超过180秒没有发来报文，认为不可达，更新自己的路由表，并向其他存活的邻居发公告。</p>

<p>每次收到转发表信息，都可能导致当前路由器的所知的到达某个子网的跳数、下一跳路由器信息，产生更新，因为新的路径（跳数）可能会更短。</p>

<p><img src="../images/2018.6/2.png" alt="1.png"></p>

<p><img src="../images/2018.6/3.png" alt="1.png"></p>

<p><img src="../images/2018.6/4.png" alt="1.png"></p>

<p>路由器可以主动询问邻居<strong>到指定目的地的费用</strong>（RIP请求报文）。基于UDP 520端口。</p>

<p><strong>RIP是一个基于传输层UDP协议的应用层进程（叫routed），用UDP来控制IP路由。</strong>这也是一个特殊进程，因为它可以操作系统内核的转发表。</p>

<p>routed会和邻居路由器的routed进程相互联系。</p>

<p><img src="../images/2018.6/1.png" alt="1.png"></p>

<h3>OSPF</h3>

<ul>
<li>被设想为RIP的后继者，因为有许多先进特性</li>
<li>洪泛链路状态信息的链路状态协议 + Dijkstra最低费用路径算法</li>
<li>是基于完整信息状态的算法</li>
<li>各条链路费用可用网络管理员配置，如果都设为1，则退化成<strong>最少跳数路由选择（RIP）</strong></li>
<li>管理员可以根据带宽大小来设置链路费用，反比，带宽越大，费用越低。</li>
<li>路由选择信息是广播到整个网络的，而不仅仅是邻居</li>
<li>当一跳链路状态（费用、连接/中断）变化时，更新并广播</li>
<li>即使无变化，也要定期广播</li>
<li>OSPF报文直接承载于IP层，所以OSPF要自行实现可靠传输，链路状态广播功能。</li>
</ul>

<p>优点：</p>

<ul>
<li>安全，对网络成员有身份鉴别功能，从而鉴别假冒的OSPF协议包。但这是可选的功能。鉴别方法是在每台路由器上配置一样的共享密钥，发包时，把密钥添加到分组里然后算一个MD5，再把MD5放到发包分组里，接收端收到分组后，对内容段添加自己的密钥并算一个MD5，并和收到的MD5进行比较鉴别。另外还有个序号，用来针对重放攻击。</li>
<li>负载均衡，如果去某个目的地存在多条费用一样的路径，OSPF允许同时使用多条路径，而不是只用其中一条。</li>
<li>层次结构</li>
<li>对多播的支持</li>
</ul>

<p>OSPF可按区域划分（大区分小区），区域和区域外的联系要经过<strong>区域边界路由器</strong>，边界路由器都连到主干路由，从而实现区域之间的连通。</p>

<h3>BGP 边界网关协议</h3>

<ul>
<li>BGP确保了因特网中所有AS知道该子网以及如何到达那里。</li>
<li>没有BGP，那么每个子网将是隔离的，不为互联网其他部分所知。</li>
<li>是BGP这个协议将所有东西粘合在一起</li>
<li>BGP基于TCP端口179，半永久TCP连接</li>
<li>BGP作用：使得每个AS知道经过其相邻AS可达哪些目的地。</li>
</ul>

<p>关键词定义：</p>

<ul>
<li>BGP对等方，BGP peers，即一条BG TCP连接的两端</li>
<li>沿着该连接发送所有BGP报文的TCP连接称为BGP会话</li>
<li>跨越2个AS的BGP会话称为外部BGP，eBGP；同理，内部的叫iBGP。</li>
<li>目的地：不是主机IP，而是CDIR化的前缀，表示一个子网或子网的集合，如：138.16.64/24。</li>
<li>前缀聚合：如果AS连接了4个子网，138.16.64/24，138.16.65/24，138.16.66/24，138.16.67/24，可以聚合成138.16.64/22</li>
</ul>

  </div>
  <div class="entry">
  (未经授权禁止转载)
  </div>
  <div class="date">
    Written on June 24, 2018
  </div>
  <p>博主将十分感谢对本文章的任意金额的打赏^_^</p>
  <img src="../images/dashang1.jpeg" />
  <img src="../images/dashang2.jpeg" />
    
    
  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'qiujiawei';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:voyagingmk@gmail.com"><i class="svg-icon email"></i></a>


<a href="http://github.com/barryclark/jekyll-now"><i class="svg-icon github"></i></a>




<a href="http://twitter.com/voyagingmk"><i class="svg-icon twitter"></i></a>


        </footer>
      </div>
    </div>

  </body>
</html>
